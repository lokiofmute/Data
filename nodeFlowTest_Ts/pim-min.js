/*! pim 0.0.55 20-04-2015 */
/*! (c) 2012-2015 - Angle Gaming Labs. */
/*! Written by enki. */
console&&console.log("The 3D elements on this page are rendered with pimJS 0.0.55. Â©2015 Angle Gaming Labs.");!function a(b,c,d){function e(f,h){var i,j;if(!c[f]){if(!b[f]){if(i="function"==typeof require&&require,!h&&i)return i(f,!0);if(g)return g(f,!0);throw Error("Cannot find module '"+f+"'")}j=c[f]={exports:{}},b[f][0].call(j.exports,function(a){var c=b[f][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[f].exports}var f,g="function"==typeof require&&require;for(f=0;f<d.length;f++)e(d[f]);return e}({1:[function(a,b,c){c.fragmentZ_pimShader="  varying vec4 wpos;\n  vec4 pack (float depth) { \n     const vec4 bias = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0); \n     float r = depth; \n     float g = fract(r * 255.0); \n     float b = fract(g * 255.0); \n     float a = fract(b * 255.0); \n     vec4 colour = vec4(r, g, b, a); return colour - (colour.yzww * bias); \n  }\n  float unpack (vec4 colour) { \n     const vec4 bitShifts = vec4(1.0, 1.0 / 255.0, 1.0 / (255.0 * 255.0), 1.0 / (255.0 * 255.0 * 255.0)); \n     return dot(colour, bitShifts); \n  }\n  void main() {\n    gl_FragColor = pack( wpos.z/100.0 );\n//    gl_FragColor = pack( gl_FragCoord.z );\n  }\n\n"},{}],2:[function(a,b,c){a("./pim_matrix"),a("./pim_polyfil"),navigator&&(c=window),c.pimMaths=a("./pim_maths").pimMaths,c.pimDirector=a("./pim_director").pimDirector,c.pimScene=a("./pim_scene").pimScene,c.pimObjectInstance=a("./pim_scene").pimObjectInstance,c.pimBone=a("./pim_scene").pimBone,c.pimLight=a("./pim_scene").pimLight,c.pimCamera=a("./pim_scene").pimCamera,c.pimObject=a("./pim_object").pimObject,c.pimInstance=a("./pim_instance").pimInstance,c.pimSurface=a("./pim_object").pimSurface,c.pimSpline=a("./pim_spline").pimSpline,c.pimRay=a("./pim_ray").pimRay,c.pimParticle=a("./pim_particle").pimParticle,c.pimStream=a("./pim_stream").pimStream,c.pimlxo=a("./pim_lxo").pimlxo,c.pimLWO2=a("./pim_lwo2").pimLWO2,c.pimLWS=a("./pim_lws").pimLWS,c.pimUtils=a("./pim_utils").pimUtils,c.pimProgress=a("./pim_utils").pimUtils.pimProgress,c.pimOptions=a("./pim_utils").pimUtils.pimOptions,c.loadImage=a("./pim_utils").pimUtils.loadImage,c.countingCompleter=a("./pim_utils").pimUtils.countingCompleter,c.pimFonts=a("./pim_fonts").pimFonts,c.pimFontMesh=a("./pim_fonts").pimFontMesh,c.pimSound=a("./pim_sound").pimSound,c.pimDirector=a("./pim_tracker").extendTracker(c.pimDirector),c.keyCodeToChar={8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause/Break",20:"Caps Lock",27:"Esc",32:"Space",33:"Page Up",34:"Page Down",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"Windows",93:"Right Click",96:"Numpad 0",97:"Numpad 1",98:"Numpad 2",99:"Numpad 3",100:"Numpad 4",101:"Numpad 5",102:"Numpad 6",103:"Numpad 7",104:"Numpad 8",105:"Numpad 9",106:"Numpad *",107:"Numpad +",109:"Numpad -",110:"Numpad .",111:"Numpad /",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"Num Lock",145:"Scroll Lock",182:"My Computer",183:"My Calculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},c.keyCharToCode={Backspace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Alt:18,"Pause/Break":19,"Caps Lock":20,Esc:27,Space:32,"Page Up":33,"Page Down":34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,Insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,Windows:91,"Right Click":93,"Numpad 0":96,"Numpad 1":97,"Numpad 2":98,"Numpad 3":99,"Numpad 4":100,"Numpad 5":101,"Numpad 6":102,"Numpad 7":103,"Numpad 8":104,"Numpad 9":105,"Numpad *":106,"Numpad +":107,"Numpad -":109,"Numpad .":110,"Numpad /":111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,"Num Lock":144,"Scroll Lock":145,"My Computer":182,"My Calculator":183,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222},c.objectShape=function(a){return Object.keys(a).map(function(b){return b+"="+(typeof a[b])[0]}).join()},c.objectShape=function(a){return Object.keys(a).map(function(b){return b+"="+(typeof a[b])[0]+(a[b]==(0|a[b])&&"number"==typeof a[b]?"":"")}).join().replace(/ /g,"")},c.pimGui=a("./pim_gui").pimGui},{"./pim_director":3,"./pim_fonts":4,"./pim_gui":5,"./pim_instance":6,"./pim_lwo2":7,"./pim_lws":8,"./pim_lxo":9,"./pim_maths":10,"./pim_matrix":11,"./pim_object":12,"./pim_particle":13,"./pim_polyfil":14,"./pim_ray":15,"./pim_scene":16,"./pim_sound":17,"./pim_spline":18,"./pim_stream":19,"./pim_tracker":20,"./pim_utils":21}],3:[function(a,b,c){function d(a){this.type=0,this.subscene=0,this.func={},this.start=0,this.stop=0,this.wrap=0,this.qStart=0,this.qStop=0,this.speed=1,this.ref={},this.locked=!1,this.time=0,this.flush=!1;for(var b in a)void 0==this[b]||(this[b]=a[b]);return this}function e(a){var b,c;this.ssTimes=[],this.lastssTimes=[],this.tracks=[],this.splines=[],this.xsplines=[],this.ysplines=[],this.zsplines=[],this.hsplines=[],this.psplines=[],this.bsplines=[],this.xssplines=[],this.yssplines=[],this.zssplines=[],this.eventMap={},this.showLoader=!0,this.loaderColor="white",this.loaderBackgroundColor="black",this.alpha=!1,this.basepath="",this.running=0,this.nrsplines=0,this.antialias=0,this.name="Poetry In Motion",this.frameHandlers={},this.masterSpeed=1,this.frameHandlersIDX=0,this.wait=new m.countingCompleter,this.prog=new pimProgress,this.loaderImage="";for(b in a)void 0==this[b]||(this[b]=a[b]);("undefined"!=typeof AudioContext||"undefined"!=typeof webkitAudioContext)&&(c=window.AudioContext||window.webkitAudioContext,c&&(this.audio=new c)),this.sounds={}}var f=a("./pim_spline").pimSpline,g=a("./pim_object").pimSurface,h=(a("./pim_object").pimObject,a("./pim_instance").pimInstance),i=(a("./pim_scene").pimBone,a("./pim_scene").pimObjectInstance),j=a("./pim_scene").pimLight,k=a("./pim_scene").pimCamera,l=a("./pim_scene").pimScene,m=a("./pim_utils").pimUtils,n=a("./pim_lws").pimLWS,o=a("./pim_gui").pimGui;e.START_QUEUE=0,e.START_DISCARD=1,e.STOP_FINISH=0,e.STOP_INT=1,e.WRAP_PING=0,e.WRAP_PINGPING=1,e.WRAP_PINGPONG=2,e.WRAP_PONGPONG=3,e.WRAP_PONG=4,e.BLOCK_SS=0,e.BLOCK_FUNC=1,e.BLOCK_WAIT=2,e.BLOCK_PAUSE=3,e.DRAGGING_DELAY=100,e.DRAGGING_THRESHOLD=5,e.oldSchool=!1,e.prototype.autoload=function(a,b,c,d){var e,f,g;return"object"!=typeof a&&(a=document.getElementById(a)),this.canvas=a,this.running=0,void 0==c&&(c=0),e=this.wait,this.unload(),f=new l,this.scene=f,this.createLoader(),a&&this.getWebGL(),a&&(this.addResizeHandler(),this.addDragDropHandlers(),this.addMouseHandlers()),this.addOrientationHandler(),this.addKeyboardHandlers(),g=this.prog,g.reset(c),this.showLoader&&(g.onprogress=function(a,b){isNaN(a)||(this.pr.value=a,this.pr.max=b,this.mb&&(this.mb.innerHTML=(100*a/b).toFixed(1)+" % "))}.bind(this)),b&&n.read(this.scene,this.basepath+b,e.link(),g),e.wait(function(){var b,c,e,g,i;(!this.canvas||this.gl)&&(0==f.cameras.length&&(b=f.addCamera(),b.inst.x=0,b.inst.y=0,b.inst.z=-1.6),a&&(a.style.visibility="visible"),c=(new Date).getTime(),e=c,g=0,i=0,void 0==this.render&&(this.render=function(){var a,b,c;this.calcCount&&(h.calcCount=this.calcCount),a=(new Date).getTime(),g+=(a-e)/1e3*this.masterSpeed,e=a,this.evaluate(g),this.raiseEvent("Frame",[this.mousex,this.mousey]);for(b in this.frameHandlers)this.frameHandlers[b](this.mousex,this.mousey);this.scene.propagateChanged(),c=this.scene.render(this.canvas,this.gl),this.raiseEvent("PostFrame",[]),c?i=0:i++,this.running&&(0!==this.maxIdleCount&&i>(this.maxIdleCount||300)?setTimeout(this.render,200):requestAnimFrame(this.render),this.calcCount=h.calcCount)}.bind(this),requestAnimFrame(this.render)),this.running=1,0==this.raiseEvent("Load",[])&&(void 0==d?this.autoplay():d.call(this)),this.scene.backdropColor&&this.gl.clearColor(f.backdropColor[0],f.backdropColor[1],f.backdropColor[2],f.backdropColor[3]),this.pr&&this.pr.removeAttribute("value"),this.mb&&(this.mb.innerHTML=this.loadText||"Hold on to your seat .."),this.wait.wait(function(){setTimeout(function(a){a&&(a.style.opacity="0",a.style.visibility="hidden")}.bind(this,this.div),500)}.bind(this)))}.bind(this)),this},e.prototype.autoLoad=e.prototype.autoload,e.prototype.autoPlay=function(){return this.playSS(0,0,this.scene.firstFrame/this.scene.framesPerSec,this.scene.lastFrame/this.scene.framesPerSec,1),this},e.prototype.autoplay=e.prototype.autoPlay,e.prototype.autoAssign=function(){return this.scene.objects.forEach(function(a){this.assign(a,a.inst.ss||0)}.bind(this)),this.scene.lights.forEach(function(a){this.assign(a,a.inst.ss||0)}.bind(this)),this.scene.cameras.forEach(function(a){this.assign(a,a.inst.ss||0)}.bind(this)),this},e.prototype.autoassign=e.prototype.autoAssign,e.prototype.assign=function(a,b,c,d,l,m){var n,o,p,q,r;if(c&&c.follow&&(l=!0),void 0==this.ssTimes[b]&&(this.ssTimes[b]=0),b=+b,a instanceof f){if(a.ss=b,a.target=c,a.targetvar=d,0==a.nrKeys&&!l)return;if(1==a.nrKeys&&!l)return void(c&&(c[d]=a.keys[0].value));switch(this.nrsplines++,d){case"x":this.xsplines.push(a);break;case"y":this.ysplines.push(a);break;case"z":this.zsplines.push(a);break;case"h":this.hsplines.push(a);break;case"p":this.psplines.push(a);break;case"b":this.bsplines.push(a);break;case"xs":this.xssplines.push(a);break;case"ys":this.yssplines.push(a);break;case"zs":this.zssplines.push(a);break;default:this.splines.push(a)}m&&(a.format=m)}else if(a instanceof i){this.assign(a.inst,b,void 0,void 0,l);for(n in a.bones)this.assign(a.bones[n].inst,a.bones[n].inst.ss||b);if(a.obj)for(o in a.obj.surfaces)this.assign(a.obj.surfaces[o],+a.obj.surfaces[o]["pimSurface.SubSceneNr"]||b,a.inst)}else if(a instanceof g){if((a.diffuseUAnim||a.diffuseVAnim||a.channels[0]&&(a.channels[0].auvx||a.channels[0].auvy))&&void 0!=b&&(a.animspline=(new f).addKey(0,0).addKey(1e5,1e5),this.assign(a.animspline,e.oldSchool?c.ss:b,c,"animtime")),a.splines){p=a.splines;for(q in p)0==p[q].tp&&this.assign(p[q].keys,b,a.color,0),1==p[q].tp&&this.assign(p[q].keys,b,a.color,1),2==p[q].tp&&this.assign(p[q].keys,b,a.color,2),3==p[q].tp&&this.assign(p[q].keys,b,a,"diffuse"),4==p[q].tp&&this.assign(p[q].keys,b,a,"specular"),6==p[q].tp&&this.assign(p[q].keys,b,a,"transparency",!0,function(a){return.001>a?.001:1==a?.9999999:a}),8==p[q].tp&&this.assign(p[q].keys,b,a,"luminosity"),100==p[q].tp&&this.assign(p[q].keys,b,c,""),p[q].keys.ctarget=c}}else if(a instanceof j){this.assign(a.inst,b);for(n in a.splines)o=a.splines[n],0==o.tp?this.assign(o,b,a,"coneangle"):this.assign(o,b,a,n)}else if(a instanceof k)this.assign(a.inst,b);else if(a instanceof pimParticle)this.assign(a.obj,b),this.assign(a.GravityX,b,a,"gX",l),this.assign(a.GravityY,b,a,"gY",l),this.assign(a.GravityZ,b,a,"gZ",l),this.assign(a.Rate,b,a,"birthRate",l),this.assign(a.StartVX,b,a,"startVX",l),this.assign(a.StopVX,b,a,"stopVX",l);else if(a instanceof h){a.ss=b,p=["_x","_y","_z","_h","_p","_b","_xs","_ys","_zs"];for(r in p)this.assign(a[p[r]],b,a,p[r].replace("_",""),l),p[r].nrKeys&&(a[p[r].replace("_","")]=a[p[r]].evaluate(0));if(a.morphs)for(r in a.morphs)a.morphs[r]&&(a.morphs[r].evaluate(0),this.assign(a.morphs[r],b,a,null,!0))}},e.prototype.unAssign=function(a,b,c,d,l){var m,n,o,p,q,r,s;if(c&&c.follow&&(l=!0),a instanceof f){if(0==a.nrKeys)return;if(1==a.nrKeys&&!l)return;this.nrsplines--,m=this[a.targetvar+"splines"]||this.splines,n=m.indexOf(a),-1==n?!e.oldSchool&&!this.oldSchool:m.splice(n,1),a.ss=0,a.target=null,a.targetvar=""}else if(a instanceof i){this.unAssign(a.inst,b,void 0,void 0,l);for(o in a.bones)this.unAssign(a.bones[o].inst,a.bones[o].inst.ss||b);if(a.obj)for(p in a.obj.surfaces)this.unAssign(a.obj.surfaces[p],+a.obj.surfaces[p]["pimSurface.SubSceneNr"]||b,a.inst)}else if(a instanceof g){if(a.diffuseUAnim||a.diffuseVAnim||a.channels[0]&&(a.channels[0].auvx||a.channels[0].auvy))for(q=0;q<this.splines.length;)this.splines[q].target==c&&"animtime"==this.splines[q].targetvar?this.unAssign(this.splines[q],b,c,d):q++;if(a.splines){r=a.splines;for(s in r)0==r[s].tp&&this.unAssign(r[s].keys,b,a.color,0),1==r[s].tp&&this.unAssign(r[s].keys,b,a.color,1),2==r[s].tp&&this.unAssign(r[s].keys,b,a.color,2),3==r[s].tp&&this.unAssign(r[s].keys,b,a,"diffuse"),4==r[s].tp&&this.unAssign(r[s].keys,b,a,"specular"),6==r[s].tp&&this.unAssign(r[s].keys,b,a,"transparency"),8==r[s].tp&&this.unAssign(r[s].keys,b,a,"luminosity"),100==r[s].tp&&this.unAssign(r[s].keys,b,c,""),r[s].keys.ctarget=c}}else if(a instanceof j)for(this.unAssign(a.inst,b),o=0;p=this.splines[o];o++)0==p.tp&&this.unAssign(p,b,a,"coneangle");else if(a instanceof k)this.unAssign(a.inst,b);else if(a instanceof pimParticle)this.unAssign(a.obj,b),this.unAssign(a.GravityX,b,a,"Gx"),this.unAssign(a.GravityY,b,a,"Gy"),this.unAssign(a.GravityZ,b,a,"Gz"),this.unAssign(a.Rate,b,a,"birthRate"),this.unAssign(a.StartVX,b,a,"startVX"),this.unAssign(a.StopVX,b,a,"stopVX");else if(a instanceof h){r=["_x","_y","_z","_h","_p","_b","_xs","_ys","_zs"];for(q in r)this.unAssign(a[r[q]],b,a,r[q].replace("_",""),l),r[q].nrKeys&&(a[r[q].replace("_","")]=a[r[q]].evaluate(0));if(a.morphs)for(q in a.morphs)a.morphs[q]&&this.unAssign(a.morphs[q],b,null,null,!0)}},e.prototype.addSound=function(a,b){return this.audio?(this.sounds[a]=0,void m.fileAsArray(a,null,function(c){this.audio.decodeAudioData(c,function(c){this.sounds[a]=c,b instanceof Function&&b()}.bind(this))}.bind(this))):void b(!1)},e.prototype.pushEvent=function(a,b){return eventObj=new d(b),void 0==this.tracks[a]&&(this.tracks[a]=[]),1==this.tracks[a].length&&this.tracks[a][0].type==e.BLOCK_SS&&this.tracks[a][0].qStop==e.STOP_INT&&this.tracks[a].shift(),this.tracks[a].push(b),b},e.prototype.playSS=function(a,b,c,d,e,f,g){this.playSSFast(a,b,c,d,1,c==d?0:e,f,g)},e.prototype.playSSFast=function(a,b,c,d,f,g,h,i){void 0==d&&(d=c,g=0,h=0,i=0),void 0==g&&(g=0),void 0==h&&(h=0),void 0==i&&(i=0),this.pushEvent(a,{type:e.BLOCK_SS,subscene:b,start:c,stop:d,speed:f,wrap:g,qStart:h,qStop:i})},e.prototype.playFunction=function(a,b){this.pushEvent(a,{type:e.BLOCK_FUNC,func:b})},e.prototype.playWaitTrack=function(a,b){var c=this.pushEvent(a,{type:e.BLOCK_WAIT,locked:!0});this.pushEvent(b,{type:e.BLOCK_WAIT,ref:c})},e.prototype.playPause=function(a,b){this.pushEvent(a,{type:e.BLOCK_PAUSE,time:b})},e.prototype.playSound=function(a,b,c){this.audio&&(void 0==c&&(c=0),this.playFunction(a,function(){if(this.sounds[b]){var a=this.audio.createBufferSource();a.buffer=this.sounds[b],a.connect(this.audio.destination),a.noteOn?a.noteOn(0):a.start&&a.start()}}.bind(this)),c&&this.playPause(a,this.sounds[b].duration))},e.prototype.flushTrack=function(a,b){if(this.tracks[a])if(b)this.tracks[a].splice(0);else for(var c=0;c<this.tracks[a].length;c++)this.tracks[a][c].flush=!0},e.prototype.evaluate=function(a){for(var b,c,d,f=0,g=0,h=0,i=!0;i;){i=!1;for(b in this.tracks)if(c=this.tracks[b],c.length)for(h=a,f=0;!f&&c.length;){switch(f=1,d=c[0],d.type){case e.BLOCK_WAIT:d.ref?(d.ref.locked=!1,c.shift(),f=0,i=!0):d.locked?d.waiting=!0:(c.shift(),f=0);break;case e.BLOCK_FUNC:f=0,i=!0,c.length>1&&(c[1].started=d.started||h),c.shift(),d.func.apply(this);break;case e.BLOCK_PAUSE:void 0==d.started&&(d.started=h),(h-d.started>=d.time||d.flush)&&(c.length>1&&(c[1].started=d.started+d.time),c.shift(),f=0,i=!0);break;case e.BLOCK_SS:switch(void 0==d.started&&(d.started=h),d.wrap){case e.WRAP_PING:g=(h-d.started)*d.speed+d.start,(g>d.stop||d.flush)&&(c.length>1&&(c[1].started=d.started+(d.stop-d.start)/d.speed,f=0,i=!0),g=d.stop,c.shift());break;case e.WRAP_PINGPING:for(g=(h-d.started)*d.speed%(d.stop-d.start)+d.start,(c.length>1&&(c[1].type!=e.BLOCK_WAIT||c[1].locked===!1||c[1].ref&&c[1].ref.waiting)&&(h-d.started)*d.speed>=1*(d.stop-d.start)||d.flush)&&(c[1].started=h-(g-d.start)/d.speed,f=0,i=!0,g=d.stop,c.shift());1==c.length&&(h-d.started)*d.speed>=d.stop-d.start;)d.started+=(d.stop-d.start)/d.speed;break;case e.WRAP_PINGPONG:for(g=Math.abs(((h-d.started)*d.speed+d.stop-d.start)%(2*(d.stop-d.start))-(d.stop-d.start))+d.start,(c.length>1&&(c[1].type!=e.BLOCK_WAIT||c[1].locked===!1||c[1].ref&&c[1].ref.waiting)&&(h-d.started)*d.speed>=2*(d.stop-d.start)||d.flush)&&(c[1].started=h-(g-d.start)/d.speed,f=0,i=!0,g=d.start,c.shift());1==c.length&&(h-d.started)*d.speed>=2*(d.stop-d.start);)d.started+=2*(d.stop-d.start)/d.speed;break;case e.WRAP_PONGPONG:for(g=d.stop-d.start-(h-d.started)*d.speed%(d.stop-d.start)+d.start,(c.length>1&&(c[1].type!=e.BLOCK_WAIT||c[1].locked===!1||c[1].ref&&c[1].ref.waiting)&&(h-d.started)*d.speed>=1*(d.stop-d.start)||d.flush)&&(c[1].started=h-(d.stop-g)/d.speed,f=0,i=!0,g=d.start,c.shift());1==c.length&&(h-d.started)*d.speed>=d.stop-d.start;)d.started+=(d.stop-d.start)/d.speed;break;case e.WRAP_PONG:g=d.stop-(h-d.started)*d.speed,(g<d.start||d.flush)&&(c.length>1&&(c[1].started=h-(d.start-g)/d.speed,f=0,i=!0),g=d.start,c.shift())}this.ssTimes[d.subscene]=g}if(i)break}}},e.prototype.evaluateSplines=function(){var a,b,c,d,e,f,g,h=this.ssTimes;for(a=0;a<this.xsplines.length&&(b=this.xsplines[a]);a++)d=b.ss,e=h[d],e!=this.lastssTimes[d]&&(f=b.target,f&&f.follow&&1==f.followerFlags[8]?(c=f.follow._x.evaluate(e-f.timeslip),f.x!=c&&(f.changed=1,f.x=c)):(c=b.evaluate(e),f.x!=c&&(f.changed=1,f.x=c)));for(a=0;a<this.ysplines.length&&(b=this.ysplines[a]);a++)d=b.ss,e=h[d],e!=this.lastssTimes[d]&&(f=b.target,f&&f.follow&&1==f.followerFlags[7]?(c=f.follow._y.evaluate(e-f.timeslip),f.y!=c&&(f.changed=1,f.y=c)):(c=b.evaluate(e),f.y!=c&&(f.changed=1,f.y=c)));for(a=0;a<this.zsplines.length&&(b=this.zsplines[a]);a++)d=b.ss,e=h[d],e!=this.lastssTimes[d]&&(f=b.target,f&&f.follow&&1==f.followerFlags[6]?(c=f.follow._z.evaluate(e-f.timeslip),f.z!=c&&(f.changed=1,f.z=c)):(c=b.evaluate(e),f.z!=c&&(f.changed=1,f.z=c)));for(a=0;a<this.hsplines.length&&(b=this.hsplines[a]);a++)d=b.ss,e=h[d],e!=this.lastssTimes[d]&&(f=b.target,f&&f.follow&&1==f.followerFlags[5]?(c=f.follow._h.evaluate(e-f.timeslip),f.h!=c&&(f.changed=1,f.h=c)):(c=b.evaluate(e),f.h!=c&&(f.changed=1,f.h=c)));for(a=0;a<this.psplines.length&&(b=this.psplines[a]);a++)d=b.ss,e=h[d],e!=this.lastssTimes[d]&&(f=b.target,f&&f.follow&&1==f.followerFlags[4]?(c=f.follow._p.evaluate(e-f.timeslip),f.p!=c&&(f.changed=1,f.p=c)):(c=b.evaluate(e),f.p!=c&&(f.changed=1,f.p=c)));for(a=0;a<this.bsplines.length&&(b=this.bsplines[a]);a++)d=b.ss,e=h[d],e!=this.lastssTimes[d]&&(f=b.target,f&&f.follow&&1==f.followerFlags[3]?(c=f.follow._b.evaluate(e-f.timeslip),f.b!=c&&(f.changed=1,f.b=c)):(c=b.evaluate(e),f.b!=c&&(f.changed=1,f.b=c)));for(a=0;a<this.xssplines.length&&(b=this.xssplines[a]);a++)d=b.ss,e=h[d],e!=this.lastssTimes[d]&&(f=b.target,f&&f.follow&&1==f.followerFlags[2]?(c=f.follow._xs.evaluate(e-f.timeslip),f.xs!=c&&(f.changed=1,f.xs=c)):(c=b.evaluate(e),f.xs!=c&&(f.changed=1,f.xs=c)));for(a=0;a<this.yssplines.length&&(b=this.yssplines[a]);a++)d=b.ss,e=h[d],e!=this.lastssTimes[d]&&(f=b.target,f&&f.follow&&1==f.followerFlags[1]?(c=f.follow._ys.evaluate(e-f.timeslip),f.ys!=c&&(f.changed=1,f.ys=c)):(c=b.evaluate(e),f.ys!=c&&(f.changed=1,f.ys=c)));for(a=0;a<this.zssplines.length&&(b=this.zssplines[a]);a++)d=b.ss,e=h[d],e!=this.lastssTimes[d]&&(f=b.target,f&&f.follow&&1==f.followerFlags[0]?(c=f.follow._zs.evaluate(e-f.timeslip),f.zs!=c&&(f.changed=1,f.zs=c)):(c=b.evaluate(e),f.zs!=c&&(f.changed=1,f.zs=c)));for(a=0;a<this.splines.length;a++)b=this.splines[a],d=b.ss,e=h[d],e!=this.lastssTimes[d]&&(g=b.cacheValue,c=b.evaluate(e),b.nrKeys&&(b.target&&b.targetvar?c!==g&&(b.target[b.targetvar]=b.format?b.format instanceof Function?b.format(c,e):b.int?Math.round(c):c+b.format:c,void 0==b.ctarget&&(b.ctarget=b.target),b.ctarget.changed=1):b.format&&b.format(c,e)));for(a=0;a<h.length;a++)void 0!=h[a]&&(this.lastssTimes[a]=h[a]);for(a=0;a<this.scene.objects.length;a++)this.scene.objects[a].inst.mouseTracked&&pimRay.mousetrack(this.mousex,this.mousey,this.canvas,this.scene,this.scene.objects[a].inst,null,[0,1,0,0]),this.scene.objects[a].inst.target&&(this.scene.objects[a].inst.lookAt(this.scene.objects[a].inst.target),this.scene.objects[a].inst.b=0);for(a=0;a<this.scene.cameras.length;a++)this.scene.cameras[a].inst.target&&(this.scene.cameras[a].inst.lookAt(this.scene.cameras[a].inst.target),this.scene.cameras[a].inst.b=0)},e.prototype.mapEventFun=function(a,b){return this.eventMap[a]=b,this},e.prototype.raiseEvent=function(a,b){if(void 0==this.eventMap||void 0==this.eventMap[a]){if(void 0==this["on"+a])return!1;this["on"+a].apply(this,b)}else this.eventMap[a].apply(this,b);return!0},e.prototype.RegisterFrameHandler=function(a,b){return this.frameHandlersIDX++,this.frameHandlers[this.frameHandlersIDX]=b.bind(a),this.frameHandlersIDX},e.prototype.UnRegisterFrameHandlerByIndex=function(a){delete this.frameHandlers[a]},window.objcache={},e.prototype.unload=function(){var a,b,c,d;if(this.scene){this.ssTimes=[],this.lastssTimes=[],this.tracks=[],this.splines=[],this.xsplines=[],this.ysplines=[],this.zsplines=[],this.hsplines=[],this.psplines=[],this.bsplines=[],this.xssplines=[],this.yssplines=[],this.zssplines=[],this.nrsplines=0;for(a in objcache){b=objcache[a];for(c in b.attribs)d=b.attribs[c],this.gl.deleteBuffer(d.glBuffer)}this.div&&(this.div.innerHTML='<TABLE WIDTH=100% HEIGHT=100%><TR><TD VALIGN=CENTER ALIGN=CENTER STYLE="color:white"><H2>'+this.name+'</H2><SMALL><SMALL>&copy; 2012/2015 Angle Gaming Labs</SMALL><BR><small id="pim_progress_mb">&nbsp;</small><BR><BR><PROGRESS ID="pim_progress"></PROGRESS></TABLE>',this.div.style["-webkit-transition"]="visibility 0s linear 0.5s,opacity 0.5s linear",this.div.style.opacity="1",this.div.style.visibility="visible"),objcache={},delete this.scene}},e.prototype.createLoader=function(){function a(a){for(var b=0,c=0;null!=a;b+=a.offsetLeft,c+=a.offsetTop,a=a.offsetParent);return{x:b,y:c}}if(this.showLoader){if(void 0==this.div)this.div=document.createElement("div"),this.div2=document.createElement("div"),o.merge(this.div2.style,{position:"absolute",pointerEvents:"none",width:"0px",height:"0px",top:a(this.canvas).y+window.pageYOffset,left:a(this.canvas).x+window.pageXOffset}),o.merge(this.div.style,{position:"relative",width:getComputedStyle(this.canvas).width,height:getComputedStyle(this.canvas).height,backgroundColor:this.loaderBackgroundColor,color:this.loaderColor,zIndex:"10",opacity:1}),this.loaderImage&&(this.div.style.backgroundImage='url("'+this.loaderImage+'")'),this.div.style["-webkit-transition"]="visibility 0s linear 0.5s,opacity 0.5s linear",this.div.innerHTML='<TABLE WIDTH=100% HEIGHT=100%><TR><TD VALIGN=CENTER ALIGN=CENTER STYLE="color:'+this.loaderColor+'"><H2>'+this.name+'</H2><SMALL>&copy; 2012/2015 Angle Gaming Labs</SMALL><BR><small id="pim_progress_mb">&nbsp;</small><BR><BR><PROGRESS ID="pim_progress"></PROGRESS></TABLE>',this.div2.appendChild(this.div),document.body.insertBefore(this.div2,document.body.firstChild),this.mb=document.getElementById("pim_progress_mb"),this.pr=document.getElementById("pim_progress"),this.mb.id=this.mb.id+"_"+Math.random(),this.pr.id=this.pr.id+"_"+Math.random();else{var b=this.div.style;b.opacity=1,b.visibility="visible",b.display=this.showLoader?"inline-block":"none",b.width=getComputedStyle(this.canvas).width,b.height=getComputedStyle(this.canvas).height,o.merge(this.div2.style,{top:a(this.canvas).y+window.pageYOffset,left:a(this.canvas).x+window.pageXOffset}),this.div.style["-webkit-transition"]="visibility 0s linear 0.5s,opacity 0.5s linear"}this.mb.innerHTML=".. please wait .."}},e.prototype.getWebGL=function(){if(this.fragmentShaderSource&&(fragmentShaderSource=this.fragmentShaderSource),void 0==this.alpha&&(this.apha=!1),void 0==this.antialias&&(this.antialias=!1),void 0==this.gl){if(this.gl=0,this.gl=this.canvas.getContext("webgl",{alpha:this.alpha,antialias:this.antialias,preserveDrawingBuffer:!0}),this.gl||(this.gl=this.canvas.getContext("experimental-webgl",{alpha:this.alpha,antialias:this.antialias,preserveDrawingBuffer:!0})),parseInt(getComputedStyle(this.canvas).width)?(this.canvas.width=parseInt(getComputedStyle(this.canvas).width),this.canvas.height=parseInt(getComputedStyle(this.canvas).height)):(this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight),!this.gl)return this.running=!1,void window.console.error("WebGL not found. Visit get.webgl.org.");this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clearColor(0,0,0,0),this.gl.enable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.CULL_FACE),this.gl.depthFunc(this.gl.LEQUAL),this.gl.frontFace(this.gl.CCW),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}void 0==this.depthTextureExt&&(this.depthTextureExt=this.gl.getExtension("WEBKIT_WEBGL_depth_texture")),void 0==this.intindex&&(this.intIndex=this.gl.getExtension("OES_element_index_uint"))},e.prototype.purge=function(){var a;for(a in pimLWO2.cache)pimLWO2.cache[a]=null;for(a in pimLWO2.foldCache)pimLWO2.foldCache[a]=null;this.scene.objects.forEach(function(a){a.bones&&a.bones.forEach(function(a){a.inst.swm=1})}),this.scene.objects.forEach(function(a){a.obj&&(a.obj.vmaps=null)})},e.prototype.addResizeHandler=function(){window.addEventListener("resize",function(){this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight,this.scene.width=this.canvas.offsetWidth,this.scene.height=this.canvas.offsetHeight,this.scene.cameras[0]&&(this.scene.cameras[0].inst.changed=1)}.bind(this),!1),this.scene.width=this.canvas.offsetWidth,this.scene.height=this.canvas.offsetHeight},e.prototype.addOrientationHandler=function(){window.addEventListener("deviceorientation",function(a){this.alpha=a.alpha/180*Math.PI,this.gamma=a.gamma/180*Math.PI,this.beta=a.beta/180*Math.PI}.bind(this))},e.prototype.addKeyboardHandlers=function(){this.keymap=Array(256),window.addEventListener("keydown",function(a){this.keymap[a.keyCode]=a.timeStamp}.bind(this),!1),window.addEventListener("keyup",function(a){this.keymap[a.keyCode]=0,a.ctrlKey||(this.keymap[17]=0),a.altKey||(this.keymap[18]=0),a.shiftKey||(this.keymap[16]=0)}.bind(this),!1)},e.prototype.addDragDropHandlers=function(){this.canvas.addEventListener("dragover",function(a){this.mousex=a.offsetX||a.layerX-a.currentTarget.offsetLeft,this.mousey=a.offsetY||a.layerY-a.currentTarget.offsetTop,(this.onMouse||this.eventMap.Mouse)&&(pimRay.intersect_vp(a.layerX,a.layerY,this.canvas,this.scene),this.raiseEvent("Mouse",["drag",pimRay.lastInst,pimRay.lastSurface])?(a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="link"):(a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="none"))}.bind(this),!1),this.canvas.addEventListener("drop",function(a){a.stopPropagation(),a.preventDefault(),this.raiseEvent("Mouse",["drop",pimRay.lastInst,pimRay.lastSurface,a.dataTransfer.files])}.bind(this),!1)},e.prototype.makeActive=function(a,b,c){this.running&&(this.last!=a||this.lastS!=b||a&&a.polyTrace)&&(this.raiseEvent("Mouse",["mouseoff",this.last&&this.last.inst||null,this.lastS,c]),this.raiseEvent("Mouse",["mouseon",a&&a.inst||null,b,c]),this.last=a,this.lastS=b)},e.prototype.addMouseHandlers=function(){this.dragging={},this.lastZoomDist=0,this.swipestarted=!1,this.canvas.addEventListener("touchstart",function(a){var b,c,d,e;this.swipestarted=!0,this.swipex=a.touches[0].clientX,this.swipey=a.touches[0].clientY,this.running&&1==a.touches.length&&(pimRay.intersect_vp(this.swipex,this.swipey,this.canvas,this.scene),this.makeActive(pimRay.lastObj,pimRay.lastSurface,a),this.raiseEvent("Mouse",["swipe",null,null,a])),2==a.touches.length&&(b=a.touches[0].clientX,c=a.touches[1].clientX,d=a.touches[0].clientY,e=a.touches[1].clientY,this.lastZoomDist=Math.sqrt(Math.pow(c-b,2)+Math.pow(e-d,2))),a.preventDefault()}.bind(this),!1),this.canvas.addEventListener("touchmove",function(a){var b,c,d,e,f,g,h;return a.preventDefault(),2==a.touches.length?(b=a.touches[0].clientX,c=a.touches[1].clientX,d=a.touches[0].clientY,e=a.touches[1].clientY,f=Math.sqrt(Math.pow(c-b,2)+Math.pow(e-d,2)),void(f!=this.lastZoomDist&&(this.raiseEvent("Mouse",["zoom",f-this.lastZoomDist]),this.lastZoomDist=f))):(this.swipestarted=!1,g=a.changedTouches[0].clientX-this.swipex,h=a.changedTouches[0].clientY-this.swipey,this.swipedx=a.changedTouches[0].clientX-this.swipex,this.swipedy=a.changedTouches[0].clientY-this.swipey,this.swipex=a.changedTouches[0].clientX,this.swipey=a.changedTouches[0].clientY,void(Math.abs(h)>Math.abs(g)?0>h?this.raiseEvent("Mouse",["swipeup",null]):this.raiseEvent("Mouse",["swipedown",null]):0>g?this.raiseEvent("Mouse",["swipeleft",null]):this.raiseEvent("Mouse",["swiperight",null])))}.bind(this),!1);var a=0;this.canvas.addEventListener("mousewheel",function(a){a.stopPropagation(),a.preventDefault(),(this.onMouse||this.eventMap.Mouse)&&this.raiseEvent("Mouse",["wheel",Math.max(-1,Math.min(1,a.wheelDelta||-a.detail))])}.bind(this),!1),this.canvas.onmousedown=function(b){return a=2,this.mousex=b.offsetX||b.layerX,this.mousey=b.offsetY||b.layerY,this.mousemx=0,this.mousemy=0,this.running&&(this.onMouse||this.eventMap.Mouse)&&(pimRay.intersect_vp(b.offsetX||b.layerX,b.offsetY||b.layerY,this.canvas,this.scene),this.makeActive(pimRay.lastObj,pimRay.lastSurface,b),this.raiseEvent("Mouse",[["lb_down","mb_down","rb_down"][b.button],pimRay.lastInst,pimRay.lastSurface,b])),this.dragging.status||(this.dragging.x=this.mousex,this.dragging.y=this.mousey,this.dragging.inst=pimRay.lastInst,this.dragging.surf=pimRay.lastSurface,this.dragging.button=2==b.button?"rb":"lb",this.dragging.start=(new Date).getTime()),pimRay.lastInst||!this.alpha?(b.preventDefault(),b.stopPropagation(),!1):void 0}.bind(this),this.canvas.oncontextmenu=function(a){return a.preventDefault(),!1},this.canvas.onmouseup=function(b){return a=2,this.running&&(this.onMouse||this.eventMap.Mouse)&&(pimRay.intersect_vp(b.offsetX||b.layerX,b.offsetY||b.layerY,this.canvas,this.scene),this.makeActive(pimRay.lastObj,pimRay.lastSurface,b),this.raiseEvent("Mouse",[["lb_up","mb_up","rb_up"][b.button],pimRay.lastInst,pimRay.lastSurface,b])),this.dragging.status=!1,this.dragging.button="",pimRay.lastInst?(b.preventDefault(),!1):void 0}.bind(this),this.canvas.onmouseout=function(a){this.running&&(this.onMouse||this.eventMap.Mouse)&&this.raiseEvent("Mouse",[2==a.button?"rb_up":1==a.button?"lb_up":"mouseoff",pimRay.lastInst,pimRay.lastSurface,a])}.bind(this),this.onmousemove=function(b){var c,d,f;this.running&&(c=b,d=c.movementX||c.webkitMovementX||c.mozMovementX||c.msMovementX||c.oMovementX||0,f=c.movementY||c.webkitMovementY||c.mozMovementY||c.msMovementY||c.oMovementY||0,void 0==c.movementX&&void 0==c.webkitMovementX&&void 0==c.mozMovementX&&void 0==c.msMovementX&&void 0==c.oMovementX&&(void 0==this.lastScreenX&&(this.lastScreenX=c.screenX,this.lastScreenY=c.screenY),d=c.screenX-this.lastScreenX,f=c.screenY-this.lastScreenY,this.lastScreenX=c.screenX,this.lastScreenY=c.screenY),!a&&50>d&&50>f&&(this.mousemx=d,this.mousemy=f),a&&a--,this.mousex=b.offsetX||b.layerX,this.mousey=b.offsetY||b.layerY,pimOptions.noOvers||(this.onMouse||this.eventMap.Mouse)&&(pimRay.intersect_vp(this.mousex,this.mousey,this.canvas,this.scene),this.makeActive(pimRay.lastObj,pimRay.lastSurface,b)),!this.dragging.status&&""!=this.dragging.button&&(new Date).getTime()-this.dragging.start>e.DRAGGING_DELAY&&(Math.abs(this.dragging.x-this.mousex)>e.DRAGGING_THRESHOLD||Math.abs(this.dragging.y-this.mousey)>e.DRAGGING_THRESHOLD)&&(this.raiseEvent("Mouse",[this.dragging.button+"_drag",this.dragging.inst,this.dragging.surf]),this.dragging.status=!0))}.bind(this),this.canvas.addEventListener("mousemove",this.onmousemove,!0)},e.prototype.stereo=function(a,b,c){var d,e,f,g,h,j,k,l,m,n;return void 0==b&&(b=.05),void 0==c&&(c=100),(0!==a&&3!=this.scene.cameras.length||(this.scene.cameras=[this.scene.cameras[0]],this.scene.filters=[],this.scene.cameras[0].inst.visible=!0,0!=a))&&(this.scene.cameras[0].inst.visible=!1,this.scene.offscreen_buffer=void 0,d=this.scene.cameras[0],d.width=this.canvas.width,d.height=this.canvas.height,e=this.scene.addCamera(),f=this.scene.addCamera(),e.width=d.width/2,e.height=d.height,f.width=d.width/2,f.height=d.height,e.clear=f.clear=1,e.aspect=f.aspect=.5,e.inst.parent=f.inst.parent=d.inst,e.vFov=f.vFov=c,e.inst.x=-b,f.inst.x=b,o.merge(e,{overlayWidth:50,overlayHeight:100,overlayLeft:0,overlayTop:0}),o.merge(f,{overlayWidth:50,overlayHeight:100,overlayLeft:50,overlayTop:0}),window.addEventListener("resize",function(){this.scene.filters.length&&(this.scene.filters[0].ctx=void 0),this.scene.cameras[0].width=this.canvas.width,this.scene.cameras[0].height=this.canvas.height
}.bind(this)),1!==a)?2==a?(o.merge(e,{overlayWidth:100,overlayHeight:50,overlayLeft:0,overlayTop:0}),o.merge(f,{overlayWidth:100,overlayHeight:50,overlayLeft:0,overlayTop:50}),g=this,void g.scene.filters.push({apply:function(a){var b,c;void 0==this.ctx&&(this.ctx=pimStream.quad([-1,-1,0],[1,1,0]),this.ctx.surfaces[0].doublesided=!0,this.ctx.surfaces[0].channels=[{enabled:!0,type:"COLR",opacity:0,texunit:0,map:{tex:a.colorTexture}}],this.ctx.surfaces[0].fragmentShaderSource="precision highp float;\nuniform sampler2D pim_texture0;\nvarying vec2 texcoord0;\nvoid main() {\n  vec2 tc=texcoord0;\n  if (mod(floor(gl_FragCoord.y), 2.0)==0.0) gl_FragColor = texture2D(pim_texture0, vec2(tc.x,tc.y/2.0));\n                                       else gl_FragColor = texture2D(pim_texture0, vec2(tc.x,tc.y/2.0+0.5));\n}",i.prototype.driverLoad.call({obj:this.ctx,bones:[]},a.gl,void 0,{lights:[]})),b=a.gl,c=mat4.identity(),b.viewport(0,0,g.canvas.width,g.canvas.height),b.scissor(0,0,g.canvas.width,g.canvas.height),i.prototype.driverRenderSurface.call({inst:{selected:0,evaluateMatrix:function(a){return a}.bind(this,c)},obj:this.ctx,loaded:1,camPos:[0,0,0]},b,c,c,[],this.ctx,this.ctx.surfaces[0],0,!1)}})):3==a?(g=this,void g.scene.filters.push({apply:function(a){var b,c;void 0==this.ctx&&(this.ctx=pimStream.quad([-1,-1,0],[1,1,0]),this.ctx.surfaces[0].doublesided=!0,this.ctx.surfaces[0].channels=[{enabled:!0,type:"COLR",opacity:0,texunit:0,map:{tex:a.colorTexture}}],this.ctx.surfaces[0].fragmentShaderSource="precision highp float;\nuniform sampler2D pim_texture0;\nvarying vec2 texcoord0;\nvoid main() {\n  vec2 tc=texcoord0;\n  gl_FragColor = texture2D(pim_texture0, vec2(tc.x/2.0,tc.y));\n  gl_FragColor.r = texture2D(pim_texture0, vec2(tc.x/2.0+0.5,tc.y)).r;\n  gl_FragColor.a=1.0;\n}",i.prototype.driverLoad.call({obj:this.ctx,bones:[]},a.gl,void 0,{lights:[]})),b=a.gl,c=mat4.identity(),b.viewport(0,0,g.canvas.width,g.canvas.height),b.scissor(0,0,g.canvas.width,g.canvas.height),i.prototype.driverRenderSurface.call({inst:{selected:0,evaluateMatrix:function(a){return a}.bind(this,c)},obj:this.ctx,loaded:1,camPos:[0,0,0]},b,c,c,[],this.ctx,this.ctx.surfaces[0],0,!1)}})):a>=4?(g=this,h={hResolution:parseInt(g.canvas.width),vResolution:parseInt(g.canvas.height),hScreenSize:.14976,vScreenSize:.12,interpupillaryDistance:.064,lensSeparationDistance:.064,eyeToScreenDistance:.041,distortionK:[1,.22,.24,0],chromaAbParameter:[.996,-.004,1.014,0]},b instanceof Object&&o.merge(h,b),j=h.hResolution/(2*h.vResolution),k=-1-4*(h.hScreenSize/4-h.lensSeparationDistance/2)/h.hScreenSize,l=h.distortionK[0]+h.distortionK[1]*Math.pow(k,2)+h.distortionK[2]*Math.pow(k,4)+h.distortionK[3]*Math.pow(k,6),c=180/Math.PI*2.25*Math.atan2(h.vScreenSize*l,2*h.eyeToScreenDistance),m=4*(h.hScreenSize/4-h.interpupillaryDistance/2)/h.hScreenSize,n=g.lensShift||4*(h.hScreenSize/4-h.lensSeparationDistance/2)/h.hScreenSize,e.vFov=f.vFov=c,4==a?(e.inst.x=-h.interpupillaryDistance/2,f.inst.x=h.interpupillaryDistance/2,e.pOffset=[m,0,0],f.pOffset=[-m,0,0]):e.inst.x=f.inst.x=0,void g.scene.filters.push({apply:function(a){var b,c;void 0==this.ctx&&(this.ctx=pimStream.quad([-1,-1,0],[0,1,0]),this.ctx.surfaces[0].doublesided=!0,this.ctx.surfaces[0].pimShaderExt={pim_lensShift:n},this.ctx.surfaces[0].channels=[{enabled:!0,type:"COLR",opacity:0,texunit:0,map:{tex:a.colorTexture}}],this.ctx.surfaces[0].fragmentShaderSource=["precision highp float;\nuniform sampler2D pim_texture0;\nuniform float pim_lensShift;\nvarying vec2 texcoord0;\nvoid main() {\n  vec2 uv = (texcoord0*2.0)-1.0;","  vec2 theta = (uv-vec2(pim_lensShift,0.0))*vec2(1.0,"+1/j+");","  float rSq = theta.x*theta.x + theta.y*theta.y;","  vec2 rvector = theta*("+h.distortionK[0].toFixed(2)+" + "+h.distortionK[1]+"*rSq + "+h.distortionK[2]+"*rSq*rSq);","  vec2 rBlue = rvector * ("+h.chromaAbParameter[2]+" + "+h.chromaAbParameter[3].toFixed(1)+" * rSq);","  vec2 tcBlue = (vec2(pim_lensShift,0.0) + vec2("+1/l+","+1*j/l+") * rBlue);","  tcBlue = (tcBlue+1.0)/2.0;","  vec2 tcGreen = vec2(pim_lensShift,0.0) + vec2("+1/l+","+1*j/l+") * rvector;","  tcGreen = (tcGreen+1.0)/2.0;","  vec2 rRed = rvector * ("+h.chromaAbParameter[0]+" + "+h.chromaAbParameter[1]+" * rSq);","  vec2 tcRed = vec2(pim_lensShift,0.0) + vec2("+1/l+","+1*j/l+") * rRed;","  tcRed = (tcRed+1.0)/2.0;\n  gl_FragColor = vec4(texture2D(pim_texture0, clamp(tcRed*vec2(0.5,1.0),vec2(0.0,0.0),vec2(0.49999,1.0))).r, texture2D(pim_texture0, clamp(tcGreen*vec2(0.5,1.0),vec2(0.0,0.0),vec2(0.49999,1.0))).g, texture2D(pim_texture0, clamp(tcBlue*vec2(0.5,1.0),vec2(0.0,0.0),vec2(0.49999,1.0))).b, 1);\n}"].join("\n"),this.ctx2=pimStream.quad([0,-1,0],[1,1,0]),this.ctx2.surfaces[0].doublesided=!0,this.ctx2.surfaces[0].channels=[{enabled:!0,type:"COLR",opacity:0,texunit:0,map:{tex:a.colorTexture}}],this.ctx2.surfaces[0].pimShaderExt={pim_lensShift:n},this.ctx2.surfaces[0].fragmentShaderSource=["precision highp float;\nuniform sampler2D pim_texture0;\nuniform float pim_lensShift;\nvarying vec2 texcoord0;\nvoid main() {\n  vec2 uv = (texcoord0*2.0)-1.0;","  vec2 theta = (uv-vec2(pim_lensShift,0.0))*vec2(1.0,"+1/j+");","  float rSq = theta.x*theta.x + theta.y*theta.y;","  vec2 rvector = theta*("+h.distortionK[0].toFixed(2)+" + "+h.distortionK[1]+"*rSq + "+h.distortionK[2]+"*rSq*rSq);","  vec2 rBlue = rvector * ("+h.chromaAbParameter[2]+" + "+h.chromaAbParameter[3].toFixed(1)+" * rSq);","  vec2 tcBlue = (vec2(pim_lensShift,0.0) + vec2("+1/l+","+1*j/l+") * rBlue);","  tcBlue = (tcBlue+1.0)/2.0;","  vec2 tcGreen = vec2(pim_lensShift,0.0) + vec2("+1/l+","+1*j/l+") * rvector;","  tcGreen = (tcGreen+1.0)/2.0;","  vec2 rRed = rvector * ("+h.chromaAbParameter[0]+" + "+h.chromaAbParameter[1]+" * rSq);","  vec2 tcRed = vec2(pim_lensShift,0.0) + vec2("+1/l+","+1*j/l+") * rRed;","  tcRed = (tcRed+1.0)/2.0;\n  gl_FragColor = vec4(texture2D(pim_texture0, clamp(tcRed*vec2(0.5,1.0)+vec2(0.5,0.0),vec2(0.5,0.0),vec2(1.0,1.0))).r, texture2D(pim_texture0, clamp(tcGreen*vec2(0.5,1.0)+vec2(0.5,0.0),vec2(0.5,0.0),vec2(1.0,1.0))).g, texture2D(pim_texture0, clamp(tcBlue*vec2(0.5,1.0)+vec2(0.5,0.0),vec2(0.5,0.0),vec2(1.0,1.0))).b, 1);\n}"].join("\n"),i.prototype.driverLoad.call({obj:this.ctx,bones:[]},a.gl,void 0,{lights:[]}),i.prototype.driverLoad.call({obj:this.ctx2,bones:[]},a.gl,void 0,{lights:[]})),b=a.gl,c=mat4.identity(),b.viewport(0,0,g.canvas.width,g.canvas.height),b.scissor(0,0,g.canvas.width,g.canvas.height),i.prototype.driverRenderSurface.call({inst:{selected:0,evaluateMatrix:function(a){return a}.bind(this,c)},obj:this.ctx,loaded:1,camPos:[0,0,0]},b,c,c,[],this.ctx,this.ctx.surfaces[0],0,!1),i.prototype.driverRenderSurface.call({inst:{selected:0,evaluateMatrix:function(a){return a}.bind(this,c)},obj:this.ctx2,loaded:1,camPos:[0,0,0]},b,c,c,[],this.ctx2,this.ctx2.surfaces[0],0,!1)}})):void 0:void 0},c.pimDirector=e},{"./pim_gui":5,"./pim_instance":6,"./pim_lws":8,"./pim_object":12,"./pim_scene":16,"./pim_spline":18,"./pim_utils":21}],4:[function(a,b,c){function d(a,b){function c(a){return{left:1*a[0],right:1*a[1],top:1*a[2],bottom:1*a[3]}}function d(a){return{x:1*a[0],y:1*a[1],w:1*a[2],h:1*a[3],a:1*a[4],b:1*a[5],c:1*a[6]}}var e={};return pimUtils.fileAsArray(a,function(){},function(a){var f,g,h,i,j,k,l=new Uint8Array(a),m="";for(f=0;f<l.length;f++)m+=String.fromCharCode(l[f]);for(g=m.replace(/\r/g,"").split("\n"),h=0;h<g.length;h++)if(i=g[h],i.match(/^\[/))switch(j=i.match(/^\[(.*?)\]/)[1]){case"Margins":e.Margins=c(g[++h].match(/\d+/g));break;case"Metrics":for(e.Metrics=[];g[h+1];)e.Metrics.push(d(g[++h].match(/\d+/g)));break;default:e[j]=g[++h]}k=new countingCompleter,e.Color.replace(/\r/g,"")&&(e.colorImage=pimUtils.loadImage(e.Color,function(){},k.link())),e.alphaImage=e.Alpha.replace(/\r/g,"")?pimUtils.loadImage(e.Alpha,function(){},k.link()):e.colorImage,b&&k.wait(function(){b(e)})}),e}function e(a,b){i.push(null);var c=i.length-1;d(a,function(a){a.Height=+a.Height,a.ActualHeight=+a.ActualHeight,a.Width=+a.Width,a.Weight=+a.Weight,a.Ital=+a.Ital,a.Version=+a.Version,void 0==a.LineSpacing&&(a.LineSpacing=0),a.LineSpacing=+a.LineSpacing,void 0==a.AverageCharacterAspectRatio&&(a.AverageCharacterAspectRatio=.75),a.AverageCharacterAspectRatio=+a.AverageCharacterAspectRatio,i[c]=a,b(a)})}function f(a,b,c,d,e){var g,h,j;if(0==i.length)return null;for(a&&(a=a.replace(/\r/g,"")),b&&(b=+b),c&&(b=+c),d&&(d=+d),e&&(e=+e),g=-1,h=-1,j=0;j<i.length;j++)if(!(a&&i[j].Name.toLowerCase()!=a.toLowerCase()||(0>g?g=j:void 0!=b&&Math.abs(i[j].Height-b)<Math.abs(i[g].Height-b)&&(g=j),void 0!=b&&i[j].Height!=b||void 0!=e&&i[j].Ital!=e||void 0!=d&&i[j].Weight!=d||void 0!=c&&i[j].Width!=c))){h=j;break}return-1==h&&-1==g?"Arial"!=a?f("Arial",b,c,d,e):f("",b,c,d,e):h>=0?i[h]:g>=0?i[g]:null}function g(a,b,c,d,e,f){var g=[],h=[],i=[];return h[0]=(b[0]-a[0])*e+a[0],h[1]=(b[1]-a[1])*e+a[1],h[2]=(b[2]-a[2])*e+a[2],i[0]=(d[0]-c[0])*e+c[0],i[1]=(d[1]-c[1])*e+c[1],i[2]=(d[2]-c[2])*e+c[2],g[0]=(i[0]-h[0])*f+h[0],g[1]=(i[1]-h[1])*f+h[1],g[2]=(i[2]-h[2])*f+h[2],g}function h(){return this.squeezeRatio=1,this.linespace=0,this.fc=null,this.oli=null,this.layer=null,this.osp=null,this.dchannel=null,this.lines=0,this.cols=0,this.maxchars=0,this.halign=0,this.txt="",this.quad_vi=Array(4),this.width=1,this.height=0,this.basequad=[[0,0,0],[0,0,0],[0,0,0],[0,0,0]],this}var i=[],j=0,k=1,l=2;h.prototype.setup_text_mesh=function(){var a,b,c,d,e,f,g,h,i=this.osp,j=this.fc,k=this.oli,l=this.obj,m=this.quad_vi;if(i.channels.splice(0),j.colorImage&&i.channels.push({type:"COLR",enabled:!0,texunit:0,opacity:8,map:j.colorImage}),j.alphaImage&&i.channels.push({type:"TRAN",enabled:!0,texunit:0,negative:!0,opacity:0,map:j.alphaImage}),i.transparency=Math.max(i.transparency,.001),i.noZ=1,k.hasTransparency=1,a=new Uint16Array(l.attribs[pimStream.pim_triangle]),b=new Float32Array(l.attribs[pimStream.pim_texcoord0]),0==b.length&&(l.attribs[pimStream.pim_texcoord0]=new ArrayBuffer(l.attribs[pimStream.pim_position]),b=new Float32Array(l.attribs[pimStream.pim_texcoord0])),b.name="pim_texcoord0",c=new Float32Array(l.attribs[pimStream.pim_position]),c.name="pim_position",l.attribs[pimStream.pim_normal]||l.calculateSmoothNormals(),!a||!b||!c)return!1;if(d=i.start,e=i.count/2,!(e<this.maxchars))throw"tbc";for(this.quad_vi=m=[],f=0;5>=f;f++)-1==m.indexOf(a[3*d+f])&&m.push(a[3*d+f]);for(this.vc=[c[3*m[1]],c[3*m[1]+1],c[3*m[1]+2]],this.va=[c[3*m[0]],c[3*m[0]+1],c[3*m[0]+2]],this.vb=[c[3*m[3]],c[3*m[3]+1],c[3*m[3]+2]],this.vd=[c[3*m[2]],c[3*m[2]+1],c[3*m[2]+2]],g=[],l.surfaces.forEach(function(a){a.fmcount&&(a.fmcountrestore=a.count,a.count=a.fmcount)}),pimStream.begin(l,4),pimStream.attrib(pimStream.pim_tag_polygon,i.tag),f=1;f<this.maxchars;f++){for(h=0;3>=h;h++)g[3-h]=pimStream.duplicateVertex(m[h],[0,1,40]);pimStream.nGon(g)}for(pimStream.end(),l.surfaces.forEach(function(a){a.fmcount&&(a.count=a.fmcountrestore)}),a=new Uint16Array(l.attribs[pimStream.pim_triangle]),c=new Float32Array(l.attribs[pimStream.pim_position]),b=new Float32Array(l.attribs[pimStream.pim_texcoord0]),i.fmcount=i.count,d=i.start,m=[],f=0;5>=f;f++)-1==m.indexOf(a[3*d+f])&&m.push(a[3*d+f]);return a[3*d+0]=m[3],a[3*d+1]=m[2],a[3*d+2]=m[1],a[3*d+3]=m[3],a[3*d+4]=m[1],a[3*d+5]=m[0],this.Rescale(),!0},h.prototype.render_textmesh=function(){var a,b,c,d,e,f,h,i,m,n,o,p,q,r,s,t,u=[[1,0],[1,1],[0,1],[0,0]],v=[[1,0],[1,1],[0,1],[0,0]],w=1*(this.fc.actualcellheight||this.fc.ActualHeight),x=this.obj,y=this.osp,z=this.maxchars,A=this.txt,B=this.quad_vi,C=this.width,D=new Uint16Array(x.attribs[pimStream.pim_triangle]),E=new Float32Array(x.attribs[pimStream.pim_texcoord0]),F=new Float32Array(x.attribs[pimStream.pim_position]),G={};if(!D||!E||!F)return!1;for(a=y.start/2,b=0,c=1,d=-1,e=1e8,f=-1,h=0;z>h;h++){for(;c<=A.length&&("\r"==A[c-1]||"\n"==A[c-1]);)(1e8==e||-1==d)&&d++,e=1e8,c++;if(c>A.length)break;if(f=h,this.fc.fontcharset=this.fc.CharSet,this.fc.entries=this.fc.Metrics,this.fc.margin=this.fc.Margins,i=this.fc.fontcharset.indexOf(A[c-1]),c++,G=i>=0?this.fc.entries[i]:{x:0,y:0,w:Math.floor(w/2),a:0,b:Math.floor(w/2),c:0,invalid:!0},d<this.lines-1&&" "==A[c-2]){for(m=G.a+G.b+G.c,n=0;c+n<=A.length&&"\r"!=A[c+n-1]&&"\n"!=A[c+n-1]&&" "!=A[c+n-1]&&(o={},i=this.fc.fontcharset.indexOf(A[c-1+n]),i>=0?o=this.fc.entries[i]:(o.x=0,o.y=0,o.w=Math.floor(w/2),o.a=0,o.b=o.w,o.c=0),m=m+o.a+o.b+o.c,!(e+m>C));)n++;e+m>C&&(e=1e8)}if(e+=G.a,e+G.b+G.c>C){if(m=C,e=b,this.halign!=j){for(m=G.a+G.b+G.c,p=0,n=0;c+n<=A.length&&"\r"!=A[c+n-1]&&"\n"!=A[c+n-1]&&(o={},i=this.fc.fontcharset.indexOf(A[c-1+n]),i>=0?o=this.fc.entries[i]:(o.x=0,o.y=0,o.w=Math.floor(w/2),o.a=0,o.b=o.w,o.c=0)," "==A[c+n-1]&&(p=m),m=m+o.a+o.b+o.c,!(m>C));)n++;C>m&&(p=m),p>0&&(this.halign==k&&(e=Math.floor((C-p)/2)),this.halign==l&&(e=C-p-1))}d++}for(q=0;3>=q;q++)t=D[6*(a+h)+1*[0,1,2,5][q]],G.invalid||d>=this.lines?(E[2*t+0]=0,E[2*t+1]=0,F[3*t+0]=F[3*B[q]+0],F[3*t+1]=F[3*B[q]+1],F[3*t+2]=F[3*B[q]+2]):(r=g(this.va,this.vb,this.vc,this.vd,(d*w+this.linespace*w-this.fc.margin.top+u[q][0]*(w*(1-this.linespace)+this.fc.margin.top+this.fc.margin.bottom))/(this.lines*w),1-(e-G.a-this.fc.margin.left+u[q][1]*(G.w+this.fc.margin.left+this.fc.margin.right))/C),E[2*t+0]=(G.x-this.fc.margin.left+v[q][1]*(G.w+this.fc.margin.left+this.fc.margin.right))/this.fc.colorImage.width,E[2*t+1]=(G.y-this.fc.margin.top+v[q][0]*(w+this.fc.margin.top+this.fc.margin.bottom))/this.fc.colorImage.height,F[3*t+0]=r[0],F[3*t+1]=r[1],F[3*t+2]=r[2]);e=e+G.b+G.c}for(h=f+1;z>h;h++)for(s=0,q=0;3>=q;q++)t=D[6*(a+h)+1*[0,1,2,5][q]],E[2*t+0]=0,E[2*t+1]=0,F[3*t+0]=[s,s,-s,-s][q],F[3*t+1]=[-s,s,-s,s][q],F[3*t+2]=[0,0,0,0][q];this.oli.bbox=this.obj.calculateBoundingBox(),this.obj.attribs[0].glBuffer=0,this.obj.attribs[40].glBuffer=0,this.obj.loaded=0,this.osp.count=2*(f+1),this.oli.inst.changed=1},h.prototype.Rescale=function(){var a,b=this.fc,c=this.oli;return b.actualcellheight=b.ActualHeight,this.cols>0?(this.height=this.lines*b.actualcellheight,this.sw=1/(1-this.linespace),this.width=Math.floor(this.sw*this.cols*b.actualcellheight*.7),!1):(a=c.inst.evaluateMatrix(),this.vheight=vec3.length(vec3.subtract(mat4.multiplyVec4(a,vec4.create([this.va[0],this.va[1],this.va[2],1])),mat4.multiplyVec4(a,vec4.create([this.vb[0],this.vb[1],this.vb[2],1])))),this.vwidth=vec3.length(vec3.subtract(mat4.multiplyVec4(a,vec4.create([this.vb[0],this.vb[1],this.vb[2],1])),mat4.multiplyVec4(a,vec4.create([this.vc[0],this.vc[1],this.vc[2],1])))),this.height=this.lines*b.actualcellheight,this.width=Math.floor(this.vwidth*this.height/this.vheight/this.squeezeRatio),0==this.width&&(this.width=10*this.height),void this.render_textmesh())},h.prototype.Start=function(a,b,c,d,e,f){return this.oli=b,this.osp=c,this.obj=b.obj,this.lines=d,this.cols=e,this.maxchars=f,this.fc=a,this.setup_text_mesh(),this.txt="",this.render_textmesh(),this},h.prototype.SetText=function(a){return a=void 0==a?"undefined":""+a,a==this.txt?this:(this.txt=a,this.render_textmesh(),this)},h.prototype.SetTextS=function(a){return a==this.txt?this:(this.txt=a,this)},h.prototype.SetRC=function(a,b){return this.lines=a,this.cols=b,this.Rescale(),this},h.prototype.SetSqueezeRatio=function(a){return this.squeezeRatio=a,this},h.prototype.SetAlign=function(a){return this.halign=a,this},h.prototype.SetLineSpace=function(a){return this.linespace=a,this},h.prototype.SetFontClip=function(a){return this.fc=a,this},h.prototype.GetProps=function(){return JSON.stringify(this)},h.prototype.GetText=function(){return this.txt},c.pimFonts={loadFont:e,findFont:f},c.pimFontMesh=h},{}],5:[function(a,b,c){function d(a,b,c){var d,e;if(!a)return a;for(d in b)a[d]=b[d];if(c)for(e in c)a.style[e]=c[e];return a}function e(a,b){return d(document.createElement("div"),{className:"pimButton",innerHTML:a,onclick:b,onmousedown:function(a){a.stopPropagation()}})}function f(a,b){return d(document.createElement("div"),{className:"pimLabel",innerHTML:a,onclick:b})}function g(a,b,c){function e(a){a.preventDefault(),i.style.left=Math.min(h.offsetWidth-(c+2),Math.max(0,(parseInt(i.style.left)||0)+a.screenX-i.lastX))+"px",i.lastX=a.screenX,h.val=parseInt(i.style.left)/(h.offsetWidth-(c+2)),b(h.val)}function f(a){a.preventDefault(),j=!1,h.setValue(h.val),window.removeEventListener("mousemove",e,!0),window.removeEventListener("mouseup",f,!0)}function g(a){return j?void 0:(h.val=a,h.lastwidth=h.lastwidth||h.offsetWidth,i.style.left=(h.lastwidth-c-2)*a+"px",this)}var h,i,j=0;return void 0==c&&(c=16),h=d(document.createElement("div"),{className:"pimSlider",lastwidth:0,onmousedown:function(a){a.preventDefault(),i.style.left=Math.min(h.offsetWidth-(c+2),Math.max(0,(a.offsetX||a.layerX||a.x)-c/2))+"px",h.val=parseInt(i.style.left)/(h.offsetWidth-(c+2)),j=!0,b(h.val),i.lastX=a.screenX,window.addEventListener("mousemove",e,!0),window.addEventListener("mouseup",f,!0)},setValue:g,setText:function(a){return i.innerHTML=a,this}},{paddingRight:c+"px"}),i=d(document.createElement("div"),{className:"pimSliderThumb"},{pointerEvents:"none",textAlign:"center",minWidth:c+"px"}),d(h.appendChild(document.createElement("p")),{innerHTML:a},{position:"absolute",top:"-14px",width:"100%"}),h.appendChild(i),h}function h(a,b,c,e){var f;return d(f=document.createElement("input"),{className:"pimEdit",value:a,skipMove:1,placeholder:c||"",onkeyup:function(a){b&&b.call(this,a),e&&(this.style.backgroundColor=e.test(this.value)?"#EEEEEE":"#FFCCCC")},mover:function(a){var c,d,e;this.skipMove-->0||(c=parseFloat(this.value),isNaN(c)||(d=this.value.indexOf("."),e=-1==d?1:1/Math.pow(10,this.value.length-d-1),c-=a.webkitMovementY*e,this.value=c.toFixed(-1==d?0:this.value.length-d-1)),b&&b.call(this,a))}.bind(f),killer:function(){this.skipMove=2,document.exitPointerLock()}.bind(f),onmousedown:function(a){a.stopPropagation(),2==a.button&&(a.preventDefault(),this.skipMove=1,document.addEventListener("pointerlockchange",this.lockChange,!1),this.requestPointerLock())},lockChange:function(){document.pointerLockElement&&document.pointerLockElement===this?(window.addEventListener("mousemove",this.mover,!1),window.addEventListener("mouseup",this.killer,!1)):(window.removeEventListener("mousemove",this.mover,!1),window.removeEventListener("mouseup",this.killer,!1),document.removeEventListener("pointerlockchange",this.lockChange,!1))}.bind(f),oncontextmenu:function(a){a.stopPropagation(),a.preventDefault()}})}function i(a,b,c){return d(document.createElement("select"),{className:"pimCombo",setIndex:function(a){return this.selectedIndex=a,this},populate:function(a){this.innerHTML="<OPTION>"+a.join("<OPTION>")},innerHTML:"<OPTION>"+a.join("<OPTION>"),value:c||a[0],onchange:b,onmousedown:function(a){a.stopPropagation()}})}function j(a,b){var c=arguments[0]instanceof Array?l.apply(this,arguments[0]):arguments[0];return c.className+=" pimSelectable",c.handler=b,c.onmousedown=function(a){var d,e;if(!a.ctrlKey)for(d=c.parentElement.firstChild;d;)d.className.match(/pimSelected/)&&(d.className=d.className.replace(/ pimSelected/g,""),d.handler&&d.handler(!1)),d=d.nextSibling;c.className.match(/pimSelected/)?c.className=c.className.replace(/ pimSelected/g,""):c.className+=" pimSelected",e=!0,b&&(e=b.call(c,!!c.className.match(/pimSelected/),c,a))},c}function k(a,b){var c,d=document.createElement.bind(document);return pimGui.merge(pimGui.hflex(c=pimGui.merge(d("input"),{type:"checkbox",onchange:function(a){b&&b(a.target.checked)}},{maxWidth:"15px"}),pimGui.merge(pimGui.pimLabel(a),{onclick:function(){this.previousSibling.click()}},{color:"black",padding:"0px"})),{className:"pimCheck",origDisplay:"flex",check:c},{paddingLeft:"2px",backgroundColor:"inherit",fontSize:"90%"})}function l(){var a,b=d(document.createElement("div"),{className:"pimHGroup"},{}),c=0;Array.prototype.forEach.call(arguments,function(a){c+=a&&a.weight||1});for(a in arguments)arguments[a].style.width=100/c*(arguments[a].weight||1)+"%",b.appendChild(arguments[a]);return b}function m(){var a,b=d(document.createElement("div"),{className:"pimGroup"});for(a in arguments)b.appendChild(arguments[a]instanceof Array?l.apply(this,arguments[a]):arguments[a]);return b}function n(a,b,c,e,g){var h,i,k,n,o,p,q,r,s,t=[];return t=[],h=[],i=[],k=[],a.forEach(function(a){k.push(a.length),i.push(d(f(a),{className:"pimLabel pimTableHeader",weight:a.length}))}),o=d(l.apply(this,i),{className:"pimHGroup pimTableHeader"},{paddingRight:"12px"}),p=function(b,e){var g,i,m=[];if(b instanceof Array)for(g=0;i=b[g];g++)g<a.length&&m.push(d(f(i),{weight:k[g]},{flexGrow:1}));else if(b instanceof Object)for(g=0;i=a[g];g++)m.push(b[i.replace(/\s+$/g,"")]instanceof HTMLElement?d(b[i.replace(/\s+$/g,"")],{weight:k[g]},{flexGrow:1}):d(f(b[i.replace(/\s+$/g,"")]),{weight:k[g]},{flexGrow:1}));t.push(j(d(l.apply(pimGui,m)),c.bind(this,b))),h.push(m),e&&o.nextSibling.appendChild(t[t.length-1])},q=function(b,c){c&&(o.nextSibling.innerHTML="",t=[],h=[]),b.forEach(function(a){p(a)}),c&&t.forEach(function(a){o.nextSibling.appendChild(a)}),n=function(c){var d,e,f;for(d=0;e=h[d];d++)if((void 0==c||c==b[d])&&b[d]instanceof Object)for(f in e)e[f].innerHTML=b[d][a[f].replace(/\s+$/g,"")]}},r=function(){for(var a,c=0;a=h[c];c++)a[0].parentElement.className.match("pimSelected")&&(a[0].parentElement.parentElement.removeChild(a[0].parentElement),h.splice(c,1),b.splice(c,1),c--)},s=function(a){var b,c;if(a)for(b=0;c=h[b];b++)a(b)&&(c[0].parentElement.className=c[0].parentElement.className.replace(/ pimSelected/g,"")+" pimSelected");else for(b=0;c=h[b];b++)c[0].parentElement.className=c[0].parentElement.className.replace(/ pimSelected/g,"")+" pimSelected"},q(b),d(m(o,d(m.apply(this,t),{className:""},{display:"flex",flexDirection:"column",flexGrow:1,border:"0px solid black",overflowX:"hidden",overflowY:"scroll",margin:"0px",position:"absolute",top:"20px",bottom:"0px",width:"100%",padding:"0px",backgroundColor:"#EEEEEE"})),{className:"",updateTable:n,populate:q,deleteSelected:r,addItem:p,selectAll:s},{position:"relative",verticalAlign:"top",minHeight:g||"200px"})}function o(a,b,c,g){var j,k,o,p,q,r,s,t;void 0==c&&(c=65535),j=[],k=[],o=[],p=null,q=null;for(r in b)(function(a){k.push(a),o.push(a.replace(/\s+$/g,"")),j.push(c||1!=k.length?l(d(f(a),{weight:.3}),"boolean"==typeof b[a]?i(["true","false"],function(){q&&(q[o[a]]=this.value,p.updateTable(q))}):b[a]instanceof Array?i(b[a],function(){q&&(q[a.replace(/\s+$/g,"")]=this.value,p.updateTable(q))}):h("",function(){q&&(q[a.replace(/\s+$/g,"")]=this.value,g&&g.call(this),p.updateTable(q))},b[a])):document.createElement("div"))})(r);return s=p=n(k,a,function(a,d){var e,f;if(d){for(e=c&!0?0:1;f=j[e];e++)f.firstChild.nextSibling.value=a[o[e]];q=a}else{for(e=c&!0?0:1;f=j[e];e++)f.firstChild.nextSibling.value="boolean"==typeof b[k[e]]?b[k[e]]:"";q=null}},100,100),s.style.minHeight="100px",s.style.flexGrow="1",p.style.display="flex",p.style.flexDirection="column",t=d(l(e("add",function(){var c,d={};for(c in o)d[o[c]]="boolean"==typeof b[o[c]]?"true"==j[c].firstChild.nextSibling.value:j[c].firstChild.nextSibling.value;a.push(d),p.populate(a,!0)}),e("delete",function(){p.deleteSelected();for(var a,c=0;a=j[c];c++)a.firstChild.nextSibling.value="boolean"==typeof b[k[c]]?b[k[c]]:""})),{},{}),d(m.apply(this,j.slice(c&!0?0:1).concat(c&!0?[s,t]:[s])),{populate:function(a){p.populate(a,!0),j.forEach(function(a){a.firstChild&&(a.firstChild.nextSibling.value="")})}},{},{})}function p(a,b,c,e,g){var h,i=[],k=null,n=[],o=[],p=function(b,g){function h(a){var b=a.parent?h(a.parent):"";return b+=("0000"+q.indexOf(a)).slice(-4)}var m,n,q,r,s,t,u,v,w,x,y,z,B=!1;if(k&&(B=!0,m=k.nextSibling.innerHTML="",i=[]),b instanceof A){for(n=b,q=[],r=0;s=n.objects[r];r++)for(s.inst.treeskip||q.push(s.inst),s.inst.treecolor=s.inst.treecolor||(s.obj?"rgba(0,255,0,0.2)":"rgba(0,0,0,0.2)"),t=0;u=s.bones[t];t++)s.inst.treeskip||q.push(u.inst),u.inst.treecolor=u.inst.treecolor||"rgba(0,0,255,0.2)";for(r=0;s=n.cameras[r];r++)s.inst.treeskip||q.push(s.inst),s.inst.treecolor=s.inst.treecolor||"rgba(255,0,0,0.2)";for(r=0;s=n.lights[r];r++)s.inst.treeskip||q.push(s.inst),s.inst.treecolor=s.inst.treecolor||"rgba(255,255,0,0.2)"}else q=b;if(v=(a[0]||"").replace(/\s*$/g,""),q.sort(function(a,b){return a[v]<b[v]?-1:a[v]>b[v]?1:0}),o=[],g){g.splice(0);for(r in q)o[r]=pimGui.merge(q[r],{parentSTR:h(q[r])}),q[r].selected&&g.push(q[r])}for(o.sort(function(a,b){return a.parentSTR<b.parentSTR?-1:a.parentSTR>b.parentSTR?1:0}),w=[],x=[],a.forEach(function(a){x.push(a.length),w.push(d(f(a),{className:"pimLabel pimTableHeader",weight:a.length},{flexGrow:0}))}),e===!1?(w=[],k||(k=d(l.apply(this,w),{className:"pimHGroup pimTableHeader"},{display:"none",paddingRight:"12px"}))):k||(k=d(l.apply(this,w),{className:"pimHGroup pimTableHeader"},{paddingRight:"12px"})),y=0;z=o[y];y++)(function(b,e){var h,k,m=[];for(h=0;k=a[h];h++)m.push(typeof e[k.replace(/\s*$/g,"")]in{string:1,number:1,"boolean":1}?d(f(0==h?'<SPAN CLASS="'+(b+1<o.length&&o[b+1].parentSTR.length>e.parentSTR.length?"icon-rarr":"icon-rarrd")+'" STYLE="margin-left:'+(-16+4*e.parentSTR.length)+'px"></SPAN>'+e[k.replace(/\s*$/g,"")]:e[k.replace(/\s*$/g,"")]),{weight:x[h]},0==h?{overflow:"hidden",marginBottom:"-1px",minHeight:"20px",maxHeight:"20px",whiteSpace:"nowrap",backgroundColor:e.treecolor||"inherit",borderBottom:"1px solid rgba(0,0,0,0.1)"}:{overflow:"hidden",whiteSpace:"nowrap",marginBottom:"-1px",minHeight:"20px",maxHeight:"20px",backgroundColor:e.treecolor||"inherit",borderBottom:"1px solid rgba(0,0,0,0.91)"}):d(e[k.replace(/\s*$/g,"")],{weight:x[h]},0==h?{overflow:"hidden",marginBottom:"-1px",maxHeight:"20px",borderBottom:"1px solid rgba(0,0,0,0.1)"}:{maxHeight:"20px",backgroundColor:"inherit",marginBottom:"-1px",borderBottom:"1px solid rgba(0,0,0,0.1)"}));m[0].firstChild.title="ctrl-LB expand recursive.",m[0].firstChild.onmousedown=function(a){m[0].handler(b,a),a.preventDefault(),a.stopPropagation()},m[0].handler=function(a,b){var c=o[a],d=this.parentElement.nextSibling;for(a++,"icon-rarrd"!=this.firstChild.className&&(this.firstChild.className="icon-darr"==this.firstChild.className?"icon-rarr":"icon-darr");a<o.length&&o[a].parentSTR.length>c.parentSTR.length;)("icon-rarr"==this.firstChild.className||o[a].parent==c||b.ctrlKey)&&(d.style.display="icon-darr"==this.firstChild.className?"block":"none","icon-rarrd"!=d.firstChild.firstChild.className&&(d.firstChild.firstChild.className=b.ctrlKey?"icon-darr":"icon-rarr")),d=d.nextSibling,a++},i.push(d(j(d(l.apply(this,m),{draggable:"true",ondragstart:function(){this.className.match(/pimSelected/)||(this.className+=" pimSelected")},ondragover:function(a){return a.preventDefault(),!0},ondrop:function(a,b){b.layerX<20&&(a=null);for(var c in i)i[c].className.match(/pimSelected/)&&o[c]!=a&&(pimInstance.calcCount=0,o[c].parent=a,o[c].calcCount=o[c].bcalcCount=o[c].bcalcCounts=o[c].bcalcCountt=0,o[c].changed=1);p(o,g)}.bind(this,o[i.length])},{flexGrow:0}),function(a,b,d,e){b&&e.layerX<d.firstChild.firstChild.offsetLeft+10?(d.firstChild.firstChild.onmousedown(e),d.className=d.className.replace(/ *pimSelected/,"")):(b?g.push(a):g.splice(g.indexOf(a),1),a.selected=b,c(a,b))}.bind(this,o[i.length])),{className:o[i.length].selected?"pimHGroup pimSelectable pimSelected":"pimHGroup pimSelectable"},{flexGrow:0,display:o[i.length].parent?"none":"block"}))})(y,z);B&&i.forEach(function(a){k.nextSibling.appendChild(a)})};return p(b,n),h=d(v(k,d(m.apply(this,i),{className:""},{borderRadius:"inherit",border:"0px solid black",overflowX:"hidden",overflowY:"scroll",minHeight:void 0!=g?g+"px":"auto",flexGrow:0,margin:"0px",position:"relative",padding:"0px",backgroundColor:"#EEEEEE"})),{className:"",selection:n,populate:function(a){p(a,this.selection)},selectItem:function(a,b){void 0==b&&(b=!0),-1==this.selection.indexOf(a)&&-1!=o.indexOf(a)&&(this.selection.push(a),i[o.indexOf(a)].className+=" pimSelected",a.selected=1,b&&c(a,!0))},clearSelection:function(){this.selection.forEach(function(a){a.selected=0,c(a,!1)}),i.forEach(function(a){a.className=a.className.replace(/ pimSelected/,"")}),this.selection.splice(0)}},{flexGrow:1}),h.firstChild.style.flexGrow=0,h.firstChild.style.flexShrink=0,h}function q(a,b){function c(){e.style.display="none";var a=h[0],d=h[1],f=h[2];i.style.backgroundColor="rgb("+a+","+d+","+f+")",i.style.color=a+d+f>384?"black":"white",b(h),window.removeEventListener("click",c,!1)}function d(a){for(var b=0,c=0;null!=a;b+=a.offsetLeft,c+=a.offsetTop,a=a.offsetParent);return{x:b,y:c}}var e,f,g,h,i=document.body.appendChild(document.createElement("div"));return i.style.height="25px",i.style.position="relative",i.style.textAlign="center",i.style.lineHeight="25px",i.style.overflow="show",i.style.color="black",i.style.backgroundColor="rgb(255,255,255)",i.innerHTML=a,e=i.appendChild(document.createElement("canvas")),e.width=192,e.height=128,e.style.display="none",f=e.getContext("2d"),f.drawImage(z,0,0),g=f.getImageData(0,0,192,128).data,h=[255,255,255],i.setColor=function(a){h=a;var b=h[0],c=h[1],d=h[2];return i.style.backgroundColor="rgb("+b+","+c+","+d+")",i.style.color=b+c+d>384?"black":"white",this},i.onclick=function(a){a.stopPropagation(),e.style.display="block",e.style.position="fixed";var b=d(i);e.style.left=b.x+"px",e.style.top=b.y-128+"px",window.addEventListener("click",c,!1)},e.addEventListener("click",function(a){var c,d,f;a.stopPropagation(),c=g[192*a.offsetY*4+4*a.offsetX],d=g[192*a.offsetY*4+4*a.offsetX+1],f=g[192*a.offsetY*4+4*a.offsetX+2],i.style.color=c+d+f>384?"black":"white",h=[c,d,f],b(h),e.style.display="none"}),e.addEventListener("mousemove",function(a){var c=g[192*a.offsetY*4+4*a.offsetX],d=g[192*a.offsetY*4+4*a.offsetX+1],e=g[192*a.offsetY*4+4*a.offsetX+2];i.style.color=c+d+e>384?"black":"white",i.style.backgroundColor="rgb("+c+","+d+","+e+")",b([c,d,e])},!1),i}function r(a,b,c){var e,g,h,i,k=[];for(e=0;g=a[e];e++)k[e]=j(d(f(g,function(d){if(!(a.length<=1)){for(var e=0;e<b.length;e++)b[e].style.display=d==e?"block":"none";c&&c(d)}}.bind(this,e)),0==e?{className:"pimLabel pimTab pimSelectable pimSelected"}:{className:"pimLabel pimTab"},{borderTopLeftRadius:"5px",borderTopRightRadius:"15px",border:"1px solid black",paddingRight:"10px",borderBottom:"0px"}));for(a=l.apply(this,k),h=a.firstChild;h;h=h.nextSibling)h.style.width="auto";for(e=0;i=b[e];e++)b[e]=d(i instanceof Array?m.apply(this,i):m(i),{},{border:"0px solid black"}),b[e].firstChild.style.borderTopLeftRadius="0px",b[e].firstChild.style.borderTopRightRadius="5px",b[e].style.display=0==e?"block":"none";return d(m.apply(this,[d(a,{},{border:"0px",borderTop:"1px"})].concat(b)),{showTab:function(a,b){k[a].style.display=b?"block":"none"},setTab:function(a){k[a].onclick({}),k[a].onmousedown({})}},{backgroundColor:"inherit",border:"0px"})}function s(a,b){var c={};return c.all=d(document.createElement("div"),{},{position:"relative",overflow:"hidden",flexGrow:1,verticalAlign:"top"}),c.cvs=d(document.createElement("canvas"),{className:"pimSpliner"},{position:"absolute",top:"0px",left:"0px",width:"100%",height:"100%",userSelect:"none"}),c.cvsk=d(document.createElement("input"),{type:"text"},{opacity:0,position:"absolute",width:"0px",height:"0px",overflow:"hidden"}),c.timeel=d(document.createElement("div"),{},{backgroundColor:"#444444",width:"1px",height:"100%",position:"absolute",top:"0px"}),c.seldiv=d(document.createElement("div"),{},{backgroundColor:"rgba(255,255,255,0.2)",position:"absolute",pointerEvents:"none",border:"1px solid rgba(255,255,0,0.2)",zIndex:10}),c.all.appendChild(c.cvs),c.all.appendChild(c.seldiv),c.all.appendChild(c.timeel),c.all.appendChild(c.cvsk),c.ymin=4,c.ymax=0,c.fps=30,c.time=0,c.track=a,c.xmin=0,c.tracksize=50,c.xmax=20/3,c.all.oncontextmenu=function(a){function select_all(){g.tracks.forEach(function(a){a.forEach(function(a){a.selected=1})}),c.redraw()}function delete_block(){g.tracks.forEach(function(a){for(var b=0;b<a.length;)a[b].selected?a.splice(b,1):b++}),c.redraw(),g.recalculate&&g.recalculate(),b&&b(4)}function duplicate_block(){g.tracks.forEach(function(a){for(var b=0,c=a.length;c>b;)a[b].selected&&(a.push(pimGui.merge({},a[b])),b=a[a.length-1],b.startTime+=g.lastTime||0,b.stopTime+=g.lastTime||0,b.tweaks&&(b.tweaks=b.tweaks.slice(0)),g.lastTime+=b.stopTime-b.startTime),b++
}),c.redraw(),g.recalculate&&g.recalculate(),b&&b(5)}var d,e,f,g=c.track;a.stopPropagation(),a.preventDefault(),d=[select_all],e=0,g.tracks.forEach(function(a){a.forEach(function(a){a.selected&&e++})}),e&&(d=d.concat([delete_block,duplicate_block])),f=x(a.x,a.y,d,function(){}),document.body.appendChild(f)},c.redraw=function(){var a,b,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F;if("none"!=getComputedStyle(this.cvs.parentElement).display&&this.all.parentElement){for(a=this.cvs,b=a.offsetWidth,d=a.offsetHeight;a&&(0==b||0==d);)a=a.parentElement,b=a.offsetWidth,d=a.offsetHeight;for(this.cvs.width=b,this.cvs.height=d,c.ymin=d/c.tracksize,e=this.cvs.getContext("2d"),e.fillStyle="rgb(192,192,192)",e.fillRect(0,0,b,d),f=0;2>f;f++)for(g=[[1/(2*c.fps),1/c.fps,1,30,60,300],[1,10,100]][f],h=[[8,32,64,64,128,164],[128,164]][f],i=[c.xmin,c.ymax][f],j=[c.xmax,c.ymin][f],k=0;l=g[k];k++)if(m=Math.ceil(Math.abs(j-i)/l),n=Math.min(1,.5*Math.max(0,(f?d:b)/m-4)))for(o=Math.round(196-n*h[k]),e.strokeStyle="rgb("+o+","+o+","+o+")",p=0;m>=p;p++)q=Math.floor(i/l)*l+p*l,q=(q-i)/(j-i)*(f?d:b),e.beginPath(),e.moveTo(f?0:q,f?d-q:0),e.lineTo(f?b:q,f?d-q:d),e.stroke();for(this.track.tracks.forEach(function(a){a.sort(function(a,b){return a.startTime-b.startTime})}),e.font="12px Segoe UI",r=0;s=this.track.tracks[r];r++)for(t=0;u=s[t];t++){if(e.fillStyle=u.color||"#FA4",v=(u.startTime-c.xmin)/(c.xmax-c.xmin)*this.cvs.width,w=(u.stopTime-c.xmin)/(c.xmax-c.xmin)*this.cvs.width,x=(c.ymin-r-1)/c.ymin*this.cvs.height,y=(c.ymin-r)/c.ymin*this.cvs.height,e.fillRect(v+1,x+1,w-v-2,y-x-2),t>0&&s[t-1].stopTime>u.startTime&&(e.fillStyle="#C80",z=(s[t-1].stopTime-c.xmin)/(c.xmax-c.xmin)*this.cvs.width,e.fillRect(v+1,x+1,z-v-2,y-x-2)),e.fillStyle="#222",c.tracksize>=40&&e.fillText(u.name,v+10,y-10),e.fillText(Math.floor(u.startTime*c.fps)+(c.tracksize<40?" "+u.name:""),v+8,x+14),e.fillText(Math.floor(u.stopTime*c.fps),w-8-8*(Math.floor(u.stopTime*c.fps)+"").length,x+14),t>0&&s[t-1].stopTime>u.startTime&&e.fillText(Math.floor(s[t-1].stopTime*c.fps),z+4,x+14),A=u.spline){if(2!=u.ticks){if(e.strokeStyle=u.spline.color||"#888",e.beginPath(),1==A.keys.length)B=A.keys[0].value,B=y-B*(y-x-1),e.moveTo(v,B),e.lineTo(w,B);else for(C=0;w-v>C;C+=1)B=A.evaluate(C/(w-v)*(u.stopTime-u.startTime)),B=y-B*(y-x-2)-1,0==C?e.moveTo(v,B):e.lineTo(v+C,B);e.stroke()}if(u.ticks)for(e.strokeStyle="#FFFF00",e.fillStyle="#0000FF",C=0;D=A.keys[C];C++)if(q=(D.time-c.xmin)/(c.xmax-c.xmin)*this.cvs.width+v,!(0>q)){if(q>c.cvs.width)break;E=(D.value-c.ymin)/(c.ymax-c.ymin)*this.cvs.height,E=y-D.value*(y-x-2)-1,!u.selected||Math.abs(c.time-D.time-u.startTime)>1/120?e.fillRect(q-2,E-2,5,5):e.strokeRect(q-1,E-1,3,3)}}e.strokeStyle="#F00",u.selected&&e.strokeRect(v,x,w-v,y-x)}F=(c.time-c.xmin)/(c.xmax-c.xmin)*c.cvs.width,c.timeel.style.left=F+"px"}},c.cvs.move=function(a){var d=c.cvs.width/((c.xmax-c.xmin)*c.fps),e=a.screenX-c.mousex,f=a.screenY-c.mousey,g=null;!a.ctrlKey&&Math.abs(e)<d?e=0:(c.mousex=a.screenX,c.mousey=a.screenY),(e||f)&&(c.track.tracks.forEach(function(b){b.forEach(function(b){b.selected&&(c.endonly||(b.startTime+=e/c.cvs.width*(c.xmax-c.xmin)),c.startonly||(b.stopTime+=e/c.cvs.width*(c.xmax-c.xmin)),a.ctrlKey||(b.startTime=Math.round(b.startTime*c.fps)/c.fps,b.stopTime=Math.round(b.stopTime*c.fps)/c.fps),g=b)})}),c.track.tracks.forEach(function(b){b.forEach(function(d,e){if(d.selected){var f=Math.max(0,Math.floor(c.ymin+a.layerY*(c.ymax-c.ymin)/c.cvs.height));d.track!=f&&(b.splice(e,1),void 0==c.track.tracks[f]&&(c.track.tracks[f]=[]),c.track.tracks[f].push(d),d.track=f),g=d}})}),b&&b(2,g),c.redraw())},c.cvs.stopmove=function(){window.removeEventListener("mousemove",c.cvs.move,!0),window.removeEventListener("mouseup",c.cvs.stopmove,!0),b&&b(3)},c.cvs.addEventListener("mousewheel",function(a){var b=Math.max(-1,Math.min(1,a.wheelDelta||-a.detail));c.tracksize+=b,c.redraw()}),c.cvs.addEventListener("mousedown",function(a){c.mousex=a.screenX,c.mousey=a.screenY;var d=null;c.clickx=c.xmin+a.layerX*(c.xmax-c.xmin)/c.cvs.width,c.clicky=Math.floor(c.ymin+a.layerY*(c.ymax-c.ymin)/c.cvs.height),a.shiftKey||this.track.tracks.forEach(function(a){a.forEach(function(a){a.selected=!1})}),this.track.tracks[c.clicky]&&this.track.tracks[c.clicky].forEach(function(a){a.startTime<c.clickx&&a.stopTime>c.clickx&&(a.selected=!0,d=a,c.endonly=(a.stopTime-c.clickx)/(a.stopTime-a.startTime)<.05,c.startonly=(a.stopTime-c.clickx)/(a.stopTime-a.startTime)>.95)}.bind(this)),c.redraw(),b&&b(1,d),window.addEventListener("mousemove",c.cvs.move,!0),window.addEventListener("mouseup",c.cvs.stopmove,!0)}.bind(c)),c.all.setRange=function(a,b){c.xmin=a,c.xmax=b},c.all.redraw=c.redraw.bind(c),c.all.setTime=function(a){c.time=a;var b=(c.time-c.xmin)/(c.xmax-c.xmin)*c.cvs.width;c.timeel.style.left=b+"px"},c.all.th=c,setTimeout(c.all.redraw,0),c.all}function t(a){var b={a:65,del:46,shift:16,ctrl:17,alt:18},c={};return c.all=d(document.createElement("div"),{},{position:"relative",overflow:"hidden",flexGrow:1,verticalAlign:"top"}),c.cvs=d(document.createElement("canvas"),{className:"pimSpliner"},{position:"absolute",top:"0px",left:"0px",width:"100%",height:"100%",userSelect:"none"}),c.cvsk=d(document.createElement("input"),{type:"text"},{opacity:0,position:"absolute",width:"0px",height:"0px",overflow:"hidden"}),c.timeel=d(document.createElement("div"),{},{backgroundColor:"#444444",width:"1px",height:"100%",position:"absolute",top:"0px"}),c.seldiv=d(document.createElement("div"),{},{backgroundColor:"rgba(255,255,255,0.2)",position:"absolute",pointerEvents:"none",border:"1px solid rgba(255,255,0,0.2)",zIndex:10}),c.all.appendChild(c.cvs),c.all.appendChild(c.seldiv),c.all.appendChild(c.timeel),c.all.appendChild(c.cvsk),c.xmin=-.5,c.xmax=4.5,c.ymin=4,c.ymax=-4,c.splines=[],c.colors=["red","green","blue"],c.colors2=["#FF8888","#88FF88","#8888FF"],c.time=0,c.fps=30,c.selected=0,c.clearSplines=function(){this.splines=[],this.redraw()},c.deleteSelection=function(){var a,b,d,e;for(a=0;b=c.splines[a];a++)if(b&&b.visible)for(d=0;e=b.keys[d];)e.flags?(b.nrKeys--,b.keys.splice(d,1),b.cachetime=-1e6,b.cachekey=-1):d++;c.selected=0,c.redraw()},c.addSpline=function(a){this.splines.push(a),this.redraw()},c.redraw=function(){var a,b,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;if("none"!=getComputedStyle(this.cvs.parentElement).display){for(a=this.cvs,b=a.offsetWidth,d=a.offsetHeight;a&&(0==b||0==d);)a=a.parentElement,b=a.offsetWidth,d=a.offsetHeight;for(this.cvs.width=b,this.cvs.height=d,e=this.cvs.getContext("2d"),e.fillStyle="rgb(196,196,196)",e.fillRect(0,0,b,d),f=0;2>f;f++)for(g=[[1/(2*c.fps),1/c.fps,1,30,60,300],[.001,.01,.1,1,10,100]][f],h=[[8,32,64,64,128,164],[16,32,32,64,128,164]][f],i=[c.xmin,c.ymax][f],j=[c.xmax,c.ymin][f],k=0;l=g[k];k++)if(m=Math.ceil(Math.abs(j-i)/l),n=Math.min(1,.5*Math.max(0,(f?d:b)/m-4)))for(o=Math.round(196-n*h[k]),e.strokeStyle="rgb("+o+","+o+","+o+")",p=0;m>=p;p++)q=Math.floor(i/l)*l+p*l,q=(q-i)/(j-i)*(f?d:b),e.beginPath(),e.moveTo(f?0:q,f?d-q:0),e.lineTo(f?b:q,f?d-q:d),e.stroke();for(r=0;s=this.splines[r];r++)if(s.visible){if(e.strokeStyle=this.colors[r%3],e.beginPath(),1==s.keys.length)t=s.keys[0].value,t=(t-c.ymin)/(c.ymax-c.ymin)*this.cvs.height,e.moveTo(0,t),e.lineTo(this.cvs.width,t);else for(u=0;u<this.cvs.width;u+=4)t=s.evaluate(c.xmin+u/this.cvs.width*(c.xmax-c.xmin)),t=(t-c.ymin)/(c.ymax-c.ymin)*this.cvs.height,0==u?e.moveTo(0,t):e.lineTo(u,t);for(t=s.evaluate(c.xmin+0/this.cvs.width*(c.xmax-c.xmin)),t=(t-c.ymin)/(c.ymax-c.ymin)*this.cvs.height,e.stroke(),e.strokeStyle="#FFFF00",e.fillStyle=this.colors2[r%3],u=0;v=s.keys[u];u++)q=(v.time-c.xmin)/(c.xmax-c.xmin)*this.cvs.width,0>q||q>c.cvs.width||(w=(v.value-c.ymin)/(c.ymax-c.ymin)*this.cvs.height,v.flags?e.strokeRect(q-1,w-1,3,3):e.fillRect(q-1,w-1,3,3))}x=(c.time-c.xmin)/(c.xmax-c.xmin)*c.cvs.width,c.timeel.style.left=x+"px"}},window.addEventListener("resize",function(){for(var a,b,d=c.cvs,e=d.offsetWidth,f=d.offsetHeight;d&&(0==e||0==f);)d=d.parentElement,e=d.offsetWidth,f=d.offsetHeight;a=(c.xmax-c.xmin)/c.cvs.width*(e-c.cvs.width),b=(c.ymax-c.ymin)/c.cvs.height*(f-c.cvs.height),c.xmax+=a,c.ymin-=b,c.redraw()}),document.addEventListener("pointerlockchange",function(){c.pointerlock=document.pointerLockElement&&document.pointerLockElement===c.cvs},!1),c.cvs.addEventListener("mousedown",function(a){switch(c.mousex=a.layerX,c.mousey=a.layerY,c.clickx=c.xmin+a.layerX*(c.xmax-c.xmin)/c.cvs.width,c.clicky=c.ymin+a.layerY*(c.ymax-c.ymin)/c.cvs.height,a.button){case 0:c.mouselb=!0;break;case 1:c.mousemb=!0;break;case 2:c.mouserb=!0}return 2==a.button&&(c.seldiv.sx=a.layerX,c.seldiv.sy=a.layerY,c.seldiv.style.left=a.layerX+"px",c.seldiv.style.top=a.layerY+"px",c.seldiv.style.right=c.cvs.width-a.layerX+"px",c.seldiv.style.bottom=c.cvs.height-a.layerY+"px",c.seldiv.style.visibility="visible"),a.altKey&&c.mouselb&&(c.skipMove=2,c.cvs.requestPointerLock()),a.preventDefault(),a.stopPropagation(),!1},!1),c.cvs.addEventListener("click",function(a){if("copy"==c.cvs.style.cursor){for(var b,d=0;b=c.splines[d];d++)b&&b.visible&&b.addKey(c.clickx,c.clicky);c.redraw()}return c.cvsk.focus(),a.preventDefault(),a.stopPropagation(),!1},!1),c.cvs.addEventListener("contextmenu",function(a){return a.preventDefault(),a.stopPropagation(),!1},!1),document.addEventListener("mouseup",function(b){var d,e,f,g,h;if(c.mouselb||c.mousemb||c.mouserb){switch(c.cvsk.focus(),c.mousex=b.layerX,c.mousey=b.layerY,c.clickxe=c.xmin+b.layerX*(c.xmax-c.xmin)/c.cvs.width,c.clickye=c.ymin+b.layerY*(c.ymax-c.ymin)/c.cvs.height,b.button){case 0:c.mouselb=!1;break;case 1:c.mousemb=!1;break;case 2:c.mouserb=!1}if(2==b.button){for(c.seldiv.style.visibility="hidden",c.selected=0,c.sel={},c.clickx>c.clickxe&&(d=c.clickx,c.clickx=c.clickxe,c.clickxe=d),c.clicky<c.clickye&&(d=c.clicky,c.clicky=c.clickye,c.clickye=d),e=0;f=c.splines[e];e++)if(f&&f.visible)for(g=0;h=f.keys[g];g++)h.time>c.clickx&&h.time<c.clickxe&&h.value<c.clicky&&h.value>c.clickye?(h.flags=1,c.sel.key=h,c.selected++):h.flags=0;c.redraw(),0==c.selected&&a&&a(),1==c.selected&&a&&a(c.sel.key)}return c.pointerlock&&(document.exitPointerLock(),c.skipMove=0),b.preventDefault(),b.stopPropagation(),!1}},!1),c.cvsk.addEventListener("keydown",function(a){a.keyCode==b.a&&c.centerAll(),a.keyCode==b.del&&c.deleteSelection(),a.keyCode==b.alt&&(c.cvs.style.cursor=a.ctrlKey?"-webkit-zoom-in":"move"),a.keyCode==b.ctrl&&(c.cvs.style.cursor=a.altKey?"-webkit-zoom-in":c.cvs.style.cursor.match(/size/)?"e-resize":"copy"),a.keyCode!=b.ctrl&&a.keyCode!=b.alt&&a.ctrlKey?c.cvsk.blur():(a.preventDefault(),a.stopPropagation())}),c.cvsk.addEventListener("keyup",function(a){a.keyCode==b.alt&&(c.cvs.style.cursor=a.ctrlKey?"copy":"crosshair"),a.keyCode==b.ctrl&&(c.cvs.style.cursor=a.altKey?"move":c.cvs.style.cursor.match(/size/)?"n-resize":"crosshair"),a.keyCode!=b.ctrl&&a.keyCode!=b.alt&&a.ctrlKey?c.cvsk.blur():(a.preventDefault(),a.stopPropagation())}),document.addEventListener("mousemove",function(b){var d,e,f,g,h,i,j,k,l,m;if(!(c.skipMove-->0)&&(0!==b.webkitMovementX||0!==b.webkitMovementY)&&(d=b.webkitMovementY+c.mousey,e=b.webkitMovementX+c.mousex,c.mouselb||c.mousemb||c.mouserb||b.target==c.cvs)){if((b.altKey||b.ctrlKey)&&c.cvsk.focus(),c.mouselb&&b.altKey&&!b.ctrlKey)f=(c.xmax-c.xmin)/c.cvs.width,g=(c.ymax-c.ymin)/c.cvs.height,c.ymin-=(d-c.mousey)*g,c.ymax-=(d-c.mousey)*g,c.xmin-=(e-c.mousex)*f,c.xmax-=(e-c.mousex)*f,c.redraw();else if(c.mouselb&&b.altKey&&b.ctrlKey)c.xmin=(c.xmin-c.clickx)*(1+.01*(c.mousex-e))+c.clickx,c.xmax=(c.xmax-c.clickx)*(1+.01*(c.mousex-e))+c.clickx,c.ymin=(c.ymin-c.clicky)*(1-.01*(c.mousey-d))+c.clicky,c.ymax=(c.ymax-c.clicky)*(1-.01*(c.mousey-d))+c.clicky,c.redraw();else if(c.mouselb&&c.selected&&!b.ctrlKey){if(g=(c.ymax-c.ymin)/c.cvs.height,1==c.selected)c.sel.key.value=parseFloat(c.sel.key.value)+(d-c.mousey)*g,c.cvs.title="T:"+c.sel.key.time+" V:"+c.sel.key.value,a&&a(c.sel.key);else{for(h=0;i=c.splines[h];h++)if(i&&i.visible)for(j=0;k=i.keys[j];j++)k.flags&&(k.value=parseFloat(k.value)+(d-c.mousey)*g);a&&a(c.sel.key)}c.redraw(),c.cvs.style.cursor="n-resize",c._update&&c._update()}else if(c.mouselb&&c.sel&&b.ctrlKey){if(f=(c.xmax-c.xmin)/c.cvs.width,1==c.selected)c.sel.key.time+=(e-c.mousex)*f;else for(h=0;i=c.splines[h];h++)if(i&&i.visible)for(j=0;k=i.keys[j];j++)k.flags&&(k.time+=(e-c.mousex)*f);a&&a(c.sel.key),c.redraw(),c.cvs.style.cursor="e-resize",c._update&&c._update()}else if(c.mouserb)c.seldiv.style.left=Math.min(c.seldiv.sx,e)+"px",c.seldiv.style.top=Math.min(c.seldiv.sy,d)+"px",c.seldiv.style.right=c.cvs.offsetWidth-Math.max(c.seldiv.sx,e)+"px",c.seldiv.style.bottom=c.cvs.offsetHeight-Math.max(c.seldiv.sy,d)+"px";else for(c.cvs.title="",c.cvs.style.cursor=b.altKey?b.ctrlKey?"-webkit-zoom-in":"move":b.ctrlKey?"copy":"crosshair",h=0;i=c.splines[h];h++)if(i&&i.visible)for(j=0;k=i.keys[j];j++)if(l=(k.value-c.ymin)/(c.ymax-c.ymin)*c.cvs.height,m=(k.time-c.xmin)/(c.xmax-c.xmin)*c.cvs.width,Math.abs(e-m)<3&&Math.abs(d-l)<3)return c.selected<=1&&(c.cvs.title="T:"+k.time+" V:"+k.value,c.sel&&c.sel.key&&(c.sel.key.flags=0),c.sel={spline:i,key:k},k.flags=1,c.selected=1,c.redraw(),a&&a(c.sel.key)),void(c.cvs.style.cursor=b.ctrlDown?"e-resize":"n-resize");c.mousex=e,c.mousey=d}},!1),c.all.redraw=c.redraw.bind(c),c.all.addSpline=c.addSpline.bind(c),c.all.clearSplines=c.clearSplines.bind(c),c.all.setTime=function(a){c.time=a;var b=(c.time-c.xmin)/(c.xmax-c.xmin)*c.cvs.width;c.timeel.style.left=b+"px"},c.all.th=c,c.all}function u(){var a=d(document.createElement("div"),{},{display:"flex",alignItems:"stretch"});return Array.prototype.forEach.call(arguments,function(b){a.appendChild(d(b,{},{flexGrow:1}))}),a}function v(){var a=d(document.createElement("div"),{},{display:"flex",alignItems:"stretch",flexDirection:"column"});return Array.prototype.forEach.call(arguments,function(b){a.appendChild(d(b,{},{flexGrow:1}))}),a}function w(a,b,c,e,f){var g,h,i,j,k=d(document.createElement("div"),{},{position:"relative",overflow:"hidden",maxWidth:1>=a?b+"px":"initial",maxHeight:a>1?b+"px":"initial",minHeight:a>1?b+"px":"initial",paddingLeft:0==a?"4px":"0px",paddingRight:1==a?"4px":"0px"});return k.style.minWidth=k.style.maxWidth,g=d(document.createElement("div"),{},{maxHeight:a>1?"4px":"100%",backgroundColor:"rgb(190,190,190)",maxWidth:1>=a?"4px":"100%",height:1>=a?"100%":"4px",width:1>=a?"4px":"100%",cursor:1>=a?"col-resize":"row-resize",position:"absolute",top:2==a?"0px":"initial",right:1==a?"0px":"initial",left:0==a?"0px":"initial"}),1>=a?(g.style.borderLeft="1px solid rgb(250,250,250)",g.style.borderRight="1px solid rgb(90,90,90)"):(g.style.borderTop="1px solid rgb(250,250,250)",g.style.borderBottom="1px solid rgb(90,90,90)"),i=function(b){var d;1>=a?(void 0==h&&(h=b.x||b.clientX),d=k.style.minWidth,k.style.maxWidth=Math.min(e,Math.max(c,parseInt(k.style.maxWidth||k.style.width||0)+(1==a?(b.x||b.clientX)-h:h-(b.x||b.clientX))))+"px",k.style.minWidth=k.style.maxWidth,d!=k.style.minWidth&&(h=b.x,window.dispatchEvent(new Event("resize")))):(void 0==h&&(h=b.y||b.clientY),d=k.style.minHeight,k.style.maxHeight=Math.min(e,Math.max(c,parseInt(k.style.maxHeight||k.style.height||0)+(3==a?(b.y||b.clientY)-h:h-(b.y||b.clientY))))+"px",k.style.minHeight=k.style.maxHeight,d!=k.style.minHeight&&(h=b.y,window.dispatchEvent(new Event("resize"))))},j=function(){window.removeEventListener("mousemove",i,!0),window.removeEventListener("mouseup",j,!0)},g.onmousedown=function(a){h=void 0,window.addEventListener("mousemove",i,!0),window.addEventListener("mouseup",j,!0),a.preventDefault(),a.stopPropagation()},k.appendChild(g),f instanceof Array?f.forEach(function(a){k.appendChild(a)}):f&&k.appendChild(f),k}function x(a,b,c,d){var e=document.createElement("div"),f=document.createElement("div"),g=250,h=!1;return pimGui.merge(e,{onclick:function(a){document.body.removeChild(e),h=!1,d(),document.elementFromPoint(a.x,a.y).click(a)}},{position:"fixed",zIndex:999,top:0,left:0,width:"100%",height:"100%"}),pimGui.merge(f,{},{position:"fixed",left:(innerWidth>a+g?a:innerWidth-g)+"px",top:(b-8+24*c.length<innerHeight?b:b-(24*c.length-8))+"px",minWidth:g+"px",maxHeight:"500px",paddingTop:"2px",paddingBottom:"2px",backgroundColor:"white",overflow:"auto",overflowX:"hidden",zIndex:1e3,border:"1px outset rgb(136, 136, 136)",boxShadow:"rgba(0, 0, 0, 0.498039) 2px 2px 2px"}),c.forEach(function(a){var b,c;return a instanceof HTMLElement?(f.appendChild(a),void(a.onclick||(a.onclick=function(a){a.stopPropagation()}))):(b=null,a instanceof Function&&(b=a,a=a.name.replace(/_/g," ")),c=document.createElement("div"),pimGui.merge(c,{innerHTML:a,className:a?"pimContext":"",onclick:function(a,c){c.stopPropagation(),c.preventDefault();var f=!0;b&&(f=b(a,c)),f!==!1&&(d(a,c),document.body.removeChild(e),h=!1)}.bind(this,a)},{}),a||pimGui.merge(c,{onclick:void 0},{borderTop:"1px solid rgba(0,0,0,0.1)",marginTop:"4px",paddingBottom:"4px"}),void f.appendChild(c))}.bind(this)),e.appendChild(f),e.oncontextmenu=function(a){a.preventDefault(),a.stopPropagation()},e.attach=function(a){return a.oncontextmenu=function(a){return a.preventDefault(),a.stopPropagation(),h?(h=!1,document.body.removeChild(e),!1):(f.style.left=a.x+g<innerWidth?a.x:innerWidth-g,f.style.top=a.y-8+24*c.length<innerHeight?a.y:a.y-(24*c.length-8),document.body.appendChild(e),h=!0,!1)},e},e}function y(a,b){var c,d=document.createElement("div"),e=document.createElement("div");return a=[].concat(a),pimGui.merge(e,{},{width:"400px",height:"400px",margin:"auto",position:"fixed",top:0,bottom:0,left:0,right:0,zIndex:105}),e.close=function(){document.body.removeChild(e),document.body.removeChild(d)},e.open=function(){document.body.appendChild(e),document.body.appendChild(d)},pimGui.merge(d,{onclick:e.close.bind(e)},{backgroundColor:"rgba(0,0,0,0.72)",position:"fixed",top:0,bottom:0,left:0,right:0,zIndex:100}),c=[].concat(b).map(function(a,b){return pimGui.pimButton(a.name||"BTN"+b,a.bind(e))}),a.push(c),e.appendChild(pimGui.pimGroup.apply(pimGui,a)),e.open(),e}var z,A=a("./pim_scene").pimScene;this["pimTable->addItem"]=function(){},this["pimTable->populate"]=function(){},this["pimTable->selectAll"]=function(){},this["pimTable->deleteSelected"]=function(){},this["pimTree->populate"]=function(){},"undefined"!=typeof Image&&(z=new Image,z.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAACACAIAAADS5vE8AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAEiVJREFUeNrcnY2SwigMx4H6Gjf3/s9oSW61XwGSkGrTkdtxnFpd9//rBgghpBGfz/D3EwPzw55UznM/eOrD5pPN+bEB3NT/fRiDJ8AjzHMhKgpKo0wQT/Ch+SWqJ2UDGhLgLvXXAzxCzn2CKFDG7XvoGeQ50CAQ1ZfLMZI/azagXwfwV+8FUPZAUdDLosRSe5CxSiGKRjR8GLUeaFQAZ/WOAH8G9CxkxmB9iQ2EYP+VkG9eciftin8RIKK3el8A0gNRddKxdBK5oZicpH+5VWE8bk8KBjQSQGtADuodAUoDah/tW1i++/cyceM214e2KqSTQf4A1N/GqhwG4C71XgDEiZYIEkFJHBPIQ7HsyJ19fGFAPw1wr/rrAZYeCA85SbD5RXsmx2yAQrV8VjtwZ4L8bvPJSu5gAP7qPQEiNaC02XPimCgHkLcM8iUUVl3ePgbbn6o+BqIBDQlwr/qrAQ4DSpuuVEKkbZiNTU/KBgj2X1cnA1RIKxOaD9BfEQxoVIAb1TsAxNUHwsM3w9JV218meWaZBLcNj0B6d4AF+bmVD0UbiYLiMQCc1dudno8AXgb0fL6mkqm0/+U5ES8fS8OmH65iBGpnquuVTqpYcdM6JMBy7e9SfzVAXKbxO8SuKJI+cZdPz1DW2PSOthgKcqpzc1I5Lg1oSID92rup9wSoDejvb04lARL5iZspTnJDkJfg2K4TBOHVmawZ0HgA1IDc1LsB1AaUyn6Q2ms7d0zb96TGsmPf+zcaeebkg2hA4wHQa++p3gcgLqvxEWu9FUHS8k2OT0ZOczRBSA/9+kOtYDyAe9VfDfCexj+LVoDkQIpxs/LZR+xMAKCByIJ86UzZgMcDSOit3hNgjQMtBjQ1C2dt+gkrIHKLnHIfapxTShC5bhf7xR8SYDcgf/UOAIUB7d7aVGpRslGALMagkIHE5Szp43AmB7l3puk8BwPYDchZvQ/AYUDTpj2UB6FBqZ6BaxoNhL4GI429lfzMMZUNeDyAhDeodwNYDSghn6H2EPIoY2P87BAd6lgEmo0/lzZfXXZ6sF3/UQES3qPeByDCZkB717nbf9iW1SpFVRqBsvivjsMg2D9yTSDLL/HwOIcESHiz+ksB3gb0BwG19qBqp7kqknbsTwDQ0G+2L2fRgIYESOiq3hkg/RlQngOAZrdKyhOUq8aspx87cwApRNIezyXQvLbR1Gt4Pw1wo3oHgLT6QKDlsUXSn7bpT+YOdD8NwhqM1BDY5pCLHkhPxPtpgIT3qPcBOAyIdd8Xmbk8rppAEjpQuQ8NhjiodMHn5hiPBYAhAfYJjJt6T4DCgKqc7Kr3zGW/mchfrxaFe3E4PRuFjTwAB9EY0JAAdAbsrN4BoDYgqj2XBIkzeGy6xhSMP5bsJtZiZs2AxgNgQyj+6i8CYAyIjTlQ+4cyEMEuB6thLBD8t+40YNeuGtBgAJUB+ah3A3gZ0N8sDOHIcsuC3798VSLaE6cnMOMwCqFQUNeCWZe5euudzj2VaXqDAUzord4TIAGZhbUbaBPZSJIbm68CUUmbCVTLhNDkbXdXYnLT/c+rAWGzi3wkAMQb1LsBvAzo+dcKgJ8+prIPBQIEZEEvcVtghRU8vQlkIZBe9Z7L47kOYSAHUAYAAHRV7wyw+kAITLwzlbPG1PRwidtUdN5zA0MfCvI4jMeGhSEBEt6p/mqA1Qei25PaPZKpMX4hu10KaaF5Hc/iwtF3Nx8ohWEBJvRW7wmQctMDBY4gcdYpbXs9b//dYNZMhFfdKNYVTgYDQLxT/dUAhQGxTSBt3n8yyA9aMEtJhuvOAUCIRZQGNCQA4j3qfQBqA4ql2Scyd4TeTvvQcETekQvqzn22CcyCC9EY0HgAiDeodwPoG9ACMXENgRUQtJw++zichcesDWFDAugGdJ16H4C3AeWAuVadGogk9HMnM7GCIS0lm5f15mJb/5AAiLepdwCY8hKJzh2ISZ7o9YoSdUvT2IOgqhM9KgCiq3pnAFwj0VsPNAvyc8Mh1SsxTwCgl9INZQ7czIWhmx5oPADaAzmrdwA4DGiXP3Md6EQWYyZDExCq9oWTKd3tAkw7m8Sj9tKQAIiu6p0BXgaUn68hLG9b++nEcSJfNZljEfJ6wKlNJWwUopoPPNdv3sO2QwL4q3cDgHlJqs9r2GEuCahwesyWrrJFIaQRGIWtm1nIxCJLGTRuMh5AxHvUewGQISxtb9EYViYoaHDewrfrMXudPnb1hYsDBeKADglwu/rrALAyoNbyq/5sUssznlmGkR6Z285fjcCyAQ0J4KneGeBtQM/CgCbSECbSqwqlMSwbk+xrwVmYRyprYVAb0HgAN6q/GgCWQOKU65EuNc5ba5RtWhK75KLWCIXe5rZuciUW/f14ABFvU+8BsC5l5MP+5/fz1CQVQdO35vfubSmcfmYdr9sKQHDh5mMWNjCAv3o3AKQGtMufSWeahTGxnQYGsVYWqondxlYwi6vxobn+gwE4q/cEeBnQ87ka0GM7Pwn9liUQoe5rQKHStRLGAnUS+XYh9qJeQwIg3KPeBwCWHujv1NRoz8LYe3I1D+XaRmCr0KevJsFaq3RgAE/1zgCvHuhVZDMfxj+pezlAWI/pzSMtS8DdxV92czCuu/BGBfhzop3V+wKQHmgq/xGZK8/A1i83zCO7N6mqetIsDMJtG8ajBxoVwF+9GwCuBjQfEFIrQFJjGnshCHOJQWhiWK33D2pCGRQGNCTALep9AF4GlEsDegjev7EDlYqjn8xGkUbgalvVFoejF38wgAj3qHcCgOVuPVnLH8qqL2epZ2woE4q2XCZOV7J+8CcBEtym3gEgLjtTcT7sfyatAGQXDgw9aS+GBYZcJlAnMc/aBxoSwFm9K8CyFrYMYbv8FiJzd6lgUwo+KpQLailcPQ739oHmMDLALep9ANZI9GJArfxuBwrqHpOoaYdeIF2ZQTZrkXsIdzyACDeo9wOoDEgyfr0PBdNasCUIaulDZ82AxgOgBuSp3gmABhLtXpyU0m2usWy54UdudrNd50T/EMAHTvQX6q8GiPkB8/voccb1ByGln5shQqzfAcPNzexb3HDtgUYFiOiqPkTmzesA/gxotke9Ua5ADVu2dfWYwoxM6A+E78jXJGsODHC1+oB88PUygNKAuiVgUYgXzCQCr17/Krktc6H6LwpQjA3goL41oIsBHrmbb4Qn19rKoTOrwymoi4VgqCJgSJgaAMBNfQjOAI+nnvGo1PFkgZbxHEgDhqPfrG4UAXLSgq7d3AMNBuCgPkAxcl0PQIawsxvvW+G5XFBern8qlq7YtnA20orXVA74LQAf9SHVi4cXA7wNyFJ5SBp7H83LmSR4pfCcCr3zyemGsvnyZOmk3wXwVP938AyeAGUPRN8FcxlGaIyfELQ+aDdVSomS9ZY6BwbwUc860VcCPKDF0e2/W4axfHTjY9JCD3xYhXR4gEvVh+AJEBcnGrvxh3YcRq4/ncqXz3cDhmLsbdPa9u/Ltlpu59NOBwBwU7840V4AcRnCUNn7UdliJn9LupvdVCS5Lz6oFHyg9o/lpamaQDAF6QcG8FG/O9EuAJsBobzrA7nUgSz0pzSYNa0u3JyYO6Rk4aauaFhkNiSNDwbgqZ7Owq4HiEsgEbupamiuwVg9nu/l2jPBrG4f+lGu3a8DuKkPDy3K+C3A2wdCMoR9kDXLrvZPR6mtfRJDx9svp49nbmbx6wDO6uks7HqA9xAWjxvGnNgzBHKu49Z1rtc/deaRCofUn8biXxDVBvzrAM7qQ2IWUy8DIE409mYCxvwEWp6kuf5ZHYTzV4sBYwO4qW99oCsBylnYqSJo7NYzrkik0oBBTpjq1rD9uorbLwI4qNd7oG8BGgNSCsFaisgkplH8Xf8PNqywBOeLt40HcLX6kPppkZ8DvA0I3/EgdnujLjxxw28uK/3F8EzawKvMBMyF3Nj58TAAzupfi3nBDaCMA1lSZnErbNQCVcPvvMqX4nBtp9ndt2uYww8J4KleCSReANBEolG+jYsyFKdGO7H/Ng43Cysx2CujZHOARgXwUc8GEi8DKGdhwVDIfDd1Wjw9ERcukoNY5GMZ+83cuxWN7c6ggwG4qacJZdcDcD2Q5Y6IwJVTn5o7E6V3IDeJ93uEXg2l8ynFAwP4qA9Ju+PmtwBnpvEo13qko+5c33SvDaPoxT/1rDi1+sTwAA7q2TjQZQDrWhicjWRBaef0Ud02LTBhlLk3j7REIb4Lxf0cgJt6Ng50GUBapvFg31dC5bM0sTwg1/9UIELZeSl7n0MCOKsPqe8DfQ6QliEMPiikx6quCN63oMlgWghmx+R2HmuowDUqgI/6ANal+E8AiAGhrQAICxGb3jMe64SsCzHL2o3+m5xUMySAm3rJB7oGIIVIeqCwlc+fzo/Gmdyzq+SgcThpV1I7fUT5Rny9JYGxAa5WXwUSLwZohjCl+ofSClrh8ahOMycmGW7mQhDskAtyLCKeK1/y6wA+6oOQT3kNQGlA9lhELu9Syqnef2Y1lq7vKzmZlDg8gIP6oMbRvwUofaAPqlFTb40+5qOF7XG4Wd2GcqoM+/l8oF8HcFMfmjDolQCbAbVglqoxsWkRbVvA1/XvpnQrW/tpQwimvNDxADzVLwbkBUCcaMnyk+C5RWL8oREe+Os/q1WvThUANMegxwBwU18Z0MUAjQ8kreYlzvip5cO6C1K5/q3zBrZ0JjhRnWN4gKvVUwO6HoAbwpS2QO2/5QikUczHySUON6t3wQNuMoAnsorHBvBUvwcSXQA4J5pNiYvlM+0692d6XaYtjAXiYvY3XpzgBg0M4KZeWY2/AICLA+2S6SBccVQomdh/0x1XkxhJNQoh9NDPBGKrEowH4KM+GMz/cwDOB6o+TyHadkHlz/z1UBpwWx4d5fpc4Vxe/cAAl6rXe6BvAdKyMxVQTqukZr8fsz9CBB7iuUxuSwgCSSwX+RWmYQAQXdUvZX69AF7T+NWBx15xkf3m2oFfRxAXd6J1I7exoP+ZHWHDALiptxjQVwCvrc0Ze1PJSLqxasGXDUGQ34VkTYCzF+nDemtAGBfAWf2f2UFwA8DFB8pBHWZpNxrKMKeUzzIdI/B+/UHYC5lPCjeH4kYCcFNPDeh6AFx8oKyvCFNrDw3H/ovT9rwFsNbrH5lbCLF12j6oM4v8tqqRAJzV77c6cAGAgK+c6IxqK2hRpAGE/mM3t325/jOpjGS8oXWbXiCtHKlFTgcA8FS/G5ATQCRDmBLGCoLxS4l06cjIpQ1YP7CEsdQdDQMDuKmveqCLAYgP1J0JYBsvIomTuG02mTaCabP/xMvMauUb7O3MPj+V+XUAH/UhiYovAMClSmv+DGX/nlTSUBcuvvYOWWpsGUuani9xMR7ApepfAMENAIoeaB88J9nysVjnLYhp0JRke0Pkt1x313/hXJXx/wOAg/oQebnXAOCysfCYxkc5GhrIZAC5AHvkz1iuPxoKXNsyEkcFcFNvNKDPAd49EJIl3ViW20/kOZAdAKH8ZEUAfANuc0xykzSO6o2J5TDKwACe6isDuhigjAO1KYuhjICGMnsglihxE56KndnSnYtQVqpob2cf5fUfD8BZfQieAFBEoiNHULWCMkRVtJpYZiGAeP1R3jpryWWSp2ADA7ipD8EToJnG054RNgtno6FUeCoJEvmqt0MIQqIAykzKvWJ6m4NHBXBTH4IbwOZEY5PZVqYkHRzVIh6W8iMZfreXENff7spX9mHbbtY2KoCn+sUHcgQgcSDk9tmmclmPmn0se8926W+LQrS7LYPgmGVDIKSXiTUqgI/6EDwBYOmBZgVISmGCJp9gbx2peEta6AlcWIytbxI+vIn22AAXqVeW2q4BeMy7AaG4MeTw1iK3Llz1rdC5/sFwIPkMcnWO4QF81IfgDEACiVGAgKa7DHKSQazfwmiVH2SU0IkiDg/gpv5UCzgNsNZInKlPzxIil42iJKqQZ4xakMPyLL3FXf8hATzVUwNyAXg8qQ+E8v8FuZQCy0vuz6J88tS7PU90MAA39V4AePhAVRRC6lsjl8sUhQSnyK8Cho+OseMujA3grN4RgDjRiiMX1N0AUdwQYP9iiztpnnmNCuCm3hEg2jeI1CndsXdd3uNzRG3eeur7rvgZG+C8+r8PxOAJ8Pjn33/neT6NYiQI6/U/dUViuOFnbACz+t2AXAAej8d/AgwA78BwrhhSWeIAAAAASUVORK5CYII="),this["pimSplines->addSpline"]=function(){},this["pimSplines->redraw"]=function(){},this["pimSplines->clearSplines"]=function(){},c.pimGui={pimButton:e,pimEdit:h,pimCombo:i,pimLabel:f,pimGroup:m,pimHGroup:l,pimSelectable:j,pimCheck:k,pimTable:n,pimTree:p,pimTabs:r,pimCRUD:o,pimSpliner:t,pimSlider:g,pimColor:q,pimTrackDisplay:s,pimMenu:x,pimModal:y,hflex:u,vflex:v,grow:w,merge:d}},{"./pim_scene":16}],6:[function(a,b,c){function d(a){return this.x=1/3,this.x=0,this.y=1/3,this.y=0,this.z=1/3,this.z=0,this.h=1/3,this.h=0,this.p=1/3,this.p=0,this.b=1/3,this.b=0,this.xs=1/3,this.xs=1,this.ys=1/3,this.ys=1,this.zs=1/3,this.zs=1,this.px=1/3,this.px=0,this.py=1/3,this.py=0,this.pz=1/3,this.pz=0,this.ph=1/3,this.ph=0,this.pp=1/3,this.pp=0,this.pb=1/3,this.pb=0,this.bx=1/3,this.bx=0,this.by=1/3,this.by=0,this.bz=1/3,this.bz=0,this.bh=1/3,this.bh=0,this.bp=1/3,this.bp=0,this.bb=1/3,this.bb=0,this._x=new f,this._y=new f,this._z=new f,this._h=new f,this._p=new f,this._b=new f,this._xs=new f,this._xs.cachevalue=1,this._ys=new f,this._ys.cachevalue=1,this._zs=new f,this._zs.cachevalue=1,this.name=a,this.origName=a,this.parent=null,this.calcCount=-1,this.bcalcCount=0,this.bcalcCounts=0,this.bcalcCountt=0,this.mtx=mat4.create(),this.mtx2=mat4.create(),this.bsmtx=mat4.create(),this.btmtx=mat4.create(),this.restLength=1,this.followid=0,this.follow=null,this.followerFlags=[1,1,1,1,1,1,1,1,1],this.changed=1,this.vChanged=1,this.active=!0,this.morphs=[],this.swm=null,this.weightmapName="",this.selected=0,this.mouseTracked=!1,this.visible=!0,this.rayTransparent=!1,this.rayLevel=0,this.shadowOptions=7,this.ss=0,this.id=0,this.pid=0,this.tid=0,this.timeslip=0,this.animtime=void 0,this.replaceTarget="",a instanceof d?function(){var b,c,d;for(b in a)if(a.hasOwnProperty(b))if(a[b]instanceof f)this[b]=new f(a[b]);else if(b in{id:1,pid:1,btmtx:1,bsmtx:1,mtx:1,mtx2:1,changed:1,bcalcCount:1,bcalcCounts:1,bcalcCountt:1});else if(a[b]instanceof Float32Array)this[b]=mat4.create(a[b]);else if(a[b]instanceof Function);else if("morphs"==b){this.morphs=[];for(c in a[b])a.morphs[c]instanceof f?(d=new f(a[b][c]),d.name=a[b][c].name,this.morphs.push(d)):this.morphs.push(a.morphs[c])}else this[b]=a[b]instanceof Array?a[b].slice(0):a[b];return this}.bind(this)():this}var e,f=a("../src/pim_spline.js").pimSpline;d.prototype.__defineSetter__&&(d.prototype.__defineSetter__("position",function(a){this.x=a[0],this.y=a[1],this.z=a[2],this.changed=1}),d.prototype.__defineGetter__("position",function(){var a=new Float32Array(3);return a[0]=this.x,a[1]=this.y,a[2]=this.z,a}),d.prototype.__defineSetter__("rotation",function(a){this.h=a[0],this.p=a[1],this.b=a[2],this.changed=1}),d.prototype.__defineGetter__("rotation",function(){var a=new Float32Array(3);return a[0]=this.h,a[1]=this.p,a[2]=this.b,a}),d.prototype.__defineSetter__("scale",function(a){this.xs=a[0],this.ys=a[1],this.zs=a[2],this.changed=1}),d.prototype.__defineGetter__("scale",function(){var a=new Float32Array(3);return a[0]=this.xs,a[1]=this.ys,a[2]=this.zs,a})),d.prototype.__defineSetter__&&[["Name","name"],["ShadowOptions","shadowOptions"],["RayTransparent","rayTransparent"],["Visible","visible"],["MouseTracked","mouseTracked"]].forEach(function(a){d.prototype.__defineGetter__(a[0],Function("console.log('%cChange "+a[0]+" into "+a[1]+"'+new Error().stack.split('\\n',3)[2],'background:#FFCCCC; color:black'); return this."+a[1]+";")),d.prototype.__defineSetter__(a[0],Function("console.log('%cChange "+a[0]+" into "+a[1]+"'+new Error().stack.split('\\n',3)[2],'background:#FFCCCC; color:black'); this."+a[1]+" = arguments[0];"))}),d.prototype.distanceTo=function(a){var b=this.evaluateMatrix(),c=a.evaluateMatrix(),d=[b[12]-c[12],b[13]-c[13],b[14]-c[14]];return Math.pow(d[0]*d[0]+d[1]*d[1]+d[2]*d[2],.5)},d.prototype.rayTrace=function(a,b,c,d,e,f,g){var h,i,j=this.rayTransparent;return this.rayTransparent=1,h=this.evaluateMatrix(),void 0!=e&&mat4.translate(h,[e,f,g]),i=pimRay.intersect([h[12],h[13],h[14]],[-b,-c,-d],a),this.rayTransparent=j,i},d.prototype.raytrace=d.prototype.rayTrace,d.prototype.squeezed=function(){if(0==this.xs)return!0;for(var a=this.parent;a;){if(0==a.xs)return!0;a=a.parent}return!1},d.prototype.evaluate=function(a){var b=this.follow||this;return b._x.nrKeys&&(this.x=b._x.evaluate(a)),b._y.nrKeys&&(this.y=b._y.evaluate(a)),b._z.nrKeys&&(this.z=b._z.evaluate(a)),b._h.nrKeys&&(this.h=b._h.evaluate(a)),b._p.nrKeys&&(this.p=b._p.evaluate(a)),b._b.nrKeys&&(this.b=b._b.evaluate(a)),b._xs.nrKeys&&(this.xs=b._xs.evaluate(a)),b._ys.nrKeys&&(this.ys=b._ys.evaluate(a)),b._zs.nrKeys&&(this.zs=b._zs.evaluate(a)),this.changed=1,this},d.prototype.evaluateMatrix=function(){var a,b=-1;if(!this.changed)for(a=this.parent;a&&(b=Math.max(a.calcCount,b),this.changed|=a.changed||b>this.calcCount,a=a.parent,!(this.changed||b>this.calcCount)););return this.vChanged=this.vChanged||this.changed,this.changed?(this.calcCount++,null!=this.parent?mat4.set(this.parent.evaluateMatrix(),this.mtx):mat4.identity(this.mtx),mat4.translate(this.mtx,[this.x,this.y,this.z]),this.ph&&mat4.rotateY(this.mtx,this.ph),this.pp&&mat4.rotateX(this.mtx,this.pp),this.pb&&mat4.rotateZ(this.mtx,this.pb),this.h&&mat4.rotateY(this.mtx,this.h),this.p&&mat4.rotateX(this.mtx,this.p),this.b&&mat4.rotateZ(this.mtx,this.b),mat4.scale(this.mtx,[this.xs,this.ys,this.zs]),mat4.translate(this.mtx,[-this.px,-this.py,-this.pz]),this.changed=0,this.mtx):this.mtx},d.prototype.boneSpace=function(a){return this.bcalcCounts&&!d.calcCount?this.bsmtx:(this.bcalcCounts++,mat4.identity(this.bsmtx),this.bb&&mat4.rotateZ(this.bsmtx,-this.bb),this.bp&&mat4.rotateX(this.bsmtx,-this.bp),this.bh&&mat4.rotateY(this.bsmtx,-this.bh),this.pb&&mat4.rotateZ(this.bsmtx,-this.pb),this.pp&&mat4.rotateX(this.bsmtx,-this.pp),this.ph&&mat4.rotateY(this.bsmtx,-this.ph),mat4.translate(this.bsmtx,[-this.bx,-this.by,-this.bz]),this.parent&&this.parent!=a&&mat4.multiply(this.bsmtx,this.parent.boneSpace(a)),this.bsmtx)},d.prototype.boneTransform=function(a){if(this.bcalcCountt==d.calcCount)return this.btmtx;this.bcalcCountt=d.calcCount;var b=this.btmtx;return null!=this.parent&&this.parent!=a?mat4.set(this.parent.boneTransform(a),b):mat4.identity(b),mat4.translate(b,[this.x,this.y,this.z]),this.ph&&mat4.rotateY(b,this.ph),this.pp&&mat4.rotateX(b,this.pp),this.pb&&mat4.rotateZ(b,this.pb),this.h&&mat4.rotateY(b,this.h),this.p&&mat4.rotateX(b,this.p),this.b&&mat4.rotateZ(b,this.b),mat4.scale(b,[this.xs,this.ys,this.zs]),this.btmtx=b,b},e=mat4.create(),d.prototype.boneMatrix=function(a){return this.evaluateMatrix(),this.bcalcCount==d.calcCount?this.mtx2:(this.bcalcCount=d.calcCount,mat4.multiply(this.boneTransform(a),this.boneSpace(a),this.mtx2),this.mtx2)},d.prototype.hasKeys=function(){for(var a in["x","y","z","h","p","b","xs","ys","zs"])if(this["_"+["x","y","z","h","p","b","xs","ys","zs"][a]]&&this["_"+["x","y","z","h","p","b","xs","ys","zs"][a]].nrKeys>1)return!0;return!1},mat4.toHPB=function(a,b,c,d){var e,f=Math.asin(-a[9]/Math.sqrt(a[8]*a[8]+a[9]*a[9]+a[10]*a[10]));return e=Math.cos(f)?[Math.atan2(a[8],a[10]),f,Math.atan2(a[1],a[5])]:[2*Math.PI-Math.atan2(a[2],a[0])-(d||0),f,d||0],void 0!=b&&(e[0]=e[0]-2*Math.round((e[0]-(b||0))/(2*Math.PI))*Math.PI,e[1]=e[1]-2*Math.round((e[1]-(c||0))/(2*Math.PI))*Math.PI,e[2]=e[2]-2*Math.round((e[2]-(d||0))/(2*Math.PI))*Math.PI),e},d.prototype.rotate=function(a,b){var c=mat4.create();
return mat4.identity(c),this.parent&&mat4.multiply(c,this.parent.evaluateMatrix()),mat4.rotateY(c,this.h),mat4.rotateX(c,this.p),mat4.rotateZ(c,this.b),mat4.rotate(c,a,b),this.rotation=mat4.toHPB(c,this.h,this.p,this.b),this.changed=1,this},d.prototype.Rotate=d.prototype.rotate,d.prototype.rotateHPB=function(a,b,c){var d=mat4.create();return mat4.identity(d),mat4.rotateY(d,this.h),mat4.rotateX(d,this.p),mat4.rotateZ(d,this.b),mat4.rotateY(d,a),mat4.rotateX(d,b),mat4.rotateZ(d,c),this.rotation=mat4.toHPB(d,this.h,this.p,this.b),this.changed=1,this},d.prototype.lookAt=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n;return void 0==c&&(c=this),void 0==b&&(b=[0,1,0,1]),this.changed=1,a.changed=1,d=this.evaluateMatrix(),mat4.multiplyVec4(d,b,b),e=this.rotation,this.h=0,this.p=0,this.b=0,this.changed=1,d=this.evaluateMatrix(),d=mat4.inverse(d,mat4.create()),null!=d&&(f=mat4.create(),a.changed=1,mat4.multiply(d,a.evaluateMatrix(),f),g=[0,0,0,1],h=vec4.create(),mat4.multiplyVec4(f,g,h),vec3.normalize(h),0!=vec3.length(h))?(i=vec4.create(),mat4.multiplyVec4(d,b,i),vec3.normalize(i),j=vec3.create(),j[0]=-h[0],j[1]=-h[1],j[2]=-h[2],vec3.normalize(j),k=vec3.create(),vec3.cross(j,i,k),l=vec3.create(),vec3.cross(k,j,l),m=mat4.create(),m[0]=k[0],m[1]=k[1],m[2]=k[2],m[3]=0,m[4]=l[0],m[5]=l[1],m[6]=l[2],m[7]=0,m[8]=-j[0],m[9]=-j[1],m[10]=-j[2],m[11]=0,m[12]=0,m[13]=0,m[14]=0,m[15]=1,n=mat4.toHPB(m,e[0],e[1],e[2]),this.h=n[0],this.p=n[1],this.b=n[2],this.changed=1,this):void 0},d.prototype.LookAt=d.prototype.lookAt,d.prototype.alignDir=function(a,b,c){var d,e,f,g,h,i,j,k,l,m;return this.h=0,this.p=0,this.b=0,this.changed=1,void 0==c&&(c=vec4.create([0,1,0,0]),mat4.multiplyVec4(a.evaluateMatrix(),c,c),vec3.normalize(c)),d=mat4.inverse(this.evaluateMatrix(),mat4.create()),a.evaluateMatrix(),b.evaluateMatrix(),i=mat4.multiplyVec4(d,[a.mtx[12],a.mtx[13],a.mtx[14],1],vec4.create()),j=mat4.multiplyVec4(d,[b.mtx[12],b.mtx[13],b.mtx[14],1],vec4.create()),k=vec3.normalize(vec3.subtract(j,i)),0!=vec3.length(k)?(Math.abs(vec3.dot(c,k))>.95?(l=vec4.create([1,0,0,0]),mat4.multiplyVec4(a.evaluateMatrix(),l,l),vec3.normalize(l),f=l,h=vec3.normalize(vec3.cross(k,f,vec3.create())),g=vec3.normalize(vec3.cross(h,k,vec3.create()))):(e=vec3.normalize(mat4.multiplyVec4(d,c,c)),g=vec3.normalize(vec3.cross(e,k,vec3.create())),h=vec3.normalize(vec3.cross(k,g,vec3.create()))),m=mat4.create(),m[0]=g[0],m[1]=g[1],m[2]=g[2],m[4]=h[0],m[5]=h[1],m[6]=h[2],m[8]=k[0],m[9]=k[1],m[10]=k[2],this.rotation=mat4.toHPB(m,0,0,0),this.changed=1,this):void 0},d.prototype.addKey=function(a){this._x.addKey(a,this.x),this._y.addKey(a,this.y),this._z.addKey(a,this.z),this._h.addKey(a,this.h),this._p.addKey(a,this.p),this._b.addKey(a,this.b),this._xs.addKey(a,this.xs),this._ys.addKey(a,this.ys),this._zs.addKey(a,this.zs)},d.prototype.clear=function(){this._x.clear(),this._y.clear(),this._z.clear(),this._h.clear(),this._p.clear(),this._b.clear(),this._xs.clear(),this._ys.clear(),this._zs.clear()},d.prototype.align=function(a,b){var c,d,e=a.rotation;return b&&a.lookAt(b),a.changed=1,c=mat4.create(a.evaluateMatrix()),c[12]=0,c[13]=0,c[14]=0,d=mat4.identity(),this.parent&&mat4.inverse(this.parent.evaluateMatrix(),d),this.rotation=mat4.toHPB(mat4.multiply(c,d,c)),a.rotation=e,this},d.prototype.alignOffs=function(a,b){var c,d=mat4.create(a.evaluateMatrix());return d[12]=0,d[13]=0,d[14]=0,c=mat4.identity(),mat4.rotateY(c,b[0]),mat4.rotateX(c,b[1]),mat4.rotateZ(c,b[2]),mat4.multiply(c,d,d),this.parent&&mat4.multiply(mat4.inverse(this.parent.evaluateMatrix(),mat4.create()),d,d),this.rotation=mat4.toHPB(d,this.h,this.p,this.b),this.changed=1,this},d.prototype.translate=function(a,b,c,e,f,g){void 0==e&&(e=this.h),void 0==f&&(f=this.p),void 0==g&&(g=this.b);var h=mat4.create();return mat4.identity(h),this.parent&&mat4.multiply(h,this.parent.evaluateMatrix()),e instanceof d?(e=e.evaluateMatrix(),e[12]=0,e[13]=0,e[14]=0,mat4.multiply(h,e)):(mat4.rotateY(h,e),mat4.rotateX(h,f),mat4.rotateZ(h,g)),mat4.translate(h,[a,b,c]),this.parent&&mat4.multiply(mat4.inverse(this.parent.evaluateMatrix(),mat4.create()),h,h),this.x+=h[12],this.y+=h[13],this.z+=h[14],this.changed=1,this},d.prototype.Translate=d.prototype.translate,c.pimInstance=d},{"../src/pim_spline.js":18}],7:[function(a,b,c){function d(a){this.arr=a,this.stream=new DataView(a),this.pos=0}function e(a,b){this.tag=a,this.data=b}function f(a,b,c,d){return new g(a,c,b,d)}function g(a,b,c,d){var e=a;"undefined"!=typeof File&&a instanceof File&&(e=a.name),g.lowercase&&(e=e.toLowerCase()),this.url=e,K[e]?K[e+"_"+c]?setTimeout(function(){b(K[e+"_"+c])}.bind(this),0):setTimeout(function(){var a=K[e];this.read(a,e.replace(/[^\\\/]*$/,""),function(a){K[e+"_"+c]=a,b(a)},c,e)}.bind(this),0):L.fileAsArray(a,d?d.link():void 0,function(a,c,d){K[c]=d,this.read(d,c.replace(/[^\\\/]*$/,""),function(d){K[c+"_"+a]=d,b(d)},a,c)}.bind(this,c,e))}var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L=a("./pim_utils").pimUtils,M=(a("./pim_gui").pimGui,/[^\\\/]*[\\\/]/gm);d.prototype.__defineGetter__&&d.prototype.__defineGetter__("length",function(){return this.stream.byteLength-this.pos}),d.prototype.skip=function(a){this.pos+=a},d.prototype.readByte=function(){return this.stream.getUint8(this.pos++)},d.prototype.readShort=function(){return this.pos+=2,this.stream.getUint16(this.pos-2)},d.prototype.readLong=function(){return this.pos+=4,this.stream.getUint32(this.pos-4)},d.prototype.readFloat32=function(){return this.pos+=4,this.stream.getFloat32(this.pos-4)},d.prototype.readFloat64=function(){return this.pos+=8,this.stream.getFloat64(this.pos-8)},d.prototype.readBlob=function(a,b){a+=a%2;var c=void 0!=b&&b?"":this.arr.slice(this.pos,this.pos+a);return this.pos+=a,c},d.prototype.peekBlob=function(a){var b=this.arr.slice(this.pos,this.pos+a);return b},d.prototype.readVX=function(){var a=this.readShort();return a>=65280&&(this.pos-=2,a=16777215&this.readLong()),a},d.prototype.readTag=function(){var a,b;if(this.length<4)return!1;for(a="",b=0;a.length<4;)a+=String.fromCharCode(this.readByte());return a=a.replace(/^\0/,"")},d.prototype.readStr0=function(){for(var a,b="";a=this.readByte();)b+=String.fromCharCode(a);return 1&this.pos&&this.pos++,b},d.prototype.readChunkSize=function(a){return this.length<=4+a?!1:new e(this.readTag(),this.readBlob(2==a?this.readShort():this.readLong()))},d.prototype.readChunk=function(){return this.readChunkSize(4)},d.prototype.readSubChunk=function(){return this.readChunkSize(2)},d.prototype.readAllChunksSize=function(a){for(var b,c=[];b=this.readChunkSize(a);)c.push(b);return c},d.prototype.readAllChunks=function(){return this.readAllChunksSize(4)},d.prototype.readAllSubChunks=function(){return this.readAllChunksSize(2)},e.prototype.__defineGetter__&&e.prototype.__defineGetter__("length",function(){return this.data.length}),i=0,j=1,k=2,l=3,m=4,n=5,o=6,p=7,q=8,r=9,s=10,t=11,u=12,v=13,w=14,x=15,y=16,z={CHAN:{channel:i},ENAB:{enabled:l},NEGA:{negative:l},OPAC:{type:l,opacity:s,envelope:r}},A={CNTR:{center:n,envelope:r},SIZE:{size:n,envelope:r},ROTA:{rotation:n,envelope:r},FALL:{type:l,falloff:n,envelope:r},OREF:{reference:m},CSYS:{coordinateSpace:l}},B={ENAB:{enabled:l}},C={TBLK:{syntax:H,blocks:q},BLOK:{syntax:G,blocks:q}},D={STIL:{still:m},ANIM:{anim:m,tp:m},XREF:{xref:p},FLAG:{flags:p}},E={},F={NSNS:{normalSpace:p},NSNO:{blocks:q},VPVL:{blocks:q},IMGS:{blocks:q},CLIP:{syntax:D,blocks:q},TBLK:{blocks:q},BLOK:{blocks:q},VMAP:{vmap:m},STIL:{still:m},PROJ:{projection:l},VPRM:{unknown1:p,unknown2:p,blocks:q}},G={IMAP:{syntax:z,ordinal:m,blocks:q},TMAP:{syntax:A,blocks:q},PROJ:{projection:l},AXIS:{axis:l},PIXB:{pixelBlending:l},AAST:{type:l,antiAlias:s},IMAG:{image:r},VMAP:{vmap:m},AUVO:{dunno:l,auvx:y,auvy:y,ex1:y,ex2:y},AUVN:{name:m},AUVU:{name:m},WRAP:{wrapX:l,wrapY:l},WRPW:{wrpW:s,envelope:r},WRPH:{wrpW:s,envelope:r},SHDR:{syntax:B,nr:l,blocks:q},FUNC:{syntax:F,name:m,blocks:q}},H={COLR:{color:n,envelope:r},LUMI:{luminosity:s,envelope:r},DIFF:{diffuse:s,envelope:r},SPEC:{specular:s,envelope:r},GLOS:{glossiness:s,envelope:r},REFL:{reflection:s,envelope:r},TRAN:{transparency:s,envelope:r},ADTR:{additiveTransparency:s,envelope:r},RIND:{refraction:s,envelope:r},TRNL:{translucency:s,envelope:r},BUMP:{bump:s,envelope:r},SMAN:{sman:s},SIDE:{doublesided:l},BLOK:{syntax:G,blocks:q},RIMG:{reflectionImage:r},RFOP:{reflectionOptions:l},VERS:{version:p},NODS:{blocks:q},NVER:{nodeVersion:p},NNDS:{blocks:q},NSRV:{dunno:m},NTAG:{blocks:q},NROT:{blocks:q},NLOC:{x:s,y:s},NZOM:{zoom:s},NRNM:{dunno:m},NNME:{dunno:m},NCRD:{x:p,y:p}},I={NAME:{name:m},"PRE ":{pre:l},POST:{post:l},"KEY ":{lastTime:s,lastVal:s},TYPE:{format:x,keytype:x},SPAN:{spanType:i,t:s,c:s,b:s}},J={FORM:{formType:i,formBlocks:j},TAGS:{tags:k},LAYR:{lnr:l,flags:l,pivot:n,name:m,parent:l},BBOX:{min:n,max:n},PNTS:{points:o},VMAP:{mapType:i,dimension:l,mapName:m,values:v},CLIP:{syntax:D,clipIndex:p,blocks:q},SURF:{syntax:H,surfName:m,source:m,blocks:q},ENVL:{syntax:I,envlIndex:r,blocks:q},POLS:{type:i,poly:t},PTAG:{tagType:i,tags:u},VMAD:{mapType:i,dimension:l,mapName:m,values:w}},e.prototype.byTag=function(a){var b,c=this.formBlocks||this.blocks;for(b=0;b<c.length;b++)if(c[b].tag==a)return c[b]},e.prototype.unfold=function(a,b){var c,e,f,g,h,z,A,B,C,D,E=function(){};if(void 0==a&&(a=J),void 0==b&&(b=""),c=a,e=new d(this.data),a[this.tag]){f=a[this.tag],E(b,this.tag);for(g in f){if("syntax"==g)c=f[g];else if(e.length)switch(1*f[g]){case i:this[g]=e.readTag();break;case l:this[g]=e.readShort();break;case m:this[g]=e.readStr0();break;case r:this[g]=e.readVX();break;case s:this[g]=e.readFloat32();break;case p:this[g]=e.readLong();break;case x:this[g]=e.readByte();break;case y:this[g]=e.readFloat64();break;case n:this[g]=[e.readFloat32(),e.readFloat32(),e.readFloat32()];break;case j:this[g]=e.readAllChunks(),E(b,this.tag),this[g].forEach(function(a){a.unfold(c,"  "+b)});break;case q:this[g]=e.readAllSubChunks(),E(b,this.tag),this[g].forEach(function(a){a.unfold(c,"  "+b)});break;case k:for(this[g]=[];e.length>1;)this[g].push(e.readStr0());break;case o:for(this[g]=new Float32Array(e.length/4),h=0;e.length>3;)this[g][h++]=e.readFloat32();break;case t:for(this[g]=[];e.length>1;){if(z=e.readShort(),A=[],void 0!=J.POLS.type)for(B=0;(1023&z)>B;B++)A.push(e.readVX());else{for(B=0;(1023&z)>B;B++)A.push(e.readShort());e.readShort()}this[g].push(A)}break;case u:for(this[g]=[];e.length>3;)this[g].push({poly:e.readVX(),tag:e.readShort()});break;case v:for(this[g]=[];e.length>=2+4*this.dimension;)switch(+this.dimension){case 0:h=e.readVX(),this[g][h]=[];break;case 1:h=e.readVX(),this[g][h]=[e.readFloat32()];break;case 2:h=e.readVX(),this[g][h]=[e.readFloat32(),e.readFloat32()];break;case 3:h=e.readVX(),this[g][h]=[e.readFloat32(),e.readFloat32(),e.readFloat32()];break;case 4:h=e.readVX(),this[g][h]=[e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32()]}break;case w:for(this[g]=[];e.length>2;)switch(+this.dimension){case 1:this[g].push({id:e.readVX(),pid:e.readVX(),data:[e.readFloat32()]});break;case 2:this[g].push({id:e.readVX(),pid:e.readVX(),data:[e.readFloat32(),e.readFloat32()]});break;case 3:this[g].push({id:e.readVX(),pid:e.readVX(),data:[e.readFloat32(),e.readFloat32(),e.readFloat32()]});break;case 4:this[g].push({id:e.readVX(),pid:e.readVX(),data:[e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32()]})}}if("FUNC"==this.tag&&"name"==g&&"(Pim)Shader"==this[g])for(e.readLong();e.length;)C=e.readStr0(),D=e.readStr0(),this[C]=D;else"syntax"==g||g.match(/blocks/i)||E(b,this.tag," -> ",g,this[g]);"FORM"==this.tag&&"formType"==g&&"LWOB"==this[g]&&delete J.POLS.type}delete this.data}else E(b,"unknown block : ",this.tag,this.data.byteLength);return this},K={},g.lowercase=!1,g.prototype.read=function(a,b,c,e,f){var g,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w=[];for(this.formBlocks=h.foldCache[f]?h.foldCache[f]:new d(a).readAllChunks()[0].unfold(void 0,"").formBlocks,h.foldCache[f]=this.formBlocks,g=this,g.layers=[],g.surfaces=[],g.splines=[],g.clips=[],g.lastpoltype="",i=!1,j=0;j<g.formBlocks.length;j++)if(k=g.formBlocks[j],("SURF"==k.tag||"ENVL"==k.tag||"CLIP"==k.tag)&&(i=!1),!i||"LAYR"==k.tag)switch(k.tag){case"TAGS":g.tags=k.tags;break;case"LAYR":void 0!=e&&(i=k.lnr!=e),g.layers.unshift({nr:k.lnr,name:k.name.replace(/\r/g,""),pivot:k.pivot,vmaps:{},vmads:{}});break;case"PNTS":0==g.layers.length&&g.layers.unshift({nr:1,name:"layer",pivot:[0,0,0],vmaps:{},vmads:{}}),g.layers[0].points=k.points;break;case"POLS":g.lastpoltype=k.type,("FACE"==k.type||"PTCH"==k.type||"PTCH"==k.type||void 0==k.type)&&(g.layers[0].poly?g.layers[0].poly.push.apply(g.layers[0].poly,k.poly):g.layers[0].poly=k.poly);break;case"PTAG":"SURF"!=k.tagType||"FACE"!=g.lastpoltype&&"PTCH"!=g.lastpoltype||(g.layers[0].ptag?(l=g.layers[0].ptag.length,g.layers[0].ptag.push.apply(g.layers[0].ptag,k.tags.map(function(a){return a.poly+=l,a}))):g.layers[0].ptag=k.tags);break;case"VMAP":"NORM"!=k.mapType&&(g.layers[0].vmaps[k.mapName]=k);break;case"VMAD":"NORM"!=k.mapType&&(g.layers[0].vmads[k.mapName]=k);break;case"CLIP":"STIL"==k.blocks[0].tag&&(g.clips[k.clipIndex]=k.blocks[0].still.replace(/ +$/,"")),"ANIM"==k.blocks[0].tag&&(g.clips[k.clipIndex]=k.blocks[0].anim.replace(/ +$/,"")),"XREF"==k.blocks[0].tag&&(g.clips[k.clipIndex]=g.clips[k.blocks[0].xref]);break;case"ENVL":for(o=new pimSpline,o.idx=k.envlIndex,p=0;q=k.blocks[p];p++)switch(q.tag){case"NAME":o.name=q.name;break;case"PRE ":o.pre=q.pre;break;case"POST":o.post=q.post;break;case"KEY ":m=q.lastTime,n=q.lastVal;break;case"SPAN":"LINE"==q.spanType&&o.addKey(m,n,pimSpline.M_LINEAR),"STEP"==q.spanType&&o.addKey(m,n,pimSpline.M_STEPPED),"TCB "==q.spanType&&o.addKey(m,n,pimSpline.M_TCB,q.t,q.c,q.b)}g.splines.push(o);break;case"SURF":o=new pimSurface({name:k.surfName,color:[.8,.8,.8],luminosity:0,diffuse:1,specular:0,transparency:0,sman:-1.3788,doublesided:!1,reflection:0,channels:[]}),o.tagnr=g.tags&&g.tags.lastIndexOf(k.surfName),-1==o.tagnr&&(o.tagnr=g.surfaces&&g.surfaces.length||0);for(p in k.blocks)switch(q=k.blocks[p],q.tag){case"COLR":o.color=q.color,q.envelope&&(o.color_env=q.envelope);break;case"LUMI":o.luminosity=q.luminosity,q.envelope&&(o.luminosity_env=q.envelope);break;case"DIFF":o.diffuse=q.diffuse,q.envelope&&(o.diffuse_env=q.envelope);break;case"SPEC":o.specular=q.specular,q.envelope&&(o.specularity_env=q.envelope);break;case"REFL":o.reflection=q.reflection,q.envelope&&(o.reflection_env=q.envelope);break;case"TRAN":o.transparency=q.transparency,q.envelope&&(o.transparency_env=q.envelope,o.transparency+=.001);break;case"ADTR":o.additiveTransparency=q.additiveTransparency;break;case"GLOS":o.glossiness=q.glossiness;break;case"SMAN":o.sman=q.sman;break;case"SIDE":o.doublesided=3==q.doublesided;break;case"RIMG":o.reflectionImage=g.clips[q.reflectionImage];break;case"BLOK":if(r={},(q.byTag("AUV")||q.byTag("AUVO"))&&(r.auvx=(q.byTag("AUV")||q.byTag("AUVO")).auvx,r.auvy=(q.byTag("AUV")||q.byTag("AUVO")).auvy),q.byTag("IMAP")&&(r.ordinal=q.byTag("IMAP").ordinal,r.type=q.byTag("IMAP").byTag("CHAN").channel,"TRAN"==r.type&&(o.transparency=Math.max(.01,o.transparency)),r.enabled=1==q.byTag("IMAP").byTag("ENAB").enabled,r.opacity=q.byTag("IMAP").byTag("OPAC").type,r.negative=1==q.byTag("IMAP").byTag("NEGA").negative),q.byTag("FUNC"))if("NormalShader"==q.byTag("FUNC").name&&q.byTag("FUNC").byTag("NSNO").byTag("VPVL").byTag("VPRM").byTag("TBLK"))r.type="NRML",r.enabled=1==q.byTag("SHDR").byTag("ENAB").enabled,r.projection=q.byTag("FUNC").byTag("NSNO").byTag("VPVL").byTag("VPRM").byTag("TBLK").byTag("BLOK").byTag("PROJ").projection,r.uvmap=q.byTag("FUNC").byTag("NSNO").byTag("VPVL").byTag("VPRM").byTag("TBLK").byTag("BLOK").byTag("VMAP").vmap,r.image=q.byTag("FUNC").byTag("NSNO").byTag("IMGS")&&q.byTag("FUNC").byTag("NSNO").byTag("IMGS").byTag("CLIP").byTag("STIL").still,-1==g.clips.indexOf(r.image)&&g.clips.push(r.image);else if("(Pim)Shader"==q.byTag("FUNC").name){o.noZ=0!=q.byTag("FUNC")["pimSurface.NoZImpression"];for(s in q.byTag("FUNC"))q.byTag("FUNC").hasOwnProperty(s)&&(o.pimShaderExt[s]=q.byTag("FUNC")[s])}if(q.byTag("PROJ")&&(r.projection=q.byTag("PROJ").projection),q.byTag("AXIS")&&(r.axis=q.byTag("AXIS").axis),q.byTag("TMAP")&&(r.center=q.byTag("TMAP").byTag("CNTR").center,r.rotation=q.byTag("TMAP").byTag("ROTA").rotation,r.scale=q.byTag("TMAP").byTag("SIZE").size,r.coordspace=q.byTag("TMAP").byTag("CSYS").coordinateSpace),q.byTag("IMAG")&&(r.image=g.clips[q.byTag("IMAG").image]),q.byTag("PIXB")&&(r.pixelBlend=q.byTag("PIXB").pixelBlending),5==r.projection&&"NRML"!=r.type){for(r.uvmap=q.byTag("VMAP")&&q.byTag("VMAP").vmap||"",t=0,u=0;u<g.layers.length;u++)g.layers[u].nr==e&&(t=u);!g.layers[t].vmaps[r.uvmap]&&!g.layers[t].vmads[r.uvmap]&&g.layers[t].ptag&&g.layers[t].ptag.some(function(a){return a.tag==o.tagnr})&&(r.uvmap=Object.keys(g.layers[t].vmaps)[0]||Object.keys(g.layers[t].vmads)[0],g.layers[t].vmaps[r.uvmap]||g.layers[t].vmads[r.uvmap]||(r.enabled=!1))}r.type&&(5==r.projection&&r.uvmap&&!r.image&&(r.image="white.jpg",!h.oldSchool,-1==g.clips.indexOf("white.jpg")&&g.clips.push("white.jpg")),r.image&&r.image.match(/\.flv$/i)&&(r.negative=!r.negative),o.channels.push(r))}g.surfaces[o.tagnr]=o}void 0==h.imageCache&&(h.imageCache={}),v=new L.countingCompleter,g.clips.forEach(function(a){var c=a.replace(M,"");0==h.strip&&(c=a,b=""),h.oldSchool&&(c=c.replace(/ +$/,""),c=c.replace(/ /g,"_")),null===h.imageCache[b+c.replace(M,"")]||void 0==h.imageCache[b+c.replace(M,"")]&&(h.imageCache[b+c.replace(M,"")]=L.loadImage(b+c,void 0,function(){},function(a,b,c){a[b]=null,c()}.bind(this,h.imageCache,b+c.replace(M,""),function(){})))}),v.wait(function(){function a(a,b,c){var d,e,f,g,h,i;if(a.poly)for(d=0;d<a.poly.length;d++)switch(b[parseInt(d)]=c.length/3,a.poly[d].length){case 2:break;case 3:c.push(a.poly[d][2],a.poly[d][1],a.poly[d][0]);break;case 4:c.push(a.poly[d][2],a.poly[d][1],a.poly[d][0]),c.push(a.poly[d][3],a.poly[d][2],a.poly[d][0]);break;default:for(e=[],e.push(a.poly[d][0]),f=!1,g=1,h=a.poly[d].length-1;h>=g;)f?(e.push(a.poly[d][g]),g++):(e.push(a.poly[d][h]),h--),f=!f;for(f=!0,i=0;i<e.length-2;i++)f?c.push(e[i],e[i+1],e[i+2]):c.push(e[i],e[i+2],e[i+1]),f=!f}b[parseInt(d)]=c.length/3}if(void 0!=e)for(var d in g.layers)if(g.layers[d].nr==e){g.layers=[g.layers[d]];break}g.layers.forEach(function(c){function d(a,b,c,d){var e,f,g;if(void 0==d&&(d=0),d>u&&(u=d),void 0==n[d][2*a])return n[d][2*a]=b,n[d][2*a+1]=c,a;if(Math.round(1e3*n[d][2*a])==Math.round(1e3*b)&&Math.round(1e3*n[d][2*a+1])==Math.round(1e3*c))return a;for(e=t.length/3,f=a;o[f]!=a;)f=o[f];for(o[e]=a,o[f]=e,t[3*e+0]=t[3*a+0],t[3*e+1]=t[3*a+1],t[3*e+2]=t[3*a+2],g=0;u>=g;g++)g!=d&&(n[g][2*e+0]=n[g][2*a+0],n[g][2*e+1]=n[g][2*a+1]);return n[d][2*e]=b,n[d][2*e+1]=c,e}function f(a,b){if(a==b)return!0;for(var c=o[b];c!=b;){if(c==a)return!0;c=o[c]}return!1}function i(a,b,c){if(b!=c)for(var d=3*p[a];d<3*p[+a+1];d++)m[d]==b&&(m[d]=c)}function j(a,b,c){b!=c&&(a=3*a,m[a]==b&&(m[a]=c),m[++a]==b&&(m[a]=c),m[++a]==b&&(m[a]=c))}function k(a,b){var c=vec3.normalize(a,z),d=vec3.normalize(b,A);return Math.atan2(vec3.dot(vec3.cross(c,d,B),y),vec3.dot(vec3.cross(c,y,B),vec3.cross(d,y,d)))}var l,m,n,o,p,q,r,s,t,u,v,x,y,z,A,B,C,D,E,F,G,H,I,J,K,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,ab,bb,cb,db,eb,fb,gb,hb,ib,jb,kb,lb,mb,nb,ob,pb,qb,rb,sb,tb,ub;if(void 0==e||c.nr==e){for(l=new pimObject,l.attribs={},m=[],n=[[],[],[],[]],o=[],p=[],q=[],r=[],s=0,t=Array.prototype.slice.call(c.points,0),fb=0;fb<t.length/3;fb++)o[fb]=fb;a(c,p,m),c.ptag&&c.ptag.forEach(function(a,b){var d,e=c.ptag[b].poly,f=c.ptag[b].tag;for(d=p[e];d<p[e+1];d++)q[d]={id:f,idx:d}}),1&&function(){var a,b;for(a in c.vmaps)"TXUV"!=c.vmaps[a].mapType&&c.vmaps[a].values&&(b=c.vmaps[a].values.length,b!=t.length/3&&c.vmaps[a].values.splice(t.length/3))}(),u=0,v=/\.flv/i,x=/[^\\\/]*[\\\/]/gm,y=vec3.create([1,1,1]),z=vec3.create(),A=vec3.create(),B=vec3.create(),g.surfaces.forEach(function(a){var e,g;a.channels.sort(function(a,b){return a.ordinal<b.ordinal?-1:a.ordinal>b.ordinal?1:0}),e=-1,g="",a.channels.forEach(function(g,l){var n,r,u,w,y,z,A,B,C,D,E,F,G,H,I,J,K,N,O;if(a["pimGui.NormalName"]?(g.image||(g.image=a["pimGui.NormalName"]),s=1):(g.image||(g.enabled=!1),g.image&&!g.image.match(v)&&null==h.imageCache[b+g.image.replace(x,"")]&&(g.enabled=!1)),g.type in{COLR:1,DIFF:1,TRAN:1,SPEC:1,LUMI:1,NRML:1}||(g.enabled=!1),"LUMI"==g.type&&0==g.opacity&&(a.luminosity=Math.min(a.luminosity,.01)),h.oldSchool&&"DIFF"==g.type&&0==g.opacity&&(g.opacity=8),"NRML"==g.type&&(s=1),g.enabled){if(g.image){for("TRAN"==g.type&&(a.transparency=Math.min(.9999999,a.transparency)),n=!1,r=-1,u=0;l>u;u++){if(w=a.channels[u],w.texunit>r&&(r=w.texunit),w.projection!=g.projection)return;if(5==g.projection){if(w.uvmap!=g.uvmap)return;n=!0,g.texunit=w.texunit;break}if(JSON.stringify([g.center,g.scale,g.rotation])!=JSON.stringify([w.center,w.scale,w.rotation]))return;n=!0,g.texunit=w.texunit;break}if(!n)if(g.texunit=++r,5==g.projection){if(c.vmaps[g.uvmap])for(y=a.tagnr,z=c.vmaps[g.uvmap].values,A=0;A<q.length;A++)if(q[A].id==y)for(B=3*A;3*A+3>B;B++){for(C=m[B];o[C]>C;)C=o[C];C=o[C],z[C]&&j(A,m[B],d(m[B],z[C][0],z[C][1],g.texunit))}if(c.vmads[g.uvmap])for(D=c.vmads[g.uvmap].values,y=a.tagnr,A=0;A<D.length;A++)if(q[p[D[A].pid]]&&q[p[D[A].pid]].id==y){for(C=D[A].id,E=3*p[D[A].pid];E<3*p[+D[A].pid+1];E++)if(f(m[E],C)){C=m[E];break}i(D[A].pid,C,d(C,D[A].data[0],D[A].data[1],g.texunit))}}else if(0==g.projection||13==g.projection){for(F=mat4.create(),mat4.identity(F),G=vec4.create(),mat4.translate(F,[.5,.5,.5]),mat4.scale(F,[1/g.scale[0],1/g.scale[1],1/g.scale[2]]),mat4.rotateY(F,g.rotation[0]),mat4.rotateX(F,-g.rotation[1]),mat4.rotateZ(F,-g.rotation[2]),mat4.translate(F,[-g.center[0],-g.center[1],-g.center[2]]),A=0;A<q.length;A++)if(q[A].id==a.tagnr)for(H=3*A;3*A+3>H;H++)switch(G[0]=t[3*m[H]+0],G[1]=t[3*m[H]+1],G[2]=t[3*m[H]+2],G[3]=1,mat4.multiplyVec4(F,G,G),g.axis){case 0:j(A,m[H],d(m[H],G[2],G[1],g.texunit));break;case 1:j(A,m[H],d(m[H],G[0],G[2],g.texunit));break;case 2:j(A,m[H],d(m[H],G[0],G[1],g.texunit))}}else if(3==g.projection){for(F=mat4.create(),mat4.identity(F),G=vec4.create(),I=vec3.create(),J=vec3.create(),K=vec3.create(),mat4.translate(F,[.5,.5,.5]),mat4.scale(F,[1/g.scale[0],1/g.scale[1],1/g.scale[2]]),mat4.rotateX(F,-g.rotation[0]),mat4.rotateY(F,g.rotation[1]),mat4.rotateZ(F,-g.rotation[2]),mat4.translate(F,[-g.center[0],-g.center[1],-g.center[2]]),A=0;A<q.length;A++)if(q[A].id==a.tagnr)for(I[0]=t[3*m[3*A+1]+0]-t[3*m[3*A]+0],I[1]=t[3*m[3*A+1]+1]-t[3*m[3*A]+1],I[2]=t[3*m[3*A+1]+2]-t[3*m[3*A]+2],J[0]=t[3*m[3*A+2]+0]-t[3*m[3*A]+0],J[1]=t[3*m[3*A+2]+1]-t[3*m[3*A]+1],J[2]=t[3*m[3*A+2]+2]-t[3*m[3*A]+2],vec3.cross(I,J,K),E=3*A;3*A+3>E;E++)switch(G[0]=t[3*m[E]+0],G[1]=t[3*m[E]+1],G[2]=t[3*m[E]+2],G[3]=1,mat4.multiplyVec4(F,G,G),O=0,(Math.abs(K[0])<Math.abs(K[1])||Math.abs(K[0])<Math.abs(K[2]))&&(O=1,Math.abs(K[1])<Math.abs(K[2])&&(O=2)),O){case 0:j(A,m[E],d(m[E],G[1],G[2],g.texunit));break;case 1:j(A,m[E],d(m[E],G[0],G[2],g.texunit));break;case 2:j(A,m[E],d(m[E],G[0],G[1],g.texunit))}}else if(1==g.projection)for(F=mat4.create(),mat4.identity(F),G=vec4.create(),I=vec3.create(),J=vec3.create(),K=vec3.create(),mat4.translate(F,[.5,.5,.5]),mat4.scale(F,[1/g.scale[0],1/g.scale[1],1/g.scale[2]]),mat4.rotateX(F,-g.rotation[0]),mat4.rotateY(F,g.rotation[1]),mat4.rotateZ(F,-g.rotation[2]),mat4.translate(F,[-g.center[0],-g.center[1],-g.center[2]]),A=0;A<q.length;A++)if(q[A].id==a.tagnr)for(I[0]=t[3*m[3*p[A]+1]+0]-t[3*m[3*p[A]]+0],I[1]=t[3*m[3*p[A]+1]+1]-t[3*m[3*p[A]]+1],I[2]=t[3*m[3*p[A]+1]+2]-t[3*m[3*p[A]]+2],J[0]=t[3*m[3*p[A]+2]+0]-t[3*m[3*p[A]]+0],J[1]=t[3*m[3*p[A]+2]+1]-t[3*m[3*p[A]]+1],J[2]=t[3*m[3*p[A]+2]+2]-t[3*m[3*p[A]]+2],vec3.cross(I,J,K),E=3*p[A];E<3*p[+A+1];E++){switch(G[0]=t[3*m[E]+0],G[1]=t[3*m[E]+1],G[2]=t[3*m[E]+2],G[3]=1,mat4.multiplyVec4(F,G,G),g.axis){case 0:H=G[0],G[0]=0,N=k(G,[1,0,0])/(2*Math.PI)-.5;break;case 1:H=G[1],G[1]=0,N=k(G,[0,1,0])/(2*Math.PI)-.5;break;case 2:H=-G[2],G[2]=0,N=-k(G,[0,0,1])/(2*Math.PI)-.5}j(A,m[E],d(m[E],N,H,g.texunit))}g.opacity=h.oldSchool?[0,1,2,8,4,5,6,7,8][g.opacity]:g.opacity,g.mapname=g.image.replace(M,""),g.map=h.imageCache[b+g.mapname]||L.loadImage(b+g.mapname)}e++}})}.bind(this)),C=vec3.create(),D=vec3.create(),E=vec3.create(),F=[],function(){for(var a=0;a<m.length/3;a++)C[0]=t[3*m[3*a+1]+0]-t[3*m[3*a]+0],C[1]=t[3*m[3*a+1]+1]-t[3*m[3*a]+1],C[2]=t[3*m[3*a+1]+2]-t[3*m[3*a]+2],D[0]=t[3*m[3*a+2]+0]-t[3*m[3*a]+0],D[1]=t[3*m[3*a+2]+1]-t[3*m[3*a]+1],D[2]=t[3*m[3*a+2]+2]-t[3*m[3*a]+2],vec3.cross(C,D,E),vec3.normalize(E),F[a]=vec3.create(E)}(),G=Array(t.length/3),H=Array(t.length/3),function(){var a,b,c,d,e,f,h=Array(m.length/3);for(a=0;a<m.length/3;a++)h[a]=q[a]&&g.surfaces[q[a].id].sman||0;for(1&&function(){var a,b,c,d;for(a=0;a<H.length;a++)H[a]=[];for(a=0;a<m.length/3;a++)for(b=0;3>b;b++)for(c=m[3*a+b],d=c;;)if(H[d].push(a),d=o[d],d==c)break}(),1&&function(){for(var a=0;a<G.length;a++)G[a]=vec3.create(),0==H[a].length?(G[a][0]=0,G[a][1]=0,G[a][2]=0):(G[a][0]=F[H[a][0]][0],G[a][1]=F[H[a][0]][1],G[a][2]=F[H[a][0]][2])}(),b=G.length,c=vec3.create(),a=0;b>a;a++)if(H[a].length>1)for(d=H[a],e=h[d[0]],f=1;f<d.length;f++)1&&function(){var b,g,h,i,j,k,l=d[f];if(vec3.cross(F[d[0]],F[l],c),b=Math.atan2(vec3.length(c),vec3.dot(F[d[0]],F[l])),e>=b)G[a][0]+=F[l][0],G[a][1]+=F[l][1],G[a][2]+=F[l][2];else{for(g=t.length/3,h=a;o[h]!=a;)h=o[h];for(o[g]=a,o[h]=g,i=0;3>i;i++)t[3*g+i]=t[3*a+i];for(j=0;4>j;j++)void 0!=n[j][2*a]&&(n[j][2*g]=n[j][2*a]),void 0!=n[j][2*a+1]&&(n[j][2*g+1]=n[j][2*a+1]);for(G[g]=vec3.create(F[l]),k=0;3>k;k++)m[3*l+k]==a&&(m[3*l+k]=g)}}()}();for(I=0;I<G.length;I++)G[I]?vec3.normalize(G[I]):G[I]=vec3.create([0,0,0]);if(s){for(J=Array(t.length/3),K=Array(t.length/3),I=0;I<m.length;I+=3)for(N=m[I+0],O=m[I+1],P=m[I+2],C=[t[3*N+0],t[3*N+1],t[3*N+2]],D=[t[3*O+0],t[3*O+1],t[3*O+2]],Q=[t[3*P+0],t[3*P+1],t[3*P+2]],R=[n[0][2*N+0],n[0][2*N+1]],S=[n[0][2*O+0],n[0][2*O+1]],T=[n[0][2*P+0],n[0][2*P+1]],U=D[0]-C[0],V=Q[0]-C[0],W=D[1]-C[1],X=Q[1]-C[1],Y=D[2]-C[2],Z=Q[2]-C[2],$=S[0]-R[0],_=T[0]-R[0],ab=S[1]-R[1],bb=T[1]-R[1],cb=$*bb-_*ab?1/($*bb-_*ab):0,db=[(bb*U-ab*V)*cb,(bb*W-ab*X)*cb,(bb*Y-ab*Z)*cb,0],eb=[($*V-_*U)*cb,($*X-_*W)*cb,($*Z-_*Y)*cb,0],vec3.normalize(db),vec3.normalize(eb),fb=0;3>fb;fb++)void 0==J[m[I+fb]]?J[m[I+fb]]=vec4.create(db):vec3.add(J[m[I+fb]],db),void 0==K[m[I+fb]]?K[m[I+fb]]=vec4.create(eb):vec3.add(K[m[I+fb]],eb);for(I=0;I<J.length;I++)void 0==J[I]&&(J[I]=vec4.create([0,0,0,0])),void 0==K[I]&&(K[I]=vec4.create([0,0,0,0])),vec3.normalize(vec3.subtract(J[I],vec3.scale(G[I],vec3.dot(G[I],J[I]),vec3.create()),J[I]),J[I]),J[I][3]=vec3.dot(vec3.cross(G[I],J[I],vec3.create()),K[I])<0?-1:1}for(gb=[],1&&function(){var a,b,d,e;for(a in c.vmaps)if("TXUV"!=c.vmaps[a].mapType&&c.vmaps[a].values){for(b=c.vmaps[a].values.length,d=t.length/3,fb=0;d>fb;fb++)void 0==c.vmaps[a].values[fb]&&(c.vmaps[a].values[fb]=[0,0,0,0].slice(0,c.vmaps[a].dimension));for(fb=b;d>fb;fb++){for(e=o[fb];e>b&&e!=fb;)e=o[e];c.vmaps[a].values[fb]=c.vmaps[a].values[e]}"MORF"==c.vmaps[a].mapType&&gb.push(c.vmaps[a])}}(),hb=[],q.forEach(function(a,b){a.origID=b}),q.sort(function(a,b){return a.id<b.id?-1:a.id>b.id?1:a.origID<b.origID?-1:a.origID>b.origID?1:0}),ib=-1,q.forEach(function(a,b){q[b].id!=ib&&(ib=q[b].id,hb.push(1*ib),r.push(1*b))}),r.push(Math.floor(m.length/3)),jb=m.slice(0),kb=F.slice(0),m=[],q.forEach(function(a,b){var c=q[b].idx;m[3*b]=jb[3*c],m[3*b+1]=jb[3*c+1],m[3*b+2]=jb[3*c+2],F[b]=kb[c]}),l.attribs[0]=new ArrayBuffer(4*t.length),l.attribs[0].itemsize=3,lb=new Float32Array(l.attribs[0]),l.attribs[0].name="pim_position",l.attribs[1]=new ArrayBuffer(4*t.length),l.attribs[1].itemsize=3,mb=new Float32Array(l.attribs[1]),l.attribs[1].name="pim_normal",s&&(l.attribs[2]=new ArrayBuffer(t.length/3*4*4),l.attribs[2].itemsize=4,nb=new Float32Array(l.attribs[2]),l.attribs[2].name="pim_tangent"),n[0].length&&(l.attribs[40]=new ArrayBuffer(t.length/3*2*4),l.attribs[40].itemsize=2,ob=new Float32Array(l.attribs[40]),l.attribs[40].name="pim_texcoord0"),n[1].length&&(l.attribs[41]=new ArrayBuffer(t.length/3*2*4),l.attribs[41].itemsize=2,pb=new Float32Array(l.attribs[41]),l.attribs[41].name="pim_texcoord1"),n[2].length&&(l.attribs[42]=new ArrayBuffer(t.length/3*2*4),l.attribs[42].itemsize=2,qb=new Float32Array(l.attribs[42]),l.attribs[42].name="pim_texcoord1"),l.attribs[4003]=new ArrayBuffer(4*F.length*3),l.attribs[4003].itemsize=3,rb=new Float32Array(l.attribs[4003]),l.attribs[2003]=new Uint8Array(q.map(function(a){return hb[a.id]})),t.length/3>65535?(l.attribs[1003]=new ArrayBuffer(4*m.length),l.attribs[1003].itemsize=1,sb=new Uint32Array(l.attribs[1003])):(l.attribs[1003]=new ArrayBuffer(2*m.length),l.attribs[1003].itemsize=1,sb=new Uint16Array(l.attribs[1003])),I=0;I<F.length;I++)rb[3*I+0]=F[I][0],rb[3*I+1]=F[I][1],rb[3*I+2]=F[I][2];for(I=0;I<t.length/3;I++)lb[3*I+0]=t[3*I],lb[3*I+1]=t[3*I+1],lb[3*I+2]=t[3*I+2],mb[3*I+0]=-G[I][0],mb[3*I+1]=-G[I][1],mb[3*I+2]=-G[I][2],s&&(nb[4*I+0]=J[I][0]||0,nb[4*I+1]=J[I][1]||0,nb[4*I+2]=J[I][2]||0,nb[4*I+3]=J[I][3]||0),n[0].length&&(ob[2*I]=n[0][2*I]||0,ob[2*I+1]=1-n[0][2*I+1]||0),n[1].length&&(pb[2*I]=n[1][2*I]||0,pb[2*I+1]=1-n[1][2*I+1]||0),n[2].length&&(qb[2*I]=n[2][2*I]||0,qb[2*I+1]=1-n[2][2*I+1]||0);if(gb.length){for(l.attribs[400]=new ArrayBuffer(4*t.length),l.attribs[400].itemsize=3,tb=new Float32Array(l.attribs[400]),I=0;I<t.length;I++)tb[I]=t[I];gb.forEach(function(a,b){var c,d;for(l.attribs[401+b]=new Float32Array(t.length),l.attribs[401+b].itemsize=3,l.attribs[401+b].name=a.mapName,c=l.attribs[401+b],d=0;d<t.length/3;d++)c[3*d+0]=a.values[d][0],c[3*d+1]=a.values[d][1],c[3*d+2]=a.values[d][2]})}for(I=0;I<m.length;I++)sb[I]=m[I];for(l.surfaces=[],I=0;I<r.length-1;I++)r[I+1]-r[I]&&(ub=new pimSurface({name:g.surfaces[hb[I]].name,alphamap:g.surfaces[hb[I]].tempmapalpha,diffusemap:g.surfaces[hb[I]].tempmap,diffusemap2:g.surfaces[hb[I]].tempmap2,tag:I,invertalpha:g.surfaces[hb[I]].invertalpha,diffusemap3:"",normalmap:"",glossiness:g.surfaces[hb[I]].glossiness||.4,channels:g.surfaces[hb[I]].channels,doublesided:g.surfaces[hb[I]].doublesided,color:g.surfaces[hb[I]].color,diffuse:g.surfaces[hb[I]].diffuse,luminosity:g.surfaces[hb[I]].luminosity,specular:g.surfaces[hb[I]].specular,transparency:g.surfaces[hb[I]].transparency||0,reflection:g.surfaces[hb[I]].reflection||0,reflectionImage:h.imageCache[b+g.surfaces[hb[I]].reflectionImage],additiveTransparency:g.surfaces[hb[I]].additiveTransparency||0,splines:[],start:parseInt(r[I]),count:parseInt(r[I+1]-r[I]),diffuseBlend:g.surfaces[hb[I]].diffuseBlend||0,diffuseBlend2:g.surfaces[hb[I]].diffuseBlend2||0,diffuseBlend3:g.surfaces[hb[I]].diffuseBlend3||0,diffuseUAnim:g.surfaces[hb[I]].auvx||0,diffuseVAnim:g.surfaces[hb[I]].auvy||0,pimShaderExt:g.surfaces[hb[I]].pimShaderExt}),l.surfaces.push(ub),1&&function(){var a,b;if(g.surfaces[hb[I]].transparency_env){a={tp:6};for(b in g.splines)g.splines[b].idx==g.surfaces[hb[I]].transparency_env&&(a=g.splines[b]);l.surfaces[l.surfaces.length-1].splines.push({tp:6,keys:a}),l.surfaces[l.surfaces.length-1].transparency=Math.max(.001,a.evaluate(0))}if(g.surfaces[hb[I]].luminosity_env){a={tp:8};for(b in g.splines)g.splines[b].idx==g.surfaces[hb[I]].luminosity_env&&(a=g.splines[b]);l.surfaces[l.surfaces.length-1].splines.push({tp:8,keys:a}),l.surfaces[l.surfaces.length-1].luminosity=a.evaluate(0)}if(g.surfaces[hb[I]].diffuse_env){a={tp:3};for(b in g.splines)g.splines[b].idx==g.surfaces[hb[I]].diffuse_env&&(a=g.splines[b]);l.surfaces[l.surfaces.length-1].splines.push({tp:3,keys:a}),l.surfaces[l.surfaces.length-1].diffuse=a.evaluate(0)}if(g.surfaces[hb[I]].color_env){a={tp:0};for(b in g.splines)g.splines[b].idx==g.surfaces[hb[I]].color_env&&(a=g.splines[b]);l.surfaces[l.surfaces.length-1].splines.push({tp:0,keys:a}),l.surfaces[l.surfaces.length-1].color[0]=a.evaluate(0),a={tp:1};for(b in g.splines)g.splines[b].idx==g.surfaces[hb[I]].color_env+1&&(a=g.splines[b]);l.surfaces[l.surfaces.length-1].splines.push({tp:1,keys:a}),l.surfaces[l.surfaces.length-1].color[0]=a.evaluate(0),a={tp:2};
for(b in g.splines)g.splines[b].idx==g.surfaces[hb[I]].color_env+2&&(a=g.splines[b]);l.surfaces[l.surfaces.length-1].splines.push({tp:2,keys:a}),l.surfaces[l.surfaces.length-1].color[0]=a.evaluate(0)}if(g.surfaces[hb[I]].specularity_env){a={tp:4};for(b in g.splines)g.splines[b].idx==g.surfaces[hb[I]].specularity_env&&(a=g.splines[b]);l.surfaces[l.surfaces.length-1].splines.push({tp:4,keys:a}),l.surfaces[l.surfaces.length-1].specularity=a.evaluate(0)}}());l.surfaces.forEach(function(a,b){h.oldSchool&&l.surfaces[b].luminosity&&l.surfaces[b].luminosity+l.surfaces[b].diffuse>1&&(l.surfaces[b].diffuse=Math.max(0,1-l.surfaces[b].luminosity))}),l.surfaces.sort(function(a,b){return b.transparency<a.transparency?1:b.transparency>a.transparency?-1:0}),l.surfaces.length&&(l.surfaces[l.surfaces.length-1].transparency||l.surfaces[l.surfaces.length-1].additiveTransparency)&&(l.hasTransparency=1),l.resourceName=this.url.replace(/\r/g,""),l.name=this.url.replace(/\r/g,"").replace(/^.*[\\\/]/,"").replace(/\.lwo/i,"")+":"+(c.name?c.name:"Layer"+(c.nr+1)),l.lnr=c.nr,l.vmaps=c.vmaps,w.push(l)}}.bind(this)),this.formBlocks&&(this.formBlocks=null),this.blocks&&(this.blocks=null),this.layers&&(this.layers=null),c(0==w.length?null:1==w.length?w[0]:w)}.bind(this))},h={LWO2:g,load:f,strip:!0,cache:K,oldSchool:!1,imageCache:{},foldCache:{}},c.pimLWO2=h},{"./pim_gui":5,"./pim_utils":21}],8:[function(a,b,c){var d=a("./pim_utils").pimUtils,e=a("./pim_lwo2").pimLWO2,f=function(a){function b(a,b){for(var c=0;c<a.length;c++)if(a[c].inst==b)return c;return-1}function c(c){var d,e,f=b(a.objects,c);if(f>=0)return(268435456+1*f).toString(16);for(d=0;e=a.objects[d];d++)if(f=b(e.bones,c),f>=0)return(1073741824+1*d+1*f*65536).toString(16);return f=b(a.lights,c),f>=0?(536870912+1*f).toString(16):(f=b(a.cameras,c),f>=0?(805306368+1*f).toString(16):void 0)}function d(a,b){var c,d,e="{ Envelope\n";if(0==a.nrKeys)e+="  1\n  Key "+b+" 0 0 0 0 0 0 0 0\n";else for(e+="  "+a.nrKeys+"\n",c=0;d=a.keys[c];c++)e+="  Key "+d.value+" "+d.time+" "+(4==d.type?5:d.type)+" "+d.tension+" "+d.continuity+" "+d.bias+" 0 0 0\n";return e+="  Behaviors "+a.pre+" "+a.post+"\n}\n"}var e,f,g,h,i,j,k,l,m,n,o,p,q="";for(q="LWSC\n5\n\n",q+="RenderRangeType 0\nFirstFrame 1\nLastFrame "+(a.lastFrame||200)+"\nFrameStep 1\nPreviewFirstFrame 0\nPreviewLastFrame "+(a.lastFrame||200)+"\nPreviewFrameStep 1\nCurrentFrame 0\nFramesPerSecond 30\n\n",q+="AmbientColor 1 1 1\nAmbientIntensity 0.05\n\n",q+='Plugin MasterHandler 1 (Pim)Director\n"v2.0"\n',g=[{k:"pimScene.SS000Name",v:"Default"},{k:"pimScene.DESFileName",v:""},{k:"pimScene.PIMPFileName",v:""}],q+='"'+g.length+'"\n',e=0;f=g[e];e++)q+='"'+f.k+'"\n"'+f.v+'"\n';for(q+='"1"\n',q+="EndPlugin\n\n",e=0;h=a.objects[e];e++)if(!h.obj||1!==h.obj.generated){for(q+=h.obj?"LoadObjectLayer "+((h.obj.lnr||0)+1)+" "+c(h.inst)+" "+h.obj.resourceName.replace(/[^\/]*\//g,"")+"\n":"AddNullObject "+c(h.inst)+" "+h.inst.name+"\n",q+="ObjectMotion\n",q+="NumChannels 9\n",i=0;9>i;i++)q+="Channel "+i+"\n",q+=d(h.inst[["_x","_y","_z","_h","_p","_b","_xs","_ys","_zs"][i]],h.inst[["x","y","z","h","p","b","xs","ys","zs"][i]]);if(h.inst.parent&&(q+="ParentItem "+c(h.inst.parent)+"\n"),q+="PivotPosition "+h.inst.px+" "+h.inst.py+" "+h.inst.pz+"\n",h.HTML){j={"pimInstance.HTML":h.HTML.outerHTML.replace(/"/g,'\\"').replace(/mce-content-body|mce_[0-9]+/g,"")},h.HTML.nopos&&(j["pimInstance.nopos"]="1");for(k in h.HTML.style)h.HTML.style[k]instanceof pimSpline&&(l=h.HTML.style[k].target,delete h.HTML.style[k].target,j["pimInstance.style."+k]=JSON.stringify(h.HTML.style[k]).replace(/"/g,'\\"'),h.HTML.style[k].target=l);q+="Plugin ItemMotionHandler 1 (Pim)Motion\n",q+='"'+Object.keys(j).length+'"\n';for(m in j)q+='"'+m+'"\n',q+='"'+j[m]+'"\n';q+="EndPlugin\n"}if(q+="\n",h.bones.length)for(n=0;o=h.bones[n];n++){for(q+="BoneFalloffType 5\nFasterBones 1\n",q+="AddBone "+c(o.inst)+"\n",q+="BoneName "+o.inst.name+"\n",q+="ShowBone 1 6\n",q+="BoneActive 1\n",q+="BoneRestPosition "+o.inst.bx+" "+o.inst.by+" "+o.inst.bz+"\n",q+="BoneRestDirection "+180*o.inst.bh/Math.PI+" "+180*o.inst.bp/Math.PI+" "+180*o.inst.bb/Math.PI+"\n",q+="BoneRestLength "+o.inst.restLength+"\n",q+="ScaleBoneStrength 1\n",q+="BoneType 0\n",q+="BoneMotion\n",q+="NumChannels 9",i=0;9>i;i++)q+="Channel "+i+"\n",q+=d(o.inst[["_x","_y","_z","_h","_p","_b","_xs","_ys","_zs"][i]],o.inst[["x","y","z","h","p","b","xs","ys","zs"][i]]);o.inst.parent&&(q+="ParentItem "+c(o.inst.parent)+"\n"),q+="PivotRotation "+180*o.inst.ph/Math.PI+" "+180*o.inst.pp/Math.PI+" "+180*o.inst.pb/Math.PI+"\n",q+="PivotPosition "+o.inst.px+" "+o.inst.py+" "+o.inst.pz+"\n"}}for(e=0;p=a.lights[e];e++){for(q+="AddLight "+c(p.inst)+"\n",q+="LightName "+p.inst.name+"\n",q+="LightMotion\n",q+="NumChannels 9\n",i=0;9>i;i++)q+="Channel "+i+"\n",q+=d(p.inst[["_x","_y","_z","_h","_p","_b","_xs","_ys","_zs"][i]],p.inst[["x","y","z","h","p","b","xs","ys","zs"][i]]);p.inst.parent&&(q+="ParentItem "+c(p.inst.parent)+"\n"),q+="LightColor 1 1 1\n",q+="LightIntensity 1\n",q+="LightType 0\n",q+="ShadowType 1\n",q+="ShadowColor 0 0 0\n",q+="\n"}for(e=0;p=a.cameras[e];e++){for(q+="AddCamera "+c(p.inst)+"\n",q+="CameraName "+p.inst.name+"\n",q+="CameraMotion\n",q+="NumChannels 6\n",i=0;6>i;i++)q+="Channel "+i+"\n",q+=d(p.inst[["_x","_y","_z","_h","_p","_b","_xs","_ys","_zs"][i]],p.inst[["x","y","z","h","p","b","xs","ys","zs"][i]]);p.inst.parent&&(q+="ParentItem "+c(p.inst.parent)+"\n"),q+="ZoomFactor 3.2\n",q+="ZoomType 1\n",q+="ResolutionMultiplier 1.0\n",q+="FrameSize 1920 1080\n",q+="PixelAspect 1\n",q+="ApertureHeight 0.015\n",q+="DepthOfField 0\n",q+="FocalDistance 1\n",q+="LensFStop 4\n",q+="\n"}return q+="GlobalFrameSize 640 480\nGlobalPixelAspect 1\nGlobalFilmHeight 0.015\n\n",q+="SolidBackdrop 1\nBackdropColor 0 0 0\n\n",q+="CurrentLight 0\nCurrentCamera 0\n",q.replace(/\n/g,"\r\n")},g=function(a,b,c,f){d.fileAsText(b,f?f.link():void 0,function(d){function g(b){var c=0;return a.objects.forEach(function(a){a.inst.origName==b&&c++,a.inst.bones&&a.inst.bones.length&&a.inst.bones.forEach(function(a){a.inst.name==b&&c++})}),a.lights.forEach(function(a){a.inst.origName==b&&c++}),a.cameras.forEach(function(a){a.inst.origName==b&&c++}),c}var i=d.split("\n"),j=0,k=null,l=null,m=null,n=null,o=null,p={},q=5,r=function(a,b){this.pattern=a,this.scaler=b||1},s=function(a){this.pattern=a},t=function(a){this.pattern=a},u=function(a,b){this.pattern=a,this.flip=b},v=function(a){this.pattern=a},w=[["rayTransparent",new u(/UnseenByRays/i)],["visible",new u(/UnseenByCamera/i,!0)],["shadowOptions",new t(/ShadowOptions/i)],["name",new v(/\/\/ name=/i)]],x=[["coneangle",new r(/^lightconeangle\s/i,3.14159265/180)],["edgeangle",new r(/^lightedgeangle\s/i,3.14159265/180)],["lensFlare",new u(/^lensflare/i)],["flareIntensity",new r(/^flareintensity/i)],["shadowType",new t(/^shadowType/i)],["shadowColor",new s(/^shadowColor[ \s\t]/i)],["shadowMapSize",new t(/^shadowmapsize/i)],["useConeAngle",new t(/^useconeangle/i)],["range",new r(/^LightRange/i)],["intensity",new r(/^LightIntensity/i)],["color",new s(/^LightColor[ \s\t]/i)],["type",new t(/^LightType/i)],["fallofType",new t(/^lightfallofftype/i)]],y=[["zoom",new r(/^zoomfactor/i)],["appertureHeight",new r(/^apertureheight/i)],["backdropColor",new s(/^backdropcolor[ \t\s]/i)]],z=[["framesPerSec",new r(/^FramesPerSecond/i)],["firstFrame",new t(/firstFrame/i)],["lastFrame",new t(/lastFrame/i)],["ambientIntensity",new r(/^AmbientIntensity/i)],["ambientColor",new s(/^AmbientColor[ \s\t]/i)]],A=function B(){function d(){var a,b,c,d=new pimSpline;for(j+=2,C=i[j],a=!0,b=-1e7;!C.match("}");)if(j++,C=i[j],C&&(c=C.match(/[^\s]+/g).map(function(a,b){return 0==b?a:parseFloat(a)})))switch(c[0]){case"Key":0==c[3]||1==c[3]||2==c[3]||5==c[3]?d.addKey(1*c[2],1*c[1],4,1*c[4],1*c[5],1*c[6]):3==c[3]?d.addKey(1*c[2],1*c[1],1,1*c[4],1*c[5],1*c[6]):d.addKey(1*c[2],1*c[1],0,1*c[4],1*c[5],1*c[6]),-1e7==b&&(b=c[1]),c[1]!=b&&(a=!1);break;case"Behaviors":d.pre=parseInt(c[1]),d.post=parseInt(c[2])}return a&&(d.clear(),d.addKey(0,b)),d}function A(a,b){var c,e,f,g,h,i;for(c=0,e=a.length;e>c;c++)if(f=a[c][0],g=a[c][1],C.match(g.pattern)){if(g instanceof r)b[f]=C.replace(g.pattern,""),b[f].indexOf("(envelope)")>=0?(void 0==b.splines&&(b.splines={}),b.splines[f]=d(),b[f]=b.splines[f].evaluate(0)):b[f]=parseFloat(b[f])*g.scaler;else if(g instanceof v)b[f]=C.replace("\r","").split("// name=")[1]||b[f];else if(g instanceof t)b[f]=parseInt(C.match(mb)[0]);else if(g instanceof u)b[f]=1==parseInt(C.match(mb)[0]),g.flip&&(b[f]=!b[f]);else if(g instanceof s){if(b[f]=C.replace(g.pattern,"").split(/[ \s\t,]+/).slice(0,3),b[f][0].indexOf("(envelope)")>=0){for(h=[],i=0;3>i;i++)h[i]=d();void 0==b.splines&&(b.splines={}),b.splines[f]=h,b[f][0]=""+h[0].evaluate(0),b[f][1]=""+h[1].evaluate(0),b[f][2]=""+h[2].evaluate(0)}b[f]=b[f].map(function(a){return 1*a})}return!0}return!1}var C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,ab,bb,cb,db,eb,fb,gb,hb,ib,jb,kb,lb,mb=/\d+/;for(n&&!k&&(k=n.lastinst),k&&(p[k.id.toUpperCase()]=k);j<i.length;)if(C=i[j],A(x,l)||A(w,k)||A(y,m)||A(z,a),k&&C.match(/^channel/i)){for(D=k[["_x","_y","_z","_h","_p","_b","_xs","_ys","_zs"][parseInt(C.match(/[^ ]+/g)[1])]],j+=2,E=-1e6,F=!0;!C.match("}");)if(C=i[++j],C&&(L=C.match(/[^\s]+/g)))switch(L[0]){case"Key":0==L[3]||1==L[3]||2==L[3]||5==L[3]?D.addKey(parseFloat(L[2]),parseFloat(L[1]),4,parseFloat(L[4]),parseFloat(L[5]),parseFloat(L[6])):3==L[3]?D.addKey(parseFloat(L[2]),parseFloat(L[1]),1,parseFloat(L[4]),parseFloat(L[5]),parseFloat(L[6])):D.addKey(parseFloat(L[2]),parseFloat(L[1]),0,parseFloat(L[4]),parseFloat(L[5]),parseFloat(L[6])),-1e6==E&&(E=L[1]),E!=L[1]&&(F=!1);break;case"Behaviors":D.pre=parseInt(L[1]),D.post=parseInt(L[2])}F&&D.nrKeys>1&&(D.clear(),D.addKey(0,parseFloat(E))),j++}else if(k&&C.match(/^parentitem/i)&&(k.pid=C.match(/\w+/g)[1]),k&&C.match(/^targetitem/i)&&(k.tid=C.match(/\w+/g)[1]),h.oldSchool&&C.match(/ItemActive/)&&0==parseInt(C.match(/\d+/)[0])||!h.oldSchool&&C.match(/ShowObject/)&&0==parseInt(C.match(/\d+/)[0]))k.visible=!1,k.rayTransparent=!0,j++;else{if(k&&C.match(/^cameraname|^lightname/i)&&(k.name=C.match(/\w+/g)[1]),C.match(/^loadobjectlayer/i))return k=null,G=b.replace(/\r/g,"").replace(/[^\\\/]*$/,""),3==q?H=C.match(/[^\s]*\s[^\s]*\s(.*)/)[1].replace(/[^ \t]*[ \t]/g,""):(H=C.match(/[^\s]*\s[^\s]*\s[^\s]*\s(.*)/)[1].replace(/[^ \t]*[ \t]/g,""),h.strip&&(H=H.replace(/.*[\\/]/,""))),n=e.load(G+H,C.match(/[ \t]([0-9]+)/)[1]-1,function(b){n=a.addObject(b),o=n,n.hasTransparency=0|b.hasTransparency,5==q&&(n.inst.id=parseInt(C.match(/\w+/g)[2],16).toString(16)),n.inst.id||(n.inst.id=(a.objects.length+268435455).toString(16)),k=n.inst,k.origName=b.name,k.name=b.name,p[n.inst.id.toUpperCase()]=n.inst;var c=g(b.name);2==c&&a.objects.forEach(function(a){a.inst.name==b.name&&a.inst!=k&&(a.inst.name+=" (1)")}),c>1&&(k.name+=" ("+c+")"),B()}.bind(this),f),void j++;if(m&&C.match(/pimCamera.Overlay"/))C=i[++j],m.overlay=parseInt(C.match(/\d+/)[0]),j++;else if(m&&C.match(/pimCamera.OverlayWidth/))C=i[++j],m.overlayWidth=parseInt(C.match(/\d+/)[0]),j++;else if(m&&C.match(/pimCamera.OverlayHeight/))C=i[++j],m.overlayHeight=parseInt(C.match(/\d+/)[0]),j++;else if(m&&C.match(/pimCamera.OverlayLeft/))C=i[++j],m.overlayLeft=parseInt(C.match(/\d+/)[0]),j++;else if(m&&C.match(/pimCamera.OverlayTop/))C=i[++j],m.overlayTop=parseInt(C.match(/\d+/)[0]),j++;else if(m&&C.match(/pimCamera.Clear/))C=i[++j],m.clear=parseInt(C.match(/\d+/)[0]),j++;else if(C.match(/pimInstance.SubSceneNr/i))C=i[++j],k.ss=parseInt(C.match(/\d+/)[0]),j++;else if(C.match(/pimInstance.ReplaceTarget/i))C=i[++j],k.replaceTarget=C.match(/"(.*)"/)[1],j++;else if(C.match(/pimInstance.Mousetracking/i))C=i[++j],k.mouseTracked=0!=parseInt(C.match(/\d+/)[0]),j++;else if(C.match(/^addnullobject/i))n=a.addObject(null),k=n.inst,3==q?(k.name=C.match(/[^\s]*\s(.*)/)[1],k.origName=k.name,k.id=(a.objects.length-1+268435456).toString(16)):(k.name=C.match(/[^\s]*\s[^\s]*\s(.*)/)[1],k.origName=k.name,k.id=C.match(/\w+/g)[1]),I=g(k.name),2==I&&a.objects.forEach(function(a){a.inst.name==k.name&&a.inst!=k&&(a.inst.name+=" (1)")}),I>1&&(k.name+=" ("+I+")"),p[k.id.toUpperCase()]=k,j++;else if(C.match(/.*pimScene.SS/))J=C.match(/.*pimScene.SS(...)/),J&&(C=i[++j],C=C.slice(1,C.length-2),void 0==a.SS&&(a.SS={}),a.SS[C]=parseInt(J[1])),j++;else if(C.match(/^addbone/i))k=new pimInstance,K=new pimBone(k),k.id=C.match(/\w+/g)[1],k.id||(k.id=(parseInt(o.inst.id,16)+805306368+65536*o.bones.length).toString(16).toUpperCase()),k.name="Bone"+o.bones.length,K.weightMap=0,o.bones.unshift(K),p[k.id.toUpperCase()]=k,j++;else if(C.match(/bonename/i))k.name=C.replace(/bonename\s/i,"").replace(/\r/g,""),j++;else if(C.match(/boneactive/i))k.active=parseInt(C.replace(/boneactive\s/i,"")),j++;else if(C.match(/boneRestLength/i))k.restLength=parseFloat(C.replace(/bonerestlength\s/i,"")),j++;else if(C.match(/boneweightmapname/i))k.weightmapName=C.replace(/boneweightmapname /i,"").replace(/[\t\r]/g,""),o.obj&&o.obj.vmaps&&(k.swm=o.obj.vmaps[k.weightmapName]),j++;else if(C.match(/boneweightmaponly/i))k.weightmapOnly=parseInt(C.replace(/boneweightmaponly\s/i,"")),j++;else if(C.match(/bonerestposition/i))L=C.match(/[^\s]+/g),k.bx=+L[1],k.by=+L[2],k.bz=+L[3],j++;else if(C.match(/bonerestdirection/i))L=C.match(/[^\s]+/g),k.bh=+L[1]/180*Math.PI,k.bp=+L[2]/180*Math.PI,k.bb=+L[3]/180*Math.PI,j++;else if(C.match(/pivotrotation/i))L=C.match(/[^\s]+/g),k.ph=+L[1]/180*Math.PI,k.pp=+L[2]/180*Math.PI,k.pb=+L[3]/180*Math.PI,j++;else if(C.match(/pivotposition/i))L=C.match(/[^\s]+/g),k.px=+L[1],k.py=+L[2],k.pz=+L[3],j++;else if(C.match(/{ KeyedMorph/))M=i[++j],N=d(),N.name=M.replace(/^\s*"|"\s*\r*\n*$/g,""),N.cachevalue=N.keys[0].value,0==n.inst.morphs.length&&(n.inst.morphs=[0]),n.inst.morphs.push(N),j++;else if(C.match(/Plugin ItemMotionHandler.*LW_Follower/)){for(C=i[++j],O=parseInt(C.match(/"(\d+)/)[1]),k.followid=O.toString(16),C=i[++j],k.followerFlags=("00000000000000000000000"+(+C.split(" ")[1]).toString(2)).slice(-9).split("").map(function(a){return parseInt(a)}),C=i[++j],k.timeslip=parseFloat(C.match(/TimeSlip ([\d.+-]+)/)[1]);!C.match(/EndPlugin/i);)C=i[++j];j++}else if(C.match(/^addlight/i))n=null,k=null,l=a.addLight(),k=l.inst,k.name="Light",k.id=3==q?(a.lights.length-1+536870912).toString(16):C.match(/\w+/g)[1],p[k.id.toUpperCase()]=k,j++;else if(C.match(/^lightname/i))k.name=C.match(/LightName (.*)/)[1],k.origName=k.name,I=g(k.name),I>1&&(k.name+=" ("+I+")"),j++;else if(C.match(/^ZoomFactor/i))m.zoomFactor=parseFloat(C.match(/ZoomFactor (.*)/)[1]),m.vFov=Math.atan(1/m.zoomFactor)*(360/Math.PI),j++;else if(C.match(/^addcamera/i))P=a.addCamera(),n=null,k=P.inst,m=P,k.name="Camera",k.id=3==q?(a.cameras.length-1+805306368).toString(16):C.match(/\w+/g)[1],p[k.id.toUpperCase()]=k,j++;else if(C.match(/^framesize/i))Q=C.match(/[\d]+/g),m.width=parseFloat(Q[0]),m.height=parseFloat(Q[1]),j++;else if(C.match(/LWSC/i))C=i[++j],q=parseInt(C.match(/(.*)/)[1]),j++;else if(C.match(/Plugin CustomObjHandler \d+ pimTextQuad/i)){for(C=i[++j],R="";!C.match(/EndPlugin/i)&&j<i.length;)R+=C+"\n",C=i[++j];n.pimTextQuad=R,j++}else if(C.match(/pimInstance.HTML/i)){for(C=i[++j],k.saved_html=C.replace(/^"|"$/g,"").replace(/\\"/g,'"'),S=document.createRange(),S.selectNode(myDir.canvas.parentElement),T=S.createContextualFragment(k.saved_html),myDir.canvas.parentElement.insertBefore(T,myDir.canvas),n.HTML=myDir.canvas.previousSibling;void 0==n.HTML.style;)n.HTML=n.HTML.previousSibling;j++}else C.match(/pimInstance.nopos/i)?(n.HTML.nopos=!0,j++):j++}for(1&&function(){for(var a in p)p[a].pid&&(p[a].parent=p[p[a].pid.toUpperCase()],!p[p[a].pid.toUpperCase()]),p[a].tid&&(p[a].target=p[p[a].tid.toUpperCase()],!p[p[a].tid.toUpperCase()]),p[a].followid&&(p[a].follow=p[p[a].followid.toUpperCase()])}(),U=0;U<a.objects.length;U++)if(a.objects[U].inst.morphs.length>0,pimInstance.calcCount++,a.objects[U].obj&&a.objects[U].bones.length){if(a.objects[U].bones.sort(function(a,b){for(var c,d,e=0,f=a.inst;f;)e++,f=f.parent;for(c=0,d=b.inst;d;)c++,d=d.parent;return c>e?-1:e>c?1:0}),a.objects[U].bones.forEach(function(a){a.inst.evaluate(0),a.inst.changed=1,a.inst.bcalcCount=0,a.inst.bcalcCounts=0,a.inst.bcalcCountt=0}),V=[],W=[],X=[],Y=a.objects[U],Y.bones.length>55)for(Z=Y.bones.slice(0),Z.forEach(function(a){a.inst.name.match(/hand_1|hand_2|hand_3|hand_4|hand_5|eye|ear|tail|handle|hold|finger/i)&&(a.inst.active=0)}),Z.sort(function(a,b){return!a.inst.active&&b.inst.active?1:a.inst.active&&!b.inst.active?-1:b.inst.restLength-a.inst.restLength}),$=54;$<Z.length;$++)Z[$].inst.active=0;if(a.evaluate(0),_=0,ab=0,bb=mat4.inverse(a.objects[U].inst.evaluateMatrix(),mat4.create()),a.objects[U].bones.forEach(function(a){a.inst.h=0,a.inst.p=0,a.inst.b=0,a.inst.changed=1}),a.objects.forEach(function(a){a.inst.evaluate(0),a.bones&&a.bones.length?a.bones.forEach(function(a){a.inst.bcalcCounts=a.inst.bcalcCountt=a.inst.bcalcCount=0,a.inst.changed=1}):(a.inst.bx=a.inst.x,a.inst.by=a.inst.y,a.inst.bz=a.inst.z,a.inst.bh=a.inst.h,a.inst.bp=a.inst.p,a.inst.bb=a.inst.b,a.inst.bcalcCountt=a.inst.bcalcCounts=0)}),a.objects[U].bones.forEach(function(b){var c,d;if(b.weightMap=-1,b.inst.active){if(!b.inst.swm&&h.oldSchool)return void(b.inst.active=0);b.inst.changed=1,b.inst.parent.changed=1,a.objects[U].inst.changed=1,b.inst.h=b.inst.bh,b.inst.p=b.inst.bp,b.inst.b=b.inst.bb,c=bb?mat4.multiply(bb,b.inst.evaluateMatrix(),mat4.create()):b.inst.boneMatrix(b.inst.parent),d=vec4.create([0,0,0,1]),mat4.multiplyVec4(c,d),b.restPos=d,b.restVec=vec3.create(),d=vec4.create([0,0,b.inst.restLength,1]),mat4.multiplyVec4(c,d),vec3.subtract(d,b.restPos,b.restVec),b.weightMap=ab++,X[_++]=b}}),cb=new Float32Array(a.objects[U].obj.attribs[0]),db=vec3.create(),eb=vec3.create(),fb=new Float64Array(X.length),gb=0,hb=vec3.create(),1&&function(){var a,b,c,d,e,f;for(a=0;a<cb.length/3;a++){for(db[0]=cb[3*a+0],db[1]=cb[3*a+1],db[2]=cb[3*a+2],gb=0,b=0;b<X.length;b++)vec3.subtract(db,X[b].restPos,hb),c=0,vec3.add(X[b].restPos,vec3.scale(X[b].restVec,Math.max(0,Math.min(1,vec3.dot(X[b].restVec,hb)/vec3.dot(X[b].restVec,X[b].restVec))),hb),hb),c=vec3.length(vec3.subtract(db,hb,eb)),d=Math.pow(1/c,32),d*=X[b].inst.restLength,gb+=d,fb[b]=d;for(e=0;4>e;e++)V[4*a+e]=0,W[4*a+e]=0;for(b=0;b<X.length;b++)for(d=fb[b]/gb,(h.oldSchool||X[b].inst.swm&&X[b].inst.weightmapOnly)&&(d=1),X[b].inst.swm&&X[b].inst.swm.values[a]&&(d*=X[b].inst.swm.values[a][0]),e=0;4>e;e++)if(d>V[4*a+e]){for(f=3;f>e;f--)V[4*a+f]=V[4*a+f-1],W[4*a+f]=W[4*a+f-1];V[4*a+e]=d,W[4*a+e]=X[b].weightMap+1;break}}}(),1&&function(){var a,b,c;for(a=0;a<cb.length/3;a++){for(b=0,c=0;4>c;c++)b+=V[4*a+c];for(c=0;4>c;c++)V[4*a+c]/=b;b||(V[4*a+0]=1,W[4*a+0]=0)}}(),V.length!=W.length)throw"debugger";for(ib=a.objects[U].obj,ib.attribs[360]=new ArrayBuffer(4*V.length),ib.attribs[360].itemsize=4,jb=new Float32Array(ib.attribs[360]),ib.attribs[370]=new ArrayBuffer(1*W.length),ib.attribs[370].itemsize=1,kb=new Uint8Array(ib.attribs[370]),lb=0;lb<V.length;lb++)jb[lb]=V[lb];for(lb=0;lb<W.length;lb++)kb[lb]=W[lb];a.objects[U].loaded=0}a.evaluate(0),p=null,c()}.bind(this);A()}.bind(this))},h={read:g,save:f,strip:!0,oldSchool:!1};c.pimLWS=h},{"./pim_lwo2":7,"./pim_utils":21}],9:[function(a,b,c){function d(a){this.arr=a,this.stream=new DataView(a),this.pos=0}function e(a,b){this.tag=a,this.data=b}function f(a,b,c,d,e){b&&(this.url=b),M[b]?M[b+"_"+d]?setTimeout(function(){for(var a in M[b+"_"+d])this[a]=M[b+"_"+d][a];c(M[b+"_"+d])}.bind(this),0):setTimeout(function(){var e=M[b];this.read(a,e,b.replace(/[^\\\/]*$/,""),function(a){c(a)},d,b)}.bind(this),0):N.fileAsArray(b,e?e.link():void 0,function(e){M[b]=e,this.read(a,e,b.replace(/[^\\\/]*$/,""),function(a){c(a)},d,b)}.bind(this))}var g,h,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N=a("./pim_utils").pimUtils,O=a("./pim_object").pimTextureCache;d.prototype.__defineGetter__&&d.prototype.__defineGetter__("length",function(){return this.stream.byteLength-this.pos}),d.prototype.skip=function(a){this.pos+=a},d.prototype.readByte=function(){return this.stream.getUint8(this.pos++)},d.prototype.readShort=function(){return this.pos+=2,this.stream.getUint16(this.pos-2)},d.prototype.readLong=function(){return this.pos+=4,this.stream.getUint32(this.pos-4)},d.prototype.readFloat32=function(){return this.pos+=4,this.stream.getFloat32(this.pos-4)},d.prototype.readFloat64=function(){return this.pos+=8,this.stream.getFloat64(this.pos-8)},d.prototype.readBlob=function(a,b){var c=void 0!=b&&b?"":this.arr.slice(this.pos,this.pos+a);return this.pos+=a,c},d.prototype.peekBlob=function(a){var b=this.arr.slice(this.pos,this.pos+a);return b},d.prototype.readVX=function(){var a=this.readShort();return a>=65280&&(this.pos-=2,a=16777215&this.readLong()),a},d.prototype.readTag=function(){if(this.length<4)return!1;for(var a="";a.length<4;)a+=String.fromCharCode(this.readByte()),a=a.replace(/^\0/,"");return a},d.prototype.readStr0=function(){for(var a,b="";a=this.readByte();)b+=String.fromCharCode(a);return 1&this.pos&&this.pos++,b},d.prototype.readChunkSize=function(a){return this.length<=4+a?!1:new e(this.readTag(),this.readBlob(2==a?this.readShort():this.readLong()))},d.prototype.readChunk=function(){return this.readChunkSize(4)},d.prototype.readSubChunk=function(){return this.readChunkSize(2)},d.prototype.readAllChunksSize=function(a){for(var b,c=[];b=this.readChunkSize(a);)c.push(b);return c},d.prototype.readAllChunks=function(){return this.readAllChunksSize(4)},d.prototype.readAllSubChunks=function(){return this.readAllChunksSize(2)},e.prototype.__defineGetter__&&e.prototype.__defineGetter__("length",function(){return this.data.length}),g=0,h=1,j=2,k=3,l=4,m=5,n=6,o=7,p=8,q=9,r=10,s=11,t=12,u=13,v=14,w=15,x=16,y=17,z=18,A={STIL:{still:l},FLAG:{flags:o}},B={CHAN:{channel:g},ENAB:{enabled:k},NEGA:{negative:k},OPAC:{type:k,opacity:r,envelope:q}},C={CNTR:{center:m,envelope:q},SIZE:{size:m,envelope:q},ROTA:{rotation:m,envelope:q},FALL:{type:k,falloff:m,envelope:q},OREF:{reference:l},CSYS:{coordinateSpace:k}},D={ENAB:{enabled:k}},E={TBLK:{blocks:p},BLOK:{syntax:H,blocks:p}},F={},G={NSNS:{normalSpace:o},NSNO:{blocks:p},VPVL:{blocks:p},IMGS:{blocks:p},CLIP:{syntax:A,blocks:p},VPRM:{syntax:E,unknown1:o,unknown2:o,blocks:p}},H={IMAP:{syntax:B,ordinal:l,blocks:p},TMAP:{syntax:C,blocks:p},PROJ:{projection:k},AXIS:{axis:k},PIXB:{pixelBlending:k},AAST:{type:k,antiAlias:r},IMAG:{image:q},VMAP:{vmap:l},AUVO:{dunno:k,auvx:x,auvy:x,ex1:x,ex2:x},AUVN:{over:w,name:l,over2:w},AUVU:{name:l},WRAP:{wrapX:k,wrapY:k},WRPW:{wrpW:r,envelope:q},WRPH:{wrpW:r,envelope:q},SHDR:{syntax:D,nr:k,blocks:p},FUNC:{syntax:G,name:l,blocks:p}},E.BLOK.syntax=H,I={COLR:{color:m,envelope:q},LUMI:{luminosity:r,envelope:q},DIFF:{diffuse:r,envelope:q},SPEC:{specular:r,envelope:q},GLOS:{glossiness:r,envelope:q},REFL:{reflection:r,envelope:q},TRAN:{transparency:r,envelope:q},ADTR:{additiveTransparency:r,envelope:q},RIND:{refraction:r,envelope:q},TRNL:{translucency:r,envelope:q},BUMP:{bump:r,envelope:q},SMAN:{sman:r},SIDE:{doublsided:k},BLOK:{syntax:H,blocks:p},RIMG:{reflectionImage:q},RFOP:{reflectionOptions:k},VERS:{version:o},NODS:{blocks:p},NVER:{nodeVersion:o},NNDS:{blocks:p},NSRV:{dunno:l},NTAG:{blocks:p},NROT:{blocks:p},NLOC:{x:r,y:r},NZOM:{zoom:r},NRNM:{dunno:l},NNME:{dunno:l},NCRD:{x:o,y:o}},J={NAME:{name:l},"PRE ":{pre:k},POST:{post:k},"KEY ":{lastTime:r,lastVal:r},TYPE:{format:w,keytype:w},SPAN:{spanType:g,t:r,c:r,b:r},TANI:{slopeType:k,weightType:k,weight:r,slope:r,value:r},TANO:{keyFlags:o,slopeType:k,weightType:k,weight:r,slope:r,value:r},FLAG:{flags:o}},K={CHAN:{channelNameIdx:q,data:y},LAYR:{lnr:o,flags:o,rgba:o},UNIQ:{identifier:l},UIDX:{index:o},LINK:{graphname:l,itemindex:o,linkindex:o},CHNV:{channelname:l,data:z},ITAG:{tp:g,value:l},CHNS:{name:l,value:l},GRAD:{channelName:l,envelope:q,interpolation:o}},L={FORM:{formType:g,formBlocks:h},VRSN:{number:o,number2:o,name:l},CHNM:{nr:o,names:j},TAGS:{tags:j},ITEM:{syntax:K,name:l,uname:l,id:o,tags:p},LAYR:{lnr:k,flags:k,pivot:m,name:l,parent:k},BBOX:{min:m,max:m},PNTS:{points:n},VMAP:{mapType:g,dimension:k,mapName:l,values:u},CLIP:{syntax:A,clipIndex:o,blocks:p},SURF:{syntax:I,surfName:l,source:l,blocks:p},ENVL:{syntax:J,envlIndex:q,blocks:p},POLS:{type:g,poly:s},PTAG:{tagType:g,tags:t},VMAD:{mapType:g,dimension:k,mapName:l,values:v}},e.prototype.byTag=function(a){var b,c=this.formBlocks||this.blocks;for(b=0;b<c.length;b++)if(c[b].tag==a)return c[b]},e.prototype.unfold=function(a,b){var c,e,f,i,A,B,C,D,E,F,G,H,I,J=console.log.bind(console);if(void 0==a&&(a=L),void 0==b&&(b=""),c=a,e=new d(this.data),a[this.tag]){f=a[this.tag];for(i in f){if("syntax"==i)c=f[i];else if(e.length)switch(1*f[i]){case g:this[i]=e.readTag();break;case k:this[i]=e.readShort();break;case l:this[i]=e.readStr0();break;case q:this[i]=e.readVX();break;case r:this[i]=e.readFloat32();break;case o:this[i]=e.readLong();break;case w:this[i]=e.readByte();break;case x:this[i]=e.readFloat64();break;case m:this[i]=[e.readFloat32(),e.readFloat32(),e.readFloat32()];break;case h:this[i]=e.readAllChunks(),J(b,this.tag),this[i].forEach(function(a){a.unfold(c,"  "+b)});break;case p:this[i]=e.readAllSubChunks(),J(b,this.tag),this[i].forEach(function(a){a.unfold(c,"  "+b)});break;case y:switch(A=e.readShort()){case 1:this[i]={value:e.readLong()};break;case 2:this[i]={value:e.readFloat32()};break;case 3:this[i]={value:e.readStr0()};break;case 4:this[i]={value:e.readLong(),env:e.readVX()};break;case 5:this[i]={value:e.readFloat32(),env:e.readVX()};break;case 6:this[i]={value:e.readStr0()}}break;case z:for(A=e.readShort(),B=e.readShort(),C=[];B--;)switch(A){case 1:C.push({name:e.readStr0(),value:e.readLong()});break;case 2:C.push({name:e.readStr0(),value:e.readFloat32()});break;case 3:C.push({name:e.readStr0(),value:e.readStr0()})}this[i]=C;break;case j:for(this[i]=[];e.length;)this[i].push(e.readStr0());break;case n:for(this[i]=new Float32Array(e.length/4),D=0;e.length;)this[i][D++]=e.readFloat32();break;case s:for(this[i]=[];e.length;){for(E=e.readShort(),F=[],G=0;(1023&E)>G;G++)F.push(e.readVX());this[i].push(F)}break;case t:for(this[i]=[];e.length;)this[i].push({poly:e.readVX(),tag:e.readShort()});break;case u:for(this[i]=[];e.length>=2+4*this.dimension;)switch(+this.dimension){case 1:D=e.readVX(),this[i][D]={id:D,data:[e.readFloat32()]};break;case 2:D=e.readVX(),this[i][D]={id:D,data:[e.readFloat32(),e.readFloat32()]};break;case 3:D=e.readVX(),this[i][D]={id:D,data:[e.readFloat32(),e.readFloat32(),e.readFloat32()]};break;case 4:D=e.readVX(),this[i][D]={id:D,data:[e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32()]}}break;case v:for(this[i]=[];e.length>2;)switch(+this.dimension){case 1:this[i].push({id:e.readVX(),pid:e.readVX(),data:[e.readFloat32()]});break;case 2:this[i].push({id:e.readVX(),pid:e.readVX(),data:[e.readFloat32(),e.readFloat32()]});break;case 3:this[i].push({id:e.readVX(),pid:e.readVX(),data:[e.readFloat32(),e.readFloat32(),e.readFloat32()]});break;case 4:this[i].push({id:e.readVX(),pid:e.readVX(),data:[e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32()]})}}if("FUNC"==this.tag&&"name"==i&&"(Pim)Shader"==this[i])for(e.readLong();e.length;)H=e.readStr0(),I=e.readStr0(),this[H]=I;else"syntax"==i||i.match(/blocks/i)||J(b,this.tag," -> ",i,this[i])}delete this.data}else J(b,"unknown block : ",this.tag,this.data.byteLength);return this},M={},f.prototype.read=function(a,b,c,e,f,g){var h,j,k,l,m,n,o,p,q,r;for(this.formBlocks=itf.foldCache[g]?itf.foldCache[g]:new d(b).readAllChunks()[0].unfold(void 0,"").formBlocks,itf.foldCache[g]=this.formBlocks,h=this,h.layers=[],h.surfaces=[],h.splines=[],h.clips=[],i=0;i<h.formBlocks.length;i++)switch(j=h.formBlocks[i],j.tag){case"TAGS":h.tags=j.tags;break;case"LAYR":h.layers.unshift({nr:j.lnr,name:j.name.replace(/\r/g,""),pivot:j.pivot,vmaps:{},vmads:{}});break;case"PNTS":h.layers[0].points=j.points;break;case"POLS":"FACE"==j.type&&(h.layers[0].poly=j.poly);break;case"PTAG":"SURF"==j.tagType&&(h.layers[0].ptag?h.layers[0].ptag.concat(j.tags):h.layers[0].ptag=j.tags);break;case"VMAP":h.layers[0].vmaps[j.mapName]=j;break;case"VMAD":h.layers[0].vmads[j.mapName]=j;break;case"CLIP":"STIL"==j.blocks[0].tag&&(h.clips[j.clipIndex]=j.blocks[0].still);break;case"ENVL":for(m=new pimSpline,m.idx=j.envlIndex,n=0;o=j.blocks[n];n++)switch(o.tag){case"NAME":m.name=o.name;break;case"PRE ":m.pre=o.pre;break;case"POST":m.post=o.post;break;case"KEY ":k=o.lastTime,l=o.lastVal;break;case"SPAN":"LINE"==o.spanType&&m.addKey(k,l,pimSpline.M_LINEAR),"STEP"==o.spanType&&m.addKey(k,l,pimSpline.M_STEPPED),"TCB "==o.spanType&&m.addKey(k,l,pimSpline.M_TCB,o.t,o.c,o.b)}h.splines.push(m);break;case"SURF":m=new pimSurface({name:j.surfName,color:[.8,.8,.8],luminosity:0,diffuse:1,specular:0,transparency:0,sman:1.3788,doublesided:!1,reflection:0,channels:[]}),m.tagnr=h.tags.lastIndexOf(j.surfName);for(n in j.blocks)switch(o=j.blocks[n],o.tag){case"COLR":m.color=o.color;break;case"LUMI":m.luminosity=o.luminosity;break;case"DIFF":m.diffuse=o.diffuse;break;case"SPEC":m.specular=o.specular;break;case"REFL":m.reflection=o.reflection;break;case"TRAN":m.transparency=o.transparency,o.envelope&&(m.transparency_env=o.envelope);break;case"ADTR":m.additiveTransparency=o.additiveTransparency;break;case"GLOS":m.glossiness=o.glossiness;break;case"SMAN":m.sman=o.sman;break;case"SIDE":m.doublesided=o.doublesided;break;case"RIMG":m.reflectionImage=o.reflectionImage;break;case"BLOK":if(p={},o.byTag("AUVO")&&(p.auvx=o.byTag("AUVO").auvx,p.auvy=o.byTag("AUVO").auvy),o.byTag("IMAP")&&(p.type=o.byTag("IMAP").byTag("CHAN").channel,p.enabled=1==o.byTag("IMAP").byTag("ENAB").enabled,p.opacity=o.byTag("IMAP").byTag("OPAC").opacity,p.negative=1==o.byTag("IMAP").byTag("NEGA").negative),o.byTag("FUNC"))if("NormalShader"==o.byTag("FUNC").name)p.type="NRML",p.enabled=1==o.byTag("SHDR").byTag("ENAB").enabled,p.projection=o.byTag("FUNC").byTag("NSNO").byTag("VPVL").byTag("VPRM").byTag("TBLK").byTag("BLOK").byTag("PROJ").projection,p.uvmap=o.byTag("FUNC").byTag("NSNO").byTag("VPVL").byTag("VPRM").byTag("TBLK").byTag("BLOK").byTag("VMAP").vmap,p.image=o.byTag("FUNC").byTag("NSNO").byTag("IMGS").byTag("CLIP").byTag("STIL").still,-1==h.clips.indexOf(p.image)&&h.clips.push(p.image);else if("(Pim)Shader"==o.byTag("FUNC").name){m.noZ=0!=o.byTag("FUNC")["pimSurface.NoZImpression"];for(q in o.byTag("FUNC"))q.match(/\./)&&(m[q]=o.byTag("FUNC")[q])}o.byTag("PROJ")&&(p.projection=o.byTag("PROJ").projection),o.byTag("AXIS")&&(p.axis=o.byTag("AXIS").axis),o.byTag("TMAP")&&(p.center=o.byTag("TMAP").byTag("CNTR").center,p.rotation=o.byTag("TMAP").byTag("ROTA").rotation,p.scale=o.byTag("TMAP").byTag("SIZE").size,p.coordspace=o.byTag("TMAP").byTag("CSYS").coordinateSpace),o.byTag("IMAG")&&(p.image=h.clips[o.byTag("IMAG").image]),o.byTag("PIXB")&&(p.pixelBlend=o.byTag("PIXB").pixelBlending),5==p.projection&&o.byTag("VMAP")&&(p.uvmap=o.byTag("VMAP").vmap),m.channels.push(p)}h.surfaces[m.tagnr]=m}r=new N.countingCompleter,h.clips.forEach(function(a){var b=a.replace(/[^\\\/]*[\\\/]/gm,"");void 0==O[c+b]&&(O[c+b]=N.loadImage(c+b,void 0,r.link(),function(a,b){a[b]=null}.bind(this,O,c+b)))}),r.wait(function(){if(void 0!=f)for(var b in h.layers)if(h.layers[b].nr==f){h.layers=[h.layers[b]];break}h.layers.forEach(function(b){function d(a,b,c){var d,e;if(void 0==k[2*a])return k[2*a]=b,k[2*a+1]=c,a;for(d=a;;){if(k[2*d]==b&&k[2*d+1]==c)return d;if(d=l[d],d==a)break}for(d=p.length/3,e=a;l[e]!=a;)e=l[e];return l[d]=a,l[e]=d,p[3*d]=p[3*a],p[3*d+1]=p[3*a+1],p[3*d+2]=p[3*a+2],k[2*d]=b,k[2*d+1]=c,d}function e(a,b,c){if(b!=c)for(var d=3*m[a];d<3*m[+a+1];d++)for(ovx2=b;;)if(j[d]==ovx2&&(j[d]=c),ovx2=l[ovx2],ovx2==b)break}function g(a,b,c){if(b!=c)for(var d=3*a;3*(+a+1)>d;d++)for(ovx2=b;;)if(j[d]==ovx2&&(j[d]=c),ovx2=l[ovx2],ovx2==b)break}var i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,P,Q,R,S,T,U,V,W,X,Y,Z;if(void 0==f||b.nr==f){for(i=new pimObject,i.attribs={},j=[],k=[],l=[],m=[],n=[],o=[],p=Array.prototype.slice.call(b.points,0),q=0;q<p.length/3;q++)l[q]=q;
for(q in b.poly)switch(m[parseInt(q)]=j.length/3,b.poly[q].length){case 2:break;case 3:j.push(b.poly[q][2],b.poly[q][1],b.poly[q][0]);break;case 4:j.push(b.poly[q][2],b.poly[q][1],b.poly[q][0]),j.push(b.poly[q][3],b.poly[q][2],b.poly[q][0]);break;default:for(r=[],r.push(b.poly[q][0]),s=!1,t=1,u=b.poly[q].length-1;u>=t;)s?(r.push(b.poly[q][t]),t++):(r.push(b.poly[q][u]),u--),s=!s;for(s=!0,v=0;v<r.length-2;v++)s?j.push(r[v],r[v+1],r[v+2]):j.push(r[v],r[v+2],r[v+1]),s=!s}m[parseInt(q)+1]=j.length/3;for(q in b.ptag)for(w=b.ptag[q].poly,x=b.ptag[q].tag,t=m[w];t<m[w+1];t++)n[t]={id:x,idx:t};for(v in b.vmaps)"TXUV"!=b.vmaps[v].mapType&&(y=b.vmaps[v].values.length,y!=p.length/3&&b.vmaps[v].values.splice(p.length/3));for(z in h.surfaces)for(A in h.surfaces[z].channels)if(B=h.surfaces[z].channels[A],B.image&&null!=O[c+B.image.replace(/[^\\\/]*[\\\/]/gm,"")])if(h.surfaces[z].auvx=B.auvx,h.surfaces[z].auvy=B.auvy,"COLR"==B.type&&(h.surfaces[z].tempmap=B.image.replace(/[^\\\/]*[\\\/]/gm,"")),"TRAN"==B.type&&(h.surfaces[z].tempmapalpha=B.image.replace(/[^\\\/]*[\\\/]/gm,""),h.surfaces[z].tempmap&&(B.projection=1)),5==B.projection){if(b.vmaps[B.uvmap])for(C=h.surfaces[z].tagnr,D=b.vmaps[B.uvmap].values,E=0;E<n.length;E++)if(n[E].id==C)for(q=3*E;3*E+3>q;q++)b.vmaps[B.uvmap].values[j[q]]&&g(E,j[q],d(j[q],D[j[q]].data[0],D[j[q]].data[1]));if(b.vmads[B.uvmap])for(F=b.vmads[B.uvmap].values,C=h.surfaces[z].tagnr,E=0;E<b.vmads[B.uvmap].values.length;E++)n[m[b.vmads[B.uvmap].values[E].pid]]&&n[m[F[E].pid]].id==C&&e(b.vmads[B.uvmap].values[E].pid,F[E].id,d(F[E].id,F[E].data[0],F[E].data[1]))}else if(0==B.projection){for(G=mat4.create(),mat4.identity(G),H=vec4.create(),mat4.translate(G,[.5,.5,.5]),mat4.scale(G,[1/B.scale[0],1/B.scale[1],1/B.scale[2]]),mat4.rotateX(G,-B.rotation[0]),mat4.rotateY(G,B.rotation[1]),mat4.rotateZ(G,-B.rotation[2]),mat4.translate(G,[-B.center[0],-B.center[1],-B.center[2]]),E=0;E<n.length;E++)if(n[E].id==h.surfaces[z].tagnr)for(v=3*m[E];v<3*m[+E+1];v++)switch(H[0]=p[3*j[v]+0],H[1]=p[3*j[v]+1],H[2]=p[3*j[v]+2],H[3]=1,mat4.multiplyVec4(G,H,H),B.axis){case 0:g(E,j[v],d(j[v],H[1],H[2]));break;case 1:g(E,j[v],d(j[v],H[0],H[2]));break;case 2:g(E,j[v],d(j[v],H[0],H[1]))}}else if(1==B.projection)for(G=mat4.create(),mat4.identity(G),H=vec4.create(),I=vec3.create(),J=vec3.create(),K=vec3.create(),mat4.translate(G,[.5,.5,.5]),mat4.scale(G,[1/B.scale[0],1/B.scale[1],1/B.scale[2]]),mat4.rotateX(G,-B.rotation[0]),mat4.rotateY(G,B.rotation[1]),mat4.rotateZ(G,-B.rotation[2]),mat4.translate(G,[-B.center[0],-B.center[1],-B.center[2]]),E=0;E<n.length;E++)if(n[E].id==h.surfaces[z].tagnr)for(I[0]=p[3*j[3*m[E]+1]+0]-p[3*j[3*m[E]]+0],I[1]=p[3*j[3*m[E]+1]+1]-p[3*j[3*m[E]]+1],I[2]=p[3*j[3*m[E]+1]+2]-p[3*j[3*m[E]]+2],J[0]=p[3*j[3*m[E]+2]+0]-p[3*j[3*m[E]]+0],J[1]=p[3*j[3*m[E]+2]+1]-p[3*j[3*m[E]]+1],J[2]=p[3*j[3*m[E]+2]+2]-p[3*j[3*m[E]]+2],vec3.cross(I,J,K),v=3*m[E];v<3*m[+E+1];v++){switch(H[0]=p[3*j[v]+0],H[1]=p[3*j[v]+1],H[2]=p[3*j[v]+2],H[3]=1,mat4.multiplyVec4(G,H,H),B.axis){case 0:v=H[0],H[0]=0,L=ong_vv(H,[1,0,0])/(2*Math.PI)-.5;break;case 1:v=H[1],H[1]=0,L=ong_vv(H,[0,1,0])/(2*Math.PI)-.5;break;case 2:v=-H[2],H[2]=0,L=-ong_vv(H,[0,0,1])/(2*Math.PI)-.5}g(E,j[v],d(j[v],L,v))}for(v in b.vmaps)if("TXUV"!=b.vmaps[v].mapType){for(y=b.vmaps[v].values.length,q=0;y>q;q++)void 0==b.vmaps[v].values[q]&&(b.vmaps[v].values[q]={data:[0,0,0,0].slice(0,b.vmaps[v].dimension),id:q});for(q=y;q<p.length/3;q++){for(M=l[q];M>y&&M!=q;)M=l[M];b.vmaps[v].values[q]=b.vmaps[v].values[M]}}N=[],n.sort(function(a,b){return a.id-b.id}),P=-1;for(q in n)n[q].id!=P&&(P=n[q].id,N.push(1*P),o.push(1*q));o.push(Math.floor(j.length/3)),Q=j.slice(0),j=[];for(q in n)t=n[q].idx,j[3*q]=Q[3*t],j[3*q+1]=Q[3*t+1],j[3*q+2]=Q[3*t+2];for(i.attribs[0]=new ArrayBuffer(4*p.length),i.attribs[0].itemsize=3,R=new Float32Array(i.attribs[0]),i.attribs[1]=new ArrayBuffer(4*p.length),i.attribs[1].itemsize=3,S=new Float32Array(i.attribs[1]),i.attribs[40]=new ArrayBuffer(p.length/3*2*4),i.attribs[40].itemsize=2,T=new Float32Array(i.attribs[40]),p.length/3>65535?(i.attribs[1003]=new ArrayBuffer(4*j.length),i.attribs[1003].itemsize=1,U=new Uint32Array(i.attribs[1003])):(i.attribs[1003]=new ArrayBuffer(2*j.length),i.attribs[1003].itemsize=1,U=new Uint16Array(i.attribs[1003])),E=0;E<p.length/3;E++)R[3*E+0]=p[3*E],R[3*E+1]=p[3*E+1],R[3*E+2]=p[3*E+2],S[3*E+0]=0,S[3*E+1]=0,S[3*E+2]=1,T[2*E]=k[2*E],T[2*E+1]=1-k[2*E+1];for(E=0;E<j.length;E++)U[E]=j[E];for(i.surfaces=[],E=0;E<o.length-1;E++)if(o[E+1]-o[E]){V=new pimSurface({name:h.surfaces[N[E]].name,alphamap:h.surfaces[N[E]].tempmapalpha,diffusemap:h.surfaces[N[E]].tempmap,diffusemap2:"",diffusemap3:"",normalmap:"",doublesided:h.surfaces[N[E]].doublesided,color:h.surfaces[N[E]].color,diffuse:h.surfaces[N[E]].diffuse,luminosity:h.surfaces[N[E]].luminosity,specular:h.surfaces[N[E]].specular,transparency:h.surfaces[N[E]].transparency||0,additiveTransparency:h.surfaces[N[E]].additiveTransparency||0,splines:[],start:parseInt(o[E]),count:parseInt(o[E+1]-o[E]),diffuseBlend:0,diffuseUAnim:h.surfaces[N[E]].auvx||0,diffuseVAnim:h.surfaces[N[E]].auvy||0});for(W in h.surfaces[N[E]])W.match(/\./)&&(V[W]=h.surfaces[N[E]][W]);if(i.surfaces.push(V),h.surfaces[N[E]].transparency_env){z={tp:0};for(X in h.splines)h.splines[X].idx==h.surfaces[N[E]].transparency_env&&(z=h.splines[X]);i.surfaces[i.surfaces.length-1].splines.push({tp:6,keys:z})}}for(E in i.surfaces)i.surfaces[E].diffusemap&&(i.surfaces[E].diffuseimg=O[c+i.surfaces[E].diffusemap]),i.surfaces[E].alphamap&&(i.surfaces[E].alphaimg=O[c+i.surfaces[E].alphamap]);i.resourceName=this.url.replace(/\r/g,""),Y=a.addObject(i),Z=Y.inst,Z.name=this.url.replace(/\r/g,"").replace(/^.*[\\\/]/,"").replace(/\.lwo/i,"")+":"+(b.name?b.name:"Layer"+(b.nr+1)),Z.ss=0,Z.visible=1,i.calculateSmoothNormals(),Y.lnr=b.nr,this.lastinst=Z,this.lastobj=Y}}.bind(this)),e(h)}.bind(this))},c.pimlxo={lxo:f,foldCache:{}}},{"./pim_object":12,"./pim_utils":21}],10:[function(a,b,c){function d(a,b,c,d){var e,f,g,h,i=1e-8,j=vec3.subtract(b,a),k=vec3.subtract(d,c),l=vec3.subtract(a,c),m=vec3.dot(j,j),n=vec3.dot(j,k),o=vec3.dot(k,k),p=vec3.dot(j,l),q=vec3.dot(k,l),r=m*o-n*n,s=r,t=r;return i>r?(f=0,s=1,h=q,t=o):(f=n*q-o*p,h=m*q-n*p,0>f?(f=0,h=q,t=o):f>s&&(f=s,h=q+n,t=o)),0>h?(h=0,0>-p?f=0:-p>m?f=s:(f=-p,s=m)):h>t&&(h=t,0>-p+n?f=0:-p+n>m?f=s:(f=-p+n,s=m)),e=Math.abs(f)<i?0:f/s,g=Math.abs(h)<i?0:h/t,vec3.length(vec3.subtract(vec3.add(l,vec3.scale(j,e)),vec3.scale(k,g)))}mat4.multiplyVec4b=function(a,b,c,d){var e=b[d],f=b[d+1],g=b[d+2];c[0]=a[0]*e+a[4]*f+a[8]*g+a[12],c[1]=a[1]*e+a[5]*f+a[9]*g+a[13],c[2]=a[2]*e+a[6]*f+a[10]*g+a[14],c[3]=a[3]*e+a[7]*f+a[11]*g+a[15]},mat4.multiplyVec3b=function(a,b,c,d){var e=b[d],f=b[d+1],g=b[d+2];c[0]=a[0]*e+a[4]*f+a[8]*g,c[1]=a[1]*e+a[5]*f+a[9]*g,c[2]=a[2]*e+a[6]*f+a[10]*g},mat4.multiplyVec3bb=function(a,b,c,d){var e=b[d],f=b[d+1],g=b[d+2];c[d]=a[0]*e+a[4]*f+a[8]*g,c[d+1]=a[1]*e+a[5]*f+a[9]*g,c[d+2]=a[2]*e+a[6]*f+a[10]*g},mat4.multiplyVec3bb1=function(a,b,c,d){var e=b[d],f=b[d+1],g=b[d+2];c[d]=a[0]*e+a[4]*f+a[8]*g+a[12],c[d+1]=a[1]*e+a[5]*f+a[9]*g+a[13],c[d+2]=a[2]*e+a[6]*f+a[10]*g+a[14]},mat4.multiplyVec4bscale=function(a,b,c,d,e){var f=b[d],g=b[d+1],h=b[d+2];c[0]=e*(a[0]*f+a[4]*g+a[8]*h+a[12]),c[1]=e*(a[1]*f+a[5]*g+a[9]*h+a[13]),c[2]=e*(a[2]*f+a[6]*g+a[10]*h+a[14]),c[3]=e*(a[3]*f+a[7]*g+a[11]*h+a[15])},mat4.multiplyVec4bbscale=function(a,b,c,d,e){var f=b[d],g=b[d+1],h=b[d+2];c[d]=e*(a[0]*f+a[4]*g+a[8]*h+a[12]),c[d+1]=e*(a[1]*f+a[5]*g+a[9]*h+a[13]),c[d+2]=e*(a[2]*f+a[6]*g+a[10]*h+a[14])},mat4.multiplyVec3bbscale=function(a,b,c,d,e){var f=b[d],g=b[d+1],h=b[d+2];c[d]=e*(a[0]*f+a[4]*g+a[8]*h),c[d+1]=e*(a[1]*f+a[5]*g+a[9]*h),c[d+2]=e*(a[2]*f+a[6]*g+a[10]*h)},mat4.multiplyVec4bscaleadd=function(a,b,c,d,e){var f=b[d],g=b[d+1],h=b[d+2];c[0]+=e*(a[0]*f+a[4]*g+a[8]*h+a[12]),c[1]+=e*(a[1]*f+a[5]*g+a[9]*h+a[13]),c[2]+=e*(a[2]*f+a[6]*g+a[10]*h+a[14]),c[3]+=e*(a[3]*f+a[7]*g+a[11]*h+a[15])},mat4.multiplyVec4bbscaleadd=function(a,b,c,d,e){var f=b[d],g=b[d+1],h=b[d+2];c[d]+=e*(a[0]*f+a[4]*g+a[8]*h+a[12]),c[d+1]+=e*(a[1]*f+a[5]*g+a[9]*h+a[13]),c[d+2]+=e*(a[2]*f+a[6]*g+a[10]*h+a[14])},mat4.multiplyVec3bbscaleadd=function(a,b,c,d,e){var f=b[d],g=b[d+1],h=b[d+2];c[d]+=e*(a[0]*f+a[4]*g+a[8]*h),c[d+1]+=e*(a[1]*f+a[5]*g+a[9]*h),c[d+2]+=e*(a[2]*f+a[6]*g+a[10]*h)},c.pimMaths={segmentToSegment:d}},{}],11:[function(){(function(a){function b(a,b,d){return e.fromEuler(a[0],a[1],a[2],f),e.fromEuler(b[0],b[1],b[2],g),e.normalize(e.slerp(f,g,d,h)),c.fromQuat(i,h),c.toHPB(i)}var c,d,e,f,g,h,i,j="undefined"!=typeof Float32Array?Float32Array:Array,k={};k.create=function(a){var b=new j(3);return a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):b[0]=b[1]=b[2]=0,b},k.subtract=function(a,b,c){return c&&a!==c?(c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c):(a[0]-=b[0],a[1]-=b[1],a[2]-=b[2],a)},k.add=function(a,b,c){return c&&a!==c?(c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c):(a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a)},k.mul=function(a,b,c){return c&&a!==c?(c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2],c):(a[0]*=b[0],a[1]*=b[1],a[2]*=b[2],a)},k.scale=function(a,b,c){return c&&a!==c?(c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c):(a[0]*=b,a[1]*=b,a[2]*=b,a)},k.normalize=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=Math.sqrt(c*c+d*d+e*e);return f?1===f?(b[0]=c,b[1]=d,b[2]=e,b):(f=1/f,b[0]=c*f,b[1]=d*f,b[2]=e*f,b):(b[0]=0,b[1]=0,b[2]=0,b)},k.cross=function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=b[0],h=b[1],i=b[2];return c[0]=e*i-f*h,c[1]=f*g-d*i,c[2]=d*h-e*g,c},k.length=function(a){var b=a[0],c=a[1],d=a[2];return Math.sqrt(b*b+c*c+d*d)},k.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},c={},c.create=function(a){var b=new j(16);return a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]),b},c.set=function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15],b},c.identity=function(a){return a||(a=c.create()),a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},c.transpose=function(a,b){if(!b||a===b){var c=a[1],d=a[2],e=a[3],f=a[6],g=a[7],h=a[11];return a[1]=a[4],a[2]=a[8],a[3]=a[12],a[4]=c,a[6]=a[9],a[7]=a[13],a[8]=d,a[9]=f,a[11]=a[14],a[12]=e,a[13]=g,a[14]=h,a}return b[0]=a[0],b[1]=a[4],b[2]=a[8],b[3]=a[12],b[4]=a[1],b[5]=a[5],b[6]=a[9],b[7]=a[13],b[8]=a[2],b[9]=a[6],b[10]=a[10],b[11]=a[14],b[12]=a[3],b[13]=a[7],b[14]=a[11],b[15]=a[15],b},c.inverse=function(a,b){b||(b=a);var c,d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],p=a[12],q=a[13],r=a[14],s=a[15],t=d*i-e*h,u=d*j-f*h,v=d*k-g*h,w=e*j-f*i,x=e*k-g*i,y=f*k-g*j,z=l*q-m*p,A=l*r-n*p,B=l*s-o*p,C=m*r-n*q,D=m*s-o*q,E=n*s-o*r,F=t*E-u*D+v*C+w*B-x*A+y*z;return F?(c=1/F,b[0]=(i*E-j*D+k*C)*c,b[1]=(-e*E+f*D-g*C)*c,b[2]=(q*y-r*x+s*w)*c,b[3]=(-m*y+n*x-o*w)*c,b[4]=(-h*E+j*B-k*A)*c,b[5]=(d*E-f*B+g*A)*c,b[6]=(-p*y+r*v-s*u)*c,b[7]=(l*y-n*v+o*u)*c,b[8]=(h*D-i*B+k*z)*c,b[9]=(-d*D+e*B-g*z)*c,b[10]=(p*x-q*v+s*t)*c,b[11]=(-l*x+m*v-o*t)*c,b[12]=(-h*C+i*A-j*z)*c,b[13]=(d*C-e*A+f*z)*c,b[14]=(-p*w+q*u-r*t)*c,b[15]=(l*w-m*u+n*t)*c,b):null},c.multiply=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;return c||(c=a),d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],p=a[12],q=a[13],r=a[14],s=a[15],t=b[0],u=b[1],v=b[2],w=b[3],c[0]=t*d+u*h+v*l+w*p,c[1]=t*e+u*i+v*m+w*q,c[2]=t*f+u*j+v*n+w*r,c[3]=t*g+u*k+v*o+w*s,t=b[4],u=b[5],v=b[6],w=b[7],c[4]=t*d+u*h+v*l+w*p,c[5]=t*e+u*i+v*m+w*q,c[6]=t*f+u*j+v*n+w*r,c[7]=t*g+u*k+v*o+w*s,t=b[8],u=b[9],v=b[10],w=b[11],c[8]=t*d+u*h+v*l+w*p,c[9]=t*e+u*i+v*m+w*q,c[10]=t*f+u*j+v*n+w*r,c[11]=t*g+u*k+v*o+w*s,t=b[12],u=b[13],v=b[14],w=b[15],c[12]=t*d+u*h+v*l+w*p,c[13]=t*e+u*i+v*m+w*q,c[14]=t*f+u*j+v*n+w*r,c[15]=t*g+u*k+v*o+w*s,c},c.multiplyVec3=function(a,b,c){c||(c=b);var d=b[0],e=b[1],f=b[2];return c[0]=a[0]*d+a[4]*e+a[8]*f+a[12],c[1]=a[1]*d+a[5]*e+a[9]*f+a[13],c[2]=a[2]*d+a[6]*e+a[10]*f+a[14],c},c.multiplyVec4FxyzwF=function(a,b,c,d,e,f){return f[0]=a[0]*b+a[4]*c+a[8]*d+a[12]*e,f[1]=a[1]*b+a[5]*c+a[9]*d+a[13]*e,f[2]=a[2]*b+a[6]*c+a[10]*d+a[14]*e,f[3]=a[3]*b+a[7]*c+a[11]*d+a[15]*e,f},c.multiplyVec4=function(a,b,c){c||(c=b);var d=b[0],e=b[1],f=b[2],g=b[3];return c[0]=a[0]*d+a[4]*e+a[8]*f+a[12]*g,c[1]=a[1]*d+a[5]*e+a[9]*f+a[13]*g,c[2]=a[2]*d+a[6]*e+a[10]*f+a[14]*g,c[3]=a[3]*d+a[7]*e+a[11]*f+a[15]*g,c},c.translate=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p=b[0],q=b[1],r=b[2];return c&&a!==c?(d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],c[0]=d,c[1]=e,c[2]=f,c[3]=g,c[4]=h,c[5]=i,c[6]=j,c[7]=k,c[8]=l,c[9]=m,c[10]=n,c[11]=o,c[12]=d*p+h*q+l*r+a[12],c[13]=e*p+i*q+m*r+a[13],c[14]=f*p+j*q+n*r+a[14],c[15]=g*p+k*q+o*r+a[15],c):(a[12]=a[0]*p+a[4]*q+a[8]*r+a[12],a[13]=a[1]*p+a[5]*q+a[9]*r+a[13],a[14]=a[2]*p+a[6]*q+a[10]*r+a[14],a[15]=a[3]*p+a[7]*q+a[11]*r+a[15],a)},c.scale=function(a,b,c){var d=b[0],e=b[1],f=b[2];return c&&a!==c?(c[0]=a[0]*d,c[1]=a[1]*d,c[2]=a[2]*d,c[3]=a[3]*d,c[4]=a[4]*e,c[5]=a[5]*e,c[6]=a[6]*e,c[7]=a[7]*e,c[8]=a[8]*f,c[9]=a[9]*f,c[10]=a[10]*f,c[11]=a[11]*f,c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15],c):(a[0]*=d,a[1]*=d,a[2]*=d,a[3]*=d,a[4]*=e,a[5]*=e,a[6]*=e,a[7]*=e,a[8]*=f,a[9]*=f,a[10]*=f,a[11]*=f,a)},c.rotate=function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C=c[0],D=c[1],E=c[2],F=Math.sqrt(C*C+D*D+E*E);return F?(1!==F&&(F=1/F,C*=F,D*=F,E*=F),e=Math.sin(b),f=Math.cos(b),g=1-f,h=a[0],i=a[1],j=a[2],k=a[3],l=a[4],m=a[5],n=a[6],o=a[7],p=a[8],q=a[9],r=a[10],s=a[11],t=C*C*g+f,u=D*C*g+E*e,v=E*C*g-D*e,w=C*D*g-E*e,x=D*D*g+f,y=E*D*g+C*e,z=C*E*g+D*e,A=D*E*g-C*e,B=E*E*g+f,d?a!==d&&(d[12]=a[12],d[13]=a[13],d[14]=a[14],d[15]=a[15]):d=a,d[0]=h*t+l*u+p*v,d[1]=i*t+m*u+q*v,d[2]=j*t+n*u+r*v,d[3]=k*t+o*u+s*v,d[4]=h*w+l*x+p*y,d[5]=i*w+m*x+q*y,d[6]=j*w+n*x+r*y,d[7]=k*w+o*x+s*y,d[8]=h*z+l*A+p*B,d[9]=i*z+m*A+q*B,d[10]=j*z+n*A+r*B,d[11]=k*z+o*A+s*B,d):null},c.rotateX=function(a,b,c){var d=Math.sin(b),e=Math.cos(b),f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11];return c?a!==c&&(c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a,c[4]=f*e+j*d,c[5]=g*e+k*d,c[6]=h*e+l*d,c[7]=i*e+m*d,c[8]=f*-d+j*e,c[9]=g*-d+k*e,c[10]=h*-d+l*e,c[11]=i*-d+m*e,c},c.rotateY=function(a,b,c){var d=Math.sin(b),e=Math.cos(b),f=a[0],g=a[1],h=a[2],i=a[3],j=a[8],k=a[9],l=a[10],m=a[11];return c?a!==c&&(c[4]=a[4],c[5]=a[5],c[6]=a[6],c[7]=a[7],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a,c[0]=f*e+j*-d,c[1]=g*e+k*-d,c[2]=h*e+l*-d,c[3]=i*e+m*-d,c[8]=f*d+j*e,c[9]=g*d+k*e,c[10]=h*d+l*e,c[11]=i*d+m*e,c},c.rotateZ=function(a,b,c){var d=Math.sin(b),e=Math.cos(b),f=a[0],g=a[1],h=a[2],i=a[3],j=a[4],k=a[5],l=a[6],m=a[7];return c?a!==c&&(c[8]=a[8],c[9]=a[9],c[10]=a[10],c[11]=a[11],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a,c[0]=f*e+j*d,c[1]=g*e+k*d,c[2]=h*e+l*d,c[3]=i*e+m*d,c[4]=f*-d+j*e,c[5]=g*-d+k*e,c[6]=h*-d+l*e,c[7]=i*-d+m*e,c},c.frustum=function(a,b,d,e,f,g,h){h||(h=c.create());var i=b-a,j=e-d,k=g-f;return h[0]=2*f/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=2*f/j,h[6]=0,h[7]=0,h[8]=(b+a)/i,h[9]=(e+d)/j,h[10]=-(g+f)/k,h[11]=-1,h[12]=0,h[13]=0,h[14]=-(g*f*2)/k,h[15]=0,h},c.perspective=function(a,b,d,e,f){var g=d*Math.tan(a*Math.PI/360),h=g*b;return c.frustum(-h,h,-g,g,d,e,f)},c.ortho=function(a,b,d,e,f,g,h){h||(h=c.create());var i=b-a,j=e-d,k=g-f;return h[0]=2/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=2/j,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=-2/k,h[11]=0,h[12]=-(a+b)/i,h[13]=-(e+d)/j,h[14]=-(g+f)/k,h[15]=1,h},c.lookAt=function(a,b,d,e){e||(e=c.create());var f,g,h,i,j,k,l,m,n,o,p=a[0],q=a[1],r=a[2],s=d[0],t=d[1],u=d[2],v=b[0],w=b[1],x=b[2];return p===v&&q===w&&r===x?c.identity(e):(l=p-v,m=q-w,n=r-x,o=1/Math.sqrt(l*l+m*m+n*n),l*=o,m*=o,n*=o,f=t*n-u*m,g=u*l-s*n,h=s*m-t*l,o=Math.sqrt(f*f+g*g+h*h),o?(o=1/o,f*=o,g*=o,h*=o):(f=0,g=0,h=0),i=m*h-n*g,j=n*f-l*h,k=l*g-m*f,o=Math.sqrt(i*i+j*j+k*k),o?(o=1/o,i*=o,j*=o,k*=o):(i=0,j=0,k=0),e[0]=f,e[1]=i,e[2]=l,e[3]=0,e[4]=g,e[5]=j,e[6]=m,e[7]=0,e[8]=h,e[9]=k,e[10]=n,e[11]=0,e[12]=-(f*p+g*q+h*r),e[13]=-(i*p+j*q+k*r),e[14]=-(l*p+m*q+n*r),e[15]=1,e)},d={},d.create=function(a){var b=new j(4);return a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):(b[0]=0,b[1]=0,b[2]=0,b[3]=0),b},d.add=function(a,b,c){return c&&a!==c?(c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c):(a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a[3]+=b[3],a)},d.scale=function(a,b,c){return c&&a!==c?(c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c):(a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b,a)},d.normalize=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=Math.sqrt(c*c+d*d+e*e+f*f);return g?1===g?(b[0]=c,b[1]=d,b[2]=e,b[3]=f,b):(g=1/g,b[0]=c*g,b[1]=d*g,b[2]=e*g,b[3]=f*g,b):(b[0]=0,b[1]=0,b[2]=0,b[3]=0,b)},d.length=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];return Math.sqrt(b*b+c*c+d*d+e*e)},e={},e.create=d.create,e.normalize=d.normalize,e.fromEuler=function(a,b,c,d){var f,g,h,i,j,k,l,m,n,o;return void 0==d&&(d=e.create()),a*=.5,b*=.5,c*=.5,f=Math.cos(a),g=Math.cos(c),h=Math.cos(b),i=Math.sin(a),j=Math.sin(c),k=Math.sin(b),l=f*g,m=f*j,n=i*k,o=i*h,d[0]=o*j+l*k,d[1]=o*g+m*k,d[2]=m*h-n*g,d[3]=l*h-n*j,d},e.slerp=function(a,b,c,e){var f,g,h,i,j,k,l,m,n,o,p,q,r;return void 0==e&&(e=d.create()),f=a[0],g=a[1],h=a[2],i=a[3],j=b[0],k=b[1],l=b[2],m=b[3],o=f*j+g*k+h*l+i*m,0>o&&(o=-o,j=-j,k=-k,l=-l,m=-m),1-o>1e-6?(n=Math.acos(o),p=Math.sin(n),q=Math.sin((1-c)*n)/p,r=Math.sin(c*n)/p):(q=1-c,r=c),e[0]=q*f+r*j,e[1]=q*g+r*k,e[2]=q*h+r*l,e[3]=q*i+r*m,e},e.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1],j=c[2],k=c[3];return a[0]=d*k+g*h+e*j-f*i,a[1]=e*k+g*i+f*h-d*j,a[2]=f*k+g*j+d*i-e*h,a[3]=g*k-d*h-e*i-f*j,a},e.slerpNoInvert=function(a,b,c,e){var f,g,h,i,j,k,l,m,n,o,p,q,r;return void 0==e&&(e=d.create()),f=a[0],g=a[1],h=a[2],i=a[3],j=b[0],k=b[1],l=b[2],m=b[3],o=f*j+g*k+h*l+i*m,o>.999999||-.999999>o?(n=Math.acos(o),p=Math.sin(n),q=Math.sin((1-c)*n)/p,r=Math.sin(c*n)/p):(q=1-c,r=c),e[0]=q*f+r*j,e[1]=q*g+r*k,e[2]=q*h+r*l,e[3]=q*i+r*m,e},e.squad=function(a,b,c,d,f,g){var h=e.create(),i=e.create();return e.slerpNoInvert(a,b,f,h),e.slerpNoInvert(c,d,f,i),e.slerpNoInvert(h,i,2*f*(1-f),g),g},e.bezier=function(a,b,c,d,f,g){var h=e.create(),i=e.create(),j=e.create();return e.slerpNoInvert(a,c,f,h),e.slerpNoInvert(c,d,f,i),e.slerpNoInvert(d,b,f,j),e.slerpNoInvert(h,i,f,h),e.slerpNoInvert(i,j,f,j),e.slerpNoInvert(h,j,f,g),g},e.log=function(a,b){var c=Math.acos(a[3]),d=Math.sin(c);return b[3]=0,d>0?(b[0]=c*a[0]/d,b[1]=c*a[1]/d,b[2]=c*a[2]/d):b[0]=b[1]=b[2]=0,b},e.exp=function(a,b){var c=k.length(a),d=Math.sin(c),e=Math.cos(c);return b[3]=e,c>0?(b[0]=d*a[0]/c,b[1]=d*a[1]/c,b[2]=d*a[2]/c):b[0]=b[1]=b[2]=0,b},e.add=d.add,e.scale=d.scale,e.splinePoint=function(a,b,c){var d,f,g=e.create();return e.conjugate(b,g),d=e.create(),f=e.create(),e.multiply(g,a,d),e.multiply(g,c,f),e.log(d,d),e.log(f,f),e.add(d,f),e.scale(d,-.25),e.exp(d,d),e.mul(b,d,out),out},e.invert=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=c*c+d*d+e*e+f*f,h=g?1/g:0;return b[0]=-c*h,b[1]=-d*h,b[2]=-e*h,b[3]=f*h,b},e.dot=function(a){return k.dot(a,a)+a[3]*a[3]},e.subtract=function(a,b,c){c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3]},e.conjugate=function(a,b){return b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=a[3],b},e.double=function(a,b,c){return e.scale(b,2*e.dot(a,b),c),e.subtract(c,a,c),c},e.bisect=function(a,b,c){return e.add(a,b,c),e.scale(c,Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]+c[3]*c[3])),c},e.findA=function(a,b,c,d){return e.double(a,b,d),e.bisect(d,c,d),d},e.findB=function(a,b,c){return e.double(b,a,c),c},e.fromMat4=function(a,b){var c,e,f,g,h;return void 0==b&&(b=d.create()),c=a[0]+a[5]+a[10],c>0?(e=Math.sqrt(c+1),b[3]=.5*e,e=.5/e,b[0]=(a[6]-a[9])*e,b[1]=(a[8]-a[2])*e,b[2]=(a[1]-a[4])*e):(f=0,a[5]>a[0]&&(f=1),a[10]>a[4*f+f]&&(f=2),g=(f+1)%3,h=(f+2)%3,e=Math.sqrt(a[4*f+f]-a[4*g+g]-a[4*h+h]+1),b[f]=.5*e,e=.5/e,b[3]=(a[4*g+h]-a[4*h+g])*e,b[g]=(a[4*g+f]+a[4*f+g])*e,b[h]=(a[4*h+f]+a[4*f+h])*e),b},c.fromQuat=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c+c,h=d+d,i=e+e,j=c*g,k=d*g,l=d*h,m=e*g,n=e*h,o=e*i,p=f*g,q=f*h,r=f*i;return a[0]=1-l-o,a[1]=k+r,a[2]=m-q,a[3]=0,a[4]=k-r,a[5]=1-j-o,a[6]=n+p,a[7]=0,a[8]=m+q,a[9]=n-p,a[10]=1-j-l,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},f=e.create(),g=e.create(),h=e.create(),i=c.create(),a.vec3=k,a.mat4=c,a.vec4=d,a.quat=e,a.slerpHPB=b}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],12:[function(a,b,c){function d(a){var b,c,e;if(this.channels=[],this.diffuse=1/3,this.diffuse=1,this.luminosity=1/3,this.luminosity=0,this.color=[1,1,1],this.transparency=1/3,this.transparency=0,this.specular=1/3,this.specular=0,this.glossiness=.2,this.additiveTransparency=1/3,this.additiveTransparency=0,this.splines=[],this.name="",this.noZ=!1,this.noZT=!1,this.tagnr=0,this.transparency_env=0,this.luminosity_env=0,this.color_env=0,this.reflectionImage="",this.tag="",this.vertexShader=null,this.fragmentShader=null,this.program=null,this.vertexZShader=null,this.fragmentZShader=null,this.Zprogram=null,this.mm=null,this.vm=null,this.mvp=null,this.zmm=null,this.zvm=null,this.zmvp=null,this.mmi=null,this.camPos=null,this.t1=null,this.t2=null,this.t3=null,this.t1anim=null,this.a1=null,this.r1=null,this.r2=null,this.extra=[],this.textureLocations={},this.lightpos=[],this.lightdir=[],this.lightcol=[],this.lightspot=[],this.lightatt=[],this.lightlvm=[],this.lightlvp=[],this.lightmap=[],this.lightintensity=[],this.lightrange=[],this.lumiloc=null,this.diffloc=null,this.colorloc=null,this.transparencyloc=null,this.morphs=[],this.zmorphs=[],this.animspline=null,this.pimShaderExt={"pimGui.ItemGui":"0"},this.doublesided=!1,this.start=0,this.count=0,this.sman=1/3,this.sman=0,this.reflection=1/3,this.reflection=0,this.alphamap="",this.diffusemap="",this.diffusemap2="",this.diffusemap3="",this.normalmap="",this.diffuseBlend=0,this.diffuseBlend2=0,this.diffuseBlend3=0,this.diffuseUAnim=0,this.diffuseVAnim=0,this.invertalpha=!1,this.pfm=null,this.fmcount=this.count,this.fmcountrestore=this.count,a instanceof d){if(this.diffuse=a.diffuse,this.luminosity=a.luminosity,this.color=vec3.create(a.color),this.transparency=a.transparency,this.specular=a.specular,this.glossiness=a.glossiness,this.additiveTransparency=a.additiveTransparency,this.name=a.name,this.start=a.start,this.count=a.count,this.diffuseBlend=a.diffuseBlend,this.diffuseBlend2=a.diffuseBlend2,this.diffuseBlend3=a.diffuseBlend3,this.diffuseUAnim=a.diffuseUAnim,this.diffuseVAnim=a.diffuseVAnim,this.splines=a.splines.map(function(a){return{tp:a.tp,keys:new pimSpline(a.keys)}}),a.channels)for(this.channels=[],b=0;c=a.channels[b];b++)e={},["enabled","map","type","auvx","auvy","negative","opacity","texunit","image","mapname","pixelBlend","axis","center","scale","rotation"].forEach(function(a){c[a]&&(e[a]=c[a])}),this.channels.push(e);if(a.pimShaderExt)for(b in a.pimShaderExt)this.pimShaderExt[b]=a.pimShaderExt[b]}else for(b in a)this[b]=a[b];return this}function e(a){var b;if(this.surfaces=[],this.hasTransparency=0,this.loaded=0,this.attribs={},this.resourceName="",this.name="",this.lnr=-1,this.vmaps={},this.generated=0,a){for(b in a.attribs)this.attribs[b]=a.attribs[b].slice&&a.attribs[b].slice(0)||a.attribs[b].buffer.slice(0),this.attribs[b].itemsize=a.attribs[b].itemsize;for(b in a.surfaces)this.surfaces[b]=new d(a.surfaces[b])}}d.prototype.loadImage=function(a){if(a instanceof File){var b=new FileReader;return b.onload=function(a){this.loadImage(a.target.result)}.bind(this),void b.readAsDataURL(a)}this.channels[0].map=pimUtils.loadImage(a)};e.attribs={0:"position",1:"normal",2:"tangent",40:"texcoord",360:"weighthash",370:"boneindex",400:"morphbase",401:"morph1",402:"morph2",403:"morph3",404:"morph4",405:"morph5",406:"morph6",407:"morph7",408:"morph8",409:"morph9",410:"morph10",411:"morph11",412:"morph12",413:"morph13",414:"morph14",415:"morph15",416:"morph16",1003:"triangles"},e.prototype.calculateBoundingBox=function(){var a,b,c;if(this.attribs){for(a=new Float32Array(this.attribs[0]),b=new Float32Array(new ArrayBuffer(24)),c=0;c<a.byteLength/12;c++)(0==c||b[0]>a[3*c])&&(b[0]=a[3*c]),(0==c||b[3]<a[3*c])&&(b[3]=a[3*c]),(0==c||b[1]>a[3*c+1])&&(b[1]=a[3*c+1]),(0==c||b[4]<a[3*c+1])&&(b[4]=a[3*c+1]),(0==c||b[2]>a[3*c+2])&&(b[2]=a[3*c+2]),(0==c||b[5]<a[3*c+2])&&(b[5]=a[3*c+2]);return b}},e.prototype.calculatePolygonNormals=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n;if(this.attribs&&this.attribs[1003]){for(a=new Float32Array(this.attribs[0]),b=a.length/3>65535?new Uint32Array(this.attribs[1003]):new Uint16Array(this.attribs[1003]),c=vec3.create(),d=vec3.create(),e=vec3.create(),f=vec3.create(),g=vec3.create(),h=vec3.create(),i=new Float32Array(new ArrayBuffer(b.byteLength/6*12)),j=0;j<b.length/3;j++)k=3*j,l=3*b[k],m=3*b[k+1],n=3*b[k+2],c.set([a[m]-a[l],a[m+1]-a[l+1],a[m+2]-a[l+2]]),d.set([a[n]-a[l],a[n+1]-a[l+1],a[n+2]-a[l+2]]),vec3.cross(c,d,e),i[k]=e[0],i[k+1]=e[1],i[k+2]=e[2];this.attribs[4003]=i}},e.prototype.calculateSmoothNormals=function(){var a,b,c,d,e,f,g,h,i,j;for(this.attribs[4003]&&this.attribs[4003].length==this.attribs[1003].length||this.calculatePolygonNormals(),void 0==this.attribs[1]&&(this.attribs[1]=new ArrayBuffer(this.attribs[0].byteLength),this.attribs[1].itemsize=3),a=new Float32Array(this.attribs[1]),a.name="pim_normal",b=new Float32Array(this.attribs[4003]),c=a.length/3>65535?new Uint32Array(this.attribs[1003]):new Uint16Array(this.attribs[1003]),d=vec3.create(),e=vec3.create(),f=0;f<a.length;f++)a[f]=0;for(f=0;f<c.length/3;f++)g=3*f,h=3*c[g],i=3*c[g+1],j=3*c[g+2],a[h+0]-=b[g],a[h+1]-=b[g+1],a[h+2]-=b[g+2],a[i+0]-=b[g],a[i+1]-=b[g+1],a[i+2]-=b[g+2],a[j+0]-=b[g],a[j+1]-=b[g+1],a[j+2]-=b[g+2];for(f=0;f<a.length/3;f++)g=3*f,d[0]=a[g],d[1]=a[g+1],d[2]=a[g+2],vec3.normalize(d),0==d[0]&&0==d[1]&&0==d[2]&&(d[2]=-1),a[g]=d[0],a[g+1]=d[1],a[g+2]=d[2]},c.pimSurface=d,c.pimObject=e},{}],13:[function(a,b,c){function d(a,b){var c,d,e;if(this.maxParticles=b.maxParticles||1024,this.lastLive=0,this.lastDead=0,this.spill=0,this.birthRate=500,this.lifeTime=2,this.forceEmit=0,this.forceDelta=0,this.velocity=0,this.lastTime=(new Date).getTime(),this.sizeRange=0,this.sizeScale=1,this.weightRange=0,this.blendMode=0,this.nozzleGeo=0,this.nozzleMode=0,this.gX=0,this.gY=0,this.gZ=0,this.obj=a,this.obj.customRender=this.customRender.bind(this),this.obj.bbox=new Float32Array(new ArrayBuffer(24)),this.direction=vec3.create(),this.direction[0]=0,this.direction[1]=0,this.direction[2]=0,this.tweightOffset=0,this.tspinOffset=0,this.coneAngle=0,this.damping=1,this.tweight=new Float32Array(new ArrayBuffer(8192)),this.tsize=new Float32Array(new ArrayBuffer(8192)),this.tintensity=new Float32Array(new ArrayBuffer(8192)),this.tspin=new Float32Array(new ArrayBuffer(8192)),this.tdispersion=new Float32Array(new ArrayBuffer(8192)),this.tcolorr=new Uint8Array(new ArrayBuffer(2048)),this.tcolorg=new Uint8Array(new ArrayBuffer(2048)),this.tcolorb=new Uint8Array(new ArrayBuffer(2048)),this.Red=new pimSpline,this.Green=new pimSpline,this.Blue=new pimSpline,this.Size=new pimSpline,this.Intensity=new pimSpline,this.Dispersion=new pimSpline,this.Weight=new pimSpline,this.Spin=new pimSpline,this.startVX=0,this.StartVX=new pimSpline,this.stopVX=1,this.StopVX=new pimSpline,this.GravityX=new pimSpline,this.GravityY=new pimSpline,this.GravityZ=new pimSpline,this.Rate=new pimSpline,this.randomColor=!1,this.xFrames=1,this.xCycles=1,this.particles=new ArrayBuffer(u*this.maxParticles*4),this.pf=new Float32Array(this.particles),this.pd=new Int32Array(this.particles),this.quadsb=new ArrayBuffer(3*this.maxParticles*4*4),this.quads=new Float32Array(this.quadsb),this.agesb=new ArrayBuffer(4*this.maxParticles*4),this.ages=new Float32Array(this.agesb),this.colorsb=new ArrayBuffer(3*this.maxParticles*4),this.colors=new Uint8Array(this.colorsb),this.image=new Image,this.image2=new Image,this.imageName="",this.alphaName="",this.invertAlpha=!1,this.obj.driverLoad=this.driverLoad.bind(this),b){for(c in b)switch(d=b[c],c){case"name":this.obj.inst.name=d;break;case"position":this.obj.inst.position=d;break;case"scale":this.obj.inst.scale=d;break;case"direction":this.direction[0]=d[0],this.direction[1]=d[1],this.direction[2]=d[2];break;case"parent":this.obj.inst.parent=d;break;case"Red":case"Green":case"Blue":case"Size":case"Intensity":case"Dispersion":case"Weight":case"Spin":case"StartVX":case"StopVX":case"GravityX":case"GravityY":case"GravityZ":case"Rate":if(d[0])for(e in d)this[c].addKey(d[e][0],d[e][1],d[e][2],d[e][3],d[e][4],d[e][5]);else this[c].addKey(0,d);break;default:this[c]=d}this.Update()}}var e,f="uniform mat4 MVM;\nuniform mat4 MVP;\nattribute vec3 pim_position;\nattribute float pim_age;\nvarying float age;\nattribute vec2 pim_texcoord0;\nvarying vec2 texcoord;\nattribute vec3 pim_color;\nvarying vec3 color;\nvoid main() {\n  texcoord = pim_texcoord0;\n  age = pim_age;\n  color = pim_color;\n  gl_Position = MVP * MVM * vec4(pim_position,1);\n}",g="precision mediump float;\nvarying float age;\nvarying vec2 texcoord;\nvarying vec3 color;\n#ifdef PIM_TEXTURE0\n  uniform sampler2D pim_texture0;\n#endif\n#ifdef PIM_ALPHA0\n  uniform sampler2D pim_alpha0;\n#endif\nvoid main() {\n  #ifdef PIM_TEXTURE0\n    vec3 c = texture2D(pim_texture0, texcoord).rgb*color/256.0;\n  #else\n    vec3 c = color/256.0;\n  #endif\n  #ifdef PIM_ALPHA0\n    #ifdef PIM_INVERT_ALPHA\n      float intensity = age * (1.0-texture2D(pim_alpha0, texcoord).r);\n    #else\n      float intensity = age * texture2D(pim_alpha0, texcoord).r;\n    #endif\n  #else\n    float intensity = age;\n  #endif\n  gl_FragColor = vec4(c, intensity);\n}",h=0,i=1,j=1,k=2,l=3,m=4,n=5,o=6,p=7,q=8,r=9,s=13,t=14,u=14;for(pimInstance.prototype.__defineSetter__&&[["blendmode","blendMode"],["birthrate","birthRate"],["Gx","gX"],["Gy","gY"],["Gz","gZ"],["Spill","spill"],["alphaname","alphaName"],["imagename","imageName"],["LifeTime","lifeTime"],["ForceEmit","forceEmit"],["LastTime","lastTime"],["WeightRange","weightRange"],["SizeRange","sizeRange"],["SizeScale","sizeScale"]].forEach(function(a){d.prototype.__defineGetter__(a[0],Function("console.log('%cChange "+a[0]+" into "+a[1]+"'+new Error().stack.split('\\n',3)[2],'background:#FFCCCC; color:black'); return this."+a[1]+";")),d.prototype.__defineSetter__(a[0],Function("console.log('%cChange "+a[0]+" into "+a[1]+"'+new Error().stack.split('\\n',3)[2],'background:#FFCCCC; color:black'); this."+a[1]+" = arguments[0];"))}),d.prototype.Update=function(){var a,b;for(a=0;2048>a;a++)this.tintensity[a]=this.Intensity.evaluate(a*(100/30)/2048),this.tsize[a]=this.Size.evaluate(a*(100/30)/2048),1==this.randomColor?(b=vec3.normalize([Math.random(),Math.random(),Math.random()]),this.tcolorr[a]=Math.floor(255*b[0]),this.tcolorg[a]=Math.floor(255*b[1]),this.tcolorb[a]=Math.floor(255*b[2])):(this.tcolorr[a]=Math.floor(255*this.Red.evaluate(a*(100/30)/2048)),this.tcolorg[a]=Math.floor(255*this.Green.evaluate(a*(100/30)/2048)),this.tcolorb[a]=Math.floor(255*this.Blue.evaluate(a*(100/30)/2048))),this.tweight[a]=this.Weight.evaluate(a*(100/30)/2048),this.tspin[a]=this.Spin.evaluate(a*(100/30)/2048),this.tdispersion[a]=this.Dispersion.evaluate(a*(100/30)/2048);this.gX=this.GravityX.evaluate(0),this.gY=this.GravityY.evaluate(0),this.gZ=this.GravityZ.evaluate(0)},d.prototype.driverLoad=function(a,b){var c,d,e,h,i,j,k,l="";for((this.imageName||this.image)&&(l+="#define PIM_TEXTURE0\n",this.image||(this.image=pimUtils.loadImage(this.imageName,function(){},function(){}.bind(this)))),(this.alphaName||this.image2)&&(l+="#define PIM_ALPHA0\n",this.invertAlpha&&(l+="#define PIM_INVERT_ALPHA\n"),this.image2||(this.image2=pimUtils.loadImage(this.alphaName,function(){},function(){}.bind(this)))),c=f,d=g,e=a.createShader(a.VERTEX_SHADER),a.shaderSource(e,l+c),a.compileShader(e),!a.getShaderParameter(e,a.COMPILE_STATUS),h=a.createShader(a.FRAGMENT_SHADER),a.shaderSource(h,l+d),a.compileShader(h),!a.getShaderParameter(h,a.COMPILE_STATUS),this.program=a.createProgram(),a.attachShader(this.program,e),a.attachShader(this.program,h),a.linkProgram(this.program),!a.getProgramParameter(this.program,a.LINK_STATUS),this.mvm=a.getUniformLocation(this.program,"MVM"),this.mvp=a.getUniformLocation(this.program,"MVP"),this.pos=a.getAttribLocation(this.program,"pim_position"),this.col=a.getAttribLocation(this.program,"pim_color"),this.age=a.getAttribLocation(this.program,"pim_age"),this.texc=a.getAttribLocation(this.program,"pim_texcoord0"),this.texm=a.getUniformLocation(this.program,"pim_texture0"),this.texa=a.getUniformLocation(this.program,"pim_alpha0"),this.glBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.glBuffer),a.bufferData(a.ARRAY_BUFFER,this.quads,a.DYNAMIC_DRAW),this.glBuffer2=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.glBuffer2),a.bufferData(a.ARRAY_BUFFER,this.ages,a.DYNAMIC_DRAW),i=new Float32Array(new ArrayBuffer(8*this.maxParticles*4)),j=0;j<this.maxParticles;j++)i[8*j+0]=1/this.xFrames,i[8*j+1]=0,i[8*j+2]=0,i[8*j+3]=0,i[8*j+4]=0,i[8*j+5]=1,i[8*j+6]=1/this.xFrames,i[8*j+7]=1;
for(this.texcoords=i,this.glBuffer3=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.glBuffer3),1!=this.xFrames?a.bufferData(a.ARRAY_BUFFER,i,a.DYNAMIC_DRAW):a.bufferData(a.ARRAY_BUFFER,i,a.STATIC_DRAW),k=new Uint16Array(new ArrayBuffer(6*this.maxParticles*2)),j=0;j<this.maxParticles;j++)k[6*j+0]=4*j,k[6*j+1]=4*j+1,k[6*j+2]=4*j+2,k[6*j+3]=4*j,k[6*j+4]=4*j+2,k[6*j+5]=4*j+3;this.gliBuffer=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.gliBuffer),a.bufferData(a.ELEMENT_ARRAY_BUFFER,k,a.STATIC_DRAW),this.glBuffer4=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.glBuffer4),a.bufferData(a.ARRAY_BUFFER,this.colors,a.DYNAMIC_DRAW),this.loaded=1,b&&b()},d.prototype.customRender=function(a,b,c,d,e){this.obj.inst.visible&&(this.loaded||this.driverLoad(a,void 0,e),this.UpdateEmitter(this.obj.inst.evaluateMatrix()),this.DrawEmitter(a,b,c,e),this.obj.inst.changed=1)},d.prototype.emit=function(a,b){return this.forceEmit=a,this.forceDelta=b||0,this.UpdateEmitter(this.obj.inst.evaluateMatrix()),this},d.prototype.emitAt=function(a,b){var c=b.evaluateMatrix();return this.obj.inst.position=[c[12],c[13],c[14]],this.obj.inst.changed=1,this.emit(a)},d.prototype.UpdateEmitter=function(){function a(a,c){var d,e,f,g,i,m;for(d=a;c>=d;d++)e=d*u,0!=this.pd[e+h]&&(this.pd[e+h]+=K),f=Math.floor(this.pd[e+h]/this.lifeTime),(f>=2048||0==this.tintensity[f])&&(this.pd[e+h]=0,this.lastDead=d,g=.05*this.pf[e+s]*this.tsize[2047],b[0]=Math.min(b[0],this.pf[e+j]-g),b[1]=Math.min(b[1],this.pf[e+k]-g),b[2]=Math.min(b[2],this.pf[e+l]-g),b[3]=Math.max(b[3],this.pf[e+j]+g),b[4]=Math.max(b[4],this.pf[e+k]+g),b[5]=Math.max(b[5],this.pf[e+l]+g)),0!=this.pd[e+h]&&(2==this.Version?(i=1*this.tweight[(f+this.tweightOffset*e)%2048]*L,this.pf[e+p]=this.pf[e+p]*this.damping+i*this.gX,this.pf[e+q]=this.pf[e+q]*this.damping+i*this.gY,this.pf[e+r]=this.pf[e+r]*this.damping+i*this.gZ,this.pf[e+j]+=this.pf[e+p]*L,this.pf[e+k]+=this.pf[e+q]*L,this.pf[e+l]+=this.pf[e+r]*L):(m=L*this.tweight[(f+this.tweightOffset*e)%2048],this.pf[e+j]+=this.pf[e+p]*m+1*m*this.gX,this.pf[e+k]+=this.pf[e+q]*m+1*m*this.gY,this.pf[e+l]+=this.pf[e+r]*m+1*m*this.gZ),g=.05*this.pf[e+s]*this.tsize[f],b[0]=Math.min(b[0],this.pf[e+j]-g),b[1]=Math.min(b[1],this.pf[e+k]-g),b[2]=Math.min(b[2],this.pf[e+l]-g),b[3]=Math.max(b[3],this.pf[e+j]+g),b[4]=Math.max(b[4],this.pf[e+k]+g),b[5]=Math.max(b[5],this.pf[e+l]+g))}var b,c,e,f,g,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J=(new Date).getTime(),K=Math.min(200,J-this.lastTime),L=K/1e3;if(this.lastTime=J,b=this.obj.bbox,b[0]=1e4,b[1]=1e4,b[2]=1e4,b[3]=-1e4,b[4]=-1e4,b[5]=-1e4,this.lastLive!=this.lastDead)this.lastLive>this.lastDead?a.call(this,this.lastDead+1,this.lastLive):(a.call(this,this.lastDead+1,this.maxParticles-1),a.call(this,0,this.lastLive));else if(c=0,this.birthRate+this.forceEmit==0&&(c=1),this.nozzleGeo&&this.startVX==this.stopVX&&(c=1),c)return;if(e=Math.floor(Math.abs(this.birthRate)*(K+this.spill)/1e3)+this.forceEmit,this.forceEmit=0,this.birthRate<0&&(e=1),f=this.obj.inst.evaluateMatrix(),0!=this.nozzleMode&&(this.nozzleGeo?(g=new Float32Array(this.nozzleGeo.obj.attribs[0]),v=new Float32Array(this.nozzleGeo.obj.attribs[1]),f=this.nozzleGeo.inst.evaluateMatrix()):(g=new Float32Array(this.obj.obj.attribs[0]),v=new Float32Array(this.obj.obj.attribs[1]))),w=vec4.create(),e&&(x=this.direction,2!=this.nozzleMode||this.nozzle||(x=[0,0,-1]),0!=x[0]||0!=x[1]||0!=x[2]?(w[0]=x[0],w[1]=x[1],w[2]=x[2],w[3]=0,mat4.multiplyVec4(this.obj.inst.evaluateMatrix(),w,w),vec3.normalize(w)):w=this.direction),0==e)this.birthRate>0&&(this.spill+=K);else for(this.spill=0!=this.birthRate&&0!=Math.floor(1e3/Math.abs(this.birthRate))?Math.floor((this.spill+K)%Math.floor(1e3/Math.abs(this.birthRate))):0,y=0,z=0,A=0,1==this.interpolateMode&&(this.lastM||(this.lastM=[f[12],f[13],f[14]]),this.lastM[0]!=f[12]||this.lastM[1]!=f[13]||this.lastM[2]!=f[14]?(y=f[12]-this.lastM[0],z=f[13]-this.lastM[1],A=f[14]-this.lastM[2],f[12]=this.lastM[0],f[13]=this.lastM[1],f[14]=this.lastM[2],B=Math.sqrt(y*y+z*z+A*A),this.birthRate<0&&(e=Math.round(Math.abs(this.birthRate)*B),0==e&&(this.spill+=K)),e&&(y/=e,z/=e,A/=e)):(y=0,z=0,A=0,this.birthRate<0&&(e=0))),C=vec4.create(),D=0;e>D;D++){if(++this.lastLive==this.maxParticles&&(this.lastLive=0),this.lastLive==this.lastDead&&++this.lastDead==this.maxParticles&&(this.lastDead=0),E=u*this.lastLive,this.pd[E+h]=this.birthRate>0?1+Math.floor(D*(1e3/Math.abs(this.birthRate))+this.spill)%2048:1,F=Math.floor(this.pd[E+h]/this.lifeTime),F>=2048)throw"ai";0==this.nozzleMode?(this.pf[E+j]=Math.random()-.5,this.pf[E+k]=Math.random()-.5,this.pf[E+l]=Math.random()-.5,this.Space||mat4.multiplyVec3bb1(f,this.pf,this.pf,E+i)):this.nozzleMode>=1&&(this.nozzleGeo instanceof d?(G=(this.nozzleGeo.lastDead+1+Math.random()*(this.nozzleGeo.lastLive-this.nozzleGeo.lastDead)|0)%this.nozzleGeo.maxParticles,G*=u,this.pf[E+j]=this.nozzleGeo.pf[G+j],this.pf[E+k]=this.nozzleGeo.pf[G+k],this.pf[E+l]=this.nozzleGeo.pf[G+l]):(H=Math.floor(this.startVX*g.length/3+Math.random()*(this.stopVX-this.startVX)*g.length/3),this.pf[E+j]=g[3*H+0],this.pf[E+k]=g[3*H+1],this.pf[E+l]=g[3*H+2],mat4.multiplyVec3bb1(f,this.pf,this.pf,E+i),this.pf[E+j]+=(Math.random()-.5)*this.tdispersion[F],this.pf[E+k]+=(Math.random()-.5)*this.tdispersion[F],this.pf[E+l]+=(Math.random()-.5)*this.tdispersion[F])),this.pf[E+m]=this.pf[E+j],this.pf[E+n]=this.pf[E+k],this.pf[E+o]=this.pf[E+l],2!=this.nozzleMode?0==w[0]&&0==w[1]&&0==w[2]?(I=vec3.normalize([2*Math.random()-1,2*Math.random()-1,2*Math.random()-1]),this.pf[E+p]=I[0]*this.velocity,this.pf[E+q]=I[1]*this.velocity,this.pf[E+r]=I[2]*this.velocity):(this.pf[E+p]=w[0]*this.velocity+Math.random()*this.coneAngle-this.coneAngle/2,this.pf[E+q]=w[1]*this.velocity+Math.random()*this.coneAngle-this.coneAngle/2,this.pf[E+r]=w[2]*this.velocity+Math.random()*this.coneAngle-this.coneAngle/2):(C[0]=v[3*H+0],C[1]=v[3*H+1],C[2]=v[3*H+2],C[3]=0,mat4.multiplyVec4(f,C,C),vec3.normalize(C),this.pf[E+p]=C[0]*this.velocity,this.pf[E+q]=C[1]*this.velocity,this.pf[E+r]=C[2]*this.velocity),this.pf[E+s]=(1+Math.random()*this.sizeRange)*this.sizeScale,this.pf[E+t]=1+Math.random()*this.weightRange,0==this.birthRate&&(K=Math.round(D*this.forceDelta),this.pf[E+j]+=.001*this.pf[E+p]*K*this.tweight[(F+this.tweightOffset*this.lastLive)%2048]+1*this.tweight[(F+this.tweightOffset*this.lastLive)%2048]*this.gX*K/1e3,this.pf[E+k]+=.001*this.pf[E+q]*K*this.tweight[(F+this.tweightOffset*this.lastLive)%2048]+1*this.tweight[(F+this.tweightOffset*this.lastLive)%2048]*this.gY*K/1e3,this.pf[E+l]+=.001*this.pf[E+r]*K*this.tweight[(F+this.tweightOffset*this.lastLive)%2048]+1*this.tweight[(F+this.tweightOffset*this.lastLive)%2048]*this.gZ*K/1e3),b[0]=Math.min(b[0],this.pf[E+j]-.05),b[1]=Math.min(b[1],this.pf[E+k]-.05),b[2]=Math.min(b[2],this.pf[E+l]-.05),b[3]=Math.max(b[3],this.pf[E+j]+.05),b[4]=Math.max(b[4],this.pf[E+k]+.05),b[5]=Math.max(b[5],this.pf[E+l]+.05),1==this.interpolateMode&&(f[12]+=y,f[13]+=z,f[14]+=A)}this.lastM=[f[12],f[13],f[14]]},d.vec3cache=[vec3.create(),vec3.create(),vec3.create(),vec3.create()],d.vec4cache=[vec4.create(),vec4.create(),vec4.create(),vec4.create()],d.prototype.intersect=function(a){function b(a,b){for(var d=a;b>=d;d++)t=d*u,0!=this.pd[t+h]&&(c[0]=this.pf[t+j],c[1]=this.pf[t+k],c[2]=this.pf[t+l],e[0]=this.pf[t+j]-this.pf[t+m],e[1]=this.pf[t+k]-this.pf[t+n],e[2]=this.pf[t+l]-this.pf[t+o],vec3.length(e)&&pimRay.intersect_ray_box(c,e,q)&&(v++,this.pd[t+h]=0))}var c,e,f,g,i,p,q,r,s,t,v;if(!a)return 0;if(!a.inst)return 0;if(!a.obj)return 0;if(0==a.inst.xs)return 0;if(a.inst.rayTransparent)return 0;if(c=d.vec3cache[0],e=d.vec3cache[1],f=d.vec4cache[0],g=d.vec4cache[1],i=a.bbox,p=a.inst.evaluateMatrix(),q=Array(6),void 0==d.vcached)for(d.vcached=Array(8),r=0;8>r;r++)d.vcached[r]=vec4.create();if(s=d.vcached,v=0,void 0==a.bbox){if(a.bbox=a.Obj.calculateBoundingBox(),void 0==a.bbox)return 0;a.Obj.calculatePolygonNormals()}for(s[0]=mat4.multiplyVec4(p,[a.bbox[0],a.bbox[1],a.bbox[2],1],s[0]),s[1]=mat4.multiplyVec4(p,[a.bbox[0],a.bbox[1],a.bbox[5],1],s[1]),s[2]=mat4.multiplyVec4(p,[a.bbox[0],a.bbox[4],a.bbox[2],1],s[2]),s[3]=mat4.multiplyVec4(p,[a.bbox[0],a.bbox[4],a.bbox[5],1],s[3]),s[4]=mat4.multiplyVec4(p,[a.bbox[3],a.bbox[1],a.bbox[2],1],s[4]),s[5]=mat4.multiplyVec4(p,[a.bbox[3],a.bbox[1],a.bbox[5],1],s[5]),s[6]=mat4.multiplyVec4(p,[a.bbox[3],a.bbox[4],a.bbox[2],1],s[6]),s[7]=mat4.multiplyVec4(p,[a.bbox[3],a.bbox[4],a.bbox[5],1],s[7]),q[0]=s[0][0],q[1]=s[0][1],q[2]=s[0][2],q[3]=s[0][0],q[4]=s[0][1],q[5]=s[0][1],r=0;8>r;r++)q[0]=Math.min(q[0],s[r][0]),q[1]=Math.min(q[1],s[r][1]),q[2]=Math.min(q[2],s[r][2]),q[3]=Math.max(q[3],s[r][0]),q[4]=Math.max(q[4],s[r][1]),q[5]=Math.max(q[5],s[r][2]);return this.lastLive!=this.lastDead&&(this.lastLive>this.lastDead?b.call(this,this.lastDead+1,this.lastLive):(this.lastDead+1!=this.maxParticles&&drawEmitterRange.call(this,this.lastDead+1,this.maxParticles-1),b.call(this,0,this.lastLive))),v},d.prototype.spinTable=[],e=0;2048>e;e++)d.prototype.spinTable[(e+2048-256)%2048]=Math.sin(e/2048*2*Math.PI);d.prototype.DrawEmitter=function(a,b,c,d){function e(c,d){var e,i,m,n,o,p,q,r,t,v,w,x,y,z,A,B=0;for(x=c;d>=x;x++)e=12*x,i=x*u,n=Math.floor(this.pd[i+h]/this.lifeTime),0!=n&&(B++,m=.05*this.pf[i+s]*this.tsize[n],g[0]=this.pf[i+j],g[1]=this.pf[i+k],g[2]=this.pf[i+l],g[3]=1,mat4.multiplyVec4(f,g,g),o=g[0],p=g[1],q=g[2],y=Math.round(2048*this.tspin[n])+x*this.tspinOffset,this.quads[e+0]=o+m*this.spinTable[(y+0)%2048],this.quads[e+1]=p+m*this.spinTable[(y+512)%2048],this.quads[e+2]=q,this.quads[e+3]=o+m*this.spinTable[(y+1536)%2048],this.quads[e+4]=p+m*this.spinTable[(y+0)%2048],this.quads[e+5]=q,this.quads[e+6]=o+m*this.spinTable[(y+1024)%2048],this.quads[e+7]=p+m*this.spinTable[(y+1536)%2048],this.quads[e+8]=q,this.quads[e+9]=o+m*this.spinTable[(y+512)%2048],this.quads[e+10]=p+m*this.spinTable[(y+1024)%2048],this.quads[e+11]=q,r=this.tintensity[n],0==n&&(r=0),this.ages[4*x]=r,this.ages[4*x+1]=r,this.ages[4*x+2]=r,this.ages[4*x+3]=r,this.randomColor?(t=this.tcolorr[x%2048],v=this.tcolorg[x%2048],w=this.tcolorb[x%2048]):(t=this.tcolorr[n],v=this.tcolorg[n],w=this.tcolorb[n]),this.colors[e+0]=t,this.colors[e+1]=v,this.colors[e+2]=w,this.colors[e+3]=t,this.colors[e+4]=v,this.colors[e+5]=w,this.colors[e+6]=t,this.colors[e+7]=v,this.colors[e+8]=w,this.colors[e+9]=t,this.colors[e+10]=v,this.colors[e+11]=w,1!=this.xFrames&&(z=Math.floor(Math.max(0,Math.min(1,n/2048))*(this.xFrames-1)*this.xCycles)%this.xFrames,this.texcoords[4*x*2+0]=1/this.xFrames+1/this.xFrames*z,this.texcoords[4*x*2+2]=1/this.xFrames*z,this.texcoords[4*x*2+4]=1/this.xFrames*z,this.texcoords[4*x*2+6]=1/this.xFrames+1/this.xFrames*z));a.useProgram(this.program),a.uniformMatrix4fv(this.mvp,!1,b),a.uniformMatrix4fv(this.mvm,!1,mat4.identity()),a.bindBuffer(a.ARRAY_BUFFER,this.glBuffer),a.bufferSubData(a.ARRAY_BUFFER,12*c*4,new Float32Array(this.quadsb,12*c*4,12*B)),a.enableVertexAttribArray(this.pos),a.vertexAttribPointer(this.pos,3,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.glBuffer2),a.bufferSubData(a.ARRAY_BUFFER,4*c*4,new Float32Array(this.agesb,4*c*4,4*B)),a.enableVertexAttribArray(this.age),a.vertexAttribPointer(this.age,1,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.glBuffer3),1!=this.xFrames&&a.bufferSubData(a.ARRAY_BUFFER,8*c*4,new Float32Array(this.texcoords.buffer,8*c*4,8*B)),a.enableVertexAttribArray(this.texc),a.vertexAttribPointer(this.texc,2,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.glBuffer4),a.enableVertexAttribArray(this.col),a.bufferSubData(a.ARRAY_BUFFER,12*c,new Uint8Array(this.colorsb,12*c,12*B)),a.vertexAttribPointer(this.col,3,a.UNSIGNED_BYTE,!1,0,0),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.gliBuffer),A=0,this.image&&(this.image.width||this.image.videoWidth)&&(a.activeTexture(a.TEXTURE0+A),pimScene.bindTexture(a,this.image),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.uniform1i(this.texm,A++)),this.image2&&(this.image2.width||this.image2.videoWidth)&&(a.activeTexture(a.TEXTURE0+A),pimScene.bindTexture(a,this.image2),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.uniform1i(this.texa,A++)),a.depthMask(!1),a.enable(a.BLEND),1==this.blendMode?a.blendFunc(a.SRC_ALPHA,a.ONE):a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),a.drawElements(a.TRIANGLES,6*B,a.UNSIGNED_SHORT,12*c),a.disable(a.BLEND),a.depthMask(!0)}var f,g;this.lastLive!=this.lastDead&&(this.obj.inst.changed=1,this.obj.inst.vChanged=1,window.lastimg=0,f=mat4.create(),g=vec4.create(),mat4.inverse(d.cameras[0].inst.evaluateMatrix(),f),this.lastLive>this.lastDead?e.call(this,this.lastDead+1,this.lastLive):(this.lastDead+1!=this.maxParticles&&e.call(this,this.lastDead+1,this.maxParticles-1),e.call(this,0,this.lastLive)))},c.pimParticle=d},{}],14:[function(){"undefined"==typeof ArrayBuffer&&(window.ArrayBuffer=Array),void 0==ArrayBuffer.prototype.slice&&(ArrayBuffer.prototype.slice=function(a,b){var c,d,e,f=new Uint8Array(this);for(void 0==b&&(b=f.length),c=new ArrayBuffer(b-a),d=new Uint8Array(c),e=a;b>=e;e++)d[e-a]=f[e];return c}),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}()},{}],15:[function(a,b,c){function d(a,b,c){var d=vec4.create();return vec3.subtract(b,a,b),vec3.subtract(c,a,c),vec3.cross(b,c,d),vec3.normalize(d),d[3]=-vec3.dot(d,a),d}function e(a,b,c,d){var e,f;return d&&(e=mat4.create(),mat4.inverse(d.evaluateMatrix(),e),mat4.transpose(e),mat4.multiplyVec4(e,c,c)),f=vec3.dot(c,b),0!=f&&(f=-(vec3.dot(c,a)+c[3])/f),f}function f(a,b,c,d,e,f,g){var h,i,j,k,l,n;g=g||[0,0,1,0],d&&d.cameras[0]&&c&&c.height&&!isNaN(c.width/c.height)&&(h=d.cameras[0].inst.evaluateMatrix(),i=mat4.multiplyVec4(mat4.inverse(mat4.scale(mat4.perspective(d.cameras[0].vFov,c.width/c.height,d.cameras[0].zNear,d.cameras[0].zFar),[1,1,-1])),[-2*a/c.width+1,-2*b/c.height+1,1,1]),j=mat4.multiplyVec4(h,[0,0,0,1]),k=vec3.normalize(mat4.multiplyVec4(h,[i[0]/i[3],-i[1]/i[3],-i[2]/i[3],0])),l=m.intersect_ray_plane(j,k,g,f),l&&(j[0]+=k[0]*l,j[1]+=k[1]*l,j[2]+=k[2]*l,j[3]=1,e&&(e.parent&&(n=mat4.inverse(e.parent.evaluateMatrix(),mat4.create()),n&&mat4.multiplyVec4(n,j)),e.x=j[0],e.y=j[1],e.z=j[2],e.changed=1)))}function g(a,b,c){{var d,e,f,g,h,i=[],j=[],k=!0;vec3.length(b)}for(d=0;3>d;d++)a[d]<c[d]?(i[d]=1,j[d]=c[d],k=!1):a[d]>c[d+3]?(i[d]=0,j[d]=c[d+3],k=!1):i[d]=2;if(k)return!0;for(e=[-1,-1,-1],d=0;3>d;d++)2!=i[d]&&0!=b[d]&&(e[d]=-(j[d]-a[d])/b[d]);for(f=0,d=1;3>d;d++)e[f]<e[d]&&(f=d);if(e[f]<0)return!1;for(h=[],d=0;3>d;d++)if(f!=d&&(g=a[d]+e[f]*-b[d],g<c[d]||g>c[d+3]))return!1;return!0}function h(a,b,c,d){return c[0]-=d,c[1]-=d,c[2]-=d,c[3]+=d,c[4]+=d,c[5]+=d,m.intersect_ray_box(a,b,c)}function i(a,b,c,d){var e,f,g,h,i,j,k,l,n,o,p,q,r,s,t,u,v,w,x;if(void 0==d&&(d=0),c.bbox||(c.bbox=c.obj.calculateBoundingBox(),c.obj.calculatePolygonNormals()),!m.intersect_ray_box(a,b,c.bbox))return 0;if(0!=d||c.bones.length)return vec3.length(a)/vec3.length(b);for(c.obj.attribs[400]&&(e=new Float32Array(c.obj.attribs[400])),e&&e.length||(e=new Float32Array(c.obj.attribs[0])),f=e.length/3>65535?new Uint32Array(c.obj.attribs[1003]):new Uint16Array(c.obj.attribs[1003]),g=new Float32Array(c.obj.attribs[4003]),h=0,i=-1,j=m.vec3cache[0],k=m.vec3cache[1],l=m.vec3cache[2],n=m.vec3cache[3],o=0;o<f.length/3;o+=1){if(p=3*o,q=0,r=3*f[p],s=3*f[p+1],t=3*f[p+2],j[0]=e[s]-e[r],j[1]=e[s+1]-e[r+1],j[2]=e[s+2]-e[r+2],k[0]=e[t]-e[r],k[1]=e[t+1]-e[r+1],k[2]=e[t+2]-e[r+2],vec3.cross(b,k,l),u=vec3.dot(j,l),m.forceDoubleSided){if(Math.abs(u)<1e-6)continue}else if(1e-6>u)continue;v=1/u,vec3.subtract(a,[e[r],e[r+1],e[r+2]],n),w=vec3.dot(n,l)*v,0>w||w>1||(vec3.cross(n,j,n),x=vec3.dot(b,n)*v,0>x||x>1||w+x>1||(q=vec3.dot(k,n)*v,0!=q&&(-1==i||Math.abs(q)<h)&&(i=o,h=Math.abs(q))))}return-1==i?0:(m.lastObjPoly=i,h)}function j(a,b,c,d){var e,f,g,h,i,j,k,l,n,o,p,q,r,s,t,u,v,w,x;if(c.bbox||(c.bbox=c.obj.calculateBoundingBox(),c.obj.calculatePolygonNormals()),!m.intersect_ray_box_ofs(a,b,c.bbox,d))return 0;for(c.obj.attribs[400]&&(e=new Float32Array(c.obj.attribs[400])),e&&e.length||(e=new Float32Array(c.obj.attribs[0])),f=e.length/3>65535?new Uint32Array(c.obj.attribs[1003]):new Uint16Array(c.obj.attribs[1003]),g=new Float32Array(c.obj.attribs[1]),h=new Float32Array(c.obj.attribs[4003]),i=0,j=-1,k=vec3.create(),l=vec3.create(),n=vec3.create(),o=0;o<f.byteLength/6;o+=1)p=3*o,q=0,r=-(b[0]*h[p]+b[1]*h[p+1]+b[2]*h[p+2]),s=r,1e-6>s||(t=3*f[p],u=3*f[p+1],k[0]=e[t]+d*g[t]-a[0],k[1]=e[t+1]+d*g[t+1]-a[1],k[2]=e[t+2]+d*g[t+2]-a[2],l[0]=e[u]+d*g[t]-a[0],l[1]=e[u+1]+d*g[u+1]-a[1],l[2]=e[u+2]+d*g[u+2]-a[2],vec3.cross(b,k,n),v=-vec3.dot(l,n),0>v||v>s||(w=3*f[p+2],x=n[0]*(e[w]+d*g[w]-a[0])+n[1]*(e[w+1]+d*g[w+1]-a[1])+n[2]*(e[w+2]+d*g[w+2]-a[2]),0>x||x+v>s||(q=(k[0]*h[p]+k[1]*h[p+1]+k[2]*h[p+2])/r))),q>0&&(-1==j||i>q)&&(j=o,i=q);return-1==j?0:i}function k(a,b,c){var d,e,f,g,h,i,j=0,k=-1,l=mat4.create(),n=mat4.create(),o=vec4.create(),p=vec4.create(),q=vec4.create();for(o in c.objects)!c.objects[o].inst.rayTransparent&&c.objects[o].inst.visible&&(d=c.objects[o],d.obj&&d.obj.attribs[1003]&&!d.inst.squeezed()&&(mat4.inverse(d.inst.evaluateMatrix(),l),mat4.transpose(d.inst.evaluateMatrix(),n),p=mat4.multiplyVec4(l,[a[0],a[1],a[2],1]),q=vec3.subtract(mat4.multiplyVec4(l,[a[0]+b[0],a[1]+b[1],a[2]+b[2],1]),p,vec4.create()),vec3.normalize(q),e=vec3.length(q),f=m.intersect_ray_object(p,q,d,c.objects[o].inst.rayLevel)/e,f&&(g=vec4.create([0,0,0,1]),vec3.add(vec3.scale(q,f,g),p,g),mat4.multiplyVec4(d.inst.evaluateMatrix(),g),f=vec3.length(vec3.subtract(g,a,g))),f>0&&(-1==k||j>f)&&(k=o,j=f,m.lastPoly=m.lastObjPoly)));if(-1!=k){for(m.lastInst=c.objects[k].inst,m.lastObj=c.objects[k],h=0;i=c.objects[k].obj.surfaces[h];h++)if(i.start<=m.lastPoly&&i.start+i.count>m.lastPoly){m.lastSurface=i;break}return j}return m.lastObj=null,m.lastInst=null,m.lastSurface=null,0}function l(a,b,c,d){var e,f;if(d&&d.cameras[0])return e=d.cameras[0].inst.evaluateMatrix(),f=mat4.multiplyVec4(mat4.inverse(mat4.scale(mat4.perspective(d.cameras[0].vFov,c.width/c.height,d.cameras[0].zNear,d.cameras[0].zFar),[1,1,-1])),[-2*a/c.width+1,-2*b/c.height+1,1,1]),m.intersect(mat4.multiplyVec4(e,[0,0,0,1]),mat4.multiplyVec4(e,[f[0]/f[3],-f[1]/f[3],-f[2]/f[3],0]),d)}var m={vec3cache:[vec3.create(),vec3.create(),vec3.create(),vec3.create()],forceDoubleSided:!1};m.plane_from_points=d,m.intersect_ray_plane=e,m.mousetrack=f,m.intersect_ray_box=g,m.intersect_ray_box_ofs=h,m.intersect_ray_object=i,m.intersect_ray_object_ofs=j,m.intersect=k,m.intersect_vp=l,c.pimRay=m},{}],16:[function(a,b,c){function d(a){return this.inst=a,this.vFov=34,this.zNear=.01,this.zFar=1e3,this.zoomFactor=3.2,this.appertureHeight=.015,this.width=1920,this.height=1080,this.backdropColor=void 0,this}function e(a){return this.inst=a,this.type=1,this.color=[1,1,1],this.intensity=1,this.range=0,this.fallofType=0,this.shadowType=0,this}function f(a){return a instanceof f?(this.inst=new q(a.inst),this.weightMap=a.weightMap,this.inst.swm=a.inst.swm,this.restPos=new Float32Array(a.restPos),this.restVec=new Float32Array(a.restVec),this):(this.inst=a,this.weightMap=-1,this)}function g(a,b){return this.obj=a,this.inst=b,this.bones=[],this.sortGroup=0,this.hasTransparency=a&&0|a.hasTransparency||0,this.bbox=void 0,this.depth=1/3,this.depth=0,this.culled=0,this.camPos=new Float32Array(3),this.resourceName="",this.screenRect=void 0,this.lr=void 0,this.lnr=-1,this.polyTrace=0,this}function h(a,b){var c,d,e,f={pim_position:0,pim_normal:1,pim_tangent:2,pim_texcoord0:40,pim_texcoord1:41,pim_texcoord2:42,pim_texcoord3:43,pim_texcoord4:44,pim_weights:360,pim_index:370,pim_morph0:400,pim_morph1:401,pim_morph2:402,pim_morph3:403,pim_morph4:404,pim_morph5:405,pim_morph6:406,pim_morph7:407,pim_morph8:408},g={attributes:[],uniforms:[],attributeCount:0,uniformCount:0},h=a.getProgramParameter(b,a.ACTIVE_UNIFORMS),i=a.getProgramParameter(b,a.ACTIVE_ATTRIBUTES),j={35664:"FLOAT_VEC2",35665:"FLOAT_VEC3",35666:"FLOAT_VEC4",35667:"INT_VEC2",35668:"INT_VEC3",35669:"INT_VEC4",35670:"BOOL",35671:"BOOL_VEC2",35672:"BOOL_VEC3",35673:"BOOL_VEC4",35674:"FLOAT_MAT2",35675:"FLOAT_MAT3",35676:"FLOAT_MAT4",35678:"SAMPLER_2D",35680:"SAMPLER_CUBE",5120:"BYTE",5121:"UNSIGNED_BYTE",5122:"SHORT",5123:"UNSIGNED_SHORT",5124:"INT",5125:"UNSIGNED_INT",5126:"FLOAT"};for(c=0;h>c;c++)d=a.getActiveUniform(b,c),d.typeName=j[d.type],d.location=a.getUniformLocation(b,d.name),g.uniforms.push(d),g.uniformCount+=d.size;for(c=0;i>c;c++)e=a.getActiveAttrib(b,c),e.typeName=j[e.type],e.location=a.getAttribLocation(b,e.name),e.pimloc=f[e.name],g.attributes.push(e),g.attributeCount+=e.size;return g}function i(a,b){var c,d,e,f,g;return b.colorTexture?(a.bindTexture(a.TEXTURE_2D,b.colorTexture),!0):(c=!1,b.uploaded===!1&&(c=!0),b.tex||(b.tex=a.createTexture(),b.uploaded=!1,c=!0),d=!1,a.bindTexture(a.TEXTURE_2D,b.tex),b instanceof HTMLVideoElement?(c=b.uploaded||b.ready||4==b.readyState,d=!0,void 0!=b.webkitDecodedFrameCount?(b.framesUploaded==b.webkitDecodedFrameCount+b.webkitDroppedFrameCount?c=!1:b.framesUploaded=b.webkitDecodedFrameCount+b.webkitDroppedFrameCount,0==b.webkitDecodedFrameCount&&(c=!0)):void 0!=b.mozDecodedFrames&&(b.framesUploaded==b.mozDecodedFrames+b.mozDroppedFrames?c=!1:b.framesUploaded=b.mozDecodedFrames+b.mozDroppedFrames)):((void 0!=b.complete&&!b.complete&&!b.naturalWidth||b.uploaded)&&(c=!1),void 0!=b.complete&&b.complete&&!b.uploaded&&(c=!0)),c&&(d?a.texImage2D(a.TEXTURE_2D,0,a.RGB,a.RGB,a.UNSIGNED_BYTE,b):a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,b.filterMag||a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,b.filterMin||a.LINEAR),e=b.videoWidth||b.naturalWidth||b.width,f=b.videoHeight||b.naturalHeight||b.height,g=e&e-1||f&f-1,g||d?(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE)):(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.REPEAT),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.REPEAT),e==f&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,b.filterMin||a.LINEAR_MIPMAP_LINEAR),a.generateMipmap(a.TEXTURE_2D))),b.uploaded=!0),!0)}function j(a){var b,c,d,e=new Float32Array(a.obj.attribs[400]),f=new Float32Array(a.obj.attribs[0]),g=e.length;if(!(g>2e3||!a.inst.changed&&!a.inst.vChanged||a.inst.rayTransparent)){for(b=0;g>b;b++)e[b]=f[b];for(c=1;c<a.inst.morphs.length;c++)for(d=a.inst.morphs[c].cachevalue,b=0;g>b;b++)e[b]+=a.obj.attribs[400+c][b]*d;a.bbox=a.obj.calculateBoundingBox()}}function l(){this.objects=[],this.lights=[],this.cameras=[],this.cstart=(new Date).getTime(),this.cframe=0,this.phase2Cull=!0,this.fps="..",this.framesPerSec=30,this.ambientColor=[1,1,1],this.ambientIntensity=0,this.filters=[]}function m(a){var b,c=0,d=0;for(b=0;8>b&&(0==d||0==c);b++)a[b][2]<-a[b][3]?d++:c++;if(0==c)return-1;if(0!=d)return 0;for(d=0,c=0,b=0;8>b&&(0==d||0==c);b++)a[b][0]<-a[b][3]?d++:c++;if(0==c)return-1;if(0!=d)return 0;for(d=0,c=0,b=0;8>b&&(0==d||0==c);b++)a[b][0]>a[b][3]?d++:c++;if(0==c)return-1;if(0!=d)return 0;for(d=0,c=0,b=0;8>b&&(0==d||0==c);b++)a[b][1]<-a[b][3]?d++:c++;if(0==c)return-1;if(0!=d)return 0;for(d=0,c=0,b=0;8>b&&(0==d||0==c);b++)a[b][1]>a[b][3]?d++:c++;return 0==c?-1:0!=d?0:1}var n,o,p,q=a("./pim_instance").pimInstance,r=a("./pim_stream").pimStream,s=0,t=a("./vertexZ.pimShader.js").vertexZ_pimShader,u="precision lowp float;\n"+a("./fragmentZ.pimShader.js").fragmentZ_pimShader,v="precision lowp float;\n"+a("./uberVertex.pimShader.js").uberVertex_pimShader,w="precision lowp float;\n"+a("./uberFragment.pimShader.js").uberFragment_pimShader;Object.prototype.__defineSetter__&&[["Inst","inst"],["backdropcolor","backdropColor"],["ZoomFactor","zoomFactor"],["vfov","vFov"]].forEach(function(a){d.prototype.__defineGetter__(a[0],Function("console.log('%cChange "+a[0]+" into "+a[1]+"'+new Error().stack.split('\\n',3)[2],'background:#FFCCCC; color:black'); return this."+a[1]+";")),d.prototype.__defineSetter__(a[0],Function("console.log('%cChange "+a[0]+" into "+a[1]+"'+new Error().stack.split('\\n',3)[2],'background:#FFCCCC; color:black'); this."+a[1]+" = arguments[0];"))}),d.prototype.toString=function(){return this.inst&&"C@"+this.inst.name||"C@!noname!"},Object.prototype.__defineSetter__&&[["Inst","inst"],["falloftype","fallofType"]].forEach(function(a){e.prototype.__defineGetter__(a[0],Function("console.log('%cChange "+a[0]+" into "+a[1]+"'+new Error().stack.split('\\n',3)[2],'background:#FFCCCC; color:black'); return this."+a[1]+";")),e.prototype.__defineSetter__(a[0],Function("console.log('%cChange "+a[0]+" into "+a[1]+"'+new Error().stack.split('\\n',3)[2],'background:#FFCCCC; color:black'); this."+a[1]+" = arguments[0];"))}),e.prototype.toString=function(){return this.inst&&"L@"+this.inst.name||"L@!noname!"},Object.prototype.__defineSetter__&&[["Inst","inst"],["weightmap","weightMap"]].forEach(function(a){f.prototype.__defineGetter__(a[0],Function("console.log('%cChange "+a[0]+" into "+a[1]+"'+new Error().stack.split('\\n',3)[2],'background:#FFCCCC; color:black'); return this."+a[1]+";")),f.prototype.__defineSetter__(a[0],Function("console.log('%cChange "+a[0]+" into "+a[1]+"'+new Error().stack.split('\\n',3)[2],'background:#FFCCCC; color:black'); this."+a[1]+" = arguments[0];"))}),Object.prototype.__defineSetter__&&[["Obj","obj"],["Inst","inst"],["Bones","bones"]].forEach(function(a){g.prototype.__defineGetter__(a[0],Function("console.log('%cChange "+a[0]+" into "+a[1]+"'+new Error().stack.split('\\n',3)[2],'background:#FFCCCC; color:black'); return this."+a[1]+";")),g.prototype.__defineSetter__(a[0],Function("console.log('%cChange "+a[0]+" into "+a[1]+"'+new Error().stack.split('\\n',3)[2],'background:#FFCCCC; color:black'); this."+a[1]+" = arguments[0];"))}),g.prototype.clone=function(a){var b,c,d=new g(this.obj,new q(this.inst));if(d.inst.name=a,this.bones){b=[this.inst];for(c in this.bones)b.push(this.bones[c].inst);for(c in this.bones)d.bones[c]=new f(this.bones[c]);pmap2=[d.inst];for(c in d.bones)pmap2.push(d.bones[c].inst);for(c in d.bones)d.bones[c].inst.parent=pmap2[b.indexOf(this.bones[c].inst.parent)]}return d},g.prototype.toString=function(){return this.inst&&this.inst.name||"!noname!"},g.prototype.byName=function(a){for(var b,c=0;b=(this.surfaces||this.obj.surfaces)[c];c++)if(a instanceof RegExp?b.name.match(a):b.name==a)return b;return null},g.prototype.deform_cpu=function(a){var b,c,d,e,f,g,h,i,j;this.obj.loaded||this.driverLoad(a),this.obj.attribs[58]||(this.obj.attribs[58]=this.obj.attribs[0].slice(0),this.obj.attribs[59]=this.obj.attribs[1].slice(0),this.bm=Array(64),this.bmit=Array(64)),b=new Float32Array(this.obj.attribs[58]),c=new Float32Array(this.obj.attribs[59]),d=new Float32Array(this.obj.attribs[0]),e=new Float32Array(this.obj.attribs[1]),f=new Uint8Array(this.obj.attribs[370]),g=new Float32Array(this.obj.attribs[360]);for(h in this.bones)255!=this.bones[h].weightMap&&(this.bm[this.bones[h].weightMap]=this.bones[h].inst.boneMatrix(this.inst));if(pimOptions.invtransNormals){this.bmit=Array(64);for(h in this.bones)255!=this.bones[h].weightMap&&(this.bmit[this.bones[h].weightMap]=mat4.create(this.bm[this.bones[h].weightMap]),mat4.inverse(mat4.transpose(this.bmit[this.bones[h].weightMap])))}else this.bmit=this.bm;for(i=0,j=0,h=0;h<this.obj.attribs[0].byteLength/12;h+=1)j=3*h,pimOptions.fastBones?this.bm[f[4*h]]&&(mat4.multiplyVec4bbscale(this.bm[f[4*h]],d,b,j,g[4*h]),i=f[4*h+1],i&&mat4.multiplyVec4bbscaleadd(this.bm[i],d,b,j,1-g[4*h])):(i=f[4*h+0],i?mat4.multiplyVec4bbscale(this.bm[i],d,b,j,g[4*h]):mat4.multiplyVec4bbscale(mat4.identity(),d,b,j,1),i=f[4*h+1],i&&mat4.multiplyVec4bbscaleadd(this.bm[i],d,b,j,g[4*h+1]),i=f[4*h+2],i&&mat4.multiplyVec4bbscaleadd(this.bm[i],d,b,j,g[4*h+2]),i=f[4*h+3],i&&mat4.multiplyVec4bbscaleadd(this.bm[i],d,b,j,g[4*h+3])),pimOptions.invtransNormals?pimOptions.fastBones?this.bmit[f[4*h]]&&(mat4.multiplyVec3bbscale(this.bmit[f[4*h]],e,c,j,g[4*h]),i=f[4*h+1],i&&mat4.multiplyVec3bbscaleadd(this.bmit[i],e,c,j,1-g[4*h])):this.bm[f[4*h]]&&(i=f[4*h+0],i&&mat4.multiplyVec3bbscale(this.bmit[i],e,c,j,g[4*h]),i=f[4*h+1],i&&mat4.multiplyVec3bbscaleadd(this.bmit[i],e,c,j,g[4*h+1]),i=f[4*h+2],i&&mat4.multiplyVec3bbscaleadd(this.bmit[i],e,c,j,g[4*h+2]),i=f[4*h+3],i&&mat4.multiplyVec3bbscaleadd(this.bmit[i],e,c,j,g[4*h+3])):this.bm[f[4*h]]&&mat4.multiplyVec3bb(this.bm[f[4*h]],e,c,j);a.bindBuffer(a.ARRAY_BUFFER,this.obj.attribs[0].glBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array(this.obj.attribs[58]),a.DYNAMIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,this.obj.attribs[1].glBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array(this.obj.attribs[59]),a.DYNAMIC_DRAW)},n={},g.prototype.driverLoad=function(a,b,c){var d,e,f,g,i,j,k,l,m,o,p,q,r,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L=this.obj;if(this.obj.loaded=1,L.attribs[0].byteLength/12<2e5){for(d=[],e=L.attribs[0].byteLength/12>65535?new Uint32Array(L.attribs[1003]):new Uint16Array(L.attribs[1003]),f=0;f<e.length/3;f++)d.push(e[3*f]<e[3*f+1]?[e[3*f],e[3*f+1]]:[e[3*f+1],e[3*f]]),d.push(e[3*f+1]<e[3*f+2]?[e[3*f+1],e[3*f+2]]:[e[3*f+2],e[3*f+1]]),d.push(e[3*f+2]<e[3*f]?[e[3*f+2],e[3*f]]:[e[3*f],e[3*f+2]]);for(d.sort(function(a,b){return a[0]<b[0]?-1:a[0]>b[0]?1:a[1]<b[1]?-1:a[1]>b[1]?1:0}),g=[],f=0;f<d.length;f++)(f==d.length-1||d[f][0]!=d[f+1][0]||d[f][1]!=d[f+1][1])&&g.push(d[f][0],d[f][1]);for(d=g,36==d.length&&"[0,1,0,2,0,3,0,4,0,6,0,7,1,2,1,6,2,3,2,4,2,5,2,6,3,4,4,5,4,6,4,7,5,6,6,7]"==JSON.stringify(d)&&(d=[0,1,0,3,0,7,1,2,1,6,2,3,2,5,3,4,4,5,4,7,5,6,6,7,0,2,0,4,0,6,2,4,2,6,4,6]),L.attribs[1002]=L.attribs[0].byteLength/12>65535?new Uint32Array(d.length):new Uint16Array(d.length),f=0;f<d.length;f++)L.attribs[1002][f]=d[f];L.attribs[1002]=L.attribs[1002].buffer,L.attribs[1002].count=d.length}s>5&&this.bones.length,(this.surfaces||L.surfaces).sort(function(a,b){return a.transparency+a.additiveTransparency-b.transparency-b.additiveTransparency}),(this.surfaces||L.surfaces).forEach(function(a){(a.transparency||a.additiveTransparency||a.splines.some(function(a){return 6==a.tp}))&&(this.hasTransparency=1)}.bind(this));for(f in this.surfaces||L.surfaces){for(i="",j="",k=0;k<c.lights.length;k++)i+="#define LIGHT"+k+"\n",2==c.lights[k].type&&(i+="#define LIGHTSPOT"+k+"\n");if(i+="#define NUM_LIGHTS "+Math.min(4,c.lights.length)+"\n",pimOptions.gpuBones&&this.bones.length&&(l=0,this.bones.forEach(function(a){a.inst.active&&l++}),l&&(i+="#define NUM_BONES "+l+"\n",j+="#define NUM_BONES "+l+"\n")),this.inst&&this.inst.morphs){for(k=1;k<Math.min(9,this.inst.morphs.length);k++)this.obj.attribs[400+k]&&(i+="#define PIM_MORPH"+k+"\n");for(k=1;k<Math.min(9,this.inst.morphs.length);k++)this.obj.attribs[400+k]&&(j+="#define PIM_MORPH"+k+"\n")}if(m=(this.surfaces||L.surfaces)[f],"1"===m["pimSurface.NoZImpression"]&&(m.noZ=1),o=pimOptions.defines+(m.defines||"")+"\n",pimOptions.forceDynamic.ALL||pimOptions.forceDynamic.PIM_COLOR||(o+="#define PIM_COLOR "+m.color[0].toFixed(2)+","+m.color[1].toFixed(2)+","+m.color[2].toFixed(2)+"\n"),pimOptions.forceDynamic.ALL||pimOptions.forceDynamic.PIM_DIFFUSE||(o+="#define PIM_DIFFUSE "+(m.diffuse||0).toFixed(2)+"\n"),pimOptions.forceDynamic.ALL||pimOptions.forceDynamic.PIM_LUMINOSITY||(o+="#define PIM_LUMINOSITY "+(m.luminosity||0).toFixed(2)+"\n"),m.specular&&(o+="#define PIM_SPECULAR "+(m.specular||0).toFixed(2)+"\n"),o+="#define PIM_GLOSSINESS "+(m.glossiness*m.glossiness*100+1).toFixed(2)+"\n",o+="#define PIM_REFLECTION "+(m.reflection||0).toFixed(2)+"\n",pimOptions.forceDynamic.ALL||pimOptions.forceDynamic.PIM_TRANSPARENCY||(o+="#define PIM_TRANSPARENCY "+(m.transparency||0).toFixed(2)+"\n"),pimOptions.forceDynamic.ALL||pimOptions.forceDynamic.PIM_TRANSLUCENCY||(o+="#define PIM_TRANSLUCENCY "+(m.translucency||0).toFixed(2)+"\n\n"),m.reflectionImage&&(o+="#define PIM_TEXTURE_REFLECTIONMAP\n\n"),m.reflectionImage2&&(o+="#define PIM_TEXTURE_REFLECTIONMAP2\n\n"),l=0,this.bones.forEach(function(a){a.inst.active&&l++
}),o+="#define NUM_BONES "+l+"\n",o+="#define NUM_LIGHTS "+Math.min(4,c.lights.length)+"\n\n",this.inst&&this.inst.morphs)for(k=1;k<Math.min(9,this.inst.morphs.length);k++)L.attribs[400+k]&&(o+="#define PIM_MORPH"+k+"\n");for(c.ambientIntensity&&(o+="#define PIM_AMBIENT_INTENSITY "+c.ambientIntensity.toFixed(3)+"\n"),k=0;p=c.lights[k];k++)o+="#define LIGHT"+k+" "+p.type+"\n",q=vec3.create([0,0,1]),r=p.inst.evaluateMatrix(),q=mat4.multiplyVec3(r,q),vec3.normalize(q),pimOptions.forceDynamic.ALL||pimOptions.forceDynamic.LIGHTx_DIRECTION||(o+="#define LIGHT"+k+"_DIRECTION "+q[0].toFixed(4)+","+q[1].toFixed(4)+","+q[2].toFixed(4)+"\n"),pimOptions.forceDynamic.ALL||pimOptions.forceDynamic.LIGHTx_POSITION||(o+="#define LIGHT"+k+"_POSITION "+r[12].toFixed(4)+","+r[13].toFixed(4)+","+r[14].toFixed(4)+"\n"),pimOptions.forceDynamic.ALL||pimOptions.forceDynamic.LIGHTx_INTENSITY||(o+="#define LIGHT"+k+"_INTENSITY "+p.intensity.toFixed(2)+"\n"),o+="#define LIGHT"+k+"_FALLOFF "+(p.fallofType||0)+"\n",pimOptions.forceDynamic.ALL||pimOptions.forceDynamic.LIGHTx_RANGE||(o+="#define LIGHT"+k+"_RANGE "+p.range.toFixed(4)+"\n"),o+="#define LIGHT"+k+"_CONE "+(p.coneangle||0).toFixed(4)+"\n",2==p.shadowType&&2==p.type&&(o+="#define LIGHT"+k+"_SHADOW\n"),pimOptions.forceDynamic.ALL||pimOptions.forceDynamic.LIGHTx_COLOR||(o+="#define LIGHT"+k+"_COLOR "+p.color[0].toFixed(2)+","+p.color[1].toFixed(2)+","+p.color[2].toFixed(2)+"\n\n");if(x=[0,0,0,0,0,0,0,0],y={COLR:1,DIFF:2,LUMI:3,SPEC:4,TRAN:5,BUMP:6,NRML:7},z=["unknown","COLOR","DIFFUSE","LUMINOSITY","SPECULAR","TRANSPARENCY","BUMP","NORMAL"],m.channels)for(A=0;B=m.channels[A];A++)B.enabled&&(C=y[B.type]||0,C&&(o+="#define PIM_TEXCOORD"+(B.texunit||0)+"\n",o+="#define PIM_TEXTURE_"+z[C]+"_"+x[C]+" "+(B.texunit||0)+"\n",o+="#define PIM_TEXTURE_"+z[C]+"_"+x[C]+"_BLEND "+(B.opacity||0)+"\n",B.negative&&(o+="#define PIM_TEXTURE_"+z[C]+"_"+x[C]+"_NEGATIVE\n"),5==C&&(B.image||B.map.src||"").match(/\.png$/i)&&(o+="#define PIM_TEXTURE_TRANSPARENCY_"+x[C]+"_ALPHA\n"),5==C&&(this.hasTransparency=1),(B.auvx||B.auvy)&&(o+="#define PIM_TEXTURE_"+z[C]+"_"+x[C]+"_UVANIM\n"),B.idx=x[C],x[C]++));if(D=o+(L.surfaces[f].vertexShaderSource||v),E=o+(L.surfaces[f].fragmentShaderSource||w),F=L.surfaces[f],void 0==n[a.canvas.id+i+D+E]?(F.vertexShader=a.createShader(a.VERTEX_SHADER),a.shaderSource(F.vertexShader,D),a.compileShader(F.vertexShader),a.getShaderParameter(F.vertexShader,a.COMPILE_STATUS)||(F.count=0),F.fragmentShader=a.createShader(a.FRAGMENT_SHADER),a.shaderSource(F.fragmentShader,E),a.compileShader(F.fragmentShader),a.getShaderParameter(F.fragmentShader,a.COMPILE_STATUS)||(F.count=0),F.program=a.createProgram(),F.program.name=(this.surfaces||L.surfaces)[f].name,a.attachShader(F.program,F.vertexShader),a.attachShader(F.program,F.fragmentShader),a.linkProgram(F.program),!a.getProgramParameter(F.program,a.LINK_STATUS),F.program.shaderProps=h(a,F.program),n[a.canvas.id+i+D+E]=F.program,F.vertexZShader=a.createShader(a.VERTEX_SHADER),a.shaderSource(F.vertexZShader,j+t),a.compileShader(F.vertexZShader),a.getShaderParameter(F.vertexZShader,a.COMPILE_STATUS)||(F.count=0),F.fragmentZShader=a.createShader(a.FRAGMENT_SHADER),a.shaderSource(F.fragmentZShader,j+u),a.compileShader(F.fragmentZShader),a.getShaderParameter(F.fragmentZShader,a.COMPILE_STATUS)||(F.count=0),F.Zprogram=a.createProgram(),F.Zprogram.name=(this.surfaces||L.surfaces)[f].name,a.attachShader(F.Zprogram,F.vertexZShader),a.attachShader(F.Zprogram,F.fragmentZShader),a.linkProgram(F.Zprogram),!a.getProgramParameter(F.Zprogram,a.LINK_STATUS),n[a.canvas.id+i+D+E+"Z"]=F.Zprogram):(F.program=n[a.canvas.id+i+D+E],F.Zprogram=n[a.canvas.id+i+D+E+"Z"]),G=F.program,F.program.shaderProps){for(H=0;I=F.program.shaderProps.attributes[H];H++)L.attribs[I.pimloc]&&(L.attribs[I.pimloc].glBuffer||(L.attribs[I.pimloc].glBuffer=a.createBuffer(),I.pimloc<1e3&&(a.bindBuffer(a.ARRAY_BUFFER,L.attribs[I.pimloc].glBuffer),a.bufferData(a.ARRAY_BUFFER,370==f?new Uint8Array(L.attribs[I.pimloc]):new Float32Array(L.attribs[I.pimloc]),a.STATIC_DRAW))));L.attribs[1003].glBuffer||(L.attribs[1003].glBuffer=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,L.attribs[1003].glBuffer),a.bufferData(a.ELEMENT_ARRAY_BUFFER,L.attribs[0].byteLength/12>65535?new Uint32Array(L.attribs[1003]):new Uint16Array(L.attribs[1003]),a.STATIC_DRAW)),L.attribs[1002]&&!L.attribs[1002].glBuffer&&(L.attribs[1002].glBuffer=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,L.attribs[1002].glBuffer),a.bufferData(a.ELEMENT_ARRAY_BUFFER,L.attribs[0].byteLength/12>65535?new Uint32Array(L.attribs[1002]):new Uint16Array(L.attribs[1002]),a.STATIC_DRAW))}for(J=[{a:0,n:"pim_position"},{a:360,n:"pim_weights"},{a:370,n:"pim_index"}],K=0;K<J.length;K++)L.attribs[J[K].a]&&(p=a.getAttribLocation(F.Zprogram,J[K].n),-1!=p&&(void 0==L.attribs[J[K].a].zloc&&(L.attribs[J[K].a].zloc=[]),L.attribs[J[K].a].zloc[f]=p));if(F.mm=a.getUniformLocation(F.program,"MM"),F.vm=a.getUniformLocation(F.program,"VM"),F.mvp=a.getUniformLocation(F.program,"MVP"),F.zmm=a.getUniformLocation(F.Zprogram,"MM"),F.zvm=a.getUniformLocation(F.Zprogram,"VM"),F.zmvp=a.getUniformLocation(F.Zprogram,"MVP"),F.mm||(F.mm=a.getUniformLocation(F.program,"pim_mm")),F.mmi=a.getUniformLocation(F.program,"pim_mmi"),F.vm||(F.vm=a.getUniformLocation(F.program,"pim_vm")),F.mvp||(F.mvp=a.getUniformLocation(F.program,"pim_p")),F.camPos=a.getUniformLocation(F.program,"camPosition"),pimOptions.gpuBones&&this.bones.length&&(F.bones=a.getUniformLocation(F.program,"bones"),F.zbones=a.getUniformLocation(F.Zprogram,"bones"),F.bones||(F.bones=a.getUniformLocation(F.program,"pim_bones"))),this.inst&&this.inst.morphs.length>1)for(F.morphs=[],F.zmorphs=[],r=1;r<Math.min(9,this.inst.morphs.length);r++)F.morphs[r]=a.getAttribLocation(F.program,"pim_morph"+r),-1!=F.morphs[r]&&(void 0==L.attribs[400+r].loc&&(L.attribs[400+r].loc=[]),void 0==L.attribs[400+r].loc2&&(L.attribs[400+r].loc2=[]),L.attribs[400+r].loc[f]=F.morphs[r],L.attribs[400+r].loc2[f]=a.getUniformLocation(F.program,"pim_morphamount"+r)),F.zmorphs[r]=a.getAttribLocation(F.Zprogram,"pim_morph"+r),-1!=F.zmorphs[r]&&(void 0==L.attribs[400+r].zloc&&(L.attribs[400+r].zloc=[]),void 0==L.attribs[400+r].zloc2&&(L.attribs[400+r].zloc2=[]),L.attribs[400+r].zloc[f]=F.zmorphs[r],L.attribs[400+r].zloc2[f]=a.getUniformLocation(F.Zprogram,"pim_morphamount"+r));for(F.t1=a.getUniformLocation(F.program,"pim_texture0"),F.t2=a.getUniformLocation(F.program,"pim_texture1")||a.getUniformLocation(F.program,"pim_diffuse0"),F.t3=a.getUniformLocation(F.program,"pim_texture2"),F.t1anim=a.getUniformLocation(F.program,"pim_texture0_uvanim")||a.getUniformLocation(F.program,"pim_color0_uvanim"),F.a1=a.getUniformLocation(F.program,"pim_alpha0")||a.getUniformLocation(F.program,"pim_transparency0"),F.r1=a.getUniformLocation(F.program,"pim_reflectionmap"),F.r2=a.getUniformLocation(F.program,"pim_reflectionmap2"),F.extra=[],F.hsbpos=a.getUniformLocation(F.program,"pim_hsb"),F.hsbpos&&F.extra.push(function(){a.uniformMatrix4fv(this.hsbpos,!1,this.pimShaderExt.PIM_HSB)}.bind(F)),F.program.shaderProps.uniforms.forEach(function(b){return b.name.match(/^pim_/)&&!b.name.match(/^pim_morph|pim_luminosity|pim_diffuse/)&&"FLOAT"==b.typeName?void 0===F.pimShaderExt[b.name]?void 0:void F.extra.push(function(b){a.uniform1f(b.location,this.pimShaderExt[b.name])}.bind(F,b)):void 0}.bind(this)),F.textureLocations={COLR:[a.getUniformLocation(F.program,"pim_texture0"),a.getUniformLocation(F.program,"pim_texture1"),a.getUniformLocation(F.program,"pim_texture2"),a.getUniformLocation(F.program,"pim_texture3")],DIFF:[a.getUniformLocation(F.program,"pim_diffuse0"),a.getUniformLocation(F.program,"pim_diffuse1"),a.getUniformLocation(F.program,"pim_diffuse2"),a.getUniformLocation(F.program,"pim_diffuse3")],TRAN:[a.getUniformLocation(F.program,"pim_transparency0"),a.getUniformLocation(F.program,"pim_transparency1"),a.getUniformLocation(F.program,"pim_transparency2"),a.getUniformLocation(F.program,"pim_transparency3")],SPEC:[a.getUniformLocation(F.program,"pim_specular0"),a.getUniformLocation(F.program,"pim_specular1"),a.getUniformLocation(F.program,"pim_specular2"),a.getUniformLocation(F.program,"pim_specular3")],LUMI:[a.getUniformLocation(F.program,"pim_luminosity0"),a.getUniformLocation(F.program,"pim_luminosity1"),a.getUniformLocation(F.program,"pim_luminosity2"),a.getUniformLocation(F.program,"pim_luminosity3")],NRML:[a.getUniformLocation(F.program,"pim_normal0"),a.getUniformLocation(F.program,"pim_normal1"),a.getUniformLocation(F.program,"pim_normal2"),a.getUniformLocation(F.program,"pim_normal3")]},F.lightpos=[],F.lightdir=[],F.lightcol=[],F.lightspot=[],F.lightatt=[],F.lightlvm=[],F.lightlvp=[],F.lightmap=[],F.lightintensity=[],F.lightrange=[],f=0;(p=c.lights[f])&&4!=f;f++)F.lightpos[f]=a.getUniformLocation(F.program,"light_position["+f+"]"),F.lightdir[f]=a.getUniformLocation(F.program,"light_direction["+f+"]"),F.lightcol[f]=a.getUniformLocation(F.program,"light_color["+f+"]")||a.getUniformLocation(F.program,"LIGHT"+f+"_COLOR"),F.lightspot[f]=a.getUniformLocation(F.program,"light_coneAngle["+f+"]"),F.lightatt[f]=a.getUniformLocation(F.program,"light_att["+f+"]"),F.lightlvm[f]=a.getUniformLocation(F.program,"light_lvm["+f+"]")||a.getUniformLocation(F.program,"LIGHT_LVM"+f),F.lightlvp[f]=a.getUniformLocation(F.program,"light_lvp["+f+"]")||a.getUniformLocation(F.program,"LIGHT_LVP"+f),F.lightmap[f]=a.getUniformLocation(F.program,"smap["+f+"]")||a.getUniformLocation(F.program,"LIGHT_SMAP"+f),F.lightpos[f]||(F.lightpos[f]=a.getUniformLocation(F.program,"LIGHT"+f+"_POSITION")),F.lightdir[f]||(F.lightdir[f]=a.getUniformLocation(F.program,"LIGHT"+f+"_DIRECTION")),F.lightintensity[f]=a.getUniformLocation(F.program,"LIGHT"+f+"_INTENSITY"),F.lightrange[f]=a.getUniformLocation(F.program,"LIGHT"+f+"_RANGE");F.lumiloc=a.getUniformLocation(F.program,"pim_luminosity"),F.diffloc=a.getUniformLocation(F.program,"pim_diffuse"),F.colorloc=a.getUniformLocation(F.program,"pim_color"),F.transparencyloc=a.getUniformLocation(F.program,"pim_transparency"),F.transparencyloc||(F.transparencyloc=a.getUniformLocation(F.program,"PIM_TRANSPARENCY")),F.lumiloc||(F.lumiloc=a.getUniformLocation(F.program,"PIM_LUMINOSITY")),F.diffloc||(F.diffloc=a.getUniformLocation(F.program,"PIM_DIFFUSE")),F.colorloc||(F.colorloc=a.getUniformLocation(F.program,"PIM_COLOR"))}b&&b()},o=0,window.lastprogram=null,window.lastobj=0,window.lastimg=0,window.lastalpha=0,window.lastframe=-1,g.prototype.driverRenderSurface=function(a,b,c,d,e,f,h,j){var k,m,n,p,q,r,s,t,u,v,w,x;if(1!=f.transparency&&f.program){if(j){if(a.useProgram(f.Zprogram),lastprogram=f.Zprogram,a.uniformMatrix4fv(f.zmvp,!1,b),a.uniformMatrix4fv(f.zvm,!1,c),a.uniformMatrix4fv(f.zmm,!1,this.inst.evaluateMatrix()),f.bones&&this.bonemap&&a.uniformMatrix4fv(f.zbones,!1,this.bonemap),this.inst.morphs)for(k=1;k<Math.min(9,this.inst.morphs.length);k++)e.attribs[400+k]&&a.uniform1f(e.attribs[400+k].zloc2[h],this.inst.morphs[k].cachevalue);for(m in e.attribs)void 0!=e.attribs[m].zloc&&void 0!=e.attribs[m].zloc[h]?(a.bindBuffer(a.ARRAY_BUFFER,e.attribs[m].glBuffer),a.enableVertexAttribArray(e.attribs[m].zloc[h]),370==m?a.vertexAttribPointer(e.attribs[m].zloc[h],4,a.UNSIGNED_BYTE,!1,0,0):a.vertexAttribPointer(e.attribs[m].zloc[h],e.attribs[m].itemsize,a.FLOAT,!1,0,0)):1003==m&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e.attribs[m].glBuffer);return void(e.attribs[0].byteLength/12>65535?a.drawElements(a.TRIANGLES,3*(this.surfaces||e.surfaces)[h].count,a.UNSIGNED_INT,3*(this.surfaces||e.surfaces)[h].start*4):a.drawElements(a.TRIANGLES,3*(this.surfaces||e.surfaces)[h].count,a.UNSIGNED_SHORT,3*(this.surfaces||e.surfaces)[h].start*2))}if(a.useProgram(f.program),lastprogram=f.program,a.uniformMatrix4fv(f.mvp,!1,b),f.camPos&&a.uniform3fv(f.camPos,this.camPos),f.vm&&a.uniformMatrix4fv(f.vm,!1,c),f.mm&&a.uniformMatrix4fv(f.mm,!1,this.inst.evaluateMatrix()),f.mmi&&a.uniformMatrix4fv(f.mmi,!1,mat4.inverse(mat4.create(this.inst.evaluateMatrix()))),f.bones&&this.bonemap&&a.uniformMatrix4fv(f.bones,!1,this.bonemap),f.program.shaderProps){for(n=0;p=f.program.shaderProps.attributes[n];n++)e.attribs[p.pimloc]&&(m=p.pimloc,a.bindBuffer(a.ARRAY_BUFFER,e.attribs[m].glBuffer),a.enableVertexAttribArray(p.location),370==m?a.vertexAttribPointer(p.location,4,a.UNSIGNED_BYTE,!1,0,0):a.vertexAttribPointer(p.location,e.attribs[m].itemsize||3,a.FLOAT,!1,0,0));a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e.attribs[1003].glBuffer)}else for(m in e.attribs)void 0!=e.attribs[m].loc&&void 0!=e.attribs[m].loc[h]?(a.bindBuffer(a.ARRAY_BUFFER,e.attribs[m].glBuffer),a.enableVertexAttribArray(e.attribs[m].loc[h]),370==m?a.vertexAttribPointer(e.attribs[m].loc[h],4,a.UNSIGNED_BYTE,!1,0,0):a.vertexAttribPointer(e.attribs[m].loc[h],e.attribs[m].itemsize||3,a.FLOAT,!1,0,0)):1003==m&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e.attribs[m].glBuffer);if(this.inst.morphs)for(k=1;k<Math.min(9,this.inst.morphs.length);k++)e.attribs[400+k]&&e.attribs[400+k].loc2[h]&&a.uniform1f(e.attribs[400+k].loc2[h],this.inst.morphs[k].cachevalue);if(f.noZ&&a.depthMask(!1),f.noZT&&a.disable(a.DEPTH_TEST),l.oldSchool?(f.lumiloc&&a.uniform1f(f.lumiloc,f.luminosity),f.luminosity+f.diffuse>1?f.diffloc&&a.uniform1f(f.diffloc,1-f.luminosity):f.diffloc&&a.uniform1f(f.diffloc,f.diffuse)):(f.lumiloc&&a.uniform1f(f.lumiloc,f.luminosity),f.diffloc&&a.uniform1f(f.diffloc,f.diffuse)),f.extra&&f.extra.forEach(function(a){a()}),f.additiveTransparency?(a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE),1==f.additiveTransparency&&a.depthMask(!1)):0!=f.transparency&&(a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA)),f.colorloc&&a.uniform3fv(f.colorloc,f.color),f.transparencyloc&&a.uniform1f(f.transparencyloc,f.transparency),q=0,f.channels&&f.channels.length)for(r=0;s=f.channels[r];r++)if(s.enabled&&s.map){if(a.activeTexture(a.TEXTURE0+q),!i(a,s.map))continue;f.textureLocations[s.type][s.idx]&&a.uniform1i(f.textureLocations[s.type][s.idx],q),f.t1anim&&(void 0==this.inst.animtime&&(this.inst.animtime=(new Date).getTime()/1e3),a.uniform2f(f.t1anim,(f.diffuseUAnim||f.channels[0].auvx||0)*this.inst.animtime,(f.diffuseVAnim||f.channels[0].auvy||0)*this.inst.animtime)),q++}for(f.reflectionImage&&(a.activeTexture(a.TEXTURE0+q),i(a,f.reflectionImage)&&a.uniform1i(f.r1,q),q++),f.reflectionImage2&&(a.activeTexture(a.TEXTURE0+q),i(a,f.reflectionImage2)&&a.uniform1i(f.r2,q),q++),t=0;3>t;t++)(f.lightpos&&f.lightpos[t]||f.lightdir&&f.lightdir[t])&&(f.lightpos[t]&&a.uniform3fv(f.lightpos[t],d[0+t]),f.lightdir[t]&&a.uniform3fv(f.lightdir[t],d[4+t]),a.uniform3fv(f.lightcol[t],d[8+t]),a.uniform1f(f.lightspot[t],d[4+t][3]),a.uniform3fv(f.lightatt[t],d[12+t]),f.lightintensity[t]&&a.uniform1f(f.lightintensity[t],d[12+t][0]),f.lightrange[t]&&a.uniform1f(f.lightrange[t],d[12+t][1]),a.uniformMatrix4fv(f.lightlvm[t],!1,d[16+t]),a.uniformMatrix4fv(f.lightlvp[t],!1,d[20+t]),a.activeTexture(a.TEXTURE0+t+q),d[24+t]&&a.bindTexture(a.TEXTURE_2D,d[24+t]),a.activeTexture(a.TEXTURE0),a.uniform1i(f.lightmap[t],q+t));if(a.activeTexture(a.TEXTURE0),f.doublesided&&a.disable(a.CULL_FACE),f.transparency>0||f.additiveTransparency>0?a.enable(a.BLEND):a.disable(a.BLEND),0==pimOptions.maxRenderLevel&&2!=this.inst.selected&&(o+=(this.surfaces||e.surfaces)[h].count,e.attribs[0].byteLength/12>65535?a.drawElements(a.TRIANGLES,3*(this.surfaces||e.surfaces)[h].count,a.UNSIGNED_INT,3*(this.surfaces||e.surfaces)[h].start*4):a.drawElements(a.TRIANGLES,3*(this.surfaces||e.surfaces)[h].count,a.UNSIGNED_SHORT,3*(this.surfaces||e.surfaces)[h].start*2)),(this.inst.selected||1==pimOptions.maxRenderLevel)&&(this.surfaces||e.surfaces)[(this.surfaces||e.surfaces).length-1]==f){if((2==this.inst.selected||1==pimOptions.maxRenderLevel)&&(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e.attribs[1002].glBuffer),e!=l.ref_bone&&e!=l.ref_ball&&e!=l.ref_cube&&a.uniform3fv(f.colorloc,[1,1,1]),f.lumiloc&&a.uniform1f(f.lumiloc,1),f.diffloc&&a.uniform1f(f.diffloc,0),f.transparencyloc&&a.uniform1f(f.transparencyloc,.75),a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),e.attribs[0].byteLength/12>65535?a.drawElements(a.LINES,e.attribs[1002].count,a.UNSIGNED_INT,0):a.drawElements(a.LINES,e.attribs[1002].count,a.UNSIGNED_SHORT,0),a.disable(a.BLEND)),this.bones&&this.bones.length){for(myDir.lastHandle=null,a.depthFunc(a.ALWAYS),t=0;u=this.bones[t];t++)u.inst.changed=1,void 0==u.inst.restWidth&&(u.inst.restWidth=u.inst.restLength),v=mat4.create(u.inst.evaluateMatrix()),v=mat4.scale(v,[Math.min(u.inst.restLength,u.inst.restWidth),Math.min(u.inst.restWidth,u.inst.restLength),u.inst.restLength]),l.ref_bone.surfaces[0].color=u.inst.selected?[1,1,0]:[0,0,1],g.prototype.driverRenderSurface.call({inst:{selected:2,evaluateMatrix:function(a){return a}.bind(this,v)},obj:l.ref_bone,loaded:1,camPos:this.camPos},a,b,c,d,l.ref_bone,l.ref_bone.surfaces[0],0,j),v=mat4.create(u.inst.evaluateMatrix()),v=mat4.rotateY(v,1.5707963267948966),v=mat4.scale(v,[.01,.01,.05]),g.prototype.driverRenderSurface.call({inst:{selected:2,evaluateMatrix:function(a){return a}.bind(this,v)},obj:l.ref_bone,loaded:1,camPos:this.camPos},a,b,c,d,l.ref_bone,l.ref_bone.surfaces[0],0,j);for(t=0;u=this.bones[t];t++)v=u.inst.evaluateMatrix(),0==t&&(w=mat4.multiplyVec4(b,mat4.multiplyVec4(c,vec4.create([v[12],v[13],v[14],1]))),w[0]=(w[0]/w[3]/2+.5)*myDir.canvas.width,w[1]=(-w[1]/w[3]/2+.5)*myDir.canvas.height,x=Math.sqrt((myDir.mousex-w[0])*(myDir.mousex-w[0])+(myDir.mousey-w[1])*(myDir.mousey-w[1])),10>x&&(myDir.lastHandle=u.inst.parent),l.ref_ball.surfaces[0].color=10>x?[0,1,0]:[1,1,1],g.prototype.driverRenderSurface.call({inst:{selected:0,evaluateMatrix:function(a){return a}.bind(this,v)},obj:l.ref_ball,loaded:1,camPos:this.camPos},a,b,c,d,l.ref_ball,l.ref_ball.surfaces[0],0,j)),mat4.translate(v,[0,0,u.inst.restLength]),w=mat4.multiplyVec4(b,mat4.multiplyVec4(c,vec4.create([v[12],v[13],v[14],1]))),w[0]=(w[0]/w[3]/2+.5)*myDir.canvas.width,w[1]=(-w[1]/w[3]/2+.5)*myDir.canvas.height,x=Math.sqrt((myDir.mousex-w[0])*(myDir.mousex-w[0])+(myDir.mousey-w[1])*(myDir.mousey-w[1])),l.ref_ball.surfaces[0].color=10>x?[0,1,0]:[1,1,1],10>x&&(myDir.lastHandle=u.inst),g.prototype.driverRenderSurface.call({inst:{selected:0,evaluateMatrix:function(a){return a}.bind(this,v)},obj:l.ref_ball,loaded:1,camPos:this.camPos},a,b,c,d,l.ref_ball,l.ref_ball.surfaces[0],0,j),u.inst.changed=1;a.depthFunc(a.LEQUAL)}e!=l.ref_cube&&e!=l.ref_bone&&e!=l.ref_ball&&(v=this.inst.evaluateMatrix(),v=mat4.translate(v,[(this.bbox[3]+this.bbox[0])/2,(this.bbox[4]+this.bbox[1])/2,(this.bbox[5]+this.bbox[2])/2]),v=mat4.scale(v,[this.bbox[3]-this.bbox[0],this.bbox[4]-this.bbox[1],this.bbox[5]-this.bbox[2]]),g.prototype.driverRenderSurface.call({inst:{selected:2,evaluateMatrix:function(a){return a}.bind(this,v)},obj:l.ref_cube,loaded:1,camPos:this.camPos},a,b,c,d,l.ref_cube,l.ref_cube.surfaces[0],0,j),this.inst.changed=1)}0!=f.additiveTransparency?a.depthMask(!0):(f.transparency||f.additiveTransparency||f.a1)&&a.disable(a.BLEND),f.noZ&&a.depthMask(!0),f.noZT&&a.enable(a.DEPTH_TEST),f.doublesided&&a.enable(a.CULL_FACE)}},g.prototype.driverRender=function(a,b,c,d,e,f){var h,i,k,m,n,o=this.obj;if(window.traceFrame,this.inst.selected&&!l.ref_cube.loaded&&(g.prototype.driverLoad.call({obj:l.ref_cube,bones:[]},a,void 0,e),l.ref_cube.attribs[1002].count=24),l.ref_bone.loaded||(g.prototype.driverLoad.call({obj:l.ref_bone,bones:[]},a,void 0,e),g.prototype.driverLoad.call({obj:l.ref_ball,bones:[]},a,void 0,e)),this.bones.length&&pimOptions.gpuBones)for(void 0==this.bonemap&&(this.bonemap=new Float32Array(new ArrayBuffer(16*this.bones.length*4))),this.bonemapi=0,i=0;i<this.bones.length;i++)if(255!=this.bones[i].weightMap)for(h=this.bones[i].inst.boneMatrix(this.inst),k=0;16>k;k++)this.bonemap[16*this.bones[i].weightMap+k]=h[k];if(this.obj.loaded||this.driverLoad(a,void 0,e),0!=this.obj.loaded)for(this.inst.morphs&&this.inst.morphs.length&&!this.inst.rayTransparent&&this.inst.visible&&j(this),m=e.cameras[0].inst.evaluateMatrix(),this.camPos=[m[12],m[13],m[14]],n=0;n<(this.surfaces||o.surfaces).length;n++)(this.surfaces||o.surfaces)[n].count&&1!=(this.surfaces||o.surfaces)[n].transparency&&this.driverRenderSurface(a,b,c,d,o,(this.surfaces||o.surfaces)[n],n,f)},q.calcCount=0,Object.prototype.__defineSetter__&&[["Objects","objects"],["Lights","lights"],["Cameras","cameras"],["phase2cull","phase2Cull"]].forEach(function(a){l.prototype.__defineGetter__(a[0],Function("console.log('%cChange "+a[0]+" into "+a[1]+"'+new Error().stack.split('\\n',3)[2],'background:#FFCCCC; color:black'); return this."+a[1]+";")),l.prototype.__defineSetter__(a[0],Function("console.log('%cChange "+a[0]+" into "+a[1]+"'+new Error().stack.split('\\n',3)[2],'background:#FFCCCC; color:black'); this."+a[1]+" = arguments[0];"))}),l.nameCache={},l.prototype.byName=function(a){var b,c;if("string"==typeof a){for(b=0;b<this.objects.length;b++){if(this.objects[b].inst.name==a)return l.nameCache[a]=this.objects[b],this.objects[b];if(this.objects[b].bones)for(c=0;c<this.objects[b].bones.length;c++)if(this.objects[b].bones[c].inst.name==a)return l.nameCache[a]=this.objects[b].bones[c],this.objects[b].bones[c]}for(b=0;b<this.lights.length;b++)if(this.lights[b].inst.name==a)return l.nameCache[a]=this.lights[b],this.lights[b];for(b=0;b<this.cameras.length;b++)if(this.cameras[b].inst.name==a)return l.nameCache[a]=this.cameras[b],this.cameras[b];return null}for(b=0;b<this.objects.length;b++){if(this.objects[b].inst.name&&this.objects[b].inst.name.match(a))return this.objects[b];if(this.objects[b].bones)for(c=0;c<this.objects[b].bones.length;c++)if(this.objects[b].bones[c].inst.name.match(a))return this.objects[b].bones[c]}for(b=0;b<this.lights.length;b++)if(this.lights[b].inst.name.match(a))return this.lights[b];for(b=0;b<this.cameras.length;b++)if(this.cameras[b].inst.name.match(a))return this.cameras[b];return null},l.prototype.match=function(a){var b,c,d,e,f=[];for(b=0;c=this.objects[b];b++)if(c.inst.name.match(a)&&f.push(c),c.bones)for(d=0;e=c.bones[d];d++)e.inst.name.match(a)&&f.push(e);for(b=0;c=this.lights[b];b++)c.inst.name.match(a)&&f.push(c);for(b=0;c=this.cameras[b];b++)c.inst.name.match(a)&&f.push(c);return f},l.prototype.evaluate=function(a){var b,c,d;for(b=0;b<this.objects.length;b++)for(this.objects[b].inst.evaluate(a),c=0;c<this.objects[b].bones.length;c++)this.objects[b].bones[c].inst.evaluate(a);for(b=0;d=this.lights[b];b++)if(d.inst.evaluate(a),d.splines)for(c=0;c<d.splines.length;c++)if(d.splines[c]instanceof Array)for(k=0;k<d.splines[c].length;k++)d[c][k]=d.splines[c][k].evaluate(a);else d[c]=d.splines[c].evaluate(a);for(b=0;b<this.cameras.length;b++)this.cameras[b].inst.evaluate(a);return this},l.prototype.addObject=function(a,b){var c=a instanceof g?a:new g(a,b||new q);return this.objects.push(c),c},l.prototype.addCamera=function(a){var b=new d(a||new q("Camera"));return this.cameras.push(b),b},l.prototype.addLight=function(a){var b=new e(a||new q("Light"));return this.lights.push(b),b},l.prototype.addParticle=function(a){var b=new g(null,new q(a.name||a.Name)),c=new pimParticle(b,a);return this.objects.push(b),c},l.prototype.getStats=function(){var a,b,c={};c.nrCameras=this.cameras.length,c.nrLights=this.lights.length,c.nrObjects=this.objects.length,c.nrBones=0,c.nrVerts=0,c.nrSkinnedVerts=0,c.nrTris=0,c.nrMaterials=0,c.nrTextures=0;for(a in this.pimTextureCache)c.nrTextures++;for(a in this.objects)b=this.objects[a],c.nrBones+=b.bones.length,b.obj&&(c.nrMaterials+=b.obj.surfaces.length,c.nrVerts+=b.obj.attribs[0].byteLength/12,b.bones.length&&(c.nrSkinnedVerts+=b.obj.attribs[0].byteLength/12),b.obj.attribs[1003]&&(c.nrTris+=b.obj.attribs[1003].byteLength/6));return c},p=[vec4.create(),vec4.create(),vec4.create(),vec4.create(),vec4.create(),vec4.create(),vec4.create(),vec4.create()],l.prototype.cull=function(a,b){var c,d,e,f,g,h,i,j,k,l,n,o,q=mat4.create(),r=mat4.create(),s=p,t=Array(8),u=0,v=0,w=(vec4.create(),vec4.create()),x=1,y=1,z=-1,A=-1;for(mat4.multiply(a,b,q),c=0,d=this.objects.length;d>c;c++)if(e=this.objects[c],f=e.obj,e.obj||e.customRender){if(f||e.customRender)if(!e.inst.squeezed()&&e.inst.visible){if(!e.bbox){if(e.bbox=f.calculateBoundingBox(),!e.bbox)continue;f.calculatePolygonNormals()}if(e.customRender?r=q:(g=e.inst.evaluateMatrix(),mat4.multiplyVec4FxyzwF(g,.5*(e.bbox[0]+e.bbox[3]),.5*(e.bbox[1]+e.bbox[4]),.5*(e.bbox[2]+e.bbox[5]),1,w),mat4.multiplyVec4(b,w,w),h=w[2],e.depth=e.hasTransparency?-h:h,this.phase2Cull&&mat4.multiply(q,g,r)),(this.phase2Cull||!--e.culled)&&(v++,mat4.multiplyVec4FxyzwF(r,e.bbox[0],e.bbox[1],e.bbox[2],1,s[0]),mat4.multiplyVec4FxyzwF(r,e.bbox[0],e.bbox[1],e.bbox[5],1,s[1]),mat4.multiplyVec4FxyzwF(r,e.bbox[0],e.bbox[4],e.bbox[2],1,s[2]),mat4.multiplyVec4FxyzwF(r,e.bbox[0],e.bbox[4],e.bbox[5],1,s[3]),mat4.multiplyVec4FxyzwF(r,e.bbox[3],e.bbox[1],e.bbox[2],1,s[4]),mat4.multiplyVec4FxyzwF(r,e.bbox[3],e.bbox[1],e.bbox[5],1,s[5]),mat4.multiplyVec4FxyzwF(r,e.bbox[3],e.bbox[4],e.bbox[2],1,s[6]),mat4.multiplyVec4FxyzwF(r,e.bbox[3],e.bbox[4],e.bbox[5],1,s[7]),m(s)<0?(u++,e.culled=0):e.culled=15,this.phase2Cull&&(e.inst.vChanged||e.customRender)&&(i=1,j=1,k=0,l=-1,n=-1,e.bbox[3]>=e.bbox[0]))){for(o=0;8>o;o++)k=1/s[o][3],t[o]=[s[o][0]*k,s[o][1]*k],i=Math.min(i,t[o][0]),l=Math.max(l,t[o][0]),j=Math.min(j,t[o][1]),n=Math.max(n,t[o][1]);e.screenRect=[i,j,l,n],void 0==e.lr&&(e.lr=[i,j,l,n]),isNaN(e.lr[0]),x=Math.max(-1,Math.min(x,Math.min(e.lr[0]-.01,i))),y=Math.max(-1,Math.min(y,Math.min(e.lr[1]-.01,j))),z=Math.min(1,Math.max(z,Math.max(e.lr[2]+.01,l))),A=Math.min(1,Math.max(A,Math.max(e.lr[3]+.01,n))),e.lr=[i,j,l,n]}}else e.depth&&e.lr&&(x=Math.max(-1,Math.min(x,e.lr[0]-.01)),y=Math.max(-1,Math.min(y,e.lr[1]-.01)),z=Math.min(1,Math.max(z,e.lr[2]+.01)),A=Math.min(1,Math.max(A,e.lr[3]+.01))),e.culled=0,e.depth=0,u++}else e.obj||(e.depth=0);return this.culled=u/v,this.cameras[0].inst.vChanged||0==this.phase2Cull?(this.dirty=[0,0,1,1],this):z>x?(this.dirty=[.5*x+.5,.5*y+.5,.5*(z-x),.5*(A-y)],this):(this.dirty=[0,0,0,0],this)},l.prototype.cleanup=function(){for(var a,b,c,d,e,f,g,h,i,j,k,l=-1,m=0;0!=l;){for(a=0,b=0,c=[],d=[],f=0;e=this.objects[f];f++)e.obj||c.push(e.inst);for(f=0;e=this.objects[f];f++){for(g in["x","y","z","h","p","b","xs","ys","zs"])e.inst[["x","y","z","h","p","b","xs","ys","zs"][g]]=1*e.inst[["x","y","z","h","p","b","xs","ys","zs"][g]];b++,!e.inst.hasKeys()&&0==e.inst.px&&0==e.inst.py&&0==e.inst.pz&&e.inst.parent&&(a++,d.push(e.inst))}for(l=0,f=0;g=d[f];f++)1==g.xs&&1==g.ys&&1==g.zs&&1==g.parent.xs&&1==g.parent.ys&&1==g.parent.zs&&(l++,h=g.parent.parent,g.parent.parent=null,g.parent.changed=1,i=g.evaluateMatrix(),g.parent.parent=h,g.parent.changed=1,g.position=[i[12],i[13],i[14]],mat4.toHPB(i,g.rotation),g.parent=g.parent.parent,g.changed=1);m+=l}for(j=[],f=0;e=this.objects[f];f++)j.push(e.inst.parent);for(f=0;e=this.lights[f];f++)j.push(e.inst.parent);for(f=0;e=this.cameras[f];f++)j.push(e.inst.parent);for(k=[],f=0;e=this.objects[f];f++)e.obj||-1!=j.indexOf(e.inst)||k.push(e);for(f=0;e=this.objects[f];)-1!=k.indexOf(e)?this.objects.splice(f,1):f++},l.bufferstack=[],l.prototype.createOffScreen=function(a,b,c){var d,e,f,g;return void 0==c&&(c=b),d=a.createTexture(),a.bindTexture(a.TEXTURE_2D,d),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),e=b&b-1||c&c-1,e?(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE)):(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.REPEAT),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.REPEAT)),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,b,c,0,a.RGBA,a.UNSIGNED_BYTE,null),f=a.createRenderbuffer(),a.bindRenderbuffer(a.RENDERBUFFER,f),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,b,c),g=a.createFramebuffer(),a.bindFramebuffer(a.FRAMEBUFFER,g),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,d,0),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,f),a.bindFramebuffer(a.FRAMEBUFFER,null),a.bindTexture(a.TEXTURE_2D,null),{gl:a,width:b,height:c,framebuffer:g,colorTexture:d,last:null,"delete":function(){a.deleteTexture(d),a.deleteRenderbuffer(f),a.deleteFramebuffer(g)},bind:function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.framebuffer),l.bufferstack.push(this)},unbind:function(a){a&&this.gl.readPixels(0,0,this.width,this.height,this.gl.RGBA,this.gl.UNSIGNED_BYTE,a),l.bufferstack.pop(this);var b=l.bufferstack[l.bufferstack.length-1]||null;b&&(b=b.framebuffer),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,b)}}},l.prototype.propagateChanged=function(){var a,b,c,d,e,f,g,h,i;for(a=0,b=this.objects.length;b>a;a++){if(c=this.objects[a],c.bones)for(d=0;e=c.bones[d];d++){if(e.inst.changed)c.inst.changed|=e.inst.changed;else{for(f=e.inst.parent;f&&(e.inst.changed|=f.changed,!f.changed);)f=f.parent;c.inst.changed|=e.inst.changed,e.inst.bChanged=e.inst.changed}e.inst.changed=0}if(!c.inst.changed)for(f=c.inst.parent;f&&(c.inst.changed|=f.changed,!f.changed);)f=f.parent}for(g=0;b=this.lights[g];g++)if(!b.inst.changed)for(f=b.inst.parent;f&&(b.inst.changed|=f.changed,!f.changed);)f=f.parent;for(h=0;i=this.cameras[h];h++)if(!i.inst.changed)for(f=i.inst.parent;f&&(i.inst.changed|=f.changed,!f.changed);)f=f.parent},l.prototype.render=function(a,b){var c,d,e,f,h,i,j,k,m;if(!this.objects||!this.objects.length)return!1;if(this.filters.length&&(void 0==this.offscreen_buffer&&(this.offscreen_buffer=this.createOffScreen(b,parseInt(a.width),parseInt(a.height))),this.offscreen_buffer.bind(),b.viewport(0,0,parseInt(a.width),parseInt(a.height)),b.scissor(0,0,parseInt(a.width),parseInt(a.height))),q.calcCount++,o=0,this.tpf=0,lastprogram=null,c=(new Date).getTime(),this.cframe++,c-this.cstart>500&&(this.fps=(this.cframe/(c-this.cstart)*1e3).toFixed(1),this.cstart=(new Date).getTime(),this.cframe=0),d=mat4.create(),e=mat4.create(),f=mat4.create(),b)for(h=0;i=this.lights[h];h++)if(2==i.shadowType&&2==i.type){for(void 0==i.depthmap&&(i.depthmap=this.createOffScreen(b,i.shadowMapSize)),i.depthmap.bind(),mat4.perspective(i.coneangle/3.1415926535*180*2,1,.01,i.range,d),d[10]=-1,d[14]=-0.2,mat4.inverse(i.inst.evaluateMatrix(),f),mat4.scale(d,[1,1,-1]),b.viewport(0,0,i.shadowMapSize||512,i.shadowMapSize||512),b.disable(b.SCISSOR_TEST),b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT),b.depthFunc(this.depthFunc||b.LEQUAL),this.objects.sort(function(a,b){return!a.obj^!b.obj?!a.obj-!b.obj:a.customRender&&!b.customRender?-1:b.customRender&&!a.customRender?1:a.sortGroup<b.sortGroup?1:a.sortGroup>b.sortGroup?-1:a.hasTransparency&&!b.hasTransparency?1:b.hasTransparency&&!a.hasTransparency?-1:a.depth-b.depth}),j=[],k=0;k<this.objects.length;k++)m=this.objects[k],void 0==m.obj&&void 0==m.customRender||m.inst.squeezed()||!m.inst.visible&&!m.customRender||!m.culled&&!m.customRender||2&m.inst.shadowOptions&&(m.customRender||m.driverRender(b,d,f,j,this,!0));i.depthmap.unbind()}return this.cameras.forEach(function(c,e){var h,i,j,k,m,n,o,p,q,r,s,t,u;if(0!=c.inst.xs&&0!=c.inst.visible){if(e?mat4.perspective(c.vFov,c.width/c.height,c.zNear,c.zFar,d):mat4.perspective(c.vFov,a.width/a.height,c.zNear,c.zFar,d),c.pMatrix=d,mat4.inverse(c.inst.evaluateMatrix(),f),mat4.scale(d,[c.aspect||1,1,-1]),c.pOffset&&mat4.translate(d,c.pOffset),this.viewport){switch(void 0==this.viewportscale&&(this.viewportscale=3),mat4.ortho(-this.viewportscale*a.width/a.height,this.viewportscale*a.width/a.height,-this.viewportscale,this.viewportscale,-100,100,d),this.viewport){case 1:h=[f[12],f[13],f[14]],mat4.identity(f),f[12]=h[0],f[13]=h[1],f[14]=h[2];break;case 2:h=[f[12],f[13],f[14]],mat4.identity(f),mat4.rotateX(f,-3.14159265),mat4.rotateZ(f,-3.14159265),f[12]=h[0],f[13]=h[1],f[14]=h[2];break;case 3:h=[f[12],f[13],f[14]],mat4.identity(f),mat4.rotateX(f,-1.570796325),f[12]=h[0],f[13]=h[1],f[14]=h[2];break;case 4:h=[f[12],f[13],f[14]],mat4.identity(f),mat4.rotateZ(f,3.14159265),mat4.rotateX(f,1.570796325),f[12]=h[0],f[13]=h[1],f[14]=h[2];break;case 5:h=[f[12],f[13],f[14]],mat4.identity(f),mat4.rotateY(f,1.57079632675),f[12]=h[0],f[13]=h[1],f[14]=h[2];
break;case 6:h=[f[12],f[13],f[14]],mat4.identity(f),mat4.rotateY(f,-1.57079632675),f[12]=h[0],f[13]=h[1],f[14]=h[2];break;case 7:mat4.perspective(this.lights[0].coneangle/3.1415926535*180*2,a.width/a.height,.01,500,d),mat4.inverse(this.lights[0].inst.evaluateMatrix(),f);break;case 8:}mat4.scale(d,[1,1,-1])}if(this.cull(d,f),b&&!e){if(this.dirty[2]-this.dirty[0]==0||this.dirty[3]-this.dirty[1]==0)return!1;b.viewport(0,0,a.width,a.height),this.blokskes&&(b.disable(b.SCISSOR_TEST),b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT)),b.enable(b.SCISSOR_TEST),b.scissor(Math.floor(this.dirty[0]*this.width),Math.floor(this.dirty[1]*this.height),Math.floor(this.dirty[2]*this.width),Math.floor(this.dirty[3]*this.height)),b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT),b.depthFunc(this.depthFunc||b.LEQUAL)}for(b&&e&&(i=a.width*c.overlayWidth/100*((this.cameras[0].width||4)/(this.cameras[0].height||3))/(a.width/a.height),j=a.height*c.overlayHeight/100,k=a.width*((c.overlayLeft/100-.5)*((this.cameras[0].width||4)/(this.cameras[0].height||3))/(a.width/a.height)+.5),m=a.height*c.overlayTop/100,b.viewport(k,m,i,j),b.enable(b.SCISSOR_TEST),b.scissor(k,m,i,j),b.clear(c.clear?b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT:b.DEPTH_BUFFER_BIT)),n=[],o=0;(p=this.lights[o])&&4!=o;o++)h=mat4.multiplyVec4(p.inst.evaluateMatrix(),[0,0,0,1]),n[o]=vec3.create(h),q=mat4.multiplyVec4(p.inst.evaluateMatrix(),[0,0,-1,0]),n[4+o]=vec3.normalize(vec3.create(q)),n[8+o]=p.color,n[12+o]=vec3.create([p.intensity,0,0]),2==p.fallofType&&(n[12+o][1]=p.range),3==p.fallofType&&(n[12+o][1]=p.range),n[16+o]=mat4.create(),mat4.inverse(p.inst.evaluateMatrix(),n[16+o]),n[20+o]=mat4.create(),mat4.perspective(p.coneangle/3.1415926535*180*2,1,.01,p.range,n[20+o]),n[20+o][10]=-1,n[20+o][14]=-0.2,mat4.scale(n[20+o],[1,1,-1]),p.depthmap&&(n[24+o]=p.depthmap.colorTexture);for(this.objects.sort(function(a,b){return!a.obj^!b.obj?!a.obj-!b.obj:!a.customRender^!b.customRender?!b.customRender-!a.customRender:a.sortGroup!=b.sortGroup?b.sortGroup-a.sortGroup:a.hasTransparency^b.hasTransparency?!!a.hasTransparency-!!b.hasTransparency:a.depth!=b.depth?(a.depth||0)-(b.depth||0):a.obj&&b.obj&&a.hasTransparency&&b.hasTransparency?b.obj.surfaces[b.obj.surfaces.length-1].transparency-a.obj.surfaces[a.obj.surfaces.length-1].transparency:0}),o=0;o<this.objects.length;o++)r=this.objects[o],r.HTML&&!r.HTML.nopos&&(s=r.HTML.pimmtx||mat4.create(),mat4.multiply(f,r.inst.evaluateMatrix(),s),mat4.multiply(d,s,s),r.HTML.pimmtx=s,r.HTML.style.left="0%",r.HTML.style.top="0%",s=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],s[12]=(r.HTML.pimmtx[12]/r.HTML.pimmtx[15]*.5+.5)*a.width,s[13]=(-r.HTML.pimmtx[13]/r.HTML.pimmtx[15]*.5+.5)*a.height,s[14]=(r.HTML.pimmtx[14]/r.HTML.pimmtx[15]*.5+.5)*a.height,s[15]=1,s[0]=s[0]/r.HTML.pimmtx[15]*a.height/15*(r.HTML.pimScale||1),s[5]=s[5]/r.HTML.pimmtx[15]*a.height/15*(r.HTML.pimScale||1),s[10]=s[10]/r.HTML.pimmtx[15]*a.height/15*(r.HTML.pimScale||1),r.HTML.style.visibility=r.HTML.pimmtx[14]>=0?"visible":"hidden",r.HTML.style["-webkit-transform-origin"]=r.HTML.pimCenter?"center center":"left top",r.HTML.style["-webkit-transform"]="matrix3d("+Array.prototype.join.call(s)+")",r.HTML.style["transform-origin"]=r.HTML.pimCenter?"center center":"left top",r.HTML.style.transform="matrix3d("+Array.prototype.join.call(s)+")"),!b||void 0==r.obj&&void 0==r.customRender||r.inst.squeezed()||!r.inst.visible&&!r.customRender||!r.culled&&!r.customRender||(r.bones.length&&!pimOptions.gpuBones&&r.deform_cpu(b),r.customRender?(r.customRender(b,d,f,n,this),lastprogram=null):r.driverRender(b,d,f,n,this)),r.inst.vChanged=0;for(t=c.inst.evaluateMatrix(),this.camPos=[t[12],t[13],t[14]],o=0;o<this.lights.length;o++)p=this.lights[o],p.inst.selected&&(u=mat4.create(p.inst.evaluateMatrix()),u=mat4.scale(u,[p.range||1,p.range||1,p.range||1]),g.prototype.driverRenderSurface.call({inst:{selected:2,evaluateMatrix:function(a){return a}.bind(this,u)},obj:l.ref_cube,loaded:1,camPos:this.camPos},b,d,f,n,l.ref_cube,l.ref_cube.surfaces[0],0,!1));c.inst.vChanged=0}}.bind(this)),this.tpf=o,delete window.traceFrame,this.filters.length&&(this.offscreen_buffer.unbind(),this.filters[0].apply&&this.filters[0].apply(this.offscreen_buffer)),!0},l.prototype.recompile=function(){this.objects.forEach(function(a){a.obj&&(a.obj.loaded=0)})},l.ref_cube=r.cube(.5,void 0,!0),l.ref_bone=r.capsule(16,2,.1,.8,!0,[0,.5,0],void 0,.1),l.ref_ball=r.sphere(8,8,.02,!0),l.ref_ball.surfaces[0].luminosity=.5,l.ref_bone.surfaces[0].color=[0,0,1],l.ref_cube.surfaces[0].luminosity=1,l.ref_cube.surfaces[0].color=[.4,1,.4],l.oldSchool=!1,l.bindTexture=i,c.pimScene=l,c.pimBone=f,c.pimLight=e,c.pimCamera=d,c.pimObjectInstance=g},{"./fragmentZ.pimShader.js":1,"./pim_instance":6,"./pim_stream":19,"./uberFragment.pimShader.js":22,"./uberVertex.pimShader.js":23,"./vertexZ.pimShader.js":24}],17:[function(require,module,exports){function pimSound(a,b,c,d,e){this.url=a,this.defSpeed=b||1,this.defVol=c||0===c?c:1,this.onLoad=d,this.onError=e,this.complete=wait.link(),this.errorCB=wait.link(!1),sound_load(a,this._onLoadComplete.bind(this))}function pimSoundInstance(a){this.url=a.url,a.onEnded=this._onEnded.bind(this),this.instanceCtx=sound_start(a),this.playing=!0}function tryDecode(){decoding||(decoding=decodeQueue.shift(),decoding&&audioContext.decodeAudioData(decoding.buffer,function(a){log("decoded ",decoding.url),decoding.cb(null,a),decoding=null,tryDecode()},function(a){logErr("Decode error",decoding.url,a,arguments),decoding.cb.apply(this,arguments),decoding=null,tryDecode()}))}function loadJS(u){pimUtils.fileAsTextSync(u,null,function(file){eval(file)})}function buzzOverwrite(){function a(a,b){setTimeout(function(){b(null,new buzz.sound(a).load())},100)}function b(a){var b=a.audioBuffer.setSpeed(a.speed).setVolume(100*a.volume).play().setTime(a.startOffset);return a.loop&&b.loop(),b}function c(a,b){this.instanceCtx.setVolume(100*a)}function d(a,b){this.instanceCtx.setSpeed(a)}function e(a,b,c){this.instanceCtx.fadeTo(100*a,1e3*b),c&&this.stop(b)}function f(a,b,c){this.instanceCtx.setSpeed(a),c&&this.stop(b)}function g(a){this.instanceCtx.stop()}return{sound_load:a,sound_start:b,setVolume:c,setSpeed:d,slideVolume:e,slideSpeed:f,stop:g}}function soundjsOverwrite(){function a(a,b){createjs.Sound.addEventListener("fileload",function c(d){d.src==a&&(createjs.Sound.removeEventListener("fileload",c),b(null,d.src))}),createjs.Sound.registerSound(a)}function b(a){1!=a.speed;var b=createjs.Sound.play(a.audioBuffer,{delay:a.delay/1e3,offset:a.startOffset/1e3,loop:a.loop?-1:0,volume:a.volume});return b.setVolume(a.volume),b}function c(a,b){b?setTimeout(this.instanceCtx.setVolume.bind(this.instanceCtx,a),1e3*b):this.instanceCtx.setVolume(a)}function d(){}function e(a,b,c){setTimeout(this.setVolume.bind(this,a),500*b),c&&setTimeout(this.stop.bind(this),1e3*b)}function f(a,b,c){c&&setTimeout(this.stop.bind(this),1e3*b)}function g(a){a?setTimeout(this.instanceCtx.stop.bind(this.instanceCtx),1e3*a):this.instanceCtx.stop()}return createjs.FlashPlugin?(createjs.FlashPlugin.swfPath="./",createjs.Sound.registerPlugins([createjs.FlashPlugin]),createjs.Sound.alternateExtensions=["mp3","wav"],{sound_load:a,sound_start:b,setVolume:c,setSpeed:d,slideVolume:e,slideSpeed:f,stop:g}):!1}var log,logWarn,logErr,wait,audioContext,decodeQueue,decoding,sound_load,sound_start;pimSound.prototype.verbose=0,log=function(){pimSound.prototype.verbose>2&&console.log.apply(console,["[pimSound]"].concat([].slice.apply(arguments)))},logWarn=function(){pimSound.prototype.verbose>1&&console.log.apply(console,["[pimSound]WARN"].concat([].slice.apply(arguments)))},logErr=function(){pimSound.prototype.verbose>0&&console.log.apply(console,["[pimSound]ERROR"].concat([].slice.apply(arguments)))},wait=new pimUtils.countingCompleter,pimSound.waitAll=wait.wait.bind(wait),pimSound.prototype._onLoadComplete=function(a,b){return a?(this.errorCB(a),logErr("loading failed "+this.url,a),void(this.onError&&this.onError(a))):(this.audioBuffer=b,this.startArgs&&this.start.apply(this,this.startArgs),this.onLoad&&this.onLoad(this),void this.complete(this))},pimSound.prototype.start=function(a,b,c,d,e){if(!this.audioBuffer)return this.startArgs=arguments,logWarn("Starting sound "+this.url+" while it failed, or has not yet finished, loading/decodeing. Will be started when looading/decode finishes");0===c&&logWarn("Ignoring speed of 0, using default of "+this.defSpeed),c||(c=1),void 0===d&&(d=1);var f={audioBuffer:this.audioBuffer,url:this.url,startOffset:a||0,delay:b||0,speed:c*this.defSpeed,volume:d*this.defVol,loop:e||!1};return log("Starting sound",this.url,f),new pimSoundInstance(f)},pimSoundInstance.prototype._onEnded=function(a){this.onEnded&&this.onEnded(a),this.playing=!1},function(){"use strict";function a(a){a&&(a.setTargetAtTime||(a.setTargetAtTime=a.setTargetValueAtTime))}window.hasOwnProperty("webkitAudioContext")&&!window.hasOwnProperty("AudioContext")&&(window.AudioContext=webkitAudioContext,AudioContext.prototype.hasOwnProperty("createGain")||(AudioContext.prototype.createGain=AudioContext.prototype.createGainNode),AudioContext.prototype.hasOwnProperty("createDelay")||(AudioContext.prototype.createDelay=AudioContext.prototype.createDelayNode),AudioContext.prototype.hasOwnProperty("createScriptProcessor")||(AudioContext.prototype.createScriptProcessor=AudioContext.prototype.createJavaScriptNode),AudioContext.prototype.internal_createGain=AudioContext.prototype.createGain,AudioContext.prototype.createGain=function(){var b=this.internal_createGain();return a(b.gain),b},AudioContext.prototype.internal_createDelay=AudioContext.prototype.createDelay,AudioContext.prototype.createDelay=function(b){var c=b?this.internal_createDelay(b):this.internal_createDelay();return a(c.delayTime),c},AudioContext.prototype.internal_createBufferSource=AudioContext.prototype.createBufferSource,AudioContext.prototype.createBufferSource=function(){var b=this.internal_createBufferSource();return b.start||(b.start=function(a,b,c){b||c?this.noteGrainOn(a,b,c):this.noteOn(a)}),b.stop||(b.stop=b.noteOff),a(b.playbackRate),b},AudioContext.prototype.internal_createDynamicsCompressor=AudioContext.prototype.createDynamicsCompressor,AudioContext.prototype.createDynamicsCompressor=function(){var b=this.internal_createDynamicsCompressor();return a(b.threshold),a(b.knee),a(b.ratio),a(b.reduction),a(b.attack),a(b.release),b},AudioContext.prototype.internal_createBiquadFilter=AudioContext.prototype.createBiquadFilter,AudioContext.prototype.createBiquadFilter=function(){var b=this.internal_createBiquadFilter();return a(b.frequency),a(b.detune),a(b.Q),a(b.gain),b},AudioContext.prototype.hasOwnProperty("createOscillator")&&(AudioContext.prototype.internal_createOscillator=AudioContext.prototype.createOscillator,AudioContext.prototype.createOscillator=function(){var b=this.internal_createOscillator();return b.start||(b.start=b.noteOn),b.stop||(b.stop=b.noteOff),a(b.frequency),a(b.detune),b}))}(window),window.AudioContext&&(audioContext=new AudioContext,pimSound.audioLibrary="WebAudio"),decodeQueue=[],decoding=null,sound_load=function(a,b,c){audioContext&&(log("start loading",a),pimUtils.fileAsArray(a,c,function(c){log("loaded ",a),decodeQueue.push({url:a,buffer:c,cb:b}),tryDecode()},b))},sound_start=function(a){var b,c;return audioContext?(b=audioContext.createBufferSource(),b.buffer=a.audioBuffer,b.playbackRate.setValueAtTime(a.speed,audioContext.currentTime),b.loop=a.loop,b.onended=a.onEnded,c=audioContext.createGain(),c.gain.setValueAtTime(a.volume,audioContext.currentTime),b.connect(c),c.connect(audioContext.destination),b.start(audioContext.currentTime+a.delay,a.startOffset),{source:b,gainNode:c}):logErr(Error("No Audio Context Found"))},pimSoundInstance.prototype.setVolume=function(a,b){this.instanceCtx.gainNode.gain.setValueAtTime(a,audioContext.currentTime+(b||0))},pimSoundInstance.prototype.setSpeed=function(a,b){this.instanceCtx.source.playbackRate.setValueAtTime(a,audioContext.currentTime+(b||0))},pimSoundInstance.prototype.slideVolume=function(a,b,c){this.instanceCtx.gainNode.gain.linearRampToValueAtTime(a,audioContext.currentTime+b),c&&this.stop(b)},pimSoundInstance.prototype.slideSpeed=function(a,b,c){this.instanceCtx.source.playbackRate.linearRampToValueAtTime(a,audioContext.currentTime+b),c&&this.stop(b)},pimSoundInstance.prototype.stop=function(a){this.instanceCtx.source.stop(audioContext.currentTime+(a||0))},window.hasOwnProperty("webkitAudioContext")||window.hasOwnProperty("AudioContext")||(loadJS("soundjs-NEXT.combined.js"),pimSound.audioLibrary="soundjs",document.addEventListener("DOMContentLoaded",function(){var a=soundjsOverwrite();a&&(sound_load=a.sound_load,sound_start=a.sound_start,pimSoundInstance.prototype.setVolume=a.setVolume,pimSoundInstance.prototype.setSpeed=a.setSpeed,pimSoundInstance.prototype.slideVolume=a.slideVolume,pimSoundInstance.prototype.slideSpeed=a.slideSpeed,pimSoundInstance.prototype.stop=a.stop)})),exports.pimSound=pimSound},{}],18:[function(a,b,c){function d(a,b,c,d,e,f){return this.type=0|a,this.flags=0,this.time=1/3,this.time=b,this.value=1/3,this.value=c,this.tension=1/3,this.tension=d,this.continuity=1/3,this.continuity=e,this.bias=1/3,this.bias=f,this}function e(a){return this.nrKeys=0,this.keys=[],this.pre=1,this.post=1,this.cachetime=-1000000.1,this.cachevalue=1/3,this.cachevalue=0,this.cachekey=-1,this.visible=!0,this.target=null,this.targetvar="",this.ss=0,this.idx=0,this.name="",this.format=void 0,this.ctarget=null,a&&1&&function(b){a.nrKeys&&(b.nrKeys=a.nrKeys),a.keys&&(b.keys=a.keys.map(function(a){var b=new d(a.type,a.time,a.value,a.tension,a.continuity,a.bias);return b.flags=a.flags,b})),void 0!=a.pre&&(b.pre=a.pre),void 0!=a.post&&(b.post=b.post),a.cachekey&&(b.cachekey=a.cachekey)}(this),this}e.M_STEPPED=0,e.M_LINEAR=1,e.M_TCB=4,e.B_RESET=0,e.B_CONST=1,e.B_REPEAT=2,e.B_OSCILATE=3,e.B_OFFSETREPEAT=4,e.B_LINEAR=5,e.prototype.delKey=function(a){if(!this.keys.length)return this;for(var b=0;b<this.keys.length;b++)if(this.keys[b].time==a){this.keys.splice(b,1),this.nrKeys--;break}return this.cachetime=-1e5,this},e.prototype.addKey=function(a,b,c,e,f,g){var h,i,j;if(0==this.keys.length||a>this.keys[this.keys.length-1].time)void 0==c?(this.cachekey=this.keys.length,this.keys.push(new d(4,a,b,0,0,0))):void 0==e?(this.cachekey=this.keys.length,this.keys.push(new d(c,a,b,0,0,0))):(void 0==g&&(g=0,void 0==f&&(f=0)),this.keys.push(new d(c,a,b,e,f,g)),this.cachekey=this.keys.length-1),this.nrKeys++;else{for(h=0,i=0,void 0==c&&(c=4,e=0,f=0,g=0),j=0;j<this.keys.length;j++)if(this.keys[j].time==a)h=1,this.keys[j]=new d(c,a,b,e,f,g),this.cachekey=j;else if(this.keys[j].time>a&&0==i){i=j;break}h||(this.cachekey=i,this.keys.splice(i,0,new d(c,a,b,e,f,g)),this.nrKeys++)}return this},e.prototype.clear=function(){return this.nrKeys=0,this.keys=[],this.pre=1,this.post=1,this.cachetime=-1,this.cachevalue=0,this.cachekey=-1,this},e.prototype.evaluate=function(a){var b,c,d,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C;if(0==this.nrKeys)return this.cachevalue;if(1==this.nrKeys)return this.keys[0].value;if(a==this.cachetime)return this.cachevalue;if(this.cachetime=a,b=this.keys[0].time,c=this.keys[this.nrKeys-1].time,d=this.keys[0].value,f=this.keys[this.nrKeys-1].value,g=0,b>a&&this.nrKeys>1)switch(this.pre){case e.B_RESET:return this.cachevalue=0,this.cachevalue;case e.B_CONST:return this.cachevalue=d,this.cachevalue;case e.B_REPEAT:a-=Math.floor((a-b)/(c-b))*(c-b);break;case e.B_OSCILATE:a-=c-b,a-=2*Math.floor((a-b)/(2*(c-b)))*(c-b),a=Math.abs(a-(c-b));break;case e.B_OFFSETREPEAT:g=(f-d)*Math.floor((a-b)/(c-b)),a-=Math.floor((a-b)/(c-b))*(c-b);break;case e.B_LINEAR:return this.cachevalue=d+(f-d)/(c-b)*(a-b),this.cachevalue}if(a>c&&this.nrKeys>1)switch(this.post){case e.B_RESET:return this.cachevalue=0,this.cachevalue;case e.B_CONST:return this.cachevalue=f,this.cachevalue;case e.B_REPEAT:a-=Math.floor((a-b)/(c-b))*(c-b);break;case e.B_OSCILATE:a-=c-b,a-=2*Math.floor((a-b)/(2*(c-b)))*(c-b),a=Math.abs(-(a-(c-b)));break;case e.B_OFFSETREPEAT:g=(f-d)*Math.floor((a-b)/(c-b)),a-=Math.floor((a-b)/(c-b))*(c-b);break;case e.B_LINEAR:return this.cachevalue=d+(f-d)/(c-b)*(a-b),this.cachevalue}for(h=0,this.cachekey>0&&a>this.keys[this.cachekey-1].time&&(h=this.cachekey);h<this.nrKeys&&a>this.keys[h].time;)h++;if(h==this.nrKeys)return this.cachevalue;if(this.cachekey=h,this.keys[h].type==e.M_TCB){if(i=this.keys[Math.max(0,h-2)],j=this.keys[Math.max(0,h-1)],k=this.keys[h],l=this.keys[Math.min(this.nrKeys-1,h+1)],a==i.time)return this.cachevalue=i.value+g,this.cachevalue;m=(a-j.time)/(k.time-j.time),n=m*m,o=n*m,p=3*n-o-o,q=1-p,r=p,t=o-n,s=t-n+m,x=(1-j.tension)*(1+j.continuity)*(1+j.bias),y=(1-j.tension)*(1-j.continuity)*(1-j.bias),z=(1-k.tension)*(1-k.continuity)*(1+k.bias),A=(1-k.tension)*(1+k.continuity)*(1-k.bias),w=k.value-j.value,k.time-i.time!=0?(B=(k.time-j.time)/(k.time-i.time),v=B*(x*(j.value-i.value)+y*w)):v=.5*(x+y)*w,l.time-j.time!=0?(C=(k.time-j.time)/(l.time-j.time),u=C*(z*w+A*(l.value-k.value))):u=.5*(z+A)*w,this.cachevalue=j.value*q+k.value*r+v*s+u*t+g}else this.cachevalue=this.keys[h].type==e.M_LINEAR?0==h?this.keys[h].value+g:g+this.keys[h-1].value+(this.keys[h].value-this.keys[h-1].value)*(a-this.keys[h-1].time)/(this.keys[h].time-this.keys[h-1].time):this.keys[h].time==a?this.keys[h].value+g:this.keys[h>0?h-1:h].value+g;return this.cachevalue},c.pimSpline=e},{}],19:[function(a,b,c){function d(a,b,c){var d,e,f;if(s={},r={},x=[],t=b||-1,v=0,u=a,w=c||!1,a.attribs[0]){a.attribs[4003]=void 0;for(d in a.attribs){if(1e3>d){for(r[d]=[],e=new Float32Array(a.attribs[d]),f=0;f<e.length;f++)r[d].push(e[f]);s[d]=d>40?[0,0]:[0,0,0]}if(1003==d){for(r[1003]=[],e=new Uint16Array(a.attribs[d]),f=0;f<e.length;f++)r[1003].push(e[f]);r[2003]=[],a.surfaces.forEach(function(a){for(var b=a.start;b<a.start+a.count;b++)r[2003][b]=a.tag})}}}}function e(a,b){var c,d,e,f;for(b=b||Object.keys(r),c=0,d=b.length,e=b[c];d>c;c++,e=b[c])if(1e3>e&&r[e])if(40>e)for(f=0;3>f;f++)r[e].push(r[e][3*a+f]);else for(f=0;2>f;f++)r[e].push(r[e][2*a+f]);return r[0].length/3-1}function f(a){void 0==r[1003]&&(r[1003]=[]),void 0==r[2003]&&(r[2003]=[]);for(var b=0;b<a.length-2;b++)r[1003].push(a[0],a[1+b],a[2+b]),r[2003].push(s[D]||0)}function g(a,b){var c,d;if(-1==t&&a!=D)return void 0==r[a]&&(r[a]=[]),void r[a].push.apply(r[a],b);if(s[a]=b,a==A){if(b){if(c=!1,w&&r[0]&&r[0].length)for(d=0;d<r[0].length/3;d++)if(b[0]==r[0][3*d]&&b[1]==r[0][3*d+1]&&b[2]==r[0][3*d+2]){c=!0,x.push(d);break}if(!w||!c){for(d in s)1e3>d&&(void 0==r[d]&&(r[d]=[]),r[d].push.apply(r[d],s[d]));x.push(r[0].length/3-1)}v++}v==t&&(void 0==r[1003]&&(r[1003]=[]),void 0==r[2003]&&(r[2003]=[]),3==v?(r[1003].push(x[0],x[1],x[2]),r[2003].push(s[D]||0)):4==v&&(r[1003].push(x[0],x[1],x[2]),r[1003].push(x[0],x[2],x[3]),r[2003].push(s[D]||0),r[2003].push(s[D]||0)),v=0,x=[])}}function h(a,b,c,d){return-1==t?(void 0==r[a]&&(r[a]=[]),void r[a].push(r[a],b,c,d)):void 0}function i(a,b,c){return-1==t?(void 0==r[a]&&(r[a]=[]),void r[a].push(r[a],b,c)):void 0}function j(a){var b,c,d,e,f,g,h;for((void 0===a||a)&&(b=r[2003].map(function(a,b){return{index:b,tag:a,poly:r[1003].slice(3*b,3*b+3)}}),b.sort(function(a,b){return a.tag<b.tag?-1:a.tag>b.tag?1:a.index<b.index?-1:a.index>b.index?1:0}),r[1003]=[],r[2003]=[],b.forEach(function(a){return r[1003].push.apply(r[1003],a.poly),r[2003].push(a.tag),!1})),c=1,d=r[2003][0],e=1;e<r[2003].length;e++)r[2003][e]!=d&&(c++,d=r[2003][e]);for(;u.surfaces.length<c;)u.surfaces.push(new z({name:"Default"+u.surfaces.length||"",channels:[],color:[1,1,1],diffuse:1,luminosity:0,specular:0,doublesided:!1,transparency:0,start:0,tag:u.surfaces.length,count:r[1003].length/3,additiveTransparency:0}));if(f=0,g=[],h=[],u.surfaces.length){for(d=r[2003][0],h[f]=0,e=1;e<r[2003].length;e++)r[2003][e]!=d&&(g[f]=e-h[f],f++,h[f]=e,d=r[2003][e]);u.surfaces[f]&&(g[f]=r[2003].length-h[f]),f++}u.surfaces.forEach(function(a){a.start=h[a.tag],a.count=g[a.tag]});for(e in r)1e3>e?(u.attribs[e]=new Float32Array(r[e]).buffer,u.attribs[e].name={0:"pim_position",1:"pim_normal",40:"pim_texcoord0",41:"pim_texcoord1",42:"pim_texcoord2",43:"pim_texcoord3"}[e],u.attribs[e].itemsize=40>e?3:2):1003==e?(u.attribs[e]=r[0].length/3>65535?new Uint32Array(r[e]).buffer:new Uint16Array(r[e]).buffer,u.attribs[e].itemsize=1):2003==e&&(u.attribs[e]=new Uint8Array(r[e]),u.attribs[e].itemsize=1);return u.resourceName="Generated_from_pim_stream",u.generated=1,u}function k(a,b){var c,d,e,f,g,h,i,j,k;for(void 0==b&&(b=mat4.identity()),c=mat4.create(b),mat4.inverse(c),mat4.transpose(c),d=r[0].length/3,e=new Float32Array(a.Obj.attribs[0]),f=new Float32Array(a.Obj.attribs[1]),g=new Float32Array(a.Obj.attribs[40]),h=vec4.create(),i=vec4.create(),j=0;j<e.length/3;j++)h[0]=e[3*j+0],h[1]=e[3*j+1],h[2]=e[3*j+2],h[3]=1,mat4.multiplyVec4(b,h,h),i[0]=f[3*j+0],i[1]=f[3*j+1],i[2]=f[3*j+2],mat4.multiplyVec4(c,i,i),r[0].push(h[0],h[1],h[2]),r[1].push(i[0],i[1],i[2]),r[40].push(g[0],g[1]);for(k=new Uint16Array(a.Obj.attribs[1003]),j=0;j<k.length/3;j++)r[1003].push(k[3*j+0]+d,k[3*j+1]+d,k[3*j+2]+d),r[2003].push(0);a.Obj.surfaces[0].count+=k.length/3}function l(a,b){return a.slice(b).concat(a.slice(0,b))}function m(a,b){var c=new y;return pimStream.begin(c,4),pimStream.attrib(C,[1,0]),pimStream.attrib(A,[b[0],a[1],0]),pimStream.attrib(C,[0,0]),pimStream.attrib(A,[a[0],a[1],0]),pimStream.attrib(C,[0,1]),pimStream.attrib(A,[a[0],b[1],0]),pimStream.attrib(C,[1,1]),pimStream.attrib(A,[b[0],b[1],0]),pimStream.end(),c.calculateSmoothNormals(),c}function n(a,b,c){var e,f,h;for(void 0==c&&(c=!1),void 0==a[0]&&(a=[a,a,a]),void 0==b&&(b=[0,0,0]),e=new y,e.resourceName="Generated cube",d(e,4,c),f=0;3>f;f++)for(h=-1;1>=h;h+=2)g(B,l([0,0,h],f)),g(C,[0,0]),g(A,vec3.add(vec3.mul(l([1,-h,h],f),a),b)),g(C,[0,1]),g(A,vec3.add(vec3.mul(l([-1,-h,h],f),a),b)),g(C,[1,1]),g(A,vec3.add(vec3.mul(l([-1,h,h],f),a),b)),g(C,[1,0]),g(A,vec3.add(vec3.mul(l([1,h,h],f),a),b));return j(),e}function o(a,b,c,e,f,h){var i,k,l,m,n,o,p,q,r,s=c;for(void 0==f&&(f=[0,0,0]),i=!1,void 0==h&&(h=new y,i=!0),h.resourceName="Generated sphere",d(h,4,e),g(B,[0,0,1]),q=0;b>q;q++)for(r=a-1;r>=0;r--)m=s*Math.cos(q/b*Math.PI),n=s*Math.cos((q+1)/b*Math.PI),k=c*Math.cos(r/a*Math.PI*2),l=c*Math.cos((r+1)/a*Math.PI*2),o=c*Math.sin(r/a*Math.PI*2),p=c*Math.sin((r+1)/a*Math.PI*2),0!=q&&(g(C,[(r+0)/a,(q+0)/b]),i&&g(B,vec3.normalize([k*Math.sin(q/b*Math.PI)+f[0],m+f[1],o*Math.sin(q/b*Math.PI)+f[2]])),g(A,[k*Math.sin(q/b*Math.PI)+f[0],m+f[1],o*Math.sin(q/b*Math.PI)+f[2]])),g(C,[(r+0)/a,(q+1)/b]),i&&g(B,vec3.normalize([k*Math.sin((q+1)/b*Math.PI)+f[0],n+f[1],o*Math.sin((q+1)/b*Math.PI)+f[2]])),g(A,[k*Math.sin((q+1)/b*Math.PI)+f[0],n+f[1],o*Math.sin((q+1)/b*Math.PI)+f[2]]),q!=b-1&&(g(C,[(r+1)/a,(q+1)/b]),i&&g(B,vec3.normalize([l*Math.sin((q+1)/b*Math.PI)+f[0],n+f[1],p*Math.sin((q+1)/b*Math.PI)+f[2]])),g(A,[l*Math.sin((q+1)/b*Math.PI)+f[0],n+f[1],p*Math.sin((q+1)/b*Math.PI)+f[2]])),g(C,[(r+1)/a,(q+0)/b]),i&&g(B,vec3.normalize([l*Math.sin(q/b*Math.PI)+f[0],m+f[1],p*Math.sin(q/b*Math.PI)+f[2]])),g(A,[l*Math.sin(q/b*Math.PI)+f[0],m+f[1],p*Math.sin(q/b*Math.PI)+f[2]]),(0==q||q==b-1)&&g(A);return j(),h}function p(a,b,c,e,f,h,i,k){function l(a){return-1e-5>a?a-e/2:a>1e-5?a+e/2:(k-.5)*e}var m,n,o,p,q,r,s,t,u,v;for(void 0==k&&(k=.5),m=c,void 0==h&&(h=[0,0,0]),n=!1,void 0==i&&(i=new y,n=!0),d(i,4,f),u=0;b>u;u++)for(v=a-1;v>=0;v--)q=m*Math.cos(u/b*Math.PI),r=m*Math.cos((u+1)/b*Math.PI),o=c*Math.cos(v/a*Math.PI*2),p=c*Math.cos((v+1)/a*Math.PI*2),s=c*Math.sin(v/a*Math.PI*2),t=c*Math.sin((v+1)/a*Math.PI*2),g(C,[(v+1)/a,(u+0)/b]),g(B,vec3.normalize([p*Math.sin(u/b*Math.PI),t*Math.sin(u/b*Math.PI),q])),g(A,[p*Math.sin(u/b*Math.PI)+h[0],t*Math.sin(u/b*Math.PI)+h[2],l(q)+h[1]]),u!=b-1&&(g(C,[(v+1)/a,(u+1)/b]),g(B,vec3.normalize([p*Math.sin((u+1)/b*Math.PI),t*Math.sin((u+1)/b*Math.PI),r])),g(A,[p*Math.sin((u+1)/b*Math.PI)+h[0],t*Math.sin((u+1)/b*Math.PI)+h[2],l(r)+h[1]])),g(C,[(v+0)/a,(u+1)/b]),g(B,vec3.normalize([o*Math.sin((u+1)/b*Math.PI),s*Math.sin((u+1)/b*Math.PI),r])),g(A,[o*Math.sin((u+1)/b*Math.PI)+h[0],s*Math.sin((u+1)/b*Math.PI)+h[2],l(r)+h[1]]),0!=u&&(g(C,[(v+0)/a,(u+0)/b]),g(B,vec3.normalize([o*Math.sin(u/b*Math.PI),s*Math.sin(u/b*Math.PI),q])),g(A,[o*Math.sin(u/b*Math.PI)+h[0],s*Math.sin(u/b*Math.PI)+h[2],l(q)+h[1]])),(0==u||u==b-1)&&g(A);return j(),i}function q(a,b,c,e,f,h,i){var k,l,m,n,o,p,q,r,s,t,u=new y;for(d(u,4,f),g(B,[0,0,1]),q=0;b>q;q++)for(r=0;a>r;r++)m=e*(q-b/2)/b,n=e*(q+1-b/2)/b,k=c*Math.cos(r/a*Math.PI*2),l=c*Math.cos((r+1)/a*Math.PI*2),o=c*Math.sin(r/a*Math.PI*2),p=c*Math.sin((r+1)/a*Math.PI*2),g(C,[(r+1)/a,(q+1)/b]),g(A,[l,n,p]),g(C,[(r+0)/a,(q+1)/b]),g(A,[k,n,o]),g(C,[(r+0)/a,(q+0)/b]),g(A,[k,m,o]),g(C,[(r+1)/a,(q+0)/b]),g(A,[l,m,p]),h&&(0==q&&(g(C,[.5,.5]),g(A,[0,m,0]),g(C,[.5+l/(2*c),.5+p/(2*c)]),g(A,[l,m-1e-5,p]),g(C,[.5+k/(2*c),.5+o/(2*c)]),g(A,[k,m-1e-5,o]),g(A)),q==b-1&&(g(C,[.5,.5]),g(A,[0,n,0]),g(C,[.5+k/(2*c),.5+o/(2*c)]),g(A,[k,n-1e-5,o]),g(C,[.5+l/(2*c),.5+p/(2*c)]),g(A,[l,n-1e-5,p]),g(A)));if(j(),i)for(s=new Float32Array(u.attribs[0]),t=vec4.create(),q=0;q<s.length;q+=3)t[0]=s[q+0],t[1]=s[q+1],t[2]=s[q+2],t[3]=1,mat4.multiplyVec4(i,t),s[q+0]=t[0],s[q+1]=t[1],s[q+2]=t[2];return u.calculateSmoothNormals(),u}var r,s,t,u,v,w,x,y=a("./pim_object").pimObject,z=a("./pim_object").pimSurface,A=0,B=1,C=40,D=2e3;c.pimStream={pim_position:0,pim_normal:1,pim_tangent:2,pim_texcoord0:40,pim_texcoord1:41,pim_texcoord2:42,pim_weights:360,pim_index:370,pim_polygon:1e3,pim_line:1002,pim_triangle:1003,pim_tag_polygon:2e3,pim_tag_triangle:2003,begin:d,attrib:g,attrib2:i,attrib3:h,end:j,nGon:f,duplicateVertex:e,quad:m,cube:n,sphere:o,disc:q,capsule:p,Instance:k}},{"./pim_object":12}],20:[function(a,b,c){function d(a){function b(){a.apply(this,arguments),this.microNow=Math.floor(1e3*performance.now()),this.now=Math.floor(this.microNow/1e3),this.animTracks=[],this.ssTimes=[],this.lastSSTimes=[],this.changeCount=0,this.sounds={},this.lastDrawTS=this.now-16,this.lastEvalTs=this.now-16,this.drawDisabled=!1,this.pendingCommands=[],this.ptrTimes={},this.globalVolume=1,this.idCnt=0}function c(){this.items=[],this.lastRet=0,this.suspended=!1,this.curStamp=0,this.newStamp=0,this.seqNr=0}var d,f,g,h,j,k,l,m,n,o,p,q=!1;return b.__defineSetter__("oldSchool",function(a){return q=e.oldSchool=a,a}),b.__defineGetter__("oldSchool",function(){return q}),b.prototype=a.prototype,d=0,f=1,g=2,h=3,j=4,k=5,l=10,m=11,n=12,o=19,p=-1,b.prototype.primeTrack=function(a){var b,d;if(a>=this.animTracks.length)for(b=this.animTracks.length;a>=b;b++)d=new c,d.speed=1,d.now=0,d.microNow=0,d.localtime=!1,d.lastPlaySoundInst=0,d.lastManSoundInst=0,d.tracelevel=0,d.nr=b,this.animTracks[b]=d},b.prototype.addAnimItem=function(a,b,c,d,e,f,g,h,i){if(isNaN(a))return void 0;this.primeTrack(a);var j=this.animTracks[a];return j.tracelevel>0,j.addItem(j.now,b,c,d,e,f,g,h,i)},b.prototype.getSeqNr=function(a,b){return this.primeTrack(a),0>a||a>=this.animTracks.length?c.prototype.masterSeqNr:this.animTracks[a].getSeqNr(b)},b.prototype.playPause=function(a,b){return this.addAnimItem(a,0,b,1,0,0,0,d)},b.prototype.playWaitTrack=function(a,b){this.primeTrack(a),this.primeTrack(b),a!=b&&this.animTracks[a].addWait(this.now,this.animTracks[b])},b.prototype.playSSFast=function(a,b,d,e,g,h,i,j){return void 0!=g&&(isNaN(g)||0>=g)?void 0:void 0!=d&&isNaN(d)?void 0:void 0!=e&&isNaN(e)?void 0:isNaN(b)||b!=(0|b)?void 0:this.addAnimItem(a,d||0,void 0!=e?e:d||0,g||1,h||c.WRAP_PING,i||c.START_NORMAL,j||c.STOP_FINISHTILLWRAP,f,b)},b.prototype.playSS=function(a,b,c,d,e,f,g){return this.playSSFast(a,b,c,d,1,e,f,g)},b.prototype.playPtr=function(a,b,c,d,e,f,h,i){return 0>=e?void 0:this.addAnimItem(a,c,d,e,f,h,i,g,{ptrInst:b,ptrId:++this.idCnt})},b.prototype.playFunction=function(a,b,d){var e,f=d||{};return f.subFrame,e={funObj:b,funId:++this.idCnt,singleShot:!d||f.singleShot?1:0,cbInfo:void 0!=f.cbInfo?f.cbInfo?1:0:d?1:0,opt:f,fires:0,armed:1,startTime:0,start:void 0!=f.start?f.start:0,stop:void 0!=f.stop?f.stop:void 0!=f.period?f.period:0,speed:void 0!=f.speed?f.speed:1,wrap:void 0!=f.wrap?f.wrap:c.WRAP_PING,caller:f.caller||Error("trace")},this.addAnimItem(a,e.start,e.stop,e.speed,e.wrap,void 0!=f.startMode?f.startMode:0,void 0!=f.stopMode?f.stopMode:c.STOP_FINISHTILLWRAP,k,e)},b.prototype.playSetSpeed=function(a,b,d){return this.addAnimItem(a,0,0,1,0,0,c.STOP_FINISHTILLWRAP,h,{track:b,speed:d})},b.prototype.playWaitFrames=function(a,b){return this.addAnimItem(a,0,999999,1,0,0,c.STOP_FINISHTILLWRAP,j,{wfCount:b})},b.prototype.flushTrack=function(a,b){this.flushTrackUntil(a,b,c.prototype.masterSeqNr)},b.prototype.flushTrackUntil=function(a,d,e){this.primeTrack(a);for(var f in this.pendingCommands)this.pendingCommands[f].tracki==a&&e-this.pendingCommands[f].seqNr>=0&&(this.pendingCommands[f].state=c.PTR_ST_FLUSH,(d==b.FLUSH_KILL||this.pendingCommands[f].cmd==k)&&(this.pendingCommands[f].state=c.PTR_ST_KILL));return d==b.FLUSH_KILLFUNCTIONS?this.animTracks[a].flush(!0,e,function(a,b,d){return b==c.PTR_TP_NORM&&d==k?c.PTR_ST_KILL:c.PTR_ST_FLUSH}):this.animTracks[a].flush(!!d,e)},b.prototype.playFlushTrack=function(a,b,c){this.playFunction(a,this.flushTrackUntil.bind(this,b,c,this.getSeqNr(-1)))},b.prototype.playSoundStart=function(a,b,d){if(this.primeTrack(a),!this.sounds[b])return null;d=d||{};var e={snd:this.sounds[b],tracked:d.tracked||!1,loop:d.loop||!1,freqscale:d.speed||1,volumescale:void 0!=d.volume?d.volume:1,startoffset:d.offset||0};return this.addAnimItem(a,0,e.tracked?999999:0,1,0,0,d.stop||c.STOP_FINISHTILLWRAP,l,e)},b.prototype.playSound=b.prototype.playSoundStart,b.prototype.playSoundStop=function(a,b){return this.addAnimItem(a,0,0,1,0,0,c.STOP_FINISHTILLWRAP,m,b)},b.prototype.playSoundSlide=function(a,b,d,e,f,g){g=g||{};var h={tracked:g.tracked||!1,strack:b,attr:d,value:e,time:f,kill:g.kill||!1};return this.addAnimItem(a,0,h.tracked?999999:0,1,0,0,g.stop||c.STOP_FINISHTILLWRAP,n,h)},b.prototype.getLastSoundChannel=function(a){return result=this.nimTracks[a].lastPlaySoundInst,bass.ChannelIsActive(this.animTracks[a].lastPlaySoundInst)==BASS_ACTIVE_STOPPED&&(result=0),result},b.prototype.addSound=function(a,b,c,d){"function"==typeof b?(d=b,b=1,c=1):(b=b||1,c=c||1);var e=this.sounds[a];e?(e.defSpeed=c,e.defVol=b):(e=new pimSound(a,c,b,d),this.sounds[a]=e)},b.prototype.fastEvaluate=function(){var a,b,e,i,q,r,s,t,u,v,w,x,y,z,A,B=!1,C=Math.floor(1e3*performance.now()),D=C-this.lastEvalTs;if(1e6/150>D)return!1;for(1!=this.masterSpeed||this.now!=this.lastEvalTs?(this.microNow=Math.round(this.microNow+D*this.masterSpeed),this.now=Math.floor(this.microNow/1e3)):(this.now=Math.floor(C/1e3),this.microNow=C),this.lastEvalTs=C,a=0;a<this.animTracks.length;a++)b=this.animTracks[a],1!=b.speed||b.localtime?(b.localtime=!0,b.microNow=Math.round(b.microNow+D*this.masterSpeed*b.speed),b.now=Math.floor(b.microNow/1e3)):(b.microNow=this.microNow,b.now=this.now);e=0,i={cmdId:0,cmdPar:null,reCheck:!1,state:-1};do for(q=!1,a=0;a<this.animTracks.length;a++){b=this.animTracks[a];do{if(!b.items.length)break;if(r=b.items[0],e=b.getSeqNr(!0),s=b.evaluate(b.microNow/1e3,i),t=i.cmdId,u=i.cmdPar,v=i.state==c.PTR_ST_KILL,w=i.reCheck,r!==b.items[0]&&(q=!0),4294967295!=t&&(B=!0),4294967295==t||t==p||t==d);else if(t==f)isNaN(s)||isNaN(u)||u!=(0|u)||v||(this.ssTimes[u]=s);else if(t==g)v||(this.ptrTimes[u.ptrId]={ptr:u.ptrInst,time:s});else{if(this.changeCount++,x=b.items.length&&b.items[0].tpe==c.PTR_TP_NORM&&b.items[0].cmdId===t&&b.items[0].cmdPar===u,v&&x)throw"pimDirector.fasteval : killed but linked ??";switch(t){case l:if(!v)if(y=u,b.lastPlaySoundInst=y.snd.start(y.startoffset,0,y.freqscale,y.volumescale,y.loop),u.tracked)b.lastPlaySoundInst?x&&(b.lastManSoundInst=b.lastPlaySoundInst,b.items[0].cmdId=o):x&&(b.items[0].cmdId=p,b.items[0].state=c.PTR_ST_FLUSH,w=!0);else if(x)throw"pimDirector.fasteval : fire& forget still linked";break;case m:v||(z=this.animTracks[u],z.lastPlaySoundInst&&(z.lastPlaySoundInst.stop(),z.lastPlaySoundInst=null));break;case n:if(!v&&(z=this.animTracks[u.strack],z.lastPlaySoundInst&&z.lastPlaySoundInst.playing)){switch(b.lastManSoundInst=z.lastPlaySoundInst,u.attr){case"volume":z.lastPlaySoundInst.slideVolume(u.value*this.globalVolume,u.time,u.kill);
break;case"speed":z.lastPlaySoundInst.slideSpeed(u.value,u.time,u.kill)}if(u.tracked){if(!x)throw"e3d fasteval managed not linked ??";b.items[0].cmdId=o}else if(x)throw"e3d fasteval unmanaged slide still linked ??"}break;case o:v?b.lastManSoundInst&&(b.lastManSoundInst=null):x&&b.lastManSoundInst&&!b.lastManSoundInst.playing&&(b.lastManSoundInst=null,b.items[0].state=c.PTR_ST_FLUSH,w=!0);break;case k:if(v)break;if(!u.armed)break;u.armed=0,A=b.microNow/1e3,u.startTime||(u.startTime=x?b.items[0].startTime:A),this.pendingCommands.push({cmdId:t,cmdPar:u,track:b,seqNr:e,time:s,trackTime:A,killed:!1,done:!x});break;case h:v||(this.animTracks[u.track].speed=u.speed);break;case j:v||x&&(u.wfStart?this.lastDrawTS!=u.wfStart&&(1==u.wfCount?(b.items[0].state=c.PTR_ST_FLUSH,w=!0):(u.wfCount--,u.wfStart=this.lastDrawTS)):u.wfStart=this.lastDrawTS);break;default:throw"Unknown pimDirector cmdId="+t}}}while(w)}while(q);return B},b.prototype.evaluate=function(){var a,b,d,e,f,g,h,i,j,l=!1;this.fastEvaluate(),this.drawDisabled||this.evaluateSplines();for(a in this.ptrTimes)delete ptrTimes[a];for(a in this.pendingCommands)switch(b=this.pendingCommands[a],b.cmdId){case k:if(b.state==c.PTR_ST_KILL)break;if(b.cmdPar.singleShot){0==b.cmdPar.fires&&(b.cmdPar.cbInfo?b.cmdPar.funObj({flushed:b.state!=c.PTR_ST_NORm}):b.cmdPar.funObj(),b.cmdPar.fires++);break}if(d=b.done||0==b.cmdPar.fires,e=b.cmdPar.stop-b.cmdPar.start,f=b.cmdPar.opt.interval||e,g=b.trackTime-b.cmdPar.startTime,b.cmdPar.opt.subFrame)for(b.done&&(g=1e3*Math.floor(g/(1e3*e))*e);d||f>0&&g>=b.cmdPar.fires*f*1e3;){if(h={time:b.time,iTime:b.cmdPar.fires*f,opt:b.cmdPar.opt,first:!b.cmdPar.fires,last:!!b.done&&g<(b.cmdPar.fires+1)*f*1e3},b.cmdPar.fires++,i=b.cmdPar.funObj(h),i===!1){b.done||b.track.flush(!0,b.seqNr);break}d=!1}else if((d||0==b.cmdPar.opt.interval||f>0&&g*b.cmdPar.speed>=b.cmdPar.fires*f*1e3)&&(j=Math.floor(g*b.cmdPar.speed/(1e3*f)),h={time:b.time,iTime:Math.round(1e3*b.time/(1e3*f))*f,startTS:b.cmdPar.startTime,trackTS:b.trackTime,opt:b.cmdPar.opt,first:!b.cmdPar.fires,last:!!b.done},b.cmdPar.fires=j+1,i=b.cmdPar.funObj(h),i===!1)){b.done||b.track.flush(!0,b.seqNr);break}b.done||(b.cmdPar.armed=1);break;default:throw"Unknown pimDirector cmdId="+rv.cmdId}return this.pendingCommands.length=0,this.lastDrawTS=Date.now(),l},b.prototype._evaluateSplines=function(){var a,b,c,d;for(i in this.splines)if(a=this.splines[i],b=a.ss,c=this.ssTimes[b],void 0!=c&&c!==this.lastSSTimes[b])if(a.target&&a.target.follow)switch(a.targetvar){case"x":d=a.target.follow._x.evaluate(c-a.target.timeslip),a.target.x!=d&&(a.target.changed=1,a.target.x=d);break;case"y":d=a.target.follow._y.evaluate(c-a.target.timeslip),a.target.y!=d&&(a.target.changed=1,a.target.y=d);break;case"z":d=a.target.follow._z.evaluate(c-a.target.timeslip),a.target.z!=d&&(a.target.changed=1,a.target.z=d);break;case"h":d=a.target.follow._h.evaluate(c-a.target.timeslip),a.target.h!=d&&(a.target.changed=1,a.target.h=d);break;case"p":d=a.target.follow._p.evaluate(c-a.target.timeslip),a.target.p!=d&&(a.target.changed=1,a.target.p=d);break;case"b":d=a.target.follow._b.evaluate(c-a.target.timeslip),a.target.b!=d&&(a.target.changed=1,a.target.b=d);break;case"xs":d=a.target.follow._xs.evaluate(c-a.target.timeslip),a.target.xs!=d&&(a.target.changed=1,a.target.xs=d);break;case"ys":d=a.target.follow._ys.evaluate(c-a.target.timeslip),a.target.ys!=d&&(a.target.changed=1,a.target.ys=d);break;case"zs":d=a.target.follow._zs.evaluate(c-a.target.timeslip),a.target.zs!=d&&(a.target.changed=1,a.target.zs=d);break;default:d=a.evaluate(c),!a.target||""!=a.targetvar&&a.target[a.targetvar]==d||(a.format?a.target[a.targetvar]=a.format instanceof Function?a.format(d,c):a.int?Math.round(d):d+a.format:(void 0==a.ctarget&&(a.ctarget=a.target),a.ctarget.changed=1,a.targetvar&&(a.target[a.targetvar]=d)))}else if(d=a.evaluate(c),a.nrKeys)switch(a.targetvar){case"x":a.target.x!=d&&(a.target.changed=1,a.target.x=d);break;case"y":a.target.y!=d&&(a.target.changed=1,a.target.y=d);break;case"z":a.target.z!=d&&(a.target.changed=1,a.target.z=d);break;case"h":a.target.h!=d&&(a.target.changed=1,a.target.h=d);break;case"p":a.target.p!=d&&(a.target.changed=1,a.target.p=d);break;case"b":a.target.b!=d&&(a.target.changed=1,a.target.b=d);break;case"xs":a.target.xs!=d&&(a.target.changed=1,a.target.xs=d);break;case"ys":a.target.ys!=d&&(a.target.changed=1,a.target.ys=d);break;case"zs":a.target.zs!=d&&(a.target.changed=1,a.target.zs=d);break;default:!a.target||""!=a.targetvar&&a.target[a.targetvar]==d||(a.format?a.target[a.targetvar]=a.format instanceof Function?a.format(d,c):a.int?Math.round(d):d+a.format:(void 0==a.ctarget&&(a.ctarget=a.target),a.ctarget.changed=1,a.targetvar&&(a.target[a.targetvar]=d)))}for(i in this.ssTimes)this.lastSSTimes[i]=this.ssTimes[i];for(i in this.scene.objects)this.scene.objects[i].inst.mousetracked&&pimRay.mousetrack(this.mousex,this.mousey,this.canvas,this.scene,this.scene.objects[i].inst,null,[0,1,0,0])},c.WRAP_PING=0,c.WRAP_PINGPING=1,c.WRAP_PINGPONG=2,c.WRAP_PONGPONG=3,c.WRAP_PONG=4,c.START_NORMAL=0,c.START_DISCARD=1,c.START_PICKUP=2,c.STOP_FINISHTILLWRAP=0,c.STOP_EVALUATEWRAP=1,c.STOP_INTERRUPT=2,c.PTR_ST_NORM=0,c.PTR_ST_KILL=1,c.PTR_ST_FLUSH=2,c.PTR_TP_NORM=0,c.PTR_TP_WAIT=1,c.prototype.TrackItem=function(){this.addTime=0,this.startTime=0,this.from=0,this.too=0,this.wrapping=c.WRAP_PING,this.stop=c.STOP_FINISHTILLWRAP,this.state=c.PTR_ST_NORM,this.tpe=c.PTR_TP_NORM,this.speed=1,this.cmdId=0,this.cmdPar=null,this.seqNr=0,this.refTrack=null,this.refStamp=0},c.prototype.itemPool=[],c.prototype.masterSeqNr=0,c.prototype.trackItemAlloc=function(){var a,b;if(0==this.itemPool.length)for(a=0;20>a;a++)this.itemPool.push(new this.TrackItem);return b=this.itemPool.shift(),c.prototype.masterSeqNr++,this.seqNr=this.masterSeqNr,b.seqNr=this.masterSeqNr,b},c.prototype.trackItemFree=function(a){this.itemPool.push(a)},c.prototype.trackItemPop=function(){if(this.items.length){var a=this.items.shift();this.trackItemFree(a),this.curStamp++}},c.prototype.curItemFinished=function(a){var b,d,e,f,g,h,i,j=this.items[0];return j.state!=c.PTR_ST_NORM?!0:j.tpe==c.PTR_TP_WAIT?refTrack.curStamp>=refStamp:(b=this.items[1]||null,d=b,b&&b.tpe==c.PTR_TP_WAIT&&(b.refTrack.curStamp<b.refStamp?d=null:b.addTime<j.startTime&&(b.addTime=a)),j.stop!=c.STOP_FINISHTILLWRAP&&d?!0:(e=(j.too-j.from)/j.speed,f=(a-j.startTime)/1e3,j.wrapping==c.WRAP_PING||j.wrapping==c.WRAP_PONG?f>=e:d?(j.wrapping==c.WRAP_PINGPONG&&(e=2*e),g=f/e,h=(b.addTime-j.startTime)/1e3,i=Math.max(1,Math.ceil(h/e)),g>=i):!1))},c.prototype.finalizeAndStartNext=function(a){var b,d=this.items[0],e=d.state==c.PTR_ST_NORM,f=d;if(this.trackItemPop(),0==this.items.length)return!1;if(d=this.items[0],e=e&&d.state==c.PTR_ST_NORM,d.startTime=a,!e||f.tpe==c.PTR_TP_WAIT||f.stop!=c.STOP_FINISHTILLWRAP)return!0;switch(b=(f.too-f.from)/f.speed,f.wrapping==c.WRAP_PINGPONG&&(b=2*b),f.wrapping){case c.WRAP_PING:case c.WRAP_PONG:d.startTime=Math.round(1e3*b)+f.startTime;break;case c.WRAP_PINGPING:case c.WRAP_PONGPONG:case c.WRAP_PINGPONG:d.startTime=d.addTime<f.startTime?f.startTime+Math.round(1e3*b):f.startTime+Math.ceil((d.addTime-f.startTime)/1e3/b)*Math.round(1e3*b)}return d.startTime=Math.min(d.startTime,a),!0},c.prototype.getSeqNr=function(a){return a?this.items[0]?this.items[0].seqNr:0:this.seqNr},c.prototype.evaluate=function(a,b){function d(a,b,d){switch(d){case c.WRAP_PING:return Math.min(a,b);case c.WRAP_PINGPING:return a%b;case c.WRAP_PINGPONG:return i=a%(2*b),i>b&&(i=2*b-i),i;case c.WRAP_PONGPONG:return Math.max(b-a%b,0);case c.WRAP_PONG:return Math.max(b-a,0)}return a}var e,f,g,h=a,i=this.lastRet;if(b.cmdId=4294967295,b.cmdPar=null,b.reCheck=!1,b.state=-1,b.wrapped=!1,!this.items.length)return i;if(e=this.items[0],b.state=e.state,e.tpe==c.PTR_TP_WAIT)return e.state==c.PTR_ST_NORM&&e.refTrack.curStamp<e.refStamp?i:(b.reCheck=this.finalizeAndStartNext(h),i);if(0==e.startTime){if(b.state!=c.PTR_ST_KILL&&this.suspended)return i;e.startTime=h}return f=(h-e.startTime)*e.speed/1e3,g=e.too-e.from,b.cmdId=e.cmdId,b.cmdPar=e.cmdPar,e.state!=c.PTR_ST_NORM?(this.lastRet=e.wrapping==c.WRAP_PING||e.wrapping==c.WRAP_PINGPING?e.too:e.from,i=this.lastRet):(this.lastRet=d(f,g,e.wrapping)+e.from,i=this.lastRet),b.state!=c.PTR_ST_KILL&&this.suspended?i:this.curItemFinished(h)?(e.stop!=c.STOP_INTERRUPT&&(this.lastRet=e.wrapping==c.WRAP_PING||e.wrapping==c.WRAP_PINGPING?e.too:e.from),b.reCheck=this.finalizeAndStartNext(h),i=this.lastRet):i},c.prototype.addItem=function(a,b,d,e,f,g,h,i,j){var k,l;return b!=d||f!=c.WRAP_PINGPING&&f!=c.WRAP_PINGPONG&&f!=c.WRAP_PONGPONG||(f=c.WRAP_PING),g==c.START_DISCARD&&this.items.length?null:(k=this.trackItemAlloc(),this.newStamp++,k.addTime=a,k.startTime=0,k.from=b,k.too=d,k.wrapping=f,k.stop=h,k.state=c.PTR_ST_NORM,k.tpe=c.PTR_TP_NORM,k.speed=e,k.cmdId=i,k.cmdPar=j,this.items.length&&(l=this.items[this.items.length-1],g!=c.START_PICKUP||l.stop!=c.STOP_INTERRUPT&&l.stop!=c.STOP_EVALUATEWRAP||!(l.startTime>0)||l.cmdId!=i||l.cmdPar!==j||f!=c.WRAP_PING&&f!=c.WRAP_PONG||(f==c.WRAP_PING&&b>=l.from&&b<=l.too&&(k.from=this.lastRet),f==c.WRAP_PONG&&d>=l.from&&d<=l.too&&(k.too=this.lastRet))),this.items.push(k),k)},c.prototype.addWait=function(a,b){var d=this.trackItemAlloc();return this.newStamp++,d.addTime=a,d.startTime=0,d.from=0,d.too=0,d.wrapping=c.WRAP_PING,d.stop=c.STOP_INTERRUPT,d.state=c.PTR_ST_NORM,d.tpe=c.PTR_TP_WAIT,d.refTrack=b,d.refStamp=b.newStamp,this.items.push(d),d},c.prototype.flush=function(a,b,d){var e=0;return this.items.some(function(f){return f.seqNr>b?!0:(f.state=d?d(f.state,f.tpe,f.cmdId,f):a?c.PTR_ST_KILL:c.PTR_ST_FLUSH,void e++)}),e},c.prototype.suspend=function(a){this.suspended=a,a&&this.items.forEach(function(a){a.startTime=0})},b.WRAP_PING=c.WRAP_PING,b.WRAP_PINGPING=c.WRAP_PINGPING,b.WRAP_PINGPONG=c.WRAP_PINGPONG,b.WRAP_PONGPONG=c.WRAP_PONGPONG,b.WRAP_PONG=c.WRAP_PONG,b.START_QUEUE=c.START_NORMAL,b.START_DISCARD=c.START_DISCARD,b.START_PICKUP=c.START_PICKUP,b.STOP_FINISH=c.STOP_FINISHTILLWRAP,b.STOP_EVAL=c.STOP_EVALUATEWRAP,b.STOP_INT=c.STOP_INTERRUPT,b.FLUSH_FFWD=0,b.FLUSH_KILL=1,b.FLUSH_KILLFUNCTIONS=2,b}if("undefined"==typeof performance&&(performance=Date),"undefined"!=typeof pimDirector)var e=pimDirector;c.extendTracker=d},{}],21:[function(a,b,c){function d(a,b,c,d){var e,f,g,h,i;return m.fileCache[a]?void setTimeout(c.bind(this,m.fileCache[a]),0):"undefined"!=typeof File&&a instanceof File?(e=new FileReader,e.onerror=d,e.onload=function(){c(e.result)},void e.readAsArrayBuffer(a)):(a=a.replace(/[\n\t\r]/g,"").replace(/^ +/,""),a=m.fileMap[a]||a,f=0,g=new XMLHttpRequest,g.open("GET",m.searchPaths[f]+a,!0),g.responseType="arraybuffer",b&&(g.onprogress=b),h=function(){return 404==this.status||0==this.status&&!this.response?void this.onerror():(f&&(m.fileMap[a]=m.searchPaths[f]+a,localStorage&&(localStorage.fileMap=JSON.stringify(m.fileMap))),void(c&&c(this.response)))},g.onload=h,i=function(){return"file:"==window.document.location.protocol&&(f++,f<m.searchPaths.length)?(g=new XMLHttpRequest,g.responseType="arraybuffer",g.onload=h,g.onerror=i,g.open("GET",m.searchPaths[f]+a,!0),void g.send(null)):void(d?d():c&&c(!1))},g.onerror=i,void g.send(null))}function e(a,b,c,d,e){var f,g,h,i;{if(!m.fileCache[a])return a=a.replace(/[\n\t\r]/g,"").replace(/^ +/,""),a=m.fileMap[a]||a,f=0,g=new XMLHttpRequest,g.open("GET",m.searchPaths[f]+a,!e),b&&(g.onprogress=b),h=function(){return 404==this.status||0==this.status&&!this.response?void this.onerror():(f&&(m.fileMap[a]=m.searchPaths[f]+a,localStorage&&(localStorage.fileMap=JSON.stringify(m.fileMap))),void(c&&c(this.response)))},i=function(){return"file:"==window.document.location.protocol&&(f++,f<m.searchPaths.length)?(e||(g=new XMLHttpRequest,g.onload=h,g.onerror=i),g.open("GET",m.searchPaths[f]+a,!e),void g.send(null)):void(d?d():c&&c(!1))},g.onload=h,g.onerror=i,g.send(null),e?g.response:void 0;if(c&&setTimeout(c.bind(this,m.fileCache[a]),0),e)return m.fileCache[a]}}function f(a,b,c,d){return e(a,b,c,d,!0)}function g(a,b,c,d){var e,f;return a||(d?d():setTimeout(c,0)),a=a.replace(/^[ \s\t]+/,"").replace(/^ +/,""),a=a.replace(/^lwspoof_/,""),a=a.replace(/\.tga$/i,".png"),a=a.replace(/\.avi$/i,".jpg"),a=a.replace(/\.flv$/i,".png"),a=m.fileMap[a]||a,m.imageCache[a]?(e=m.imageCache[a],0==e.naturalWidth?(e.pendingComplete||(e.pendingComplete=[]),c&&e.pendingComplete.push(c)):c&&setTimeout(function(){c.call(e,null,e)},0),e):(e=new Image,f=0,e.crossOrigin="",e.src=m.searchPaths[f]+a,e.onload=function(b){f&&(m.fileMap[a]=m.searchPaths[f]+a,localStorage&&(localStorage.fileMap=JSON.stringify(m.fileMap)));for(var d in e.pendingComplete)e.pendingComplete[d].call(e,b,e);c&&c.call(e,b,e)},e.onerror=function(){return"file:"==window.document.location.protocol&&(f++,f<m.searchPaths.length)?void(e.src=m.searchPaths[f]+a):(b&&b({loaded:.1*e.width*e.height,total:.1*e.width*e.height}),void(d?d():c&&c()))},m.imageCache[a]=e,e)}function h(a,b,c,d,e){function f(a){e&&(h.onclick=function(){h.play()},h.click()),h.ready=!0,h.removeEventListener("canplaythrough",f,!0);for(var b in h.pendingComplete)h.pendingComplete[b].call(h,a,h);c&&c.call(h,a,h)}function g(){return"file:"==window.document.location.protocol&&(i++,i<m.searchPaths.length)?void(h.src=m.searchPaths[i]+a):(d?d():c&&c(),void h.removeEventListener("error",g,!0))}var h,i;return a||(d?d():c()),a=a.replace(/^[ \s\t]+/,""),a=a.replace(/\.avi$/i,".mp4"),a=a.replace(/^lwspoof_/,""),a=a.replace(/\.flv$/i,".mp4"),a=m.fileMap[a]||a,m.videoCache[a]?(h=m.videoCache[a],h.ready?(e&&(h.onclick=function(){h.play()},h.click()),c&&setTimeout(function(){c.call(h,null,h)},0)):(h.pendingComplete||(h.pendingComplete=[]),c&&h.pendingComplete.push(c)),h):(h=document.createElement("video"),document.body.appendChild(h),i=0,h.style.display="none",h.preload="auto",h.loop=1,h.muted=1,h.addEventListener("canplaythrough",f,!0),h.addEventListener("error",g,!0),h.src=m.searchPaths[i]+a,m.videoCache[a]=h,h)}function i(a){this.reset(a)}function j(){this.count=0,this.args=[],this.ref=[Error()],void 0==window.completers?window.completers=[this]:window.completers.push(this)}function k(a){var b,c,d,e,f,g,h,i="";if(a){b=["MAX_VERTEX_TEXTURE_IMAGE_UNITS","COMPRESSED_TEXTURE_FORMATS","DEPTH_BITS","MAX_CUBE_MAP_TEXTURE_SIZE","MAX_FRAGMENT_UNIFORM_VECTORS","MAX_RENDERBUFFER_SIZE","MAX_TEXTURE_IMAGE_UNITS","MAX_TEXTURE_SIZE","MAX_VARYING_VECTORS","MAX_VERTEX_ATTRIBS","MAX_VERTEX_TEXTURE_IMAGE_UNITS","MAX_VERTEX_UNIFORM_VECTORS","MAX_VIEWPORT_DIMS","RENDERER","SHADING_LANGUAGE_VERSION","SUBPIXEL_BITS","VENDOR","VERSION"];for(c in b)i+="* "+b[c]+": "+a.getParameter(a[b[c]])+"<BR>";d=["OES_texture_float","OES_texture_half_float","OES_standard_derivatives","WEBGL_debug_renderer_info","WEBGL_debug_shaders","EXT_texture_filter_anisotropic","WEBGL_lose_context","OES_vertex_array_object","WEBGL_compressed_texture_s3tc","WEBGL_depth_texture","OES_element_index_uint","WEBGL_compressed_texture_atc","WEBGL_compressed_texture_pvrtc","ANGLE_instanced_arrays","WEBGL_dynamic_texture","WEBGL_fbo_color_attachments","WEBGL_shared_resources"];for(e in d);i+="* "+d[e]+" : "+(null!=a.getExtension(d[e]))+"<BR>"}return f=navigator.userAgent.match(/(Firefox|MSIE |Chrome|Opera|Safari)[\/\s](\d+\.\d+)/),g=f[1],h=f[2],i}var l,m;i.prototype.onprogress=function(){},i.count=0,i.prototype.link=function(){var a=i.count++;return function(b){var c,d=0;for(c in this.map)this.map[c].src==a&&(d=1,this.map[c].received=b.loaded,this.update());d||(this.map.push({src:a,total:b.total,received:b.loaded}),this.update())}.bind(this)},i.prototype.reset=function(a){this.map=[],this.total=0,this.received=0,this.guess=void 0==a?0:a},i.prototype.update=function(){var a,b=0,c=0;for(a in this.map)b+=Math.max(this.map[a].total,this.map[a].received),c+=this.map[a].received;b>this.guess,this.onprogress&&this.onprogress(1==this.map.length&&0==this.guess?c/2:c,Math.max(this.guess,b))},j.prototype.unlink=function(a){var b,c,d=Array.prototype.slice.call(arguments,1);this.args[a]=1==d.length?d[0]:d,--this.count||this.cb&&(b=this.cb,c=this.args,delete this.cb,this.args=[],b.apply(this,c))},j.prototype.link=function(a){var b=this.count;return a!==!1&&this.count++,this.unlink.bind(this,b)},j.prototype.wait=function(a){return 0==this.count?(delete this.cb,void a()):void(this.cb=a)},l={fastBones:!1,invtransNormals:!0,gpuBones:!0,maxRenderLevel:0,defines:"",noOvers:!1,forceDynamic:{ALL:!1,PIM_COLOR:!1,PIM_DIFFUSE:!1,PIM_LUMINOSITY:!1,PIM_SPECULAR:!1,PIM_GLOSSINESS:!1,PIM_REFLECTION:!1,PIM_TRANSPARENCY:!1,PIM_TRANSLUCENCY:!1,LIGHTx_POSITION:!1,LIGHTx_INTENSITY:!1,LIGHTx_FALLOFF:!1,LIGHTx_RANGE:!1,LIGHTx_CONE:!1,LIGHTx_COLOR:!1}},m={fileAsArray:d,fileAsText:e,fileAsTextSync:f,loadImage:g,loadVideo:h,countingCompleter:j,pimProgress:i,pimOptions:l,pimCheck:k,mobile:function(){var a=!1;return function(b){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(b)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(b.substr(0,4)))&&(a=!0)}(navigator.userAgent||navigator.vendor||window.opera),a}(),searchPaths:[""],fileMap:"undefined"!=typeof localStorage&&localStorage.fileMap&&JSON.parse(localStorage.fileMap)||{},imageCache:{},videoCache:{},fileCache:{}},c.pimUtils=m},{}],22:[function(a,b,c){c.uberFragment_pimShader='// Incoming position.\n  varying vec4 worldPosition;\n  varying vec4 eyePosition;\n  uniform vec3 camPosition; // position of cam in worldspace.\n\n// hsb tweak support\n  #ifdef PIM_HSB\n  uniform mat4 pim_hsb;\n  #endif\n\n// Incoming normal\n  varying vec3 worldNormal;\n  varying vec3 eyeNormal;\n  vec3 wNormal;\n\n// extra options\n  #ifdef PIM_PARALLAX\n    #ifndef PIM_PARALLAX_SCALE\n      #define PIM_PARALLAX_SCALE 0.02\n    #endif\n  #endif\n\n// Incoming texture coordinates.\n  #ifdef PIM_TEXCOORD0\n    varying vec2 texcoord0;\n    vec2 texcoord0v;\n  #endif\n  #ifdef PIM_TEXCOORD1\n    varying vec2 texcoord1;\n  #endif\n  #ifdef PIM_TEXCOORD2\n    varying vec2 texcoord2;\n  #endif\n  #ifdef PIM_TEXCOORD3\n    varying vec2 texcoord3;\n  #endif\n\n// weightshade\n  #ifdef PIM_WEIGHTSHADE\n    varying vec3 weight_color;\n  #endif\n\n// Incoming textures.\n  #ifdef PIM_TEXTURE_COLOR_0\n    uniform sampler2D pim_texture0;\n    #ifdef PIM_TEXTURE_COLOR_0_UVANIM\n      uniform vec2 pim_texture0_uvanim;\n    #endif\n  #endif\n  #ifdef PIM_TEXTURE_COLOR_1\n    uniform sampler2D pim_texture1;\n  #endif\n  #ifdef PIM_TEXTURE_COLOR_2\n    uniform sampler2D pim_texture2;\n  #endif\n  #ifdef PIM_TEXTURE_DIFFUSE_0\n    uniform sampler2D pim_diffuse0;\n  #endif\n  #ifdef PIM_TEXTURE_NORMAL_0\n    varying vec4 worldTangent;\n    uniform sampler2D pim_normal0;\n  #endif\n  #ifdef PIM_TEXTURE_LUMINOSITY_0\n    uniform sampler2D pim_luminosity0;\n  #endif\n  #ifdef PIM_TEXTURE_SPECULAR_0\n    uniform sampler2D pim_specular0;\n  #endif\n  #ifdef PIM_TEXTURE_TRANSPARENCY_0\n    uniform sampler2D pim_transparency0;\n  #endif\n  #ifdef PIM_TEXTURE_TRANSPARENCY_1\n    uniform sampler2D pim_transparency1;\n  #endif\n  #ifdef PIM_TEXTURE_REFLECTION_0\n    uniform sampler2D pim_reflection0;\n  #endif\n  #ifdef PIM_TEXTURE_REFLECTIONMAP\n    uniform sampler2D pim_reflectionmap;\n  #endif\n  #ifdef PIM_TEXTURE_REFLECTIONMAP2\n    uniform sampler2D pim_reflectionmap2;\n  #endif\n  #if defined(PIM_SKYBOX) || defined(PIM_SKYBOX_MIN)\n    uniform float pim_ibl_strength;\n    uniform float pim_ibl_aofi;\n    uniform float pim_ibl_refl;\n    uniform float pim_ibl_refract;\n  #endif\n\n// Dynamic surface props\n  #ifndef PIM_DIFFUSE\n    uniform float PIM_DIFFUSE;\n  #endif\n  #ifndef PIM_LUMINOSITY\n    uniform float PIM_LUMINOSITY;\n  #endif\n  #ifndef PIM_TRANSPARENCY\n    uniform float PIM_TRANSPARENCY;\n  #endif\n  #ifndef PIM_REFLECTION\n    uniform float PIM_REFLECTION;\n  #endif\n  #ifndef PIM_COLOR\n    uniform vec3 PIM_COLOR;\n  #endif\n\n// Dynamic light props\n  #if (NUM_LIGHTS > 0) \n    #ifdef PIM_TEXTURE_NORMAL_0\n      varying vec3 vLIGHT0_POSITION;\n      varying vec3 vLIGHT0_DIRECTION;\n      vec3 LIGHT0_POSITION;\n      vec3 LIGHT0_DIRECTION;\n      varying vec3 vvertexToEye;\n      vec3   vertexToEye;\n    #else\n      vec3 vertexToEye;\n      #ifndef LIGHT0_POSITION\n        uniform vec3 LIGHT0_POSITION;\n      #endif\n      #ifndef LIGHT0_DIRECTION\n        uniform vec3 LIGHT0_DIRECTION;\n      #endif\n    #endif\n    #ifndef LIGHT0_INTENSITY\n      uniform float LIGHT0_INTENSITY;\n    #endif\n    #ifndef LIGHT0_RANGE\n      uniform float LIGHT0_RANGE;\n    #endif\n    #ifndef LIGHT0_COLOR\n      uniform vec3 LIGHT0_COLOR;\n    #endif\n    #ifdef LIGHT0_SHADOW\n      uniform mat4 LIGHT_LVM0;\n      uniform mat4 LIGHT_LVP0;\n      uniform sampler2D LIGHT_SMAP0;\n    #endif\n  #endif\n  #if (NUM_LIGHTS > 1) \n    #ifdef PIM_TEXTURE_NORMAL_0\n      varying vec3 vLIGHT1_POSITION;\n      varying vec3 vLIGHT1_DIRECTION;\n      vec3 LIGHT1_POSITION;\n      vec3 LIGHT1_DIRECTION;\n    #else\n      #ifndef LIGHT1_POSITION\n        uniform vec3 LIGHT1_POSITION;\n      #endif\n      #ifndef LIGHT1_DIRECTION\n        uniform vec3 LIGHT1_DIRECTION;\n      #endif\n    #endif\n    #ifndef LIGHT1_INTENSITY\n      uniform float LIGHT1_INTENSITY;\n    #endif\n    #ifndef LIGHT1_RANGE\n      uniform float LIGHT1_RANGE;\n    #endif\n    #ifndef LIGHT1_COLOR\n      uniform vec3 LIGHT1_COLOR;\n    #endif\n    #ifdef LIGHT1_SHADOW\n      uniform mat4 LIGHT_LVM1;\n      uniform mat4 LIGHT_LVP1;\n      uniform sampler2D LIGHT_SMAP1;\n    #endif\n  #endif\n  #if (NUM_LIGHTS > 2) \n    #ifndef LIGHT2_POSITION\n      uniform vec3 LIGHT2_POSITION;\n    #endif\n    #ifndef LIGHT2_DIRECTION\n      uniform vec3 LIGHT2_DIRECTION;\n    #endif\n    #ifndef LIGHT2_INTENSITY\n      uniform float LIGHT2_INTENSITY;\n    #endif\n    #ifndef LIGHT2_RANGE\n      uniform float LIGHT2_RANGE;\n    #endif\n    #ifndef LIGHT2_COLOR\n      uniform vec3 LIGHT2_COLOR;\n    #endif\n    #ifdef LIGHT2_SHADOW\n      uniform mat4 LIGHT_LVM2;\n      uniform mat4 LIGHT_LVP2;\n      uniform sampler2D LIGHT_SMAP2;\n    #endif\n  #endif\n  #if (NUM_LIGHTS > 3) \n    #ifndef LIGHT3_POSITION\n      uniform vec3 LIGHT3_POSITION;\n    #endif\n    #ifndef LIGHT3_DIRECTION\n      uniform vec3 LIGHT3_DIRECTION;\n    #endif\n    #ifndef LIGHT3_INTENSITY\n      uniform float LIGHT3_INTENSITY;\n    #endif\n    #ifndef LIGHT3_RANGE\n      uniform float LIGHT3_RANGE;\n    #endif\n    #ifndef LIGHT3_COLOR\n      uniform vec3 LIGHT3_COLOR;\n    #endif\n    #ifdef LIGHT3_SHADOW\n      uniform mat4 LIGHT_LVM3;\n      uniform mat4 LIGHT_LVP3;\n      uniform sampler2D LIGHT_SMAP3;\n    #endif\n  #endif\n\n// Helpers\nfloat unpack (vec4 colour) { const vec4 bitShifts = vec4(1.0, 1.0 / 255.0, 1.0 / (255.0 * 255.0), 1.0 / (255.0 * 255.0 * 255.0)); return dot(colour, bitShifts); }\nfloat rand (vec2 co) { return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453); }  \n// temps.\n  vec3 normal;\n  vec3 texture;\n  float diffuse;\n  float luminosity;\n  vec3 specular;\n  vec2 uvanim0=vec2(0.0,0.0);\n  float transparency;\n\nvoid main() {\n#ifndef PIM_WEIGHTSHADE\n   #ifdef PIM_TEXTURE_COLOR_0_UVANIM\n     uvanim0=pim_texture0_uvanim;\n   #endif\n \n  // Specular requires vertex to eye - same for all lights.\n  #if (defined(PIM_SPECULAR) || defined(PIM_TEXTURE_SPECULAR_0))\n    #ifdef PIM_TEXTURE_NORMAL_0\n      vertexToEye = vvertexToEye;\n      vertexToEye = normalize( vertexToEye );\n    #else \n      vertexToEye = normalize( camPosition - worldPosition.xyz ); \n    #endif\n  #endif\n\n  // Sample normalmap.\n  #ifdef PIM_TEXCOORD0\n    texcoord0v = texcoord0; // writable version.\n  #endif\n  #ifdef PIM_TEXTURE_NORMAL_0\n    #ifdef PIM_PARALLAX\n      #if (PIM_PARALLAX==0)\n        float height=-texture2D(pim_normal0, texcoord0v).a*0.012-0.006;\n        texcoord0v.x -= vertexToEye.x*height; \n        texcoord0v.y += vertexToEye.y*height;  \n      #else\n        float step = 1.0/float(PIM_PARALLAX);\n        vec2 dt = vertexToEye.xy * PIM_PARALLAX_SCALE / (float(PIM_PARALLAX) * (0.000001+vertexToEye.z));\n        float height = 1.0;\n        vec2 t = texcoord0v.xy;\n        dt.x=-dt.x;\n        float nba = texture2D(pim_normal0, t).a;\n        for (int i=0; i<PIM_PARALLAX; i++) {\n          if (nba < height) {\n            height -= step;\n            t += dt;\n            nba = texture2D(pim_normal0, t).a;\n          }\n        }\n        texcoord0v = t;\n      #endif\n    #endif\n    vec3 tgnorm;\n    #if PIM_TEXTURE_NORMAL_0 == 0\n      tgnorm = texture2D(pim_normal0, texcoord0v).rgb;\n    #elif PIM_TEXTURE_NORMAL_0 == 1\n      tgnorm = texture2D(pim_normal0, texcoord1).rgb;\n    #elif PIM_TEXTURE_NORMAL_0 == 2\n      tgnorm = texture2D(pim_normal0, texcoord2).rgb;\n    #elif PIM_TEXTURE_NORMAL_0 == 3\n      tgnorm = texture2D(pim_normal0, texcoord3).rgb;\n    #endif\n    wNormal=normalize(2.0*tgnorm-1.0);\n  #else\n    wNormal=worldNormal;\n  #endif\n \n  // Mixdown transparency first (early bail alpha0)\n  #ifdef PIM_TEXTURE_TRANSPARENCY_0\n    float tran;\n    #ifdef PIM_TEXTURE_TRANSPARENCY_0_ALPHA // assume alpha suplied in alpha is negated .. i.e. opacity\n      #if PIM_TEXTURE_TRANSPARENCY_0 == 0\n        tran = texture2D(pim_transparency0, texcoord0v+uvanim0).a;\n      #elif PIM_TEXTURE_TRANSPARENCY_0 == 1\n        tran = texture2D(pim_transparency0, texcoord1+uvanim0).a;\n      #elif PIM_TEXTURE_TRANSPARENCY_0 == 2\n        tran = texture2D(pim_transparency0, texcoord2+uvanim0).a;\n      #elif PIM_TEXTURE_TRANSPARENCY_0 == 3\n        tran = texture2D(pim_transparency0, texcoord3+uvanim0).a;\n      #endif\n    #else // assume alpha supplied as color image is alpha .. i.e. transparency\n      #if PIM_TEXTURE_TRANSPARENCY_0 == 0\n        tran = texture2D(pim_transparency0, texcoord0v+uvanim0).r;\n      #elif PIM_TEXTURE_TRANSPARENCY_0 == 1\n        tran = texture2D(pim_transparency0, texcoord1+uvanim0).r;\n      #elif PIM_TEXTURE_TRANSPARENCY_0 == 2\n        tran = texture2D(pim_transparency0, texcoord2+uvanim0).r;\n      #elif PIM_TEXTURE_TRANSPARENCY_0 == 3\n        tran = texture2D(pim_transparency0, texcoord3+uvanim0).r;\n      #endif\n    #endif\n\n    #if PIM_TEXTURE_TRANSPARENCY_0_BLEND == 7\n     transparency = tran + (1.0-PIM_TRANSPARENCY);     \n    #elif PIM_TEXTURE_TRANSPARENCY_0_BLEND == 3\n     transparency = sqrt(tran * (1.0-PIM_TRANSPARENCY));     \n    #elif PIM_TEXTURE_TRANSPARENCY_0_BLEND == 8\n     transparency = tran * (1.0-PIM_TRANSPARENCY);     \n    #else\n     transparency = tran;\n    #endif\n\n    #ifdef PIM_TEXTURE_TRANSPARENCY_0_NEGATIVE // negate flag\n      transparency = 1.0-transparency;\n    #endif\n  #else\n    transparency = PIM_TRANSPARENCY;\n  #endif\n\n  #ifdef PIM_TEXTURE_TRANSPARENCY_1\n    #ifdef PIM_TEXTURE_TRANSPARENCY_1_ALPHA // assume alpha suplied in alpha is negated .. i.e. opacity\n      #if PIM_TEXTURE_TRANSPARENCY_1 == 0\n        tran = texture2D(pim_transparency1, texcoord0v+uvanim0).a;\n      #elif PIM_TEXTURE_TRANSPARENCY_1 == 1\n        tran = texture2D(pim_transparency1, texcoord1+uvanim0).a;\n      #elif PIM_TEXTURE_TRANSPARENCY_1 == 2\n        tran = texture2D(pim_transparency1, texcoord2+uvanim0).a;\n      #elif PIM_TEXTURE_TRANSPARENCY_1 == 3\n        tran = texture2D(pim_transparency1, texcoord3+uvanim0).a;\n      #endif\n    #else // assume alpha supplied as color image is alpha .. i.e. transparency\n      #if PIM_TEXTURE_TRANSPARENCY_1 == 0\n        tran = texture2D(pim_transparency1, texcoord0v+uvanim0).r;\n      #elif PIM_TEXTURE_TRANSPARENCY_1 == 1\n        tran = texture2D(pim_transparency1, texcoord1+uvanim0).r;\n      #elif PIM_TEXTURE_TRANSPARENCY_1 == 2\n        tran = texture2D(pim_transparency1, texcoord2+uvanim0).r;\n      #elif PIM_TEXTURE_TRANSPARENCY_1 == 3\n        tran = texture2D(pim_transparency1, texcoord3+uvanim0).r;\n      #endif\n    #endif\n\n    #ifdef PIM_TEXTURE_TRANSPARENCY_1_NEGATIVE // negate flag\n      tran = 1.0-tran;\n    #endif\n\n    #if PIM_TEXTURE_TRANSPARENCY_1_BLEND == 7\n     transparency = tran + transparency;     \n    #elif PIM_TEXTURE_TRANSPARENCY_1_BLEND == 3\n     transparency = tran * transparency;\n    #elif PIM_TEXTURE_TRANSPARENCY_1_BLEND == 8\n     transparency = tran * transparency; \n    #else\n     transparency = tran;\n    #endif\n  #endif\n\n  if (transparency>=0.9765) discard; // 6/255\n\n\n  // Mixdown color.\n  #ifdef PIM_TEXTURE_COLOR_0\n    vec3 tex;\n    #if PIM_TEXTURE_COLOR_0 == 0\n      tex = texture2D(pim_texture0, texcoord0v+uvanim0).rgb;\n    #elif PIM_TEXTURE_COLOR_0 == 1\n      tex = texture2D(pim_texture0, texcoord1+uvanim0).rgb;\n    #elif PIM_TEXTURE_COLOR_0 == 2\n      tex = texture2D(pim_texture0, texcoord2+uvanim0).rgb;\n    #elif PIM_TEXTURE_COLOR_0 == 3\n      tex = texture2D(pim_texture0, texcoord3+uvanim0).rgb;\n    #endif\n    #if PIM_TEXTURE_COLOR_0_BLEND == 7\n     texture = vec3(PIM_COLOR) + tex;     \n    #elif PIM_TEXTURE_COLOR_0_BLEND == 3\n     texture = sqrt(tex * vec3(PIM_COLOR));     \n    #elif PIM_TEXTURE_COLOR_0_BLEND == 8\n     texture = vec3(PIM_COLOR) * tex;     \n    #else\n     texture = tex;\n    #endif\n\n    #ifdef PIM_TEXTURE_COLOR_1\n      #if PIM_TEXTURE_COLOR_1 == 0\n        tex = texture2D(pim_texture1, texcoord0v).rgb;\n      #elif PIM_TEXTURE_COLOR_1 == 1\n        tex = texture2D(pim_texture1, texcoord1).rgb;\n      #elif PIM_TEXTURE_COLOR_1 == 2\n        tex = texture2D(pim_texture1, texcoord2).rgb;\n      #elif PIM_TEXTURE_COLOR_1 == 3\n        tex = texture2D(pim_texture1, texcoord3).rgb;\n      #endif\n      #if PIM_TEXTURE_COLOR_1_BLEND == 7\n       texture = texture + tex;     \n      #elif PIM_TEXTURE_COLOR_1_BLEND == 3\n       texture = sqrt(texture * tex);     \n      #elif PIM_TEXTURE_COLOR_1_BLEND == 8\n       texture = texture * tex;     \n      #else\n       texture = tex;\n      #endif\n    #endif\n\n    #ifdef PIM_TEXTURE_COLOR_2\n      #if PIM_TEXTURE_COLOR_2 == 0\n        tex = texture2D(pim_texture2, texcoord0v).rgb;\n      #elif PIM_TEXTURE_COLOR_2 == 1\n        tex = texture2D(pim_texture2, texcoord1).rgb;\n      #elif PIM_TEXTURE_COLOR_2 == 2\n        tex = texture2D(pim_texture2, texcoord2).rgb;\n      #elif PIM_TEXTURE_COLOR_2 == 3\n        tex = texture2D(pim_texture2, texcoord3).rgb;\n      #endif\n      #if PIM_TEXTURE_COLOR_2_BLEND == 7\n       texture = texture + tex;     \n      #elif PIM_TEXTURE_COLOR_2_BLEND == 3\n       texture = sqrt(texture * tex);     \n      #elif PIM_TEXTURE_COLOR_2_BLEND == 8\n       texture = texture * tex;     \n      #else\n       texture = tex;\n      #endif\n    #endif\n    #ifdef PIM_GAMMA\n      texture=texture*texture; // antigamma \n    #endif\n  #else\n    texture = vec3(PIM_COLOR);    \n    #ifdef PIM_SKYBOX\n      #ifdef PIM_SKYBOX_MIN\n        vec3 rr=(worldPosition.xyz-camPosition);\n        vec3 FirstPlaneIntersect = (vec3(PIM_SKYBOX_MAX) - worldPosition.xyz) / rr;\n        vec3 SecondPlaneIntersect = (vec3(PIM_SKYBOX_MIN) - worldPosition.xyz) / rr;\n        vec3 FurthestPlane = max(FirstPlaneIntersect, SecondPlaneIntersect);\n        float Distance = min(min(FurthestPlane.x, FurthestPlane.y), FurthestPlane.z); \n        vec3 IntersectPositionWS = worldPosition.xyz + rr * Distance;\n        rr = normalize(IntersectPositionWS - vec3(PIM_SKYBOX_POS));\n        texture = texture2D(pim_reflectionmap2, vec2(0.0+(3.141592 + atan(rr.z,rr.x)) / (2.0 * 3.141592), acos(rr.y) / 3.141592)).rgb;\n      #else \n        vec3 rr=normalize(worldPosition.xyz-camPosition);\n        texture = texture2D(pim_reflectionmap2, vec2(0.0+(3.141592 + atan(rr.z,rr.x)) / (2.0 * 3.141592), acos(rr.y) / 3.141592)).rgb;\n      #endif\n    #endif\n\n\n\n\n  #endif\n  \n\n  // Mixdown diffuse.\n  #ifdef PIM_TEXTURE_DIFFUSE_0\n    float diff;\n    #if PIM_TEXTURE_DIFFUSE_0 == 0\n      diff = texture2D(pim_diffuse0, texcoord0v).r;\n    #elif PIM_TEXTURE_DIFFUSE_0 == 1\n      diff = texture2D(pim_diffuse0, texcoord1).r;\n    #elif PIM_TEXTURE_DIFFUSE_0 == 2\n      diff = texture2D(pim_diffuse0, texcoord2).r;\n    #elif PIM_TEXTURE_DIFFUSE_0 == 3\n      diff = texture2D(pim_diffuse0, texcoord3).r;\n    #endif\n    #if PIM_TEXTURE_DIFFUSE_0_BLEND == 8\n      diffuse = PIM_DIFFUSE * diff;\n    #else\n      diffuse=diff;\n    #endif\n  #else\n    diffuse = PIM_DIFFUSE;\n  #endif\n\n\n  // Mixdown specular.\n  #ifdef PIM_TEXTURE_SPECULAR_0\n    vec3 spec;\n    #if PIM_TEXTURE_SPECULAR_0 == 0\n      spec = texture2D(pim_specular0, texcoord0v).rgb;\n    #elif PIM_TEXTURE_SPECULAR_0 == 1\n      spec = texture2D(pim_specular0, texcoord1).rgb;\n    #elif PIM_TEXTURE_SPECULAR_0 == 2\n      spec = texture2D(pim_specular0, texcoord2).rgb;\n    #elif PIM_TEXTURE_SPECULAR_0 == 3\n      spec = texture2D(pim_specular0, texcoord3).rgb;\n    #endif\n    specular = spec;\n  #else\n    #if (defined(PIM_SPECULAR) || defined(PIM_TEXTURE_SPECULAR_0))\n      specular = vec3(PIM_SPECULAR,PIM_SPECULAR,PIM_SPECULAR); \n    #else\n      specular = vec3(0.0,0.0,0.0);\n    #endif\n  #endif\n\n  // Mixdown luminosity.\n  #ifdef PIM_TEXTURE_LUMINOSITY_0\n    float lumi;\n    #if PIM_TEXTURE_LUMINOSITY_0 == 0\n      lumi = texture2D(pim_luminosity0, texcoord0v).r;\n    #elif PIM_TEXTURE_LUMINOSITY_0 == 1\n      lumi = texture2D(pim_luminosity0, texcoord1).r;\n    #elif PIM_TEXTURE_LUMINOSITY_0 == 2\n      lumi = texture2D(pim_luminosity0, texcoord2).r;\n    #elif PIM_TEXTURE_LUMINOSITY_0 == 3\n      lumi = texture2D(pim_luminosity0, texcoord3).r;\n    #endif\n    #if PIM_TEXTURE_LUMINOSITY_0_BLEND == 7\n     luminosity = lumi + PIM_LUMINOSITY;     \n    #elif PIM_TEXTURE_LUMINOSITY_0_BLEND == 3\n     luminosity = sqrt(lumi * PIM_LUMINOSITY);     \n    #elif PIM_TEXTURE_LUMINOSITY_0_BLEND == 8\n     luminosity = lumi * PIM_LUMINOSITY;     \n    #else\n     luminosity = lumi;\n    #endif\n    transparency = lumi;\n  #else\n    luminosity = PIM_LUMINOSITY;\n  #endif\n\n  // Ambient color/intensity\n  #ifdef PIM_AMBIENT_INTENSITY\n    luminosity = luminosity + diffuse * PIM_AMBIENT_INTENSITY;\n  #endif\n\n  \n  // Normal processing. If a normalmap is used, the vertexshader will supply light positions in TANGENT SPACE.\n  #ifdef PIM_TEXTURE_NORMAL_0\n    normal = normalize(wNormal);\n    LIGHT0_POSITION = vLIGHT0_POSITION;\n    LIGHT0_DIRECTION = vLIGHT0_DIRECTION;\n    #if (NUM_LIGHTS > 1)\n      LIGHT1_POSITION = vLIGHT1_POSITION; \n      LIGHT1_DIRECTION = vLIGHT1_DIRECTION;\n    #endif\n  // transform worldNormal\n    mat3 tgw = mat3( worldTangent.xyz, cross(worldTangent.xyz, worldNormal)*worldTangent.w, worldNormal );\n    wNormal = normalize(tgw*normal);\n  #else\n    normal = normalize(wNormal);\n  #endif\n  \n  // Accumulate Lighting.\n  vec3 light, l0, LightReflect, lights = vec3(0.0,0.0,0.0);\n  float outer, inner, att=1.0;\n\n  const mat4 ScaleMatrix = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);\n  vec4 lpos;\n  vec3 lpos2;\n\n  #ifdef PIM_SKYBOX\n    float lumShadow=1.0;\n  #else\n    #ifdef PIM_SKYBOX_MIN\n      float lumShadow=1.0;\n    #endif\n  #endif\n\n\n  // Light 0\n  #ifdef LIGHT0\n    // Directional\n    #if LIGHT0 == 0 \n      light = vec3(LIGHT0_COLOR) * LIGHT0_INTENSITY * dot( vec3(LIGHT0_DIRECTION), normal ); \n    // Point\n    #elif LIGHT0 == 1\n      #ifdef PIM_TEXTURE_NORMAL_0\n        l0 = vec3(LIGHT0_POSITION);\n      #else\n        l0 = vec3(LIGHT0_POSITION) - worldPosition.xyz;\n      #endif\n      // no Falloff\n      #if LIGHT0_FALLOFF == 0\n        light = vec3(LIGHT0_COLOR) * LIGHT0_INTENSITY * max(0.0,dot( normalize(l0), normal ));\n      // Linear FallOff\n      #elif LIGHT0_FALLOFF == 1\n        att = 1.0/(1.0/(LIGHT0_RANGE) * length(l0));\n        light = vec3(LIGHT0_COLOR) * LIGHT0_INTENSITY * att * max(0.0, dot( normalize(l0), normal ));\n      // Inverse distance squared.\n      #else\n        att = 1.0/(1.0/(LIGHT0_RANGE*LIGHT0_RANGE) * dot(l0,l0));\n        light = vec3(LIGHT0_COLOR) * LIGHT0_INTENSITY * att * max(0.0, dot( normalize(l0), normal ));\n      #endif\n    // Spot\n    #elif LIGHT0 == 2\n      // Softness Range spotlight.\n      outer = (LIGHT0_CONE);\n      inner = (LIGHT0_CONE-0.08);\n      #ifdef PIM_TEXTURE_NORMAL_0\n        l0 = vec3(LIGHT0_POSITION);\n      #else\n        l0 = vec3(LIGHT0_POSITION) - worldPosition.xyz;\n      #endif\n      // Shadowmap sampling.\n      #ifdef LIGHT0_SHADOW\n        lpos  = ScaleMatrix * LIGHT_LVP0 * LIGHT_LVM0 * worldPosition;\n        lpos2 = (lpos).xyz/lpos.w;\n        lpos2.z = (LIGHT_LVM0 * worldPosition).z/100.0*0.99;\n       #ifdef PIM_TEXTURE_NORMAL_0\n          #ifdef PIM_PARALLAX\n          #if (PIM_PARALLAX > 1)\n             lpos2.x -= nba*0.002;\n             lpos2.y += nba*0.002;\n          #endif\n          #endif\n        #endif\n        #ifdef PIM_SKYBOX_MIN\n\n         #ifdef PIM_SOFT_SHADOWS\n         lpos.xy=lpos2.xy;\n         for (int x=-2;x<3;x++) for (int y=-2;y<3;y++) {\n           lpos2.xy = vec2(lpos.x+float(x)/1024.0,lpos.y+float(y)/1024.0);\n           float sdepth = unpack(texture2D( LIGHT_SMAP0, lpos2.xy ));\n           if ( lpos2.z > sdepth ) att-=0.04;\n         }\n         lumShadow = 1.0-((1.0-att)/2.0);\n\n         #else\n          if ( lpos2.z >= unpack(texture2D( LIGHT_SMAP0, lpos2.xy ))) {\n            att*=0.01;\n            lumShadow=0.5;\n          }\n         #endif\n        #else\n         #ifdef PIM_SOFT_SHADOWS\n         lpos.xy=lpos2.xy;\n         for (int x=-2;x<3;x++) for (int y=-2;y<3;y++) {\n           lpos2.xy = vec2(lpos.x+float(x)/1024.0,lpos.y+float(y)/1024.0);\n           float sdepth = unpack(texture2D( LIGHT_SMAP0, lpos2.xy ));\n           if ( lpos2.z > sdepth ) att-=0.04;\n         }\n         #else\n         if ( lpos2.z > unpack(texture2D( LIGHT_SMAP0, lpos2.xy ))) {\n           att*=0.01;\n         }\n         #endif\n        #endif\n      // self shadow by tracing heightmap\n        #ifdef PIM_TEXTURE_NORMAL_0\n          #ifdef PIM_PARALLAX\n          #if (PIM_PARALLAX>1)\n             // trace in direction of light. if we hit the heightmap, we\'re being shadowed.\n              step = 1.0/float(PIM_PARALLAX);\n              vec3 tsL = normalize(l0);\n              dt = vec2(tsL.x, -tsL.y) * PIM_PARALLAX_SCALE / (float(PIM_PARALLAX) * tsL.z);\n              height = nba + step*0.5;\n              vec2 curt = texcoord0v;\n	      for (int i=0; i<PIM_PARALLAX; i++) {\n                if (nba < height && height < 1.0) {\n                  height += step;\n                  curt += dt;\n                  nba = texture2D(pim_normal0, curt).a;\n                }\n              }\n              if (nba >= height) att*=0.01;\n          #endif\n          #endif\n        #endif\n      #endif\n      // no FallOff\n      #if LIGHT0_FALLOFF == 0\n        l0 = normalize(l0);\n        float att_angle=  min(1.0,(1.0-clamp(acos((dot(l0,normalize(vec3(LIGHT0_DIRECTION)))))-inner,0.0,outer-inner)/(outer-inner)));\n        att*=att_angle;\n        #ifdef PIM_SKYBOX\n          if (att_angle<=0.1) lumShadow=1.0;\n        #endif\n        light = vec3(LIGHT0_COLOR) * LIGHT0_INTENSITY * ( max(0.0,dot(l0,normal))) * att;\n      // Linear FallOff\n      #elif LIGHT0_FALLOFF == 1\n        att *= 1.0/(1.0/(LIGHT0_RANGE) * length(l0));\n        l0 = normalize(l0);\n        att *=  min(1.0,(1.0-clamp(acos((dot(l0,normalize(vec3(LIGHT0_DIRECTION)))))-inner,0.0,outer-inner)/(outer-inner)));\n        light = vec3(LIGHT0_COLOR) * LIGHT0_INTENSITY * (max(0.0,dot(l0,normal))) * att;\n      // Inverse distance squared.\n      #else\n        att *= 1.0/(1.0/(LIGHT0_RANGE*LIGHT0_RANGE) * dot(l0,l0));\n        l0 = normalize(l0);\n        float att_angle =  min(1.0,(1.0-clamp(acos((dot(l0,normalize(vec3(LIGHT0_DIRECTION)))))-inner,0.0,outer-inner)/(outer-inner)));\n        att*=att_angle;\n        #ifdef PIM_SKYBOX\n          if (att_angle<=0.1) lumShadow=1.0;\n        #endif\n        light = vec3(LIGHT0_COLOR) * LIGHT0_INTENSITY * (max(0.0,dot(l0,normal))) * att;\n      #endif\n    #endif\n    #ifdef PIM_VOLUMETRIC\n    // Add in volumetric contribution.\n      // project light position onto vertex-to-eye\n        vec3 vtoeye = worldPosition.xyz-camPosition; // vertex-cam = vector from cam to vertex.\n        vec3 ltoeye = LIGHT0_POSITION-camPosition;   // light-cam = vector from cam to light.\n        vec3 plight = dot(vtoeye, ltoeye) / dot(vtoeye,vtoeye) * vtoeye + camPosition;\n        float volumetric = 0.0;\n//        if (length(plight) < length(vtoeye)) \n        volumetric = min(0.5,(LIGHT0_RANGE*0.001/(length( plight - LIGHT0_POSITION)*length( plight - LIGHT0_POSITION))));\n\n//        volumetric*=att;\n        //float dist = length(plight)-length(vtoeye);\n        //plight = worldPosition.xyz + normalize(LIGHT0_POSITION - worldPosition.xyz) * dist;\n\n//        l0 = normalize(vec3(LIGHT0_POSITION)-plight);\n//        volumetric *=  min(1.0,(1.0-clamp(acos((dot(l0,normalize(vec3(LIGHT0_DIRECTION)))))-inner,0.0,outer-inner)/(outer-inner)));\n\n        lights += LIGHT0_COLOR*vec3(volumetric,volumetric,volumetric);\n\n/*\nvolume lineAndCone\n(\n	uniform string coneSpace = "nameYourCoordinateSpaceHere";\n	uniform float coneAngle = 10;\n	uniform float coneMaxDist = 3;//not yet implemented\n)\n{\n	varying point _P = transform("shader",P);\n \n	varying point eye = transform("shader",P-I);\n \n	varying vector _lightDirection = vtransform(coneSpace,"shader",vector(0,0,-1));//Down the -z axis like a camera\n	varying vector _In = normalize(vtransform("shader",I));\n	varying point coneVertex = transform(coneSpace,"shader",point(0,0,0));\n	varying vector coneEye = coneVertex-eye;\n	varying vector normalToPlane = normalize (coneEye ^ _In);\n \n	varying vector uPlane = normalize(normalToPlane ^ _lightDirection);\n	varying vector vPlane = normalize( _lightDirection);\n	varying vector wPlane = normalize(uPlane ^ vPlane);\n \n	varying float angleFromConeAxis = acos(sqrt(1- pow(_lightDirection.normalToPlane,2)));\n \n	varying float coneAngleRad = radians(coneAngle);\n \n	// the eye ray intersects the cone\n	vector lineOnConeSurface1 = vPlane +  tan(angleFromConeAxis)*wPlane + sqrt((pow(tan(coneAngleRad),2) - pow(tan(angleFromConeAxis),2)))*uPlane;\n	vector lineOnConeSurface2 = vPlane +  tan(angleFromConeAxis)*wPlane - sqrt((pow(tan(coneAngleRad),2) - pow(tan(angleFromConeAxis),2)))*uPlane;\n	point hitOne = ((eye - coneVertex) ^ lineOnConeSurface1) . (_In ^ lineOnConeSurface1)/pow(length(_In ^ lineOnConeSurface1),2);\n	point hitTwo = ((eye - coneVertex) ^ lineOnConeSurface2) . (_In ^ lineOnConeSurface2)/pow(length(_In ^ lineOnConeSurface2),2);\n	Ci = length(hitOne-hitTwo);\n \n}\n\n*/\n\n      // distance of this point to light represents amount of the light sphere that the camera-to-vertex vector goes through.\n    #endif\n    // Add Specular contribution.\n    #if (defined(PIM_SPECULAR) || defined(PIM_TEXTURE_SPECULAR_0))\n      LightReflect = normalize(reflect( l0 , normal ));\n      lights += LIGHT0_INTENSITY * vec3(LIGHT0_COLOR) * att * specular * pow(max(0.0,dot(-vertexToEye, LightReflect)),PIM_GLOSSINESS);\n    #endif\n  #else\n    light = vec3(1.0,1.0,1.0);\n  #endif\n\n  #ifdef LIGHT1\n    att=1.0;\n    // Directional\n    #if LIGHT1 == 0 \n      light += vec3(LIGHT1_COLOR) * LIGHT1_INTENSITY * dot( vec3(LIGHT1_DIRECTION), normal ); \n    // Point\n    #elif LIGHT1 == 1\n      #ifdef PIM_TEXTURE_NORMAL_0\n        l0 = vec3(LIGHT1_POSITION);\n      #else\n        l0 = vec3(LIGHT1_POSITION) - worldPosition.xyz;\n      #endif\n      // no Falloff\n      #if LIGHT1_FALLOFF == 0\n        light += vec3(LIGHT1_COLOR) * LIGHT1_INTENSITY * max(0.0,dot( normalize(l0), normal ));\n      // Linear FallOff\n      #elif LIGHT1_FALLOFF == 1\n        att = 1.0/(1.0/(LIGHT1_RANGE) * length(l0));\n        light += vec3(LIGHT1_COLOR) * LIGHT1_INTENSITY * att * max(0.0, dot( normalize(l0), normal ));\n      // Inverse distance squared.\n      #else\n        att = 1.0/(1.0/(LIGHT1_RANGE*LIGHT1_RANGE) * dot(l0,l0));\n        light += vec3(LIGHT1_COLOR) * LIGHT1_INTENSITY * att * max(0.0, dot( normalize(l0), normal ));\n      #endif\n    // Spot\n    #elif LIGHT1 == 2\n      // Softness Range spotlight.\n      outer = (LIGHT1_CONE);\n      inner = (LIGHT1_CONE-0.08);\n      #ifdef PIM_TEXTURE_NORMAL_0\n        l0 = vec3(LIGHT1_POSITION);\n      #else\n        l0 = vec3(LIGHT1_POSITION) - worldPosition.xyz;\n      #endif\n      // Shadowmap sampling.\n      #ifdef LIGHT1_SHADOW\n        lpos  = ScaleMatrix * LIGHT_LVP1 * LIGHT_LVM1 * worldPosition;\n        lpos2 = (lpos).xyz/lpos.w;\n        lpos2.z = (LIGHT_LVM1 * worldPosition).z/100.0*0.99;\n        #ifdef PIM_TEXTURE_NORMAL_0\n          #ifdef PIM_PARALLAX\n          #if (PIM_PARALLAX > 1)\n             lpos2.x -= nba*0.002;\n             lpos2.y += nba*0.002;\n          #endif\n          #endif\n        #endif\n        if ( lpos2.z > unpack(texture2D( LIGHT_SMAP1, lpos2.xy ))) {\n          att*=0.01; \n        }\n      // self shadow by tracing heightmap\n        #ifdef PIM_TEXTURE_NORMAL_0\n          #ifdef PIM_PARALLAX\n          #if (PIM_PARALLAX>1)\n             // trace in direction of light. if we hit the heightmap, we\'re being shadowed.\n              step = 1.0/float(PIM_PARALLAX);\n              vec3 tsL = normalize(l0);\n              dt = vec2(tsL.x, -tsL.y) * PIM_PARALLAX_SCALE / (float(PIM_PARALLAX) * tsL.z);\n              height = nba + step*0.5;\n              vec2 curt = texcoord0v;\n	      for (int i=0; i<PIM_PARALLAX; i++) {\n                if (nba < height && height < 1.0) {\n                  height += step;\n                  curt += dt;\n                  nba = texture2D(pim_normal0, curt).a;\n                }\n              }\n              if (nba >= height) att*=0.01;\n          #endif\n          #endif\n        #endif\n      #endif\n      // no FallOff\n      #if LIGHT1_FALLOFF == 0\n        l0 = normalize(l0);\n        att *=  min(1.0,(1.0-clamp(acos((dot(l0,normalize(vec3(LIGHT1_DIRECTION)))))-inner,0.0,outer-inner)/(outer-inner)));\n        light += vec3(LIGHT1_COLOR) * LIGHT1_INTENSITY * ( max(0.0,dot(l0,normal))) * att;\n      // Linear FallOff\n      #elif LIGHT1_FALLOFF == 1\n        att *= 1.0/(1.0/(LIGHT1_RANGE) * length(l0));\n        l0 = normalize(l0);\n        att *=  min(1.0,(1.0-clamp(acos((dot(l0,normalize(vec3(LIGHT1_DIRECTION)))))-inner,0.0,outer-inner)/(outer-inner)));\n        light += vec3(LIGHT1_COLOR) * LIGHT1_INTENSITY * (max(0.0,dot(l0,normal))) * att;\n      // Inverse distance squared.\n      #else\n        att *= 1.0/(1.0/(LIGHT1_RANGE*LIGHT1_RANGE) * dot(l0,l0));\n        l0 = normalize(l0);\n        att *=  min(1.0,(1.0-clamp(acos((dot(l0,normalize(vec3(LIGHT1_DIRECTION)))))-inner,0.0,outer-inner)/(outer-inner)));\n        light += vec3(LIGHT1_COLOR) * LIGHT1_INTENSITY * (max(0.0,dot(l0,normal))) * att;\n      #endif\n    #endif\n    // Add Specular contribution.\n    #if (defined(PIM_SPECULAR) || defined(PIM_TEXTURE_SPECULAR_0))\n      LightReflect = normalize(reflect( l0 , normal ));\n      lights += LIGHT1_INTENSITY * vec3(LIGHT1_COLOR) * att * specular * pow(max(0.0,dot(-vertexToEye, LightReflect)),PIM_GLOSSINESS);\n    #endif\n  #endif\n\n  #ifdef LIGHT2\n    att=1.0;\n    #if LIGHT2 == 0\n      light += vec3(LIGHT2_COLOR) * LIGHT2_INTENSITY * dot( vec3(LIGHT2_DIRECTION), normal );\n    #elif LIGHT2 == 1\n      l0 = vec3(LIGHT2_POSITION) - worldPosition.xyz;\n      #if LIGHT2_FALLOFF == 0\n        light += vec3(LIGHT2_COLOR) * LIGHT2_INTENSITY * dot( normalize(vec3(LIGHT2_POSITION) - worldPosition.xyz), normal );\n      #elif LIGHT2_FALLOFF == 1\n        att = 1.0/(1.0/(LIGHT2_RANGE) * length(l0));\n        light += vec3(LIGHT2_COLOR) * LIGHT2_INTENSITY * att * dot( normalize(vec3(LIGHT2_POSITION) - worldPosition.xyz), normal );\n      #else\n        att = 1.0/(1.0/(LIGHT2_RANGE*LIGHT2_RANGE) * dot(l0,l0));\n        light += vec3(LIGHT2_COLOR) * LIGHT2_INTENSITY * att * dot( normalize(vec3(LIGHT2_POSITION) - worldPosition.xyz), normal );\n      #endif\n    #elif LIGHT2 == 2\n      #ifdef LIGHT2_SHADOW\n        lpos  = ScaleMatrix * LIGHT_LVP1 * LIGHT_LVM1 * worldPosition;\n        lpos2 = (lpos).xyz/lpos.w;\n        lpos2.z = (LIGHT_LVM1 * worldPosition).z/100.0*0.99;\n        if ( lpos2.z > unpack(texture2D( LIGHT_SMAP1, lpos2.xy ))) att*=0.01;\n      #endif\n      outer = (LIGHT2_CONE);\n      inner = (LIGHT2_CONE-0.08);\n      l0 = vec3(LIGHT2_POSITION) - worldPosition.xyz;\n      #if LIGHT2_FALLOFF == 0\n        l0 = normalize(l0);\n        att *=  min(1.0,(1.0-clamp(acos((dot(l0,normalize(vec3(LIGHT2_DIRECTION)))))-inner,0.0,outer-inner)/(outer-inner)));\n        light += vec3(LIGHT2_COLOR) * LIGHT2_INTENSITY * ( max(0.0,dot(l0,normal))) * att;\n      #elif LIGHT2_FALLOFF == 1\n        att *= 1.0/(1.0/(LIGHT2_RANGE) * length(l0));\n        l0 = normalize(l0);\n        att *=  min(1.0,(1.0-clamp(acos((dot(l0,normalize(vec3(LIGHT2_DIRECTION)))))-inner,0.0,outer-inner)/(outer-inner)));\n        light += vec3(LIGHT2_COLOR) * LIGHT2_INTENSITY * (max(0.0,dot(l0,normal))) * att;\n      #else\n        att *= 1.0/(1.0/(LIGHT2_RANGE*LIGHT2_RANGE) * dot(l0,l0));\n        l0 = normalize(l0);\n        att *=  min(1.0,(1.0-clamp(acos((dot(l0,normalize(vec3(LIGHT2_DIRECTION)))))-inner,0.0,outer-inner)/(outer-inner)));\n        light += vec3(LIGHT2_COLOR) * LIGHT2_INTENSITY * (max(0.0,dot(l0,normal))) * att;\n      #endif\n    #endif\n    #if (defined(PIM_SPECULAR) || defined(PIM_TEXTURE_SPECULAR_0))\n      LightReflect = normalize(reflect( l0 , normal ));\n      lights += LIGHT2_INTENSITY * vec3(LIGHT2_COLOR) * att * specular * pow(max(0.0,dot(-vertexToEye, LightReflect)),PIM_GLOSSINESS);\n    #endif\n  #endif\n\n  #ifdef LIGHT3\n    att=1.0;\n    #if LIGHT3 == 0\n      light += vec3(LIGHT3_COLOR) * LIGHT3_INTENSITY * dot( vec3(LIGHT3_DIRECTION), normal );\n    #elif LIGHT3 == 1\n      l0 = vec3(LIGHT3_POSITION) - worldPosition.xyz;\n      #if LIGHT3_FALLOFF == 0\n        light += vec3(LIGHT3_COLOR) * LIGHT3_INTENSITY * dot( normalize(vec3(LIGHT3_POSITION) - worldPosition.xyz), normal );\n      #elif LIGHT3_FALLOFF == 1\n        att = 1.0/(1.0/(LIGHT3_RANGE) * length(l0));\n        light += vec3(LIGHT3_COLOR) * LIGHT3_INTENSITY * att * dot( normalize(vec3(LIGHT3_POSITION) - worldPosition.xyz), normal );\n      #else\n        att = 1.0/(1.0/(LIGHT3_RANGE*LIGHT3_RANGE) * dot(l0,l0));\n        light += vec3(LIGHT3_COLOR) * LIGHT3_INTENSITY * att * dot( normalize(vec3(LIGHT3_POSITION) - worldPosition.xyz), normal );\n      #endif\n    #elif LIGHT3 == 2\n      #ifdef LIGHT3_SHADOW\n        lpos  = ScaleMatrix * LIGHT_LVP1 * LIGHT_LVM1 * worldPosition;\n        lpos2 = (lpos).xyz/lpos.w;\n        lpos2.z = (LIGHT_LVM1 * worldPosition).z/100.0*0.99;\n        if ( lpos2.z > unpack(texture2D( LIGHT_SMAP1, lpos2.xy ))) att*=0.01;\n      #endif\n      outer = (LIGHT3_CONE);\n      inner = (LIGHT3_CONE-0.08);\n      l0 = vec3(LIGHT3_POSITION) - worldPosition.xyz;\n      #if LIGHT3_FALLOFF == 0\n        l0 = normalize(l0);\n        att *=  min(1.0,(1.0-clamp(acos((dot(l0,normalize(vec3(LIGHT3_DIRECTION)))))-inner,0.0,outer-inner)/(outer-inner)));\n        light += vec3(LIGHT3_COLOR) * LIGHT3_INTENSITY * ( max(0.0,dot(l0,normal))) * att;\n      #elif LIGHT3_FALLOFF == 1\n        att *= 1.0/(1.0/(LIGHT3_RANGE) * length(l0));\n        l0 = normalize(l0);\n        att *=  min(1.0,(1.0-clamp(acos((dot(l0,normalize(vec3(LIGHT3_DIRECTION)))))-inner,0.0,outer-inner)/(outer-inner)));\n        light += vec3(LIGHT3_COLOR) * LIGHT3_INTENSITY * (max(0.0,dot(l0,normal))) * att;\n      #else\n        att *= 1.0/(1.0/(LIGHT3_RANGE*LIGHT3_RANGE) * dot(l0,l0));\n        l0 = normalize(l0);\n        att *=  min(1.0,(1.0-clamp(acos((dot(l0,normalize(vec3(LIGHT3_DIRECTION)))))-inner,0.0,outer-inner)/(outer-inner)));\n        light += vec3(LIGHT3_COLOR) * LIGHT3_INTENSITY * (max(0.0,dot(l0,normal))) * att;\n      #endif\n    #endif\n    #if (defined(PIM_SPECULAR) || defined(PIM_TEXTURE_SPECULAR_0))\n      LightReflect = normalize(reflect( l0 , normal ));\n      lights += LIGHT3_INTENSITY * vec3(LIGHT3_COLOR) * att * specular * pow(max(0.0,dot(-vertexToEye, LightReflect)),PIM_GLOSSINESS);\n    #endif\n  #endif\n  // add in IBL lighting\n  #ifdef PIM_TEXTURE_REFLECTIONMAP2\n  // sample light from reflectionmap2 using normal.\n      // hit cube  .. \n    #ifndef PIM_SKYBOX\n      vec3 r2 =  wNormal; //normal;\n      vec3 FirstPlaneIntersect = (vec3(PIM_SKYBOX_MAX) - worldPosition.xyz) / r2;\n      vec3 SecondPlaneIntersect = (vec3(PIM_SKYBOX_MIN) - worldPosition.xyz) / r2;\n      vec3 FurthestPlane = max(FirstPlaneIntersect, SecondPlaneIntersect);\n      float Distance = min(min(FurthestPlane.x, FurthestPlane.y), FurthestPlane.z); \n      vec3 IntersectPositionWS = worldPosition.xyz + r2 * Distance;\n      r2 = normalize(IntersectPositionWS - vec3(PIM_SKYBOX_POS));\n      IntersectPositionWS = texture2D(pim_reflectionmap2, vec2( 0.0+(3.141592 + atan(r2.z,r2.x)) / (2.0 * 3.141592), acos(r2.y) / 3.141592)).rgb;\n      #ifdef PIM_GAMMA\n      light += pim_ibl_strength * lumShadow *  IntersectPositionWS*IntersectPositionWS;\n      #else\n      light += pim_ibl_strength * lumShadow *  IntersectPositionWS * texture;\n      #endif\n//      light += pim_ibl_strength * texture2D(pim_reflectionmap2, vec2( (3.141592 + atan(normal.z,normal.x)) / (2.0 * 3.141592), acos(normal.y) / 3.141592)).rgb;\n  // skybox shader test.\n    #else\n      //light=vec3(0.0);\n //     vec3 r = normalize(vec3(worldPosition.x,worldPosition.y,worldPosition.z));\n      vec3 r3=worldPosition.xyz-camPosition;\n      // hit cube  .. \n      #ifdef PIM_SKYBOX_MIN\n       FirstPlaneIntersect = (vec3(PIM_SKYBOX_MAX) - worldPosition.xyz) / r3;\n       SecondPlaneIntersect = (vec3(PIM_SKYBOX_MIN) - worldPosition.xyz) / r3;\n       FurthestPlane = max(FirstPlaneIntersect, SecondPlaneIntersect);\n       Distance = min(min(FurthestPlane.x, FurthestPlane.y), FurthestPlane.z); \n       IntersectPositionWS = worldPosition.xyz + r3 * Distance;\n      r3 = normalize(IntersectPositionWS - vec3(PIM_SKYBOX_POS));\n      r3 = texture2D(pim_reflectionmap2, vec2(0.0+(3.141592 + atan(r3.z,r3.x)) / (2.0 * 3.141592), acos(r3.y) / 3.141592)).rgb;\n      #else \n      r3 = worldPosition.xyz;\n      r3 = normalize(r3); //vec3(worldPosition.x,worldPosition.y,worldPosition.z));\n      r3 = texture2D(pim_reflectionmap2, vec2(0.0+(3.141592 + atan(r3.z,r3.x)) / (2.0 * 3.141592), acos(r3.y) / 3.141592)).rgb;\n      #endif\n\n      r3.r = pow(r3.r,pim_ibl_refl*4.0);\n      r3.g = pow(r3.g,pim_ibl_refl*4.0);\n      r3.b = pow(r3.b,pim_ibl_refl*4.0);\n      lights += (lumShadow)*pim_ibl_strength*r3;\n    #endif\n  #endif\n  // Calculate Final mix.\n  #ifdef PIM_GAMMA\n    gl_FragColor.rgb = sqrt(texture*(luminosity+diffuse*light)+lights);\n  #else\n    gl_FragColor.rgb = texture*(luminosity+diffuse*light)+lights;\n  #endif\n  gl_FragColor.a   = 1.0-transparency;\n\n // gl_FragColor.rgb=normal/2.0+0.5;\n\n  // Reflectionmap\n  #ifdef PIM_TEXTURE_REFLECTIONMAP\n    #ifndef PIM_TEXTURE_NORMAL_0\n      vec3 r  = reflect(normalize(eyePosition.xyz), normalize(eyeNormal.xyz));\n    #else\n      vec3 r = reflect( normalize(vertexToEye), normalize(normal) );\n    #endif\n    //float aofi = 0.5+0.5*dot( normalize(-epos.rgb), normalize(eNormal.xyz)  );\n\n\n    // test long/lat\n\n//    r=normal;\n//     vec3 smap=2.5*texture2D(pim_reflectionmap, vec2( (3.141592 + atan(r.z,r.x)) / (2.0 * 3.141592), acos(r.y) / 3.141592)).rgb;\n\n\n    #ifdef PIM_TEXTURE_REFLECTIONMAP2\n//      r=worldPosition.xyz-camPosition;\n      // hit cube  ..\n      r = worldPosition.xyz - camPosition.xyz;\n      r = reflect( normalize(r), normalize(wNormal));\n//      r = refract( normalize(r), normalize(worldNormal), 0.66);\n\n       FirstPlaneIntersect = (vec3(PIM_SKYBOX_MAX) - worldPosition.xyz) / r;\n       SecondPlaneIntersect = (vec3(PIM_SKYBOX_MIN) - worldPosition.xyz) / r;\n       FurthestPlane = max(FirstPlaneIntersect, SecondPlaneIntersect);\n       Distance = min(min(FurthestPlane.x, FurthestPlane.y), FurthestPlane.z);\n       IntersectPositionWS = worldPosition.xyz + r * Distance;\n       r = normalize(IntersectPositionWS - vec3(PIM_SKYBOX_POS));\n\n      float aofi = 0.5+0.5*dot( normalize((worldPosition.xyz - camPosition.xyz).xyz), normalize(wNormal)  );\n\n      aofi=mix(aofi,1.0,pim_ibl_aofi);\n\n\n      #ifdef PIM_TEXTURE_SPECULAR_0\n      gl_FragColor.rgb += pim_ibl_refl * aofi * specular * texture2D(pim_reflectionmap, vec2( 0.0+(3.141592 + atan(r.z,r.x)) / (2.0 * 3.141592), acos(r.y) / 3.141592)).rgb;\n      #else\n      gl_FragColor.rgb += pim_ibl_refl * aofi * texture2D(pim_reflectionmap, vec2( 0.0+(3.141592 + atan(r.z,r.x)) / (2.0 * 3.141592), acos(r.y) / 3.141592)).rgb;\n      #endif\n\n      if (pim_ibl_refract != 0.0) {\n       r = worldPosition.xyz - camPosition.xyz;\n       r = refract( normalize(r), normalize(wNormal), 0.66);\n\n       FirstPlaneIntersect = (vec3(PIM_SKYBOX_MAX) - worldPosition.xyz) / r;\n       SecondPlaneIntersect = (vec3(PIM_SKYBOX_MIN) - worldPosition.xyz) / r;\n       FurthestPlane = max(FirstPlaneIntersect, SecondPlaneIntersect);\n       Distance = min(min(FurthestPlane.x, FurthestPlane.y), FurthestPlane.z);\n       IntersectPositionWS = worldPosition.xyz + r * Distance;\n       r = normalize(IntersectPositionWS - vec3(PIM_SKYBOX_POS));\n       gl_FragColor.rgb += pim_ibl_refract * texture2D(pim_reflectionmap, vec2(0.0+(3.141592 + atan(r.z,r.x)) / (2.0 * 3.141592), acos(r.y) / 3.141592)).rgb;\n     }\n\n\n\n    #else\n    // standard reflection.\n      float p = sqrt(r.x*r.x+r.y*r.y+(r.z+1.0)*(r.z+1.0))*2.0;\n      gl_FragColor.rgb += PIM_REFLECTION * texture2D(pim_reflectionmap, vec2(r.x/p+0.5,r.y/p+0.5)).rgb;\n    #endif\n\n\n //   gl_FragColor.rgb = texture2D(pim_reflectionmap, vec2(0.5,0.5)).rgb;\n//    gl_FragColor.rgb = texture2D(pim_texture0, vec2(0.5,0.5)).rgb;\n\n\n//    vec3 smap=2.5*texture2D(pim_reflectionmap, vec2(r.x/p+0.5,r.y/p+0.5)).rgb;\n//    gl_FragColor.rgb = 0.25*sqrt(texture*(luminosity+diffuse*light)+lights)+0.75* (texture+0.05)*smap;\n  #endif\n\n  #else\n    gl_FragColor.rgb = weight_color; //mix(gl_FragColor.rgb, vec3(1.0,0.0,0.0), weight_color.r);\n  #endif\n\n  #ifdef PIM_BADVIDEO\n    gl_FragColor.rgb = vec3(dot(vec3(0.2126, 0.7152, 0.0722),gl_FragColor.rgb)) * (0.8+0.4*rand(gl_FragCoord.xy*0.01));\n  #endif\n\n  #ifdef PIM_HSB\n  // multiply with HSB matrix.\n    gl_FragColor.rgb = (vec4(gl_FragColor.rgb,1.0) * pim_hsb).rgb;\n  #endif\n\n\n/*  light.r = pow(max(0.0,lights.r-1.0),0.1);\n  gl_FragColor.rgb = vec3(light.r);*/\n}\n  \n \n'
},{}],23:[function(a,b,c){c.uberVertex_pimShader="// Incoming matrices.\n  uniform mat4 pim_mm;   // object to world. (model)\n  uniform mat4 pim_vm;   // world to eye.    (view)\n  uniform mat4 pim_p;    // eye to screen    (projection)\n\n// Position is a required parameter.\n  attribute vec3 pim_position;\n  varying   vec4 worldPosition;\n  varying   vec4 eyePosition;\n\n// Incoming normals\n  attribute vec3 pim_normal;\n  varying   vec3 worldNormal;\n  varying   vec3 eyeNormal;\n  #ifdef PIM_TEXTURE_NORMAL_0\n    uniform   mat4 pim_mmi; // world to object.\n    attribute vec4 pim_tangent;\n    varying vec4 worldTangent;\n    vec3 osNormal;\n    #ifndef LIGHT0_POSITION\n      uniform vec3 LIGHT0_POSITION;\n    #endif\n    #ifndef LIGHT0_DIRECTION\n      uniform vec3 LIGHT0_DIRECTION;\n    #endif\n    varying vec3 vvertexToEye;\n    varying vec3 vLIGHT0_POSITION;\n    varying vec3 vLIGHT0_DIRECTION;\n    uniform vec3 camPosition; // position of cam in worldspace.\n    #if (NUM_LIGHTS > 1) \n      #ifndef LIGHT1_POSITION\n        uniform vec3 LIGHT1_POSITION;\n      #endif\n      #ifndef LIGHT1_DIRECTION\n        uniform vec3 LIGHT1_DIRECTION;\n      #endif\n      varying vec3 vLIGHT1_POSITION;\n      varying vec3 vLIGHT1_DIRECTION;\n    #endif\n  #endif\n\n// Weight shade option\n  #ifdef PIM_WEIGHTSHADE\n    varying vec3 weight_color;\n  #endif\n\n// If there are bones we need weights, bone indices and bone matrixes\n  #if defined NUM_BONES && NUM_BONES>0\n    attribute vec4 pim_weights;\n    attribute vec4 pim_index;\n    uniform mat4 pim_bones [ NUM_BONES ];\n  #endif\n\n// Incoming morphs.\n  #ifdef PIM_MORPH1\n    attribute vec3 pim_morph1;\n    uniform float pim_morphamount1;\n  #endif\n  #ifdef PIM_MORPH2\n    attribute vec3 pim_morph2;\n    uniform float pim_morphamount2;\n  #endif\n  #ifdef PIM_MORPH3\n    attribute vec3 pim_morph3;\n    uniform float pim_morphamount3;\n  #endif\n  #ifdef PIM_MORPH4\n    attribute vec3 pim_morph4;\n    uniform float pim_morphamount4;\n  #endif\n  #ifdef PIM_MORPH5\n    attribute vec3 pim_morph5;\n    uniform float pim_morphamount5;\n  #endif\n  #ifdef PIM_MORPH6\n    attribute vec3 pim_morph6;\n    uniform float pim_morphamount6;\n  #endif\n  #ifdef PIM_MORPH7\n    attribute vec3 pim_morph7;\n    uniform float pim_morphamount7;\n  #endif\n  #ifdef PIM_MORPH8\n    attribute vec3 pim_morph8;\n    uniform float pim_morphamount8;\n  #endif\n\n// Incoming texture coordinates.\n  #ifdef PIM_TEXCOORD0\n    attribute vec2 pim_texcoord0;\n    varying   vec2 texcoord0;\n  #endif\n  #ifdef PIM_TEXCOORD1\n    attribute vec2 pim_texcoord1;\n    varying   vec2 texcoord1;\n  #endif\n  #ifdef PIM_TEXCOORD2\n    attribute vec2 pim_texcoord2;\n    varying   vec2 texcoord2;\n  #endif\n\nvoid main() {\n  // Output texture coordinates. uvanim TBC\n  #ifdef PIM_TEXCOORD0\n    texcoord0 = pim_texcoord0;\n  #endif\n  #ifdef PIM_TEXCOORD1\n    texcoord1 = pim_texcoord1;\n  #endif\n  #ifdef PIM_TEXCOORD2\n    texcoord2 = pim_texcoord2;\n  #endif\n\n  // start from non-morphed position.\n  vec3 mpos = pim_position;\n\n  // Apply morphs ..\n  #ifdef PIM_MORPH1\n   mpos += pim_morphamount1 * pim_morph1;\n  #endif\n  #ifdef PIM_MORPH2\n   mpos += pim_morphamount2 * pim_morph2;\n  #endif\n  #ifdef PIM_MORPH3\n   mpos += pim_morphamount3 * pim_morph3;\n  #endif\n  #ifdef PIM_MORPH4\n   mpos += pim_morphamount4 * pim_morph4;\n  #endif\n  #ifdef PIM_MORPH5\n   mpos += pim_morphamount5 * pim_morph5;\n  #endif\n  #ifdef PIM_MORPH6\n   mpos += pim_morphamount6 * pim_morph6;\n  #endif\n  #ifdef PIM_MORPH7\n   mpos += pim_morphamount7 * pim_morph7;\n  #endif\n  #ifdef PIM_MORPH8\n   mpos += pim_morphamount8 * pim_morph8;\n  #endif\n\n  // If we have bones, skin\n  #if defined NUM_BONES && NUM_BONES>0\n    vec4 pos;\n         pos  = (pim_bones[ int(pim_index.x) -1 ] * vec4(mpos, 1.0) - vec4(mpos, 1.0)) * pim_weights.x;\n         pos += (pim_bones[ int(pim_index.y) -1 ] * vec4(mpos, 1.0) - vec4(mpos, 1.0)) * pim_weights.y;\n         pos += (pim_bones[ int(pim_index.z) -1 ] * vec4(mpos, 1.0) - vec4(mpos, 1.0)) * pim_weights.z;\n         pos += (pim_bones[ int(pim_index.w) -1 ] * vec4(mpos, 1.0) - vec4(mpos, 1.0)) * pim_weights.w;\n         pos +=  vec4(mpos, 1.0);\n\n    #ifdef PIM_WEIGHTSHADE\n      weight_color.r = 0.0;\n      if (int(pim_index.x)==PIM_WEIGHTSHADE) weight_color.r = pim_weights.x;\n      if (int(pim_index.y)==PIM_WEIGHTSHADE) weight_color.r = pim_weights.y;\n      if (int(pim_index.z)==PIM_WEIGHTSHADE) weight_color.r = pim_weights.z;\n      if (int(pim_index.w)==PIM_WEIGHTSHADE) weight_color.r = pim_weights.w;\n    #endif\n    \n    vec4 norm;\n         norm  = (pim_bones[ int(pim_index.x) -1 ] * vec4(pim_normal, 0.0) ) * pim_weights.x;\n         norm += (pim_bones[ int(pim_index.y) -1 ] * vec4(pim_normal, 0.0) ) * pim_weights.y;\n         norm += (pim_bones[ int(pim_index.z) -1 ] * vec4(pim_normal, 0.0) ) * pim_weights.z;\n         norm += (pim_bones[ int(pim_index.w) -1 ] * vec4(pim_normal, 0.0) ) * pim_weights.w;\n    \n    #ifdef PIM_TEXTURE_NORMAL_0\n    vec3 tang;\n         tang  = (pim_bones[ int(pim_index.x) -1 ] * vec4(pim_tangent.xyz, 0.0) ).xyz * pim_weights.x;\n         tang += (pim_bones[ int(pim_index.y) -1 ] * vec4(pim_tangent.xyz, 0.0) ).xyz * pim_weights.y;\n         tang += (pim_bones[ int(pim_index.z) -1 ] * vec4(pim_tangent.xyz, 0.0) ).xyz * pim_weights.z;\n         tang += (pim_bones[ int(pim_index.w) -1 ] * vec4(pim_tangent.xyz, 0.0) ).xyz * pim_weights.w;\n    #endif\n\n    mpos = pos.xyz;\n    worldPosition = pim_mm * vec4(pos.xyz,1.0);\n    eyePosition   = pim_vm * worldPosition;\n    gl_Position   = pim_p * eyePosition;\n    worldNormal   = normalize((pim_mm * norm).xyz);\n  #else\n  // If we don't have bones, just transform and output.\n    worldNormal = normalize((pim_mm * vec4(pim_normal,0.0)).xyz);\n    worldPosition = pim_mm * vec4(mpos, 1);\n    eyePosition   = pim_vm * worldPosition;\n    gl_Position   = pim_p * eyePosition;\n  #endif\n\n  // tangent space support.\n  #ifdef PIM_TEXTURE_NORMAL_0\n    #if defined NUM_BONES && NUM_BONES>0\n      osNormal      = normalize(norm.xyz);\n      tang = normalize(tang);\n    #else\n      osNormal      = pim_normal;\n      vec3 tang;\n      tang = pim_tangent.xyz;\n    #endif\n    worldTangent.xyz = normalize((pim_mm * vec4(tang,0.0)).xyz);\n    worldTangent.w = pim_tangent.w;\n    vec3 bitangent = cross( tang, osNormal )*pim_tangent.w;\n    vec3 lposos = (pim_mmi * vec4(LIGHT0_POSITION, 1.0)).xyz - mpos;\n    float lposl = length(vec3(LIGHT0_POSITION) - worldPosition.xyz);\n    vLIGHT0_POSITION.x  = dot(tang, lposos);\n    vLIGHT0_POSITION.y  = dot(bitangent,   lposos);\n    vLIGHT0_POSITION.z  = dot(osNormal,    lposos);\n    vLIGHT0_POSITION.xyz = normalize(vLIGHT0_POSITION.xyz) * lposl;\n    lposos = (pim_mmi * vec4(LIGHT0_DIRECTION, 0.0)).xyz;\n    vLIGHT0_DIRECTION.x   = dot(tang, lposos);\n    vLIGHT0_DIRECTION.y   = dot(bitangent, lposos);\n    vLIGHT0_DIRECTION.z   = dot(osNormal, lposos);\n    #if (NUM_LIGHTS > 1)\n      lposos = (pim_mmi * vec4(vec3(LIGHT1_POSITION), 1.0)).xyz - mpos;\n      lposl = length(vec3(LIGHT1_POSITION) - worldPosition.xyz);\n      vLIGHT1_POSITION.x  = dot(tang, lposos);\n      vLIGHT1_POSITION.y  = dot(bitangent,   lposos);\n      vLIGHT1_POSITION.z  = dot(osNormal,    lposos);\n      vLIGHT1_POSITION.xyz = normalize(vLIGHT1_POSITION.xyz) * lposl;\n      lposos = (pim_mmi * vec4(LIGHT1_DIRECTION, 0.0)).xyz;\n      vLIGHT1_DIRECTION.x   = dot(tang, lposos);\n      vLIGHT1_DIRECTION.y   = dot(bitangent, lposos);\n      vLIGHT1_DIRECTION.z   = dot(osNormal, lposos);\n    #endif\n    #if (defined(PIM_SPECULAR) || defined(PIM_TEXTURE_SPECULAR_0) || defined(PIM_TEXTURE_REFLECTIONMAP))\n      lposos = (pim_mmi * vec4(camPosition - worldPosition.xyz,0.0)).xyz;\n      vvertexToEye.x   = dot(tang, lposos);\n      vvertexToEye.y   = dot(bitangent, lposos);\n      vvertexToEye.z   = dot(osNormal, lposos);\n    #endif\n  #endif\n\n  eyeNormal = (pim_vm * vec4(worldNormal,0.0)).xyz;\n}"},{}],24:[function(a,b,c){c.vertexZ_pimShader="uniform mat4 MM;\nuniform mat4 VM;\nmat4 MVM=VM*MM;\nuniform mat4 MVP;\nattribute vec3 pim_position;\n#ifdef NUM_BONES\n  attribute vec4 pim_weights;\n  attribute vec4 pim_index;\n#endif\n#ifdef PIM_MORPH1\n  attribute vec3 pim_morph1;\n  uniform float pim_morphamount1;\n#endif\n#ifdef PIM_MORPH2\n  attribute vec3 pim_morph2;\n  uniform float pim_morphamount2;\n#endif\n#ifdef PIM_MORPH3\n  attribute vec3 pim_morph3;\n  uniform float pim_morphamount3;\n#endif\n#ifdef PIM_MORPH4\n  attribute vec3 pim_morph4;\n  uniform float pim_morphamount4;\n#endif\n#ifdef PIM_MORPH5\n  attribute vec3 pim_morph5;\n  uniform float pim_morphamount5;\n#endif\n#ifdef PIM_MORPH6\n  attribute vec3 pim_morph6;\n  uniform float pim_morphamount6;\n#endif\n#ifdef PIM_MORPH7\n  attribute vec3 pim_morph7;\n  uniform float pim_morphamount7;\n#endif\n#ifdef PIM_MORPH8\n  attribute vec3 pim_morph8;\n  uniform float pim_morphamount8;\n#endif\n#ifdef NUM_BONES\n  uniform mat4 bones [ NUM_BONES ];\n#endif\n\nvarying vec4 wpos;\n\nvoid main() {\n\n  vec3 temp = pim_position;\n  #ifdef PIM_MORPH1\n   temp += pim_morphamount1 * pim_morph1;\n  #endif\n  #ifdef PIM_MORPH2\n   temp += pim_morphamount2 * pim_morph2;\n  #endif\n  #ifdef PIM_MORPH3\n   temp += pim_morphamount3 * pim_morph3;\n  #endif\n  #ifdef PIM_MORPH4\n   temp += pim_morphamount4 * pim_morph4;\n  #endif\n  #ifdef PIM_MORPH5\n   temp += pim_morphamount5 * pim_morph5;\n  #endif\n  #ifdef PIM_MORPH6\n   temp += pim_morphamount6 * pim_morph6;\n  #endif\n  #ifdef PIM_MORPH7\n   temp += pim_morphamount7 * pim_morph7;\n  #endif\n  #ifdef PIM_MORPH8\n   temp += pim_morphamount8 * pim_morph8;\n  #endif\n  #ifdef NUM_BONES\n    vec4 pos;\n         pos  = (bones[ int(pim_index.x) -1 ] * vec4(temp, 1) ) * pim_weights.x;\n         pos += (bones[ int(pim_index.y) -1 ] * vec4(temp, 1) ) * pim_weights.y;\n         pos += (bones[ int(pim_index.z) -1 ] * vec4(temp, 1) ) * pim_weights.z;\n         pos += (bones[ int(pim_index.w) -1 ] * vec4(temp, 1) ) * pim_weights.w;\n    wpos = VM *  MM * vec4(pos.xyz,1.0);\n    gl_Position = MVP *  wpos;\n  #else\n    wpos = VM *  MM * vec4(temp, 1);\n    gl_Position = MVP  * wpos;\n  #endif\n}\n"},{}]},{},[2]);